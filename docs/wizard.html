<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-61YKX0133N"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-61YKX0133N');</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M.A.S.S. Trap — Build Wizard</title>
<meta name="description" content="Interactive wiring guide for building a M.A.S.S. Trap physics lab. Step-by-step instructions with color-coded diagrams.">
<style>
/* ============================================================
   M.A.S.S. Trap Build Wizard
   Same design language as index.html (Navy + Gold)
   ============================================================ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --navy:#091B2F;--navy-light:#0d2847;--navy-mid:#112d4e;--navy-card:#0f2340;
  --gold:#D4AF37;--gold-dim:rgba(212,175,55,0.25);--gold-glow:rgba(212,175,55,0.08);
  --orange:#FF4500;--orange-dim:rgba(255,69,0,0.15);
  --text:#E8E8E8;--text-muted:#8899AA;--text-dim:#556677;
  --green:#28a745;--red:#dc3545;--cyan:#17a2b8;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  --mono:"SF Mono",Monaco,"Cascadia Code","Fira Code",monospace;
  --max-w:900px;
  --radius:12px;
  /* Wire colors */
  --wire-red:#ff3333;--wire-black:#333;--wire-blue:#4488ff;--wire-yellow:#ffcc00;
  --wire-green:#33cc33;--wire-orange:#ff8800;--wire-white:#eeeeee;
}
html{scroll-behavior:smooth}
body{background:var(--navy);color:var(--text);font-family:var(--font);line-height:1.7;-webkit-font-smoothing:antialiased}
a{color:var(--gold);text-decoration:none}
a:hover{color:#e8c84a;text-decoration:underline}
.container{max-width:var(--max-w);margin:0 auto;padding:0 20px}

/* === HEADER === */
.wiz-header{text-align:center;padding:40px 20px 24px;border-bottom:1px solid var(--gold-dim)}
.wiz-header h1{font-size:2rem;color:var(--gold);letter-spacing:3px;font-weight:900}
.wiz-header p{color:var(--text-muted);font-size:0.9rem;margin-top:4px}
.wiz-back{display:inline-block;margin-bottom:12px;font-size:0.8rem;color:var(--text-muted)}
.wiz-back:hover{color:var(--gold)}

/* === MODULE SELECTOR === */
.module-selector{padding:32px 0;text-align:center}
.module-selector h2{font-size:1.3rem;color:var(--gold);letter-spacing:1px;margin-bottom:16px}
.module-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;max-width:var(--max-w);margin:0 auto;padding:0 20px}
.module-card{background:var(--navy-card);border:2px solid var(--gold-dim);border-radius:var(--radius);padding:20px 16px;text-align:center;cursor:pointer;transition:all 0.2s}
.module-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.module-card.active{border-color:var(--gold);background:linear-gradient(135deg,var(--navy-card),rgba(212,175,55,0.05))}
.module-card.coming-soon{opacity:0.5;cursor:not-allowed}
.module-card.coming-soon:hover{border-color:var(--gold-dim);transform:none}
.module-emoji{font-size:2rem;margin-bottom:8px}
.module-name{font-size:0.95rem;font-weight:700;color:var(--text)}
.module-desc{font-size:0.75rem;color:var(--text-muted);margin-top:4px}
.module-tag{display:inline-block;font-size:0.55rem;font-weight:900;padding:2px 8px;border-radius:4px;letter-spacing:1px;text-transform:uppercase;margin-top:6px}
.module-tag.ready{background:rgba(40,167,69,0.15);color:var(--green);border:1px solid var(--green)}
.module-tag.soon{background:rgba(255,255,255,0.05);color:var(--text-dim);border:1px solid var(--text-dim)}

/* === WIRING GUIDE === */
.wiring-guide{padding:24px 0;display:none}
.wiring-guide.visible{display:block}
.wg-title{text-align:center;margin-bottom:24px}
.wg-title h2{font-size:1.5rem;color:var(--gold);letter-spacing:1px}
.wg-title p{color:var(--text-muted);font-size:0.85rem;margin-top:4px}

/* --- PARTS LIST --- */
.parts-list{background:var(--navy-card);border:1px solid var(--gold-dim);border-radius:var(--radius);padding:20px;margin-bottom:24px}
.parts-list h3{font-size:0.85rem;color:var(--gold);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:12px}
.part-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.part-row:last-child{border-bottom:none}
.part-icon{font-size:1.2rem;width:28px;text-align:center;flex-shrink:0}
.part-name{font-size:0.85rem;font-weight:700;color:var(--text)}
.part-detail{font-size:0.75rem;color:var(--text-muted)}

/* --- STEP CARDS --- */
.step-card{background:var(--navy-card);border:2px solid var(--gold-dim);border-radius:var(--radius);margin-bottom:16px;overflow:hidden;transition:border-color 0.3s}
.step-card.completed{border-color:var(--green)}
.step-card.active{border-color:var(--gold);box-shadow:0 0 16px rgba(212,175,55,0.1)}
.step-header{display:flex;align-items:center;gap:12px;padding:16px 20px;cursor:pointer;user-select:none}
.step-number{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:900;flex-shrink:0;transition:all 0.3s}
.step-card:not(.completed) .step-number{background:rgba(var(--gold-rgb,212,175,55),0.15);color:var(--gold);border:2px solid var(--gold)}
.step-card.completed .step-number{background:var(--green);color:#fff;border:2px solid var(--green)}
.step-info{flex:1;min-width:0}
.step-title{font-size:0.95rem;font-weight:700;color:var(--text)}
.step-subtitle{font-size:0.75rem;color:var(--text-muted)}
.step-check{width:24px;height:24px;border:2px solid var(--text-dim);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0;font-size:0.8rem;color:transparent}
.step-check:hover{border-color:var(--green)}
.step-card.completed .step-check{background:var(--green);border-color:var(--green);color:#fff}
.step-body{padding:0 20px 16px;display:none}
.step-card.active .step-body{display:block}

/* --- WIRE DIAGRAM --- */
.wire-diagram{background:var(--navy);border:1px solid var(--gold-dim);border-radius:8px;padding:20px;margin:12px 0;position:relative;overflow:hidden;min-height:180px}
.wd-board{display:inline-block;background:#1a3a1a;border:2px solid #2d5a2d;border-radius:6px;padding:10px;position:relative}
.wd-board-label{font-size:0.55rem;font-weight:900;letter-spacing:1.5px;text-transform:uppercase;text-align:center;margin-bottom:8px}
.wd-pin-row{display:flex;gap:4px;justify-content:center;margin:4px 0}
.wd-pin{width:24px;height:24px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:0.45rem;font-weight:900;color:#fff;position:relative;cursor:help}
.wd-pin[data-active="true"]{box-shadow:0 0 8px currentColor;transform:scale(1.1)}
.wd-pin.pin-pwr{background:#cc2222}
.wd-pin.pin-gnd{background:#222}
.wd-pin.pin-data{background:#2244aa}
.wd-pin.pin-nc{background:#444}
.wd-pin-tooltip{position:absolute;bottom:120%;left:50%;transform:translateX(-50%);background:#222;color:#fff;font-size:0.6rem;padding:3px 8px;border-radius:4px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:5}
.wd-pin:hover .wd-pin-tooltip{opacity:1}

/* Wire connections drawn as colored divs */
.wd-wire{height:3px;border-radius:2px;margin:4px 0;position:relative}
.wd-wire::before{content:attr(data-label);position:absolute;right:8px;top:-10px;font-size:0.55rem;font-weight:700;letter-spacing:0.5px}
.wd-wire.wire-red{background:var(--wire-red)}.wd-wire.wire-red::before{color:var(--wire-red)}
.wd-wire.wire-black{background:var(--wire-black);border:1px solid #555}.wd-wire.wire-black::before{color:#999}
.wd-wire.wire-blue{background:var(--wire-blue)}.wd-wire.wire-blue::before{color:var(--wire-blue)}
.wd-wire.wire-yellow{background:var(--wire-yellow)}.wd-wire.wire-yellow::before{color:var(--wire-yellow)}
.wd-wire.wire-green{background:var(--wire-green)}.wd-wire.wire-green::before{color:var(--wire-green)}
.wd-wire.wire-orange{background:var(--wire-orange)}.wd-wire.wire-orange::before{color:var(--wire-orange)}

/* --- CONNECTION TABLE --- */
.conn-table{width:100%;border-collapse:collapse;font-size:0.8rem;margin:12px 0}
.conn-table th{font-weight:700;color:var(--gold);font-size:0.65rem;letter-spacing:1px;text-transform:uppercase;padding:8px 6px;border-bottom:2px solid var(--gold-dim);text-align:left}
.conn-table td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.04);color:var(--text)}
.conn-table .wire-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}

/* --- PROGRESS BAR --- */
.wg-progress{background:var(--navy-card);border:1px solid var(--gold-dim);border-radius:var(--radius);padding:16px 20px;margin-bottom:24px;text-align:center}
.wg-progress-label{font-size:0.7rem;color:var(--gold);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}
.wg-progress-bar{height:8px;background:var(--navy);border-radius:4px;overflow:hidden;border:1px solid var(--gold-dim)}
.wg-progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--green));border-radius:4px;transition:width 0.5s ease}
.wg-progress-text{font-size:0.7rem;color:var(--text-muted);margin-top:6px;font-family:var(--mono)}

/* --- TIP BUBBLE --- */
.wg-tip{background:var(--navy-light);border:1px solid var(--gold-dim);border-radius:8px;padding:12px 16px;margin:12px 0;font-size:0.8rem;color:var(--text-muted);line-height:1.6}
.wg-tip strong{color:var(--text)}
.wg-tip em{color:var(--cyan);font-style:normal}
.wg-tip-label{display:inline-block;background:var(--gold);color:var(--navy);font-size:0.5rem;font-weight:900;padding:1px 6px;border-radius:3px;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}

/* --- SUCCESS STATE --- */
.wg-success{background:linear-gradient(135deg,rgba(40,167,69,0.1),rgba(40,167,69,0.05));border:2px solid var(--green);border-radius:var(--radius);padding:24px;text-align:center;margin-top:24px;display:none}
.wg-success.visible{display:block}
.wg-success h3{font-size:1.2rem;color:var(--green);margin-bottom:8px}

/* --- DIAGNOSTICS RESULTS --- */
.diag-card{background:var(--navy-card);border:1px solid var(--gold-dim);border-radius:8px;padding:12px 14px}
.diag-card-title{font-size:0.65rem;font-weight:700;color:var(--gold);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.diag-card-title .diag-icon{font-size:0.9rem}
.diag-row{display:flex;justify-content:space-between;font-size:0.75rem;padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.03)}
.diag-row:last-child{border:none}
.diag-label{color:var(--text-muted)}.diag-value{color:var(--text);font-family:var(--mono);font-weight:600}
.diag-ok{color:var(--green)}.diag-warn{color:var(--wire-yellow)}.diag-fail{color:var(--red)}
.diag-badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:0.6rem;font-weight:700;letter-spacing:0.5px}
.diag-badge.ok{background:rgba(40,167,69,0.15);color:var(--green);border:1px solid rgba(40,167,69,0.3)}
.diag-badge.warn{background:rgba(255,204,0,0.1);color:var(--wire-yellow);border:1px solid rgba(255,204,0,0.2)}
.diag-badge.fail{background:rgba(220,53,69,0.1);color:var(--red);border:1px solid rgba(220,53,69,0.2)}
.wg-success p{font-size:0.85rem;color:var(--text-muted)}

/* --- BATTERY CALCULATOR --- */
.batt-calc{background:var(--navy-card);border:1px solid var(--gold-dim);border-radius:var(--radius);padding:20px;margin-top:24px}
.batt-calc h3{font-size:0.85rem;color:var(--gold);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:16px}
.batt-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.batt-field{display:flex;flex-direction:column;gap:4px}
.batt-field label{font-size:0.65rem;font-weight:700;color:var(--text-muted);letter-spacing:0.5px;text-transform:uppercase}
.batt-field input,.batt-field select{background:var(--navy);color:var(--gold);border:1px solid var(--gold-dim);border-radius:6px;padding:8px 10px;font-family:var(--mono);font-size:0.85rem;width:100%}
.batt-field input:focus,.batt-field select:focus{outline:none;border-color:var(--gold)}
.batt-field .batt-unit{font-size:0.6rem;color:var(--text-dim);margin-top:2px}
.batt-results{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:16px}
.batt-card{background:var(--navy);border:1px solid var(--gold-dim);border-radius:8px;padding:12px;text-align:center}
.batt-card-label{font-size:0.55rem;font-weight:700;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px}
.batt-card-value{font-size:1.5rem;font-weight:900;font-family:var(--mono);line-height:1.2}
.batt-card-sub{font-size:0.65rem;color:var(--text-muted);margin-top:2px}
.batt-card.good .batt-card-value{color:var(--green)}
.batt-card.warn .batt-card-value{color:var(--wire-yellow)}
.batt-card.bad .batt-card-value{color:var(--red)}
.batt-bar{height:10px;background:var(--navy);border:1px solid var(--gold-dim);border-radius:5px;overflow:hidden;margin:4px 0}
.batt-bar-fill{height:100%;border-radius:5px;transition:width 0.4s ease,background 0.4s ease}
.batt-weight-grid{margin-top:12px;font-size:0.8rem}
.batt-weight-grid .bw-label{color:var(--text-muted)}.batt-weight-grid .bw-value{color:var(--text);font-family:var(--mono);text-align:right;font-weight:600}
.batt-weight-row{display:flex;justify-content:space-between;padding:4px 0;font-size:0.8rem;color:var(--text-muted)}
.batt-weight-row span:last-child{font-family:var(--mono);font-weight:600;color:var(--text)}
.batt-verdict{margin-top:16px;padding:12px 16px;border-radius:8px;font-size:0.85rem;font-weight:700;text-align:center;background:var(--navy);border:1px solid var(--border);color:var(--text-muted)}
.batt-verdict.good{background:rgba(40,167,69,0.12);border-color:var(--green);color:var(--green)}
.batt-verdict.warn{background:rgba(245,166,35,0.12);border-color:#f5a623;color:#f5a623}
.batt-verdict.bad{background:rgba(231,76,60,0.12);border-color:#e74c3c;color:#e74c3c}
.batt-presets{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.batt-preset{background:var(--navy-light);border:1px solid var(--gold-dim);border-radius:6px;padding:4px 10px;font-size:0.7rem;color:var(--text-muted);cursor:pointer;font-family:var(--font);transition:all 0.2s}
.batt-preset:hover{border-color:var(--gold);color:var(--gold)}
.batt-preset.selected{background:var(--gold);color:var(--navy);border-color:var(--gold);font-weight:700}
@media(max-width:600px){.batt-form{grid-template-columns:1fr}.batt-results{grid-template-columns:1fr 1fr}}

/* === FOOTER === */
.wiz-footer{border-top:1px solid var(--gold-dim);padding:24px 0;text-align:center;margin-top:48px}
.wiz-footer a{color:var(--text-muted);font-size:0.8rem}

/* === RESPONSIVE === */
@media(max-width:600px){
  .wiz-header h1{font-size:1.5rem}
  .module-grid{grid-template-columns:1fr 1fr}
  .wire-diagram{padding:12px}
  .step-header{padding:12px 16px}
  .step-body{padding:0 16px 12px}
}
</style>
</head>
<body>

<div class="wiz-header">
  <a href="index.html" class="wiz-back">&larr; Back to M.A.S.S. Trap</a>
  <h1>BUILD WIZARD</h1>
  <p>Pick a module. Follow the wires. Flash the firmware. Done.</p>
  <p style="margin-top:8px"><a href="parents-guide.html" style="font-size:0.8rem;color:var(--text-muted)">&#128101; Migrating to terminal block shields? See the <strong style="color:var(--gold)">Parent's Wiring Guide</strong></a></p>
</div>

<!-- ==================== MODULE SELECTOR ==================== -->
<div class="module-selector">
  <h2>Choose Your Build</h2>
  <div class="module-grid">
    <div class="module-card active" onclick="showModule('telemetry')">
      <div class="module-emoji">&#127918;</div>
      <div class="module-name">Onboard Telemetry</div>
      <div class="module-desc">IMU strapped to a Hot Wheels car. 3 tiers: Street (MG24 + built-in), Forensic (XIAO + BNO055), Lab Grade (XIAO + WT901).</div>
      <div class="module-tag ready">GUIDE READY</div>
    </div>
    <div class="module-card" onclick="showModule('finish')">
      <div class="module-emoji">&#127937;</div>
      <div class="module-name">Finish Gate</div>
      <div class="module-desc">ESP32-S3 + IR sensor + speaker. The main dashboard and race timer.</div>
      <div class="module-tag ready">GUIDE READY</div>
    </div>
    <div class="module-card coming-soon">
      <div class="module-emoji">&#128681;</div>
      <div class="module-name">Start Gate</div>
      <div class="module-desc">ESP32-S3 + IR sensor + optional LiDAR. Detects car release and starts the clock.</div>
      <div class="module-tag soon">COMING SOON</div>
    </div>
    <div class="module-card coming-soon">
      <div class="module-emoji">&#128296;</div>
      <div class="module-name">Speed Trap</div>
      <div class="module-desc">ESP32-S3 + dual IR sensors. Measures mid-track velocity.</div>
      <div class="module-tag soon">COMING SOON</div>
    </div>
    <div class="module-card coming-soon">
      <div class="module-emoji">&#128266;</div>
      <div class="module-name">Audio Module</div>
      <div class="module-desc">DY-SV5W or MAX98357A. Race announcer and dispatcher voice system.</div>
      <div class="module-tag soon">COMING SOON</div>
    </div>
    <div class="module-card coming-soon">
      <div class="module-emoji">&#128161;</div>
      <div class="module-name">WLED Strip</div>
      <div class="module-desc">WS2812B addressable LEDs. Race state visualization.</div>
      <div class="module-tag soon">COMING SOON</div>
    </div>
  </div>
</div>

<!-- ==================== TELEMETRY WIRING GUIDE ==================== -->
<div id="guide-telemetry" class="wiring-guide visible">
  <div class="container">
    <div class="wg-title">
      <h2>Onboard Telemetry Logger</h2>
      <p>Strap an IMU to a Hot Wheels car. Measure g-forces, tilt, and acceleration as it races down the track.</p>
    </div>

    <!-- Telemetry Tier Selector -->
    <div class="parts-list" style="margin-bottom:24px;text-align:center">
      <h3>Choose Your Build Tier</h3>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px">Each tier measures acceleration &mdash; higher tiers add precision, fusion quality, and data rate.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">
        <button onclick="setTelemetryTier('street')" id="btnTierStreet" class="tier-btn" style="background:var(--navy-card);color:var(--text-muted);border:2px solid var(--gold-dim);padding:12px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);text-align:left;transition:all 0.2s">
          <div style="font-weight:800;font-size:0.85rem;color:var(--text)">&#127918; Tier 1: Street</div>
          <div style="font-size:0.7rem;margin-top:4px">XIAO MG24 Sense<br><span style="color:var(--text-dim)">Built-in LSM6DS3TR-C 6-axis<br>BLE 5.3 &bull; ~$13 &bull; ~3g</span></div>
        </button>
        <button onclick="setTelemetryTier('forensic')" id="btnTierForensic" class="tier-btn tier-active" style="background:var(--navy-light);color:var(--gold);border:2px solid var(--gold);padding:12px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);text-align:left;transition:all 0.2s">
          <div style="font-weight:800;font-size:0.85rem;color:var(--gold)">&#128270; Tier 2: Forensic</div>
          <div style="font-size:0.7rem;margin-top:4px">XIAO ESP32-S3 + BNO055<br><span style="color:var(--text-dim)">9-axis hardware fusion<br>ESP-NOW &bull; ~$28 &bull; ~6g</span></div>
        </button>
        <button onclick="setTelemetryTier('lab')" id="btnTierLab" class="tier-btn" style="background:var(--navy-card);color:var(--text-muted);border:2px solid var(--gold-dim);padding:12px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);text-align:left;transition:all 0.2s">
          <div style="font-weight:800;font-size:0.85rem;color:var(--text)">&#128300; Tier 3: Lab Grade</div>
          <div style="font-size:0.7rem;margin-top:4px">XIAO ESP32-S3 + WitMotion WT901<br><span style="color:var(--text-dim)">9-axis Kalman AHRS &bull; 200Hz<br>ESP-NOW &bull; ~$42 &bull; ~4g</span></div>
        </button>
      </div>
    </div>

    <!-- Tier comparison table -->
    <div class="parts-list" id="tierComparison" style="margin-bottom:24px">
      <h3>Tier Comparison</h3>
      <table class="conn-table" style="font-size:0.75rem">
        <thead>
          <tr><th>Spec</th><th style="color:var(--text-muted)">Street</th><th style="color:var(--gold)">Forensic</th><th style="color:var(--orange)">Lab Grade</th></tr>
        </thead>
        <tbody>
          <tr><td>MCU</td><td>XIAO MG24 Sense</td><td>XIAO ESP32-S3</td><td>XIAO ESP32-S3</td></tr>
          <tr><td>IMU Sensor</td><td>LSM6DS3TR-C (built-in)</td><td>Adafruit BNO055</td><td>WitMotion WT901</td></tr>
          <tr><td>Axes</td><td>6 (accel + gyro)</td><td>9 (accel + gyro + mag)</td><td>9 (accel + gyro + mag)</td></tr>
          <tr><td>Fusion</td><td>None (software DIY)</td><td>Hardware (BNO055 M0+)</td><td>Kalman filter (48MHz MCU)</td></tr>
          <tr><td>Accel Range</td><td>&plusmn;2 / 4 / 8 / 16g</td><td>&plusmn;2 / 4 / 8 / 16g</td><td>&plusmn;2 / 4 / 8 / 16g</td></tr>
          <tr><td>Max Data Rate</td><td>6.66 kHz (raw)</td><td>100 Hz (fused)</td><td>200 Hz (fused)</td></tr>
          <tr><td>Angle Accuracy</td><td>Depends on code</td><td>&plusmn;0.5&deg; (static)</td><td>&plusmn;0.05&deg; (static)</td></tr>
          <tr><td>Radio</td><td>BLE 5.3 / Thread</td><td>WiFi / ESP-NOW</td><td>WiFi / ESP-NOW</td></tr>
          <tr><td>Interface</td><td>On-chip SPI</td><td>I2C (4 wires)</td><td>UART TTL (4 wires)</td></tr>
          <tr><td>IMU Weight</td><td>0g (built-in)</td><td>~3.5g (breakout board)</td><td>~1g (bare module)</td></tr>
          <tr><td>IMU Power</td><td>0.9 mA</td><td>12 mA</td><td>20 mA</td></tr>
          <tr><td>IMU Price</td><td>$0 (included)</td><td>~$15</td><td>~$34</td></tr>
          <tr><td>Total Cost</td><td>~$13</td><td>~$28</td><td>~$42</td></tr>
          <tr><td>Best For</td><td style="color:var(--text-muted)">Quick demos, weight-limited</td><td style="color:var(--gold)">Science fair, ESP-NOW mesh</td><td style="color:var(--orange)">Max precision, research</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Progress -->
    <div class="wg-progress">
      <div class="wg-progress-label">WIRING PROGRESS</div>
      <div class="wg-progress-bar">
        <div class="wg-progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      <div class="wg-progress-text" id="progressText">0 of 4 connections</div>
    </div>

    <!-- Parts List -->
    <div class="parts-list">
      <h3>Parts Needed</h3>
      <div class="part-row">
        <div class="part-icon">&#128187;</div>
        <div>
          <div class="part-name">Seeed Studio XIAO ESP32-S3</div>
          <div class="part-detail">Dual-core WiFi MCU. Tiny enough to ride on a Hot Wheels car.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#127922;</div>
        <div>
          <div class="part-name">Adafruit BNO055 9-DOF IMU Breakout</div>
          <div class="part-detail">Accelerometer + gyroscope + magnetometer with onboard sensor fusion. I2C interface.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128268;</div>
        <div>
          <div class="part-name">4x Dupont Jumper Wires (Female-Female)</div>
          <div class="part-detail">Red, Black, Blue, Yellow recommended for color coding. Any F-F jumpers work.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128267;</div>
        <div>
          <div class="part-name">USB-C Cable</div>
          <div class="part-detail">For programming the XIAO and initial testing. Any data-capable USB-C cable.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128267;</div>
        <div>
          <div class="part-name">Battery Pack (optional)</div>
          <div class="part-detail">3.7V LiPo or battery holder for untethered operation on the car.</div>
        </div>
      </div>
    </div>

    <!-- Connection Table -->
    <div class="parts-list" style="margin-bottom:24px">
      <h3>Connection Map</h3>
      <table class="conn-table">
        <thead>
          <tr><th>Wire</th><th>XIAO Pin</th><th>BNO055 Pin</th><th>Purpose</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-red)"></span>Red</td>
            <td><strong>3V3</strong></td>
            <td><strong>VIN</strong></td>
            <td>3.3V Power</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-black);border:1px solid #666"></span>Black</td>
            <td><strong>GND</strong></td>
            <td><strong>GND</strong></td>
            <td>Ground</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-blue)"></span>Blue</td>
            <td><strong>D4</strong> (GPIO 5)</td>
            <td><strong>SDA</strong></td>
            <td>I2C Data</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-yellow)"></span>Yellow</td>
            <td><strong>D5</strong> (GPIO 6)</td>
            <td><strong>SCL</strong></td>
            <td>I2C Clock</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- WT901 UART Info (shown when Lab tier selected) -->
    <div id="wt901Info" class="wg-tip" style="display:none;margin-bottom:20px;border-left:3px solid var(--orange)">
      <div class="wg-tip-label" style="color:var(--orange)">WT901 UART Wiring Notes</div>
      <strong>The WT901 uses UART (serial), not I2C.</strong> This means TX/RX are crossed: XIAO&rsquo;s TX pin connects to the WT901&rsquo;s RX, and vice versa. Default baud rate is <strong>9600</strong> (configurable up to 230400 via WitMotion PC software).<br><br>
      <strong>Logic levels:</strong> The WT901 has an onboard LDO and accepts 3.3V&ndash;5V on VCC. The TX/RX pins are 3.3V-tolerant, so direct connection to the XIAO (3.3V logic) is safe &mdash; no level shifter needed.<br><br>
      <strong>Data protocol:</strong> The WT901 continuously outputs binary packets at the configured rate (10Hz default, up to 200Hz). Each packet contains acceleration, angular velocity, angles, and magnetic field. The XIAO reads and parses these packets &mdash; no polling commands needed.<br><br>
      <strong>Calibration:</strong> Use the WitMotion MiniIMU.exe PC software (Windows) to calibrate the magnetometer and set output rate before mounting on the car. Calibration persists in the WT901&rsquo;s flash memory.
    </div>

    <!-- Step 1: Power -->
    <div class="step-card active" id="step1" data-step="1">
      <div class="step-header" onclick="toggleStep(1)">
        <div class="step-number">1</div>
        <div class="step-info">
          <div class="step-title">Connect Power (3.3V)</div>
          <div class="step-subtitle">Red wire: XIAO 3V3 &rarr; BNO055 VIN</div>
        </div>
        <div class="step-check" onclick="event.stopPropagation();completeStep(1)">&#10003;</div>
      </div>
      <div class="step-body">
        <div class="wg-tip">
          <div class="wg-tip-label">Find the Pin</div>
          On the <strong>XIAO</strong>: The <em>3V3</em> pin is on the left side, 2nd pin from the top (when USB-C port faces up).<br>
          On the <strong>BNO055</strong>: The <em>VIN</em> pin is clearly labeled on the board. It accepts 3.3V&ndash;5V.
        </div>
        <div style="text-align:center;margin:12px 0">
          <div class="wd-wire wire-red" data-label="3.3V POWER" style="width:80%;margin:16px auto"></div>
        </div>
        <div class="wg-tip">
          <div class="wg-tip-label">Why Red?</div>
          Convention: <strong>Red = power, black = ground.</strong> Always. This prevents accidentally swapping power and ground, which can fry your components instantly.
        </div>
      </div>
    </div>

    <!-- Step 2: Ground -->
    <div class="step-card" id="step2" data-step="2">
      <div class="step-header" onclick="toggleStep(2)">
        <div class="step-number">2</div>
        <div class="step-info">
          <div class="step-title">Connect Ground</div>
          <div class="step-subtitle">Black wire: XIAO GND &rarr; BNO055 GND</div>
        </div>
        <div class="step-check" onclick="event.stopPropagation();completeStep(2)">&#10003;</div>
      </div>
      <div class="step-body">
        <div class="wg-tip">
          <div class="wg-tip-label">Find the Pin</div>
          On the <strong>XIAO</strong>: <em>GND</em> is on the left side, 3rd pin from the top.<br>
          On the <strong>BNO055</strong>: <em>GND</em> is labeled on the board, usually right next to VIN.
        </div>
        <div style="text-align:center;margin:12px 0">
          <div class="wd-wire wire-black" data-label="GROUND" style="width:80%;margin:16px auto"></div>
        </div>
        <div class="wg-tip">
          <div class="wg-tip-label">Safety Check</div>
          <strong>Power + Ground done!</strong> Before connecting data wires, double-check: red goes to 3V3/VIN, black goes to GND/GND. Swapping these is the #1 way to kill electronics. <em>It's happened to all of us.</em>
        </div>
      </div>
    </div>

    <!-- Step 3: SDA -->
    <div class="step-card" id="step3" data-step="3">
      <div class="step-header" onclick="toggleStep(3)">
        <div class="step-number">3</div>
        <div class="step-info">
          <div class="step-title">Connect I2C Data (SDA)</div>
          <div class="step-subtitle">Blue wire: XIAO D4 (GPIO 5) &rarr; BNO055 SDA</div>
        </div>
        <div class="step-check" onclick="event.stopPropagation();completeStep(3)">&#10003;</div>
      </div>
      <div class="step-body">
        <div class="wg-tip">
          <div class="wg-tip-label">What is I2C?</div>
          <strong>I2C</strong> (pronounced "eye-two-see") is a communication protocol that lets chips talk to each other using just 2 wires: <em>SDA</em> (data) and <em>SCL</em> (clock). The XIAO asks the BNO055 "what's your acceleration?" and the BNO055 answers on these wires. It's like two people passing notes using a shared clipboard.
        </div>
        <div style="text-align:center;margin:12px 0">
          <div class="wd-wire wire-blue" data-label="I2C DATA (SDA)" style="width:80%;margin:16px auto"></div>
        </div>
        <div class="wg-tip">
          <div class="wg-tip-label">Pin D4?</div>
          The XIAO labels its pins as <strong>D0&ndash;D10</strong>, but internally the ESP32-S3 uses GPIO numbers. <em>D4 = GPIO 5</em>. This is the default SDA (I2C data) pin on the XIAO ESP32-S3. You don't need to remember the GPIO number &mdash; the code handles the mapping.
        </div>
      </div>
    </div>

    <!-- Step 4: SCL -->
    <div class="step-card" id="step4" data-step="4">
      <div class="step-header" onclick="toggleStep(4)">
        <div class="step-number">4</div>
        <div class="step-info">
          <div class="step-title">Connect I2C Clock (SCL)</div>
          <div class="step-subtitle">Yellow wire: XIAO D5 (GPIO 6) &rarr; BNO055 SCL</div>
        </div>
        <div class="step-check" onclick="event.stopPropagation();completeStep(4)">&#10003;</div>
      </div>
      <div class="step-body">
        <div class="wg-tip">
          <div class="wg-tip-label">SDA + SCL = Complete I2C Bus</div>
          <em>SCL</em> is the clock signal &mdash; it keeps the XIAO and BNO055 in sync, like a metronome. The XIAO controls the clock speed (100kHz or 400kHz). Without SCL, the data on SDA would be meaningless &mdash; like listening to someone talk without knowing when each word starts and stops.
        </div>
        <div style="text-align:center;margin:12px 0">
          <div class="wd-wire wire-yellow" data-label="I2C CLOCK (SCL)" style="width:80%;margin:16px auto"></div>
        </div>
        <div class="wg-tip">
          <div class="wg-tip-label">That's It!</div>
          <strong>4 wires. That's the whole connection.</strong> I2C is beautiful because you only need 4 wires total (power, ground, data, clock) to talk to incredibly sophisticated sensors. The BNO055 has 3 sensors and a full fusion processor &mdash; all accessible through these 4 wires.
        </div>
      </div>
    </div>

    <!-- Success Banner -->
    <div class="wg-success" id="successBanner">
      <h3>&#10003; WIRING COMPLETE!</h3>
      <p>All 4 connections verified. Plug the XIAO into your computer via USB-C and proceed to firmware flashing.</p>
      <div style="margin-top:16px">
        <div class="wg-tip" style="text-align:left;margin:0">
          <div class="wg-tip-label">Next Steps</div>
          <strong>1.</strong> Plug XIAO into Mac/PC via USB-C<br>
          <strong>2.</strong> Open a terminal and flash the telemetry firmware<br>
          <strong>3.</strong> Open serial monitor &mdash; you should see accelerometer readings<br>
          <strong>4.</strong> Strap both boards to a Hot Wheels car and race!
        </div>
      </div>
    </div>

    <!-- Quick Reference -->
    <div class="parts-list" style="margin-top:24px">
      <h3>Quick Reference: XIAO ESP32-S3 Pinout</h3>
      <table class="conn-table">
        <thead>
          <tr><th>Pin Label</th><th>GPIO</th><th>Function</th><th>Used By</th></tr>
        </thead>
        <tbody>
          <tr><td>3V3</td><td>&mdash;</td><td>3.3V output</td><td style="color:var(--wire-red)">BNO055 VIN</td></tr>
          <tr><td>GND</td><td>&mdash;</td><td>Ground</td><td style="color:var(--text-muted)">BNO055 GND</td></tr>
          <tr><td>D0</td><td>GPIO 1</td><td>Digital I/O</td><td style="color:var(--text-dim)">&mdash;</td></tr>
          <tr><td>D1</td><td>GPIO 2</td><td>Digital I/O</td><td style="color:var(--text-dim)">&mdash;</td></tr>
          <tr><td>D2</td><td>GPIO 3</td><td>Digital I/O</td><td style="color:var(--text-dim)">&mdash;</td></tr>
          <tr><td>D3</td><td>GPIO 4</td><td>Digital I/O</td><td style="color:var(--text-dim)">&mdash;</td></tr>
          <tr><td>D4</td><td>GPIO 5</td><td>I2C SDA (default)</td><td style="color:var(--wire-blue)">BNO055 SDA</td></tr>
          <tr><td>D5</td><td>GPIO 6</td><td>I2C SCL (default)</td><td style="color:var(--wire-yellow)">BNO055 SCL</td></tr>
          <tr><td>D6</td><td>GPIO 43</td><td>UART TX</td><td style="color:var(--text-dim)">&mdash;</td></tr>
          <tr><td>D7</td><td>GPIO 44</td><td>UART RX</td><td style="color:var(--text-dim)">&mdash;</td></tr>
          <tr><td>D8</td><td>GPIO 7</td><td>Digital I/O</td><td style="color:var(--text-dim)">Onboard LED</td></tr>
          <tr><td>D9</td><td>GPIO 8</td><td>Digital I/O</td><td style="color:var(--text-dim)">&mdash;</td></tr>
          <tr><td>D10</td><td>GPIO 9</td><td>Digital I/O</td><td style="color:var(--text-dim)">&mdash;</td></tr>
        </tbody>
      </table>
    </div>

    <!-- ==================== BATTERY POWER PLANNER ==================== -->
    <div class="batt-calc" id="batteryCalc">
      <h3>&#128267; Battery Power Planner</h3>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:16px">Select your MCU, pick a battery (or enter custom specs), and see your runtime, weight budget, and discharge safety at a glance.</p>

      <!-- MCU selector -->
      <div style="margin-bottom:14px">
        <div style="font-size:0.65rem;font-weight:700;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">MCU Board</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--card-bg);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:0.8rem">
            <input type="radio" name="battMcuRadio" value="xiao-s3" checked onchange="document.getElementById('battMcu').value='xiao-s3';calcBattery()">
            <span><strong>XIAO ESP32-S3</strong> + BNO055</span>
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--card-bg);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:0.8rem">
            <input type="radio" name="battMcuRadio" value="xiao-mg24" onchange="document.getElementById('battMcu').value='xiao-mg24';calcBattery()">
            <span><strong>XIAO MG24 Sense</strong> <em style="color:var(--gold);font-size:0.7rem">(built-in IMU)</em></span>
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--card-bg);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:0.8rem">
            <input type="radio" name="battMcuRadio" value="xiao-wt901" onchange="document.getElementById('battMcu').value='xiao-wt901';calcBattery()">
            <span><strong>XIAO ESP32-S3</strong> + WT901 <em style="color:var(--orange);font-size:0.7rem">(200Hz Kalman)</em></span>
          </label>
        </div>
        <input type="hidden" id="battMcu" value="xiao-s3">
      </div>

      <div style="font-size:0.65rem;font-weight:700;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Battery Quick Pick</div>
      <div class="batt-presets" id="battPresets">
        <button class="batt-preset selected" onclick="setBattPreset(120,'521521','2*15*23mm',3.5,0.12)">120mAh 521521</button>
        <button class="batt-preset" onclick="setBattPreset(150,'501230','5*12*30mm',4.0,0.15)">150mAh 501230</button>
        <button class="batt-preset" onclick="setBattPreset(200,'502030','5*20*30mm',5.5,0.20)">200mAh 502030</button>
        <button class="batt-preset" onclick="setBattPreset(300,'602030','6*20*30mm',7.5,0.30)">300mAh 602030</button>
        <button class="batt-preset" onclick="setBattPreset(0,'custom','—',0,0)">Custom</button>
      </div>

      <!-- Input form -->
      <div class="batt-form">
        <div class="batt-field">
          <label>Battery Capacity</label>
          <input type="number" id="battCap" value="120" min="50" max="5000" step="10" oninput="calcBattery()">
          <div class="batt-unit">milliamp-hours (mAh)</div>
        </div>
        <div class="batt-field">
          <label>Max Discharge</label>
          <input type="number" id="battMaxDis" value="0.12" min="0.05" max="10" step="0.01" oninput="calcBattery()">
          <div class="batt-unit">amps (A) &mdash; from battery datasheet</div>
        </div>
        <div class="batt-field">
          <label>Battery Weight</label>
          <input type="number" id="battWeight" value="3.5" min="0" max="100" step="0.1" oninput="calcBattery()">
          <div class="batt-unit">grams</div>
        </div>
        <div class="batt-field">
          <label>Car Weight (without battery)</label>
          <input type="number" id="battCarWeight" value="35" min="0" max="200" step="0.1" oninput="calcBattery()">
          <div class="batt-unit">grams &mdash; weigh your car naked</div>
        </div>
      </div>

      <!-- Results -->
      <div class="batt-results" id="battResults">
        <div class="batt-card" id="battResSF">
          <div class="batt-card-label">Science Fair Runtime</div>
          <div class="batt-card-value">--</div>
          <div class="batt-card-sub">calculating&hellip;</div>
        </div>
        <div class="batt-card" id="battResCont">
          <div class="batt-card-label">Continuous Logging</div>
          <div class="batt-card-value">--</div>
          <div class="batt-card-sub">calculating&hellip;</div>
        </div>
        <div class="batt-card" id="battResSleep">
          <div class="batt-card-label">Deep Sleep Standby</div>
          <div class="batt-card-value">--</div>
          <div class="batt-card-sub">calculating&hellip;</div>
        </div>
        <div class="batt-card" id="battResDis">
          <div class="batt-card-label">Discharge Safety</div>
          <div class="batt-card-value">--</div>
          <div class="batt-card-sub">calculating&hellip;</div>
        </div>
      </div>

      <!-- Weight budget breakdown -->
      <div style="margin-top:20px">
        <div style="font-size:0.65rem;font-weight:700;color:var(--gold);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Weight Budget</div>
        <div class="batt-weight-grid" id="battWeightGrid">
          <!-- Populated by calcBattery() -->
        </div>
        <div id="battWeightBar" style="margin-top:8px">
          <div class="batt-bar"><div class="batt-bar-fill" style="width:0%"></div></div>
          <div class="batt-bar-label" style="text-align:center;font-size:0.6rem;color:var(--text-dim);margin-top:2px"></div>
        </div>
      </div>

      <!-- Verdict -->
      <div class="batt-verdict" id="battVerdict">
        &#9889; Enter battery specs above to see your verdict
      </div>

      <!-- Power design tips -->
      <div class="wg-tip" style="margin-top:16px">
        <div class="wg-tip-label">Firmware Power Tips</div>
        <strong>Use ESP-NOW (ESP32-S3) or BLE (MG24), not full WiFi.</strong> Short radio bursts (1-2ms) vs sustained 150mA+ WiFi draw. The firmware should:<br>
        &#8226; <strong>ESP32-S3 (Tier 2/3):</strong> Use ESP-NOW only &mdash; never call <em>WiFi.begin()</em><br>
        &#8226; <strong>MG24 Sense (Tier 1):</strong> Use BLE 5.3 advertisements &mdash; 1.95&micro;A deep sleep<br>
        &#8226; <strong>WT901 (Tier 3):</strong> Draws 20mA continuously when outputting &mdash; no sleep mode. Reduce output rate to 10Hz between runs.<br>
        &#8226; Log IMU data to local flash during the run (no radio needed)<br>
        &#8226; Send one summary packet after the run ends<br>
        &#8226; Use deep sleep with accelerometer wake-on-motion between runs<br>
        &#8226; Disable WiFi/BLE scanning entirely &mdash; biggest current hog
      </div>

      <div class="wg-tip">
        <div class="wg-tip-label">Discharge Rate Warning</div>
        Small LiPo cells (under 200mAh) often have <strong>max discharge = 1C</strong> (capacity in amps). A 120mAh cell maxes at 120mA sustained. The XIAO ESP32-S3 can spike to ~150mA during radio TX bursts, but those are &lt;2ms &mdash; well within what any LiPo tolerates. The MG24 Sense peaks at ~42mA TX &mdash; much more battery-friendly. <strong>Avoid sustained WiFi scans</strong> regardless of MCU.
      </div>
    </div>

  </div>
</div>

<!-- ==================== FINISH GATE WIRING GUIDE ==================== -->
<div id="guide-finish" class="wiring-guide">
  <div class="container">
    <div class="wg-title">
      <h2>Finish Gate: ESP32-S3 + IR Sensor + Audio</h2>
      <p>The brain of the operation. Hosts the dashboard, records race times, calculates physics, and announces results.</p>
    </div>

    <!-- Wiring Tier Toggle -->
    <div class="parts-list" style="margin-bottom:24px;text-align:center">
      <h3>Choose Your Wiring Method</h3>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px">Both methods produce the same result. The terminal block shield is an upgrade, not a necessity.</p>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button onclick="setFinishTier('dupont')" id="btnDupont" class="tier-btn tier-active" style="background:var(--navy-light);color:var(--gold);border:2px solid var(--gold);padding:10px 20px;border-radius:8px;cursor:pointer;font-family:var(--font);font-weight:700;font-size:0.8rem;transition:all 0.2s">
          &#128268; Dupont Wires<br><span style="font-size:0.65rem;font-weight:400;color:var(--text-muted)">Starter &mdash; Quick &amp; Easy</span>
        </button>
        <button onclick="setFinishTier('terminal')" id="btnTerminal" class="tier-btn" style="background:var(--navy-card);color:var(--text-muted);border:2px solid var(--gold-dim);padding:10px 20px;border-radius:8px;cursor:pointer;font-family:var(--font);font-weight:700;font-size:0.8rem;transition:all 0.2s">
          &#128297; Terminal Block Shield<br><span style="font-size:0.65rem;font-weight:400;color:var(--text-muted)">Upgrade &mdash; Permanent &amp; Clean</span>
        </button>
      </div>
    </div>

    <!-- Progress -->
    <div class="wg-progress">
      <div class="wg-progress-label">WIRING PROGRESS</div>
      <div class="wg-progress-bar">
        <div class="wg-progress-fill" id="fgProgressFill" style="width:0%"></div>
      </div>
      <div class="wg-progress-text" id="fgProgressText">0 of 3 connections</div>
    </div>

    <!-- DUPONT PARTS LIST -->
    <div id="fgPartsDupont" class="parts-list">
      <h3>Parts Needed &mdash; Dupont Wire Method</h3>
      <div class="part-row">
        <div class="part-icon">&#128187;</div>
        <div>
          <div class="part-name">ESP32-S3 N16R8 Dev Board (38-pin)</div>
          <div class="part-detail">16MB Flash / 8MB PSRAM. The purple AITEXM or any ESP32-S3-WROOM-1 dev board with pin headers.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128308;</div>
        <div>
          <div class="part-name">IR Break-Beam Sensor Pair</div>
          <div class="part-detail">Photoelectric transmitter + receiver (3-wire: VCC, GND, Signal). The car breaks the beam &rarr; race stops.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128266;</div>
        <div>
          <div class="part-name">MAX98357A I2S Amplifier + Speaker (optional)</div>
          <div class="part-detail">3W class-D amp. Announces race results, car names, and speed records. Skip this for a silent build.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128268;</div>
        <div>
          <div class="part-name">Dupont Jumper Wires (Female-Female)</div>
          <div class="part-detail">3 wires minimum (IR sensor). 6 wires if adding audio. Color-coded recommended.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128267;</div>
        <div>
          <div class="part-name">USB-C Cable + 5V Power Supply</div>
          <div class="part-detail">USB-C for initial flash. 5V/2A supply for permanent installation (barrel jack or USB).</div>
        </div>
      </div>
      <div class="wg-tip" style="margin-top:12px">
        <div class="wg-tip-label">Dupont Wires Are Fine!</div>
        <strong>Dupont jumper wires are how every prototype starts.</strong> They're quick to connect, easy to rearrange, and free with most sensor kits. The only downside: they can wiggle loose if bumped. If your track lives on stairs and gets kicked by kids, consider upgrading to the terminal block shield later.
      </div>
    </div>

    <!-- TERMINAL BLOCK PARTS LIST -->
    <div id="fgPartsTerminal" class="parts-list" style="display:none">
      <h3>Parts Needed &mdash; Terminal Block Shield</h3>
      <div class="part-row">
        <div class="part-icon">&#128187;</div>
        <div>
          <div class="part-name">ESP32-S3 N16R8 Dev Board (38-pin)</div>
          <div class="part-detail">Same board as Dupont method. Must be the 38-pin variant with standard 2.54mm pin headers.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128296;</div>
        <div>
          <div class="part-name">Meshnology ESP32/ESP32-S3 Terminal Block Shield</div>
          <div class="part-detail">Breakout board with screw terminals for every GPIO. 7-12V barrel jack input with onboard regulator. <a href="https://www.amazon.com/dp/B0FLK4MDDW?tag=ryanmassfelle-20" target="_blank" style="color:var(--gold)">Amazon &rarr;</a></div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128308;</div>
        <div>
          <div class="part-name">IR Break-Beam Sensor Pair</div>
          <div class="part-detail">Same sensor. The screw terminals accept the bare wire ends directly &mdash; strip 5mm of insulation.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128266;</div>
        <div>
          <div class="part-name">MAX98357A I2S Amplifier + Speaker (optional)</div>
          <div class="part-detail">Same amp. Connect via screw terminals instead of Dupont wires.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128268;</div>
        <div>
          <div class="part-name">Solid-Core Wire or Stripped Jumpers</div>
          <div class="part-detail">22AWG solid-core is ideal for screw terminals. Or strip the ends of regular jumper wires.</div>
        </div>
      </div>
      <div class="part-row">
        <div class="part-icon">&#128295;</div>
        <div>
          <div class="part-name">Small Flathead Screwdriver</div>
          <div class="part-detail">For tightening the screw terminals. A precision/jeweler's screwdriver works best.</div>
        </div>
      </div>
      <div class="wg-tip" style="margin-top:12px">
        <div class="wg-tip-label">The Upgrade Path</div>
        <strong>The terminal block shield is the "production" upgrade.</strong> Your ESP32-S3 plugs into the center socket. Every GPIO breaks out to a labeled screw terminal on the sides. Connections are vibration-proof &mdash; you can literally shake the board and nothing comes loose. It also adds a 7-12V barrel jack so you can power the whole thing from a wall adapter instead of USB.<br><br>
        <strong>You don't need this to get started.</strong> Build with Dupont wires first. Migrate to the shield when you're done prototyping and ready to make it permanent.
      </div>
    </div>

    <!-- Connection Table (adapts to tier) -->
    <div class="parts-list" style="margin-bottom:24px">
      <h3>Connection Map &mdash; IR Sensor</h3>
      <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px">The IR sensor has 3 wires. This is the minimum to get a working finish gate.</p>
      <table class="conn-table">
        <thead>
          <tr><th>Wire</th><th>ESP32-S3 Pin</th><th>IR Sensor Pin</th><th>Purpose</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-red)"></span>Red</td>
            <td><strong id="fgPinVCC">3.3V</strong></td>
            <td><strong>VCC</strong></td>
            <td>Sensor power (3.3V or 5V)</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-black);border:1px solid #666"></span>Black</td>
            <td><strong id="fgPinGND">GND</strong></td>
            <td><strong>GND</strong></td>
            <td>Ground</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-green)"></span>Green</td>
            <td><strong id="fgPinSig">GPIO 4</strong></td>
            <td><strong>OUT / SIG</strong></td>
            <td>Signal &mdash; goes LOW when beam is broken</td>
          </tr>
        </tbody>
      </table>
      <div class="wg-tip" style="margin-top:8px">
        <div class="wg-tip-label" id="fgPinNote">Dupont Method</div>
        <span id="fgPinDesc">Plug the female Dupont connector directly onto the ESP32-S3 header pins. Match the colors: red to 3.3V, black to GND, green (or white) to GPIO 4.</span>
      </div>
    </div>

    <!-- Audio Table (shown for both tiers) -->
    <div class="parts-list" style="margin-bottom:24px">
      <h3>Connection Map &mdash; Audio (Optional)</h3>
      <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px">Skip this section if you want a silent build. You can always add audio later.</p>
      <table class="conn-table">
        <thead>
          <tr><th>Wire</th><th>ESP32-S3 Pin</th><th>MAX98357A Pin</th><th>Purpose</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-red)"></span>Red</td>
            <td><strong>3.3V</strong></td>
            <td><strong>VIN</strong></td>
            <td>Amplifier power</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-black);border:1px solid #666"></span>Black</td>
            <td><strong>GND</strong></td>
            <td><strong>GND</strong></td>
            <td>Ground</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-orange)"></span>Orange</td>
            <td><strong>GPIO 15</strong></td>
            <td><strong>BCLK</strong></td>
            <td>I2S Bit Clock</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-yellow)"></span>Yellow</td>
            <td><strong>GPIO 16</strong></td>
            <td><strong>LRC</strong></td>
            <td>I2S Left/Right Clock</td>
          </tr>
          <tr>
            <td><span class="wire-dot" style="background:var(--wire-blue)"></span>Blue</td>
            <td><strong>GPIO 17</strong></td>
            <td><strong>DIN</strong></td>
            <td>I2S Data</td>
          </tr>
        </tbody>
      </table>
      <div class="wg-tip" style="margin-top:8px">
        <div class="wg-tip-label">Speaker Connection</div>
        The MAX98357A has two speaker terminals (<strong>+</strong> and <strong>&minus;</strong>). Connect your speaker wires there. Any 4&ohm; or 8&ohm; speaker 1-3W works. The audio system is disabled by default in firmware &mdash; enable it in the System tab after first boot.
      </div>
    </div>

    <!-- STEP 1: Power -->
    <div class="step-card active" id="fg-step1" data-step="1">
      <div class="step-header" onclick="fgToggleStep(1)">
        <div class="step-number">1</div>
        <div class="step-info">
          <div class="step-title">Connect IR Sensor Power</div>
          <div class="step-subtitle">Red wire: ESP32-S3 3.3V &rarr; IR Sensor VCC</div>
        </div>
        <div class="step-check" onclick="event.stopPropagation();fgCompleteStep(1)">&#10003;</div>
      </div>
      <div class="step-body">
        <div class="wg-tip">
          <div class="wg-tip-label">Find the Pin</div>
          On the <strong>ESP32-S3 dev board</strong>: Look for the pin labeled <em>3V3</em> (sometimes <em>3.3V</em>). It&rsquo;s typically in the top-left corner of the pin header.<br>
          On the <strong>IR sensor</strong>: The <em>VCC</em> wire is usually <strong>red</strong> (or brown on some sensors). Check the label on the sensor PCB if unsure.
        </div>
        <div id="fgStep1Tip" class="wg-tip">
          <div class="wg-tip-label">Dupont Method</div>
          Slide the female Dupont connector onto the <em>3V3</em> header pin. It should click gently. Don&rsquo;t force it &mdash; if it&rsquo;s hard to push, you might be on the wrong pin.
        </div>
        <div style="text-align:center;margin:12px 0">
          <div class="wd-wire wire-red" data-label="3.3V POWER" style="width:80%;margin:16px auto"></div>
        </div>
        <div class="wg-tip">
          <div class="wg-tip-label">3.3V vs 5V</div>
          Most IR break-beam sensors work at both 3.3V and 5V. Using <strong>3.3V is safer</strong> because the ESP32-S3 GPIO pins are 3.3V logic. If your sensor requires 5V power, use the 5V pin for VCC but be aware the signal pin may need a voltage divider. <em>When in doubt, start with 3.3V.</em>
        </div>
      </div>
    </div>

    <!-- STEP 2: Ground -->
    <div class="step-card" id="fg-step2" data-step="2">
      <div class="step-header" onclick="fgToggleStep(2)">
        <div class="step-number">2</div>
        <div class="step-info">
          <div class="step-title">Connect IR Sensor Ground</div>
          <div class="step-subtitle">Black wire: ESP32-S3 GND &rarr; IR Sensor GND</div>
        </div>
        <div class="step-check" onclick="event.stopPropagation();fgCompleteStep(2)">&#10003;</div>
      </div>
      <div class="step-body">
        <div class="wg-tip">
          <div class="wg-tip-label">Find the Pin</div>
          On the <strong>ESP32-S3</strong>: Multiple <em>GND</em> pins exist on most dev boards (usually 2-3). Use any one of them &mdash; they&rsquo;re all connected internally.<br>
          On the <strong>IR sensor</strong>: The <em>GND</em> wire is usually <strong>black</strong> (or blue on some sensors).
        </div>
        <div style="text-align:center;margin:12px 0">
          <div class="wd-wire wire-black" data-label="GROUND" style="width:80%;margin:16px auto"></div>
        </div>
        <div class="wg-tip">
          <div class="wg-tip-label">Safety Check</div>
          <strong>Power + Ground done!</strong> Before connecting the signal wire, double-check: red goes to 3.3V/VCC, black goes to GND/GND. <em>Swapping these will fry the sensor instantly.</em> There is no undo.
        </div>
      </div>
    </div>

    <!-- STEP 3: Signal -->
    <div class="step-card" id="fg-step3" data-step="3">
      <div class="step-header" onclick="fgToggleStep(3)">
        <div class="step-number">3</div>
        <div class="step-info">
          <div class="step-title">Connect IR Signal Wire</div>
          <div class="step-subtitle">Green wire: ESP32-S3 GPIO 4 &rarr; IR Sensor OUT</div>
        </div>
        <div class="step-check" onclick="event.stopPropagation();fgCompleteStep(3)">&#10003;</div>
      </div>
      <div class="step-body">
        <div class="wg-tip">
          <div class="wg-tip-label">How It Works</div>
          The IR break-beam sensor has two parts: a <strong>transmitter</strong> (emits invisible infrared light) and a <strong>receiver</strong> (detects it). When a car rolls between them, the beam is broken and the signal pin goes <em>LOW</em>. The ESP32 ISR (Interrupt Service Routine) catches this at microsecond precision &mdash; that&rsquo;s your race time.
        </div>
        <div style="text-align:center;margin:12px 0">
          <div class="wd-wire wire-green" data-label="SIGNAL (GPIO 4)" style="width:80%;margin:16px auto"></div>
        </div>
        <div class="wg-tip">
          <div class="wg-tip-label">GPIO 4 is the Default</div>
          The firmware defaults to <em>GPIO 4</em> for the primary IR sensor. This is configurable in the dashboard under System &rarr; Pin Configuration. <strong>You can change it later</strong> if GPIO 4 is inconvenient for your wiring layout &mdash; any free GPIO works.
        </div>
        <div class="wg-tip">
          <div class="wg-tip-label">Sensor Placement</div>
          Mount the transmitter and receiver on <strong>opposite sides of the track</strong>, at car-height (~15mm above the track surface). The beam should cross the track perpendicular to the direction of travel. The finish line is wherever you place these sensors.
        </div>
      </div>
    </div>

    <!-- Success Banner -->
    <div class="wg-success" id="fgSuccessBanner">
      <h3>&#10003; FINISH GATE WIRED!</h3>
      <p>Core wiring complete. Flash the firmware and you have a working race timer.</p>
      <div style="margin-top:16px">
        <div class="wg-tip" style="text-align:left;margin:0">
          <div class="wg-tip-label">First Boot Checklist</div>
          <strong>1.</strong> Plug ESP32-S3 into your computer via USB-C<br>
          <strong>2.</strong> Flash the M.A.S.S. Trap firmware via PlatformIO: <code style="background:var(--navy);padding:2px 6px;border-radius:3px;font-size:0.75rem">pio run -t upload</code><br>
          <strong>3.</strong> The device creates a WiFi hotspot: <em>MASS-Trap-Setup</em><br>
          <strong>4.</strong> Connect and configure at <em>192.168.4.1</em> &mdash; set role to <strong>Finish Gate</strong><br>
          <strong>5.</strong> After reboot, open the dashboard at the device&rsquo;s IP address<br>
          <strong>6.</strong> Wave your hand through the IR beam &mdash; you should see FINISHED!
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="wg-tip" style="text-align:left;margin:0">
          <div class="wg-tip-label">Optional: Add Audio Later</div>
          The audio connections (MAX98357A) in the table above can be added anytime. Just wire 5 more connections, enable audio in System settings, and upload WAV files. The finish gate works perfectly without audio.
        </div>
      </div>
    </div>

    <!-- Hardware Diagnostics — Verify Connection -->
    <div id="fgDiagnostics" class="parts-list" style="margin-top:24px;display:none">
      <h3 style="color:var(--gold)">&#128269; Verify Connection</h3>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px">Enter your device&rsquo;s IP address and run a live hardware check. The firmware scans pin states, I2C bus, memory, WiFi, and connected peripherals.</p>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:16px">
        <label style="font-size:0.8rem;color:var(--text-muted)">Device IP:</label>
        <input type="text" id="diagIP" placeholder="192.168.1.83" value="" style="background:var(--navy);color:var(--gold);border:1px solid var(--gold-dim);border-radius:6px;padding:6px 12px;font-family:var(--mono);font-size:0.85rem;width:180px">
        <button onclick="runDiagnostics()" id="diagRunBtn" style="background:var(--gold);color:var(--navy);font-weight:700;border:none;border-radius:6px;padding:8px 18px;cursor:pointer;font-size:0.85rem;letter-spacing:0.5px">RUN DIAGNOSTICS</button>
        <span id="diagSpinner" style="display:none;color:var(--gold)">&#9201; Scanning&hellip;</span>
      </div>
      <div id="diagResults" style="display:none">
        <!-- Verdict banner -->
        <div id="diagVerdict" style="padding:12px 16px;border-radius:8px;margin-bottom:16px;font-weight:700;font-size:0.9rem"></div>
        <!-- Traffic light results grid -->
        <div id="diagGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px"></div>
        <!-- Raw JSON toggle -->
        <details style="margin-top:16px">
          <summary style="cursor:pointer;color:var(--text-muted);font-size:0.75rem">Show raw JSON response</summary>
          <pre id="diagRaw" style="background:var(--navy);border:1px solid var(--gold-dim);border-radius:6px;padding:12px;margin-top:8px;font-size:0.7rem;overflow-x:auto;max-height:400px;color:var(--text-muted)"></pre>
        </details>
      </div>
      <div id="diagError" style="display:none;padding:12px 16px;border-radius:8px;border:1px solid var(--red);background:rgba(220,53,69,0.1);color:var(--red);font-size:0.85rem;margin-top:8px"></div>
    </div>

    <!-- Meshnology Terminal Block Reference -->
    <div class="parts-list" style="margin-top:24px">
      <h3>Quick Reference: Meshnology Shield Pin Map</h3>
      <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px">Screw terminal numbers match GPIO numbers. Find your GPIO, find the terminal.</p>
      <table class="conn-table">
        <thead>
          <tr><th>Terminal #</th><th>GPIO</th><th>M.A.S.S. Trap Use</th><th>Wire Color</th></tr>
        </thead>
        <tbody>
          <tr><td>4</td><td>GPIO 4</td><td style="color:var(--wire-green)">IR Sensor (Finish)</td><td><span class="wire-dot" style="background:var(--wire-green)"></span>Green</td></tr>
          <tr><td>5</td><td>GPIO 5</td><td style="color:var(--text-dim)">IR Sensor 2 (Speed Trap)</td><td><span class="wire-dot" style="background:#777"></span>Optional</td></tr>
          <tr><td>15</td><td>GPIO 15</td><td style="color:var(--wire-orange)">I2S BCLK (Audio)</td><td><span class="wire-dot" style="background:var(--wire-orange)"></span>Orange</td></tr>
          <tr><td>16</td><td>GPIO 16</td><td style="color:var(--wire-yellow)">I2S LRC (Audio)</td><td><span class="wire-dot" style="background:var(--wire-yellow)"></span>Yellow</td></tr>
          <tr><td>17</td><td>GPIO 17</td><td style="color:var(--wire-blue)">I2S DIN (Audio)</td><td><span class="wire-dot" style="background:var(--wire-blue)"></span>Blue</td></tr>
          <tr><td>38</td><td>GPIO 38</td><td style="color:var(--cyan)">LiDAR TX (Start Gate)</td><td><span class="wire-dot" style="background:var(--cyan)"></span>Teal</td></tr>
          <tr><td>39</td><td>GPIO 39</td><td style="color:var(--cyan)">LiDAR RX (Start Gate)</td><td><span class="wire-dot" style="background:var(--cyan)"></span>Teal</td></tr>
          <tr><td>2</td><td>GPIO 2</td><td style="color:var(--text-dim)">Status LED</td><td><span class="wire-dot" style="background:#777"></span>Optional</td></tr>
          <tr style="color:var(--text-dim)"><td>3V3</td><td>&mdash;</td><td>Sensor power</td><td><span class="wire-dot" style="background:var(--wire-red)"></span>Red</td></tr>
          <tr style="color:var(--text-dim)"><td>GND</td><td>&mdash;</td><td>Ground</td><td><span class="wire-dot" style="background:var(--wire-black);border:1px solid #666"></span>Black</td></tr>
          <tr style="color:var(--text-dim)"><td>5V</td><td>&mdash;</td><td>5V power (barrel jack)</td><td><span class="wire-dot" style="background:var(--wire-red)"></span>Red</td></tr>
        </tbody>
      </table>
      <div class="wg-tip" style="margin-top:8px">
        <div class="wg-tip-label">Terminal Block Advantage</div>
        <strong>The terminal numbers match the GPIO numbers.</strong> GPIO 4 &rarr; Terminal 4. GPIO 15 &rarr; Terminal 15. No translation needed. Tighten with a small flathead screwdriver &mdash; connections are vibration-proof and won&rsquo;t wiggle loose when a 10-year-old crashes into the track at full speed.
      </div>
    </div>

  </div>
</div>

<!-- ==================== FOOTER ==================== -->
<div class="wiz-footer">
  <div class="container">
    <a href="index.html">M.A.S.S. Trap</a> &bull;
    <a href="parents-guide.html">Parent's Guide</a> &bull;
    <a href="https://github.com/Ryan4n6/MASS-Trap" target="_blank">GitHub</a> &bull;
    <a href="store.html">Parts Store</a>
  </div>
</div>

<script>
/* =============================================================
   M.A.S.S. Trap Build Wizard — Interactive Wiring Guide
   ES5 compatible (var only)
   Supports multiple modules with independent progress tracking
   ============================================================= */
(function() {
  'use strict';

  /* ---- Module definitions ---- */
  var modules = {
    telemetry: { totalSteps: 4, prefix: 'step', progressFill: 'progressFill', progressText: 'progressText', successBanner: 'successBanner', storageKey: 'mass_wizard_telemetry' },
    finish:    { totalSteps: 3, prefix: 'fg-step', progressFill: 'fgProgressFill', progressText: 'fgProgressText', successBanner: 'fgSuccessBanner', storageKey: 'mass_wizard_finish' }
  };
  var state = {}; // { telemetry: {1:true,2:true}, finish: {1:true} }
  var activeModule = 'telemetry';
  var finishTier = 'dupont';

  /* ---- Progress update for a given module ---- */
  function updateModuleProgress(modId) {
    var mod = modules[modId];
    if (!mod) return;
    var completed = state[modId] || {};
    var count = Object.keys(completed).length;
    var pct = Math.round((count / mod.totalSteps) * 100);
    var fill = document.getElementById(mod.progressFill);
    var text = document.getElementById(mod.progressText);
    if (fill) fill.style.width = pct + '%';
    if (text) text.textContent = count + ' of ' + mod.totalSteps + ' connections';

    var banner = document.getElementById(mod.successBanner);
    if (banner) {
      if (count >= mod.totalSteps) {
        banner.classList.add('visible');
        banner.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        banner.classList.remove('visible');
      }
    }
    try { localStorage.setItem(mod.storageKey, JSON.stringify(completed)); } catch(e) {}
  }

  /* ---- Generic toggle/complete for any module ---- */
  function toggleStepGeneric(modId, n) {
    var mod = modules[modId];
    if (!mod) return;
    var card = document.getElementById(mod.prefix + n);
    if (!card) return;
    var wasActive = card.classList.contains('active');
    for (var i = 1; i <= mod.totalSteps; i++) {
      var c = document.getElementById(mod.prefix + i);
      if (c) c.classList.remove('active');
    }
    if (!wasActive) card.classList.add('active');
  }

  function completeStepGeneric(modId, n) {
    var mod = modules[modId];
    if (!mod) return;
    if (!state[modId]) state[modId] = {};
    var card = document.getElementById(mod.prefix + n);
    if (!card) return;
    if (state[modId][n]) {
      delete state[modId][n];
      card.classList.remove('completed');
    } else {
      state[modId][n] = true;
      card.classList.add('completed');
      card.classList.remove('active');
      var next = document.getElementById(mod.prefix + (n + 1));
      if (next && !state[modId][n + 1]) {
        next.classList.add('active');
        next.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    var num = card.querySelector('.step-number');
    if (num) num.textContent = state[modId][n] ? '\u2713' : n;
    updateModuleProgress(modId);
  }

  /* ---- Telemetry module wrappers (backward compat) ---- */
  window.toggleStep = function(n) { toggleStepGeneric('telemetry', n); };
  window.completeStep = function(n) { completeStepGeneric('telemetry', n); };

  /* ---- Finish Gate module wrappers ---- */
  window.fgToggleStep = function(n) { toggleStepGeneric('finish', n); };
  window.fgCompleteStep = function(n) { completeStepGeneric('finish', n); };

  /* ---- Finish Gate tier toggle ---- */
  window.setFinishTier = function(tier) {
    finishTier = tier;
    var dParts = document.getElementById('fgPartsDupont');
    var tParts = document.getElementById('fgPartsTerminal');
    var btnD = document.getElementById('btnDupont');
    var btnT = document.getElementById('btnTerminal');
    var pinNote = document.getElementById('fgPinNote');
    var pinDesc = document.getElementById('fgPinDesc');
    var step1Tip = document.getElementById('fgStep1Tip');

    if (tier === 'terminal') {
      if (dParts) dParts.style.display = 'none';
      if (tParts) tParts.style.display = '';
      if (btnD) { btnD.style.borderColor = 'var(--gold-dim)'; btnD.style.color = 'var(--text-muted)'; btnD.style.background = 'var(--navy-card)'; }
      if (btnT) { btnT.style.borderColor = 'var(--gold)'; btnT.style.color = 'var(--gold)'; btnT.style.background = 'var(--navy-light)'; }
      if (pinNote) pinNote.textContent = 'Terminal Block Method';
      if (pinDesc) pinDesc.innerHTML = 'Strip 5mm of wire insulation. Insert the bare wire into the screw terminal matching the GPIO number. Terminal <strong>4</strong> = GPIO 4. Tighten with a small flathead screwdriver until the wire doesn\'t pull out. Power and ground use the dedicated <strong>3V3</strong> and <strong>GND</strong> terminals on the board edges.';
      if (step1Tip) { step1Tip.querySelector('.wg-tip-label').textContent = 'Terminal Block Method'; step1Tip.querySelector('.wg-tip-label').nextSibling.textContent = ''; step1Tip.innerHTML = '<div class="wg-tip-label">Terminal Block Method</div>Find the <strong>3V3</strong> screw terminal on the Meshnology board edge (green block, labeled). Strip 5mm of insulation from your red wire, insert, and tighten. Give it a gentle tug to confirm it\'s secure.'; }
    } else {
      if (dParts) dParts.style.display = '';
      if (tParts) tParts.style.display = 'none';
      if (btnT) { btnT.style.borderColor = 'var(--gold-dim)'; btnT.style.color = 'var(--text-muted)'; btnT.style.background = 'var(--navy-card)'; }
      if (btnD) { btnD.style.borderColor = 'var(--gold)'; btnD.style.color = 'var(--gold)'; btnD.style.background = 'var(--navy-light)'; }
      if (pinNote) pinNote.textContent = 'Dupont Method';
      if (pinDesc) pinDesc.textContent = 'Plug the female Dupont connector directly onto the ESP32-S3 header pins. Match the colors: red to 3.3V, black to GND, green (or white) to GPIO 4.';
      if (step1Tip) { step1Tip.innerHTML = '<div class="wg-tip-label">Dupont Method</div>Slide the female Dupont connector onto the <em>3V3</em> header pin. It should click gently. Don\'t force it \u2014 if it\'s hard to push, you might be on the wrong pin.'; }
    }
    try { localStorage.setItem('mass_wizard_finish_tier', tier); } catch(e) {}
  };

  /* ---- Hardware Diagnostics ---- */
  window.runDiagnostics = function() {
    var ip = document.getElementById('diagIP').value.trim();
    if (!ip) { document.getElementById('diagIP').focus(); return; }

    var btn = document.getElementById('diagRunBtn');
    var spinner = document.getElementById('diagSpinner');
    var results = document.getElementById('diagResults');
    var errBox = document.getElementById('diagError');
    btn.disabled = true; btn.textContent = 'SCANNING...';
    spinner.style.display = 'inline';
    results.style.display = 'none';
    errBox.style.display = 'none';

    var url = 'http://' + ip + '/api/diagnostics';
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.timeout = 8000;
    xhr.onload = function() {
      btn.disabled = false; btn.textContent = 'RUN DIAGNOSTICS'; spinner.style.display = 'none';
      if (xhr.status === 200) {
        try {
          var d = JSON.parse(xhr.responseText);
          renderDiagnostics(d);
          results.style.display = 'block';
          document.getElementById('diagRaw').textContent = JSON.stringify(d, null, 2);
          try { localStorage.setItem('mass_wizard_diag_ip', ip); } catch(e) {}
        } catch(e) {
          errBox.textContent = 'Invalid JSON response. Is this a M.A.S.S. Trap device?';
          errBox.style.display = 'block';
        }
      } else {
        errBox.textContent = 'HTTP ' + xhr.status + ' — Device responded but returned an error.';
        errBox.style.display = 'block';
      }
    };
    xhr.onerror = function() {
      btn.disabled = false; btn.textContent = 'RUN DIAGNOSTICS'; spinner.style.display = 'none';
      errBox.innerHTML = '<strong>Connection failed.</strong> Make sure:<br>• Your computer is on the same WiFi as the ESP32<br>• The device IP is correct (check your router or try <em>masstrap-finish.local</em>)<br>• The device is powered on and fully booted (~10 seconds after power-up)';
      errBox.style.display = 'block';
    };
    xhr.ontimeout = function() {
      btn.disabled = false; btn.textContent = 'RUN DIAGNOSTICS'; spinner.style.display = 'none';
      errBox.textContent = 'Request timed out (8s). Device may be unreachable or still booting.';
      errBox.style.display = 'block';
    };
    xhr.send();
  };

  function renderDiagnostics(d) {
    var grid = document.getElementById('diagGrid');
    var verdictEl = document.getElementById('diagVerdict');
    grid.innerHTML = '';

    // Verdict banner
    var v = d.verdict || {};
    var allClear = (v.issue_count === 0);
    verdictEl.style.background = allClear ? 'rgba(40,167,69,0.1)' : 'rgba(220,53,69,0.1)';
    verdictEl.style.border = '1px solid ' + (allClear ? 'var(--green)' : 'var(--red)');
    verdictEl.style.color = allClear ? 'var(--green)' : 'var(--red)';
    var verdictIcon = allClear ? '&#10003;' : '&#9888;';
    var verdictText = allClear ? 'ALL CLEAR — No issues detected' : v.issue_count + ' issue' + (v.issue_count > 1 ? 's' : '') + ' detected';
    verdictEl.innerHTML = verdictIcon + ' ' + verdictText;
    if (!allClear && v.issues) {
      for (var vi = 0; vi < v.issues.length; vi++) {
        verdictEl.innerHTML += '<br><span style="font-weight:400;font-size:0.8rem">&bull; ' + v.issues[vi] + '</span>';
      }
    }

    // System card
    var sys = d.system || {};
    addCard(grid, '&#128187;', 'System', [
      ['Firmware', sys.firmware || '?'],
      ['Role', sys.role || 'unconfigured'],
      ['Board', sys.board || '?'],
      ['CPU', (sys.cpu_freq_mhz || '?') + ' MHz'],
      ['Uptime', sys.uptime_str || '?'],
      ['SDK', sys.sdk || '?']
    ]);

    // Memory card
    var mem = d.memory || {};
    var heapOk = (mem.heap_pct_free || 0) > 15;
    addCard(grid, '&#129518;', 'Memory', [
      ['Heap Free', formatBytes(mem.free_heap) + ' / ' + formatBytes(mem.total_heap), heapOk ? 'ok' : 'warn'],
      ['Heap %', (mem.heap_pct_free || 0) + '% free', heapOk ? 'ok' : 'warn'],
      ['Min Ever', formatBytes(mem.min_free_heap)],
      ['PSRAM', mem.psram_total > 0 ? formatBytes(mem.psram_free) + ' / ' + formatBytes(mem.psram_total) : 'Not detected']
    ]);

    // Filesystem card
    var fs = d.filesystem || {};
    var fsOk = (fs.pct_used || 0) < 90;
    addCard(grid, '&#128190;', 'Filesystem', [
      ['Used', formatBytes(fs.used_bytes) + ' / ' + formatBytes(fs.total_bytes), fsOk ? 'ok' : 'warn'],
      ['Free', formatBytes(fs.free_bytes)],
      ['Usage', (fs.pct_used || 0) + '%', fsOk ? 'ok' : 'warn']
    ]);

    // WiFi card
    var wifi = d.wifi || {};
    var rssiOk = (wifi.rssi || -100) > -70;
    var rssiWarn = (wifi.rssi || -100) > -80;
    addCard(grid, '&#128225;', 'WiFi / Radio', [
      ['Mode', wifi.mode || '?'],
      ['Connected', wifi.sta_connected ? 'YES' : 'NO', wifi.sta_connected ? 'ok' : 'fail'],
      ['IP', wifi.sta_ip || '—'],
      ['RSSI', (wifi.rssi || '?') + ' dBm (' + (wifi.signal_quality || 0) + '%)', rssiOk ? 'ok' : (rssiWarn ? 'warn' : 'fail')],
      ['Channel', wifi.channel || '?'],
      ['AP Clients', wifi.ap_clients || 0]
    ]);

    // ESP-NOW / Peers card
    var espnow = d.espnow || {};
    addCard(grid, '&#128752;', 'ESP-NOW Peers', [
      ['Primary Peer', espnow.peer_connected ? 'CONNECTED' : 'DISCONNECTED', espnow.peer_connected ? 'ok' : 'warn'],
      ['Peer Count', espnow.peer_count || 0],
      ['Clock Offset', (espnow.clock_offset_us || 0) + ' \u00B5s']
    ]);
    // Add individual peers
    if (espnow.peers && espnow.peers.length > 0) {
      for (var pi = 0; pi < espnow.peers.length; pi++) {
        var peer = espnow.peers[pi];
        var pStatus = peer.status || 'OFFLINE';
        var card = document.createElement('div'); card.className = 'diag-card';
        card.innerHTML = '<div class="diag-card-title"><span class="diag-icon">&#128110;</span>Peer: ' + (peer.hostname || peer.mac) + '</div>';
        card.innerHTML += diagRow('Role', peer.role);
        card.innerHTML += diagRow('MAC', peer.mac);
        card.innerHTML += diagRow('Status', pStatus, pStatus === 'ONLINE' ? 'ok' : (pStatus === 'STALE' ? 'warn' : 'fail'));
        card.innerHTML += diagRow('Paired', peer.paired ? 'YES' : 'NO');
        card.innerHTML += diagRow('Last Seen', formatMs(peer.last_seen_ms) + ' ago');
        grid.appendChild(card);
      }
    }

    // Pins card
    var pins = d.pins || {};
    var pinRows = [];
    if (pins.ir_sensor) {
      var ir = pins.ir_sensor;
      pinRows.push(['IR Sensor', 'GPIO ' + ir.gpio + ' — ' + (ir.state || '?'), ir.ok ? 'ok' : 'fail']);
    }
    if (pins.ir_sensor_2) {
      var ir2 = pins.ir_sensor_2;
      pinRows.push(['IR Sensor 2', 'GPIO ' + ir2.gpio + ' — ' + (ir2.state || '?'), ir2.ok ? 'ok' : 'fail']);
    }
    if (pins.led) pinRows.push(['LED', 'GPIO ' + pins.led.gpio]);
    if (pins.audio) {
      var au = pins.audio;
      pinRows.push(['Audio BCLK', 'GPIO ' + au.bclk_gpio]);
      pinRows.push(['Audio LRC', 'GPIO ' + au.lrc_gpio]);
      pinRows.push(['Audio DOUT', 'GPIO ' + au.dout_gpio]);
      pinRows.push(['Volume', au.volume + '/21']);
      pinRows.push(['Playing', au.playing ? 'YES' : 'No']);
    }
    if (pins.lidar) {
      var li = pins.lidar;
      pinRows.push(['LiDAR RX/TX', 'GPIO ' + li.rx_gpio + '/' + li.tx_gpio]);
      pinRows.push(['LiDAR Dist', li.distance_mm + ' mm', li.ok ? 'ok' : 'fail']);
      pinRows.push(['LiDAR State', li.state]);
    }
    if (pinRows.length > 0) addCard(grid, '&#128268;', 'Pin Status', pinRows);

    // I2C card
    var i2c = d.i2c || {};
    if (i2c.device_count > 0) {
      var i2cRows = [];
      for (var di = 0; di < (i2c.devices || []).length; di++) {
        var dev = i2c.devices[di];
        i2cRows.push([dev.address, dev.device || 'Unknown', 'ok']);
      }
      addCard(grid, '&#128268;', 'I2C Bus (' + i2c.device_count + ' devices)', i2cRows);
    } else {
      addCard(grid, '&#128268;', 'I2C Bus', [['Devices', 'None found']]);
    }

    // WLED card
    if (d.wled) {
      addCard(grid, '&#127752;', 'WLED', [
        ['Host', d.wled.host],
        ['Reachable', d.wled.reachable ? 'YES' : 'NO', d.wled.reachable ? 'ok' : 'fail']
      ]);
    }

    // Race state card
    var race = d.race || {};
    addCard(grid, '&#127937;', 'Race State', [
      ['State', race.state || '?'],
      ['Dry Run', race.dry_run ? 'ON' : 'Off'],
      ['Total Runs', race.total_runs || 0],
      ['Current Car', race.current_car || '—']
    ]);

    // Show diagnostics panel
    document.getElementById('fgDiagnostics').style.display = 'block';
  }

  function addCard(grid, icon, title, rows) {
    var card = document.createElement('div'); card.className = 'diag-card';
    card.innerHTML = '<div class="diag-card-title"><span class="diag-icon">' + icon + '</span>' + title + '</div>';
    for (var i = 0; i < rows.length; i++) {
      card.innerHTML += diagRow(rows[i][0], rows[i][1], rows[i][2]);
    }
    grid.appendChild(card);
  }

  function diagRow(label, value, status) {
    var cls = status ? ' diag-' + status : '';
    var badge = '';
    if (status === 'ok') badge = ' <span class="diag-badge ok">OK</span>';
    else if (status === 'warn') badge = ' <span class="diag-badge warn">WARN</span>';
    else if (status === 'fail') badge = ' <span class="diag-badge fail">FAIL</span>';
    return '<div class="diag-row"><span class="diag-label">' + label + '</span><span class="diag-value' + cls + '">' + value + badge + '</span></div>';
  }

  function formatBytes(b) {
    if (!b && b !== 0) return '?';
    if (b < 1024) return b + ' B';
    if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
    return (b / 1048576).toFixed(1) + ' MB';
  }

  function formatMs(ms) {
    if (!ms && ms !== 0) return '?';
    if (ms < 1000) return ms + 'ms';
    if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
    if (ms < 3600000) return Math.floor(ms / 60000) + 'm ' + Math.floor((ms % 60000) / 1000) + 's';
    return Math.floor(ms / 3600000) + 'h ' + Math.floor((ms % 3600000) / 60000) + 'm';
  }

  /* ---- Battery Power Planner ---- */
  var battPresets = {
    '521521': { cap: 120, model: '521521', size: '2×15×23mm', weight: 3.5, maxDis: 0.12 },
    '501230': { cap: 150, model: '501230', size: '5×12×30mm', weight: 4.0, maxDis: 0.15 },
    '502030': { cap: 200, model: '502030', size: '5×20×30mm', weight: 5.5, maxDis: 0.20 },
    '602030': { cap: 300, model: '602030', size: '6×20×30mm', weight: 7.5, maxDis: 0.30 }
  };

  window.setBattPreset = function(cap, model, size, weight, maxDis) {
    document.getElementById('battCap').value = cap;
    document.getElementById('battMaxDis').value = maxDis;
    document.getElementById('battWeight').value = weight;
    // Highlight active preset
    var btns = document.querySelectorAll('.batt-preset');
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove('selected');
    // Find matching button
    var all = document.querySelectorAll('.batt-preset');
    for (var j = 0; j < all.length; j++) {
      if (all[j].textContent.indexOf(model) !== -1) all[j].classList.add('selected');
    }
    calcBattery();
  };

  window.calcBattery = function() {
    var cap = parseFloat(document.getElementById('battCap').value) || 0;
    var maxDis = parseFloat(document.getElementById('battMaxDis').value) || 0;
    var battW = parseFloat(document.getElementById('battWeight').value) || 0;
    var carW = parseFloat(document.getElementById('battCarWeight').value) || 0;

    // Power draw constants (mA) — configurable per MCU
    var mcuSel = document.getElementById('battMcu');
    var mcuType = mcuSel ? mcuSel.value : 'xiao-s3';
    var mcu = { active: 150, idle: 20, sleep: 0.5, weight: 2.5, name: 'XIAO ESP32-S3' };
    if (mcuType === 'xiao-mg24') {
      mcu = { active: 35, idle: 8, sleep: 0.002, weight: 2.5, name: 'XIAO MG24 Sense' };
    } else if (mcuType === 'xiao-wt901') {
      mcu = { active: 150, idle: 20, sleep: 0.5, weight: 2.5, name: 'XIAO ESP32-S3' };
    }
    var imuDraw = 12;  // BNO055 in NDOF mode (mA)
    var imuName = 'BNO055';
    if (mcuType === 'xiao-mg24') { imuDraw = 0.9; imuName = 'LSM6DS3TR-C'; } // built-in (mA)
    else if (mcuType === 'xiao-wt901') { imuDraw = 20; imuName = 'WT901'; } // Kalman AHRS (mA)
    var imuWeight = (mcuType === 'xiao-mg24') ? 0 : (mcuType === 'xiao-wt901' ? 1.0 : 3.5); // WT901=~1g, BNO055=~3.5g

    // Calculate runtimes
    var activeDraw = mcu.active + imuDraw;   // Full logging (mA)
    var idleDraw = mcu.idle + imuDraw;       // Idle polling (mA)
    var sleepDraw = mcu.sleep + 0.01;        // Deep sleep + wakeup circuit (mA)

    // Science fair scenario: 30% active (logging), 70% idle (between runs)
    var scienceFairDraw = (activeDraw * 0.3) + (idleDraw * 0.7);

    var continuousH = cap > 0 ? (cap / activeDraw) : 0;
    var scienceFairH = cap > 0 ? (cap / scienceFairDraw) : 0;
    var deepSleepH = cap > 0 ? (cap / sleepDraw) : 0;

    // Format runtime helpers
    function fmtTime(hours) {
      if (hours <= 0) return '--';
      if (hours < 1) return Math.round(hours * 60) + ' min';
      if (hours < 24) return hours.toFixed(1) + ' hr';
      return Math.round(hours / 24) + ' days';
    }
    function fmtSub(hours) {
      if (hours <= 0) return '';
      var mins = Math.round(hours * 60);
      if (mins < 60) return mins + ' minutes';
      var h = Math.floor(hours);
      var m = Math.round((hours - h) * 60);
      return h + 'h ' + m + 'm';
    }

    // Discharge safety
    var peakDraw = mcu.active * 1.2; // WiFi TX burst peak (mA) — conservative
    var peakDrawA = peakDraw / 1000;
    var dischargeOk = maxDis > 0 ? (peakDrawA <= maxDis) : false;
    var dischargeRatio = maxDis > 0 ? (peakDrawA / maxDis * 100) : 0;
    var dischargeStatus = 'good';
    if (dischargeRatio > 100) dischargeStatus = 'bad';
    else if (dischargeRatio > 80) dischargeStatus = 'warn';

    // Fill result cards
    var els = {
      sf: document.getElementById('battResSF'),
      cont: document.getElementById('battResCont'),
      sleep: document.getElementById('battResSleep'),
      dis: document.getElementById('battResDis')
    };
    if (els.sf) {
      els.sf.querySelector('.batt-card-value').textContent = fmtTime(scienceFairH);
      els.sf.querySelector('.batt-card-sub').textContent = fmtSub(scienceFairH) + ' @ ' + scienceFairDraw.toFixed(0) + 'mA avg';
      els.sf.className = 'batt-card' + (scienceFairH >= 3 ? ' good' : (scienceFairH >= 1 ? ' warn' : ' bad'));
    }
    if (els.cont) {
      els.cont.querySelector('.batt-card-value').textContent = fmtTime(continuousH);
      els.cont.querySelector('.batt-card-sub').textContent = fmtSub(continuousH) + ' @ ' + activeDraw.toFixed(0) + 'mA';
      els.cont.className = 'batt-card' + (continuousH >= 1 ? ' good' : (continuousH >= 0.5 ? ' warn' : ' bad'));
    }
    if (els.sleep) {
      els.sleep.querySelector('.batt-card-value').textContent = fmtTime(deepSleepH);
      els.sleep.querySelector('.batt-card-sub').textContent = sleepDraw.toFixed(2) + 'mA standby';
      els.sleep.className = 'batt-card good';
    }
    if (els.dis) {
      els.dis.querySelector('.batt-card-value').textContent = dischargeOk ? 'SAFE' : 'RISKY';
      els.dis.querySelector('.batt-card-sub').textContent = peakDraw.toFixed(0) + 'mA peak / ' + (maxDis * 1000).toFixed(0) + 'mA max';
      els.dis.className = 'batt-card ' + dischargeStatus;
    }

    // Weight budget
    var wiresW = 1.0;
    var totalW = mcu.weight + imuWeight + battW + wiresW;
    var totalWithCar = totalW + carW;
    var scaleLimit = 50;
    var pct = Math.min(100, (totalWithCar / scaleLimit) * 100);

    var wGrid = document.getElementById('battWeightGrid');
    if (wGrid) {
      wGrid.innerHTML =
        '<div class="batt-weight-row"><span>MCU (' + mcu.name + ')</span><span>' + mcu.weight.toFixed(1) + 'g</span></div>' +
        (imuWeight > 0 ? '<div class="batt-weight-row"><span>IMU (' + imuName + ')</span><span>' + imuWeight.toFixed(1) + 'g</span></div>' : '') +
        '<div class="batt-weight-row"><span>Battery</span><span>' + battW.toFixed(1) + 'g</span></div>' +
        '<div class="batt-weight-row"><span>Wires / mount</span><span>' + wiresW.toFixed(1) + 'g</span></div>' +
        '<div class="batt-weight-row" style="border-top:1px solid var(--border);padding-top:6px;font-weight:700"><span>Telemetry Package</span><span>' + totalW.toFixed(1) + 'g</span></div>' +
        (carW > 0 ? '<div class="batt-weight-row"><span>+ Car</span><span>' + carW.toFixed(1) + 'g</span></div>' +
        '<div class="batt-weight-row" style="font-weight:700;color:var(--gold)"><span>Total on Scale</span><span>' + totalWithCar.toFixed(1) + 'g / ' + scaleLimit + 'g</span></div>' : '');
    }

    // Progress bar
    var barWrap = document.getElementById('battWeightBar');
    if (barWrap) {
      var fill = barWrap.querySelector('.batt-bar-fill');
      if (fill) {
        fill.style.width = pct + '%';
        fill.style.background = pct < 70 ? 'var(--accent)' : (pct < 90 ? '#f5a623' : '#e74c3c');
      }
      var label = barWrap.querySelector('.batt-bar-label');
      if (label) label.textContent = totalWithCar.toFixed(1) + 'g / ' + scaleLimit + 'g (' + pct.toFixed(0) + '%)';
    }

    // Verdict
    var verdict = document.getElementById('battVerdict');
    if (verdict) {
      var good = scienceFairH >= 2 && dischargeOk && totalWithCar <= scaleLimit;
      var ok = scienceFairH >= 1 && totalWithCar <= scaleLimit;
      if (cap <= 0) {
        verdict.className = 'batt-verdict';
        verdict.innerHTML = '&#9889; Enter battery specs above to see your verdict';
      } else if (good) {
        verdict.className = 'batt-verdict good';
        verdict.innerHTML = '&#9989; <strong>GO FOR LAUNCH</strong> — ' + fmtTime(scienceFairH) + ' runtime, ' + totalW.toFixed(1) + 'g package weight. This battery works.';
      } else if (ok) {
        verdict.className = 'batt-verdict warn';
        var issues = [];
        if (!dischargeOk) issues.push('discharge rate is tight — use ESP-NOW only, never WiFi.begin()');
        if (scienceFairH < 2) issues.push('runtime is short — keep deep sleep aggressive');
        verdict.innerHTML = '&#9888;&#65039; <strong>PROCEED WITH CAUTION</strong> — ' + issues.join('; ') + '.';
      } else {
        verdict.className = 'batt-verdict bad';
        var problems = [];
        if (totalWithCar > scaleLimit) problems.push('over 50g scale limit by ' + (totalWithCar - scaleLimit).toFixed(1) + 'g');
        if (scienceFairH < 1) problems.push('runtime under 1 hour — battery too small');
        if (!dischargeOk) problems.push('peak draw exceeds max discharge — risk of voltage sag / brownout');
        verdict.innerHTML = '&#10060; <strong>NO GO</strong> — ' + problems.join('; ') + '.';
      }
    }
  };

  /* ---- Telemetry Tier Selector ---- */
  window.setTelemetryTier = function(tier) {
    // Update tier buttons
    var btns = ['btnTierStreet', 'btnTierForensic', 'btnTierLab'];
    for (var i = 0; i < btns.length; i++) {
      var btn = document.getElementById(btns[i]);
      if (!btn) continue;
      btn.classList.remove('tier-active');
      btn.style.background = 'var(--navy-card)';
      btn.style.color = 'var(--text-muted)';
      btn.style.borderColor = 'var(--gold-dim)';
    }
    var activeBtn = document.getElementById(
      tier === 'street' ? 'btnTierStreet' : (tier === 'lab' ? 'btnTierLab' : 'btnTierForensic')
    );
    if (activeBtn) {
      activeBtn.classList.add('tier-active');
      activeBtn.style.background = 'var(--navy-light)';
      activeBtn.style.color = 'var(--gold)';
      activeBtn.style.borderColor = 'var(--gold)';
    }

    // Map tier → MCU radio value & select it
    var mcuVal = 'xiao-s3';
    if (tier === 'street') mcuVal = 'xiao-mg24';
    else if (tier === 'lab') mcuVal = 'xiao-wt901';
    var radios = document.getElementsByName('battMcuRadio');
    for (var r = 0; r < radios.length; r++) {
      radios[r].checked = (radios[r].value === mcuVal);
    }
    var hidden = document.getElementById('battMcu');
    if (hidden) hidden.value = mcuVal;

    // Update wiring guide title
    var guideTitle = document.querySelector('#guide-telemetry .wg-title h2');
    var guideDesc = document.querySelector('#guide-telemetry .wg-title p');
    if (tier === 'street') {
      if (guideTitle) guideTitle.textContent = 'Tier 1: XIAO MG24 Sense (Built-in IMU)';
      if (guideDesc) guideDesc.textContent = 'No external IMU needed \u2014 the MG24 Sense has a 6-axis LSM6DS3TR-C on board. Just flash and ride.';
    } else if (tier === 'lab') {
      if (guideTitle) guideTitle.textContent = 'Tier 3: XIAO ESP32-S3 + WitMotion WT901';
      if (guideDesc) guideDesc.textContent = '200Hz Kalman-filtered AHRS with \u00b10.05\u00b0 static accuracy. UART interface \u2014 4 wires: VCC, GND, TX, RX.';
    } else {
      if (guideTitle) guideTitle.textContent = 'Tier 2: XIAO ESP32-S3 + BNO055';
      if (guideDesc) guideDesc.textContent = '9-axis IMU with hardware sensor fusion. I2C interface \u2014 4 wires. The recommended build for science fair.';
    }

    // Update parts list names (step cards remain — wiring is 4 wires for all tiers with external IMU)
    var partNameEls = document.querySelectorAll('#guide-telemetry .part-name');
    for (var p = 0; p < partNameEls.length; p++) {
      var txt = partNameEls[p].textContent;
      if (txt.indexOf('BNO055') !== -1 || txt.indexOf('WT901') !== -1 || txt.indexOf('LSM6DS3') !== -1) {
        if (tier === 'street') {
          partNameEls[p].textContent = 'Built-in LSM6DS3TR-C 6-Axis IMU';
          partNameEls[p].nextElementSibling.textContent = 'Already on the MG24 Sense board \u2014 no external sensor to wire.';
        } else if (tier === 'lab') {
          partNameEls[p].textContent = 'WitMotion WT901 9-Axis AHRS Module';
          partNameEls[p].nextElementSibling.textContent = 'MPU9250 + 48MHz Kalman fusion processor. UART output up to 200Hz. 15.24\u00d715.24\u00d72mm, ~1g.';
        } else {
          partNameEls[p].textContent = 'Adafruit BNO055 9-DOF IMU Breakout';
          partNameEls[p].nextElementSibling.textContent = 'Accelerometer + gyroscope + magnetometer with onboard sensor fusion. I2C interface.';
        }
      }
      if (txt.indexOf('XIAO ESP32-S3') !== -1 || txt.indexOf('XIAO MG24') !== -1) {
        if (tier === 'street') {
          partNameEls[p].textContent = 'Seeed Studio XIAO MG24 Sense';
          partNameEls[p].nextElementSibling.textContent = 'Silicon Labs EFR32MG24, BLE 5.3/Thread/Zigbee. Built-in 6-axis IMU. Ultra-low power (1.95\u00b5A sleep).';
        } else {
          partNameEls[p].textContent = 'Seeed Studio XIAO ESP32-S3';
          partNameEls[p].nextElementSibling.textContent = 'Dual-core WiFi MCU. Tiny enough to ride on a Hot Wheels car.';
        }
      }
    }

    // Update connection table for tier
    var connBody = document.querySelector('#guide-telemetry .conn-table tbody');
    if (connBody) {
      if (tier === 'street') {
        connBody.innerHTML =
          '<tr><td colspan="4" style="text-align:center;color:var(--gold);font-style:italic;padding:16px">No external wiring needed \u2014 IMU is built into the MG24 Sense board.</td></tr>';
      } else if (tier === 'lab') {
        connBody.innerHTML =
          '<tr><td><span class="wire-dot" style="background:var(--wire-red)"></span>Red</td><td><strong>3V3</strong></td><td><strong>VCC</strong></td><td>3.3V Power</td></tr>' +
          '<tr><td><span class="wire-dot" style="background:var(--wire-black);border:1px solid #666"></span>Black</td><td><strong>GND</strong></td><td><strong>GND</strong></td><td>Ground</td></tr>' +
          '<tr><td><span class="wire-dot" style="background:var(--wire-green)"></span>Green</td><td><strong>D6</strong> (GPIO 43 TX)</td><td><strong>RX</strong></td><td>UART Receive (XIAO TX \u2192 WT901 RX)</td></tr>' +
          '<tr><td><span class="wire-dot" style="background:var(--wire-orange)"></span>Orange</td><td><strong>D7</strong> (GPIO 44 RX)</td><td><strong>TX</strong></td><td>UART Transmit (WT901 TX \u2192 XIAO RX)</td></tr>';
      } else {
        connBody.innerHTML =
          '<tr><td><span class="wire-dot" style="background:var(--wire-red)"></span>Red</td><td><strong>3V3</strong></td><td><strong>VIN</strong></td><td>3.3V Power</td></tr>' +
          '<tr><td><span class="wire-dot" style="background:var(--wire-black);border:1px solid #666"></span>Black</td><td><strong>GND</strong></td><td><strong>GND</strong></td><td>Ground</td></tr>' +
          '<tr><td><span class="wire-dot" style="background:var(--wire-blue)"></span>Blue</td><td><strong>D4</strong> (GPIO 5)</td><td><strong>SDA</strong></td><td>I2C Data</td></tr>' +
          '<tr><td><span class="wire-dot" style="background:var(--wire-yellow)"></span>Yellow</td><td><strong>D5</strong> (GPIO 6)</td><td><strong>SCL</strong></td><td>I2C Clock</td></tr>';
      }
    }

    // Show/hide WT901 info box
    var wt901Box = document.getElementById('wt901Info');
    if (wt901Box) wt901Box.style.display = (tier === 'lab') ? 'block' : 'none';

    // For street tier, hide the step cards (no wiring needed) and show a message
    var stepCards = document.querySelectorAll('#guide-telemetry .step-card');
    for (var s = 0; s < stepCards.length; s++) {
      stepCards[s].style.display = (tier === 'street') ? 'none' : '';
    }

    // Update step card labels for lab tier (UART vs I2C)
    if (tier === 'lab') {
      var titles = [
        ['Connect Power (3.3V)', 'Red wire: XIAO 3V3 \u2192 WT901 VCC'],
        ['Connect Ground', 'Black wire: XIAO GND \u2192 WT901 GND'],
        ['Connect UART TX \u2192 RX', 'Green wire: XIAO D6 (TX) \u2192 WT901 RX'],
        ['Connect UART RX \u2190 TX', 'Orange wire: WT901 TX \u2192 XIAO D7 (RX)']
      ];
      for (var t = 0; t < stepCards.length && t < titles.length; t++) {
        var titleEl = stepCards[t].querySelector('.step-title');
        var subEl = stepCards[t].querySelector('.step-subtitle');
        if (titleEl) titleEl.textContent = titles[t][0];
        if (subEl) subEl.textContent = titles[t][1];
      }
    } else if (tier === 'forensic') {
      var bnoTitles = [
        ['Connect Power (3.3V)', 'Red wire: XIAO 3V3 \u2192 BNO055 VIN'],
        ['Connect Ground', 'Black wire: XIAO GND \u2192 BNO055 GND'],
        ['Connect I2C Data (SDA)', 'Blue wire: XIAO D4 (GPIO 5) \u2192 BNO055 SDA'],
        ['Connect I2C Clock (SCL)', 'Yellow wire: XIAO D5 (GPIO 6) \u2192 BNO055 SCL']
      ];
      for (var u = 0; u < stepCards.length && u < bnoTitles.length; u++) {
        var titleEl2 = stepCards[u].querySelector('.step-title');
        var subEl2 = stepCards[u].querySelector('.step-subtitle');
        if (titleEl2) titleEl2.textContent = bnoTitles[u][0];
        if (subEl2) subEl2.textContent = bnoTitles[u][1];
      }
    }

    // Recalculate battery with new MCU
    calcBattery();
  };

  /* ---- Module switcher ---- */
  window.showModule = function(moduleId) {
    if (!modules[moduleId]) return;
    activeModule = moduleId;
    // Hide all guides
    var guides = document.querySelectorAll('.wiring-guide');
    for (var i = 0; i < guides.length; i++) {
      guides[i].classList.remove('visible');
    }
    // Show selected
    var guide = document.getElementById('guide-' + moduleId);
    if (guide) {
      guide.classList.add('visible');
      setTimeout(function() { guide.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
    }
    // Show/hide diagnostics panel (only for finish gate)
    var diagPanel = document.getElementById('fgDiagnostics');
    if (diagPanel) diagPanel.style.display = (moduleId === 'finish') ? 'block' : 'none';
    // Update module cards
    var allCards = document.querySelectorAll('.module-card');
    for (var j = 0; j < allCards.length; j++) {
      allCards[j].classList.remove('active');
    }
    // Find the card that has onclick matching this module
    var cards = document.querySelectorAll('.module-card');
    for (var k = 0; k < cards.length; k++) {
      var onclick = cards[k].getAttribute('onclick') || '';
      if (onclick.indexOf("'" + moduleId + "'") !== -1) {
        cards[k].classList.add('active');
      }
    }
  };

  /* ---- Restore saved state ---- */
  function restoreModule(modId) {
    var mod = modules[modId];
    if (!mod) return;
    try {
      var saved = localStorage.getItem(mod.storageKey);
      if (saved) {
        state[modId] = JSON.parse(saved);
        for (var n in state[modId]) {
          if (state[modId].hasOwnProperty(n)) {
            var card = document.getElementById(mod.prefix + n);
            if (card) {
              card.classList.add('completed');
              card.classList.remove('active');
              var num = card.querySelector('.step-number');
              if (num) num.textContent = '\u2713';
            }
          }
        }
        updateModuleProgress(modId);
      }
    } catch(e) {}
  }

  function init() {
    // Restore all modules
    for (var modId in modules) {
      if (modules.hasOwnProperty(modId)) {
        if (!state[modId]) state[modId] = {};
        restoreModule(modId);
      }
    }
    // Restore finish gate tier
    try {
      var savedTier = localStorage.getItem('mass_wizard_finish_tier');
      if (savedTier) setFinishTier(savedTier);
    } catch(e) {}
    // Restore diagnostics IP
    try {
      var savedIP = localStorage.getItem('mass_wizard_diag_ip');
      if (savedIP) document.getElementById('diagIP').value = savedIP;
    } catch(e) {}
    // Show diagnostics panel if finish guide is visible
    var fgGuide = document.getElementById('guide-finish');
    if (fgGuide && fgGuide.classList.contains('visible')) {
      document.getElementById('fgDiagnostics').style.display = 'block';
    }
    // Initialize battery calculator with default values
    if (typeof calcBattery === 'function') calcBattery();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

</body>
</html>
