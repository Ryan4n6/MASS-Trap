<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="color-scheme" content="dark">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://i.ibb.co https://api.qrserver.com; connect-src 'self' ws: wss:; frame-ancestors 'none';">
  <meta name="fw-version" content="2.4.0">
  <title>M.A.S.S. Trap Command Center</title>
  <style>
    /* ===== VARIABLES ===== */
    :root {
      --mass-navy: #1a1a2e;
      --mass-gold: #d4af37;
      --mass-blue: #4a90d9;
      --mass-green: #28a745;
      --mass-red: #dc3545;
      --mass-dark: #0f0f1e;
      --mass-card: #16213e;
      --mass-card-border: #2a2a4a;
      --mass-text: #e0e0e0;
      --mass-muted: #8888aa;
    }

    /* ===== RESET & BASE ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--mass-navy);
      min-height: 100vh;
      padding: 15px;
      color: var(--mass-text);
    }

    .container { max-width: 1200px; margin: 0 auto; }

    /* ===== HEADER ===== */
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px 0;
    }

    .header-shield {
      display: inline-block;
      width: 60px; height: 70px;
      background: var(--mass-gold);
      clip-path: polygon(50% 0%, 100% 15%, 100% 65%, 50% 100%, 0% 65%, 0% 15%);
      margin-bottom: 10px;
      position: relative;
    }
    .header-shield::after {
      content: 'M';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--mass-navy);
    }

    .header h1 {
      font-size: 2.8rem;
      font-weight: 900;
      letter-spacing: 4px;
      color: var(--mass-gold);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      margin: 0;
    }

    .header .subtitle {
      font-size: 0.9rem;
      letter-spacing: 6px;
      color: var(--mass-muted);
      text-transform: uppercase;
      margin-top: 4px;
    }

    .header .tagline {
      font-weight: bold;
      color: var(--mass-blue);
      margin-top: 8px;
      font-size: 1.1rem;
      letter-spacing: 2px;
    }

    /* ===== SETTINGS LINK ===== */
    .settings-link {
      position: fixed;
      top: 10px;
      background: rgba(0,0,0,0.8);
      color: var(--mass-gold);
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 1.2rem;
      z-index: 1000;
      border: 2px solid var(--mass-card-border);
    }
    .settings-link:hover { background: var(--mass-card); }

    /* Version Badge */
    .version-badge {
      position: fixed;
      bottom: 8px; right: 8px;
      background: rgba(0,0,0,0.7);
      color: var(--mass-muted);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      z-index: 1000;
      font-family: monospace;
    }

    /* ===== CONNECTION STATUS ===== */
    .connection-status {
      position: fixed;
      top: 10px; right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      z-index: 1000;
      border: 2px solid var(--mass-card-border);
    }
    .connection-status.connected { border-color: var(--mass-green); color: var(--mass-green); }
    .connection-status.disconnected { border-color: var(--mass-red); color: var(--mass-red); }

    /* ===== STATE BANNER ===== */
    .state-banner {
      background: var(--mass-dark);
      color: var(--mass-muted);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      font-size: 2rem;
      font-weight: 900;
      border: 3px solid var(--mass-card-border);
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 4px;
      transition: all 0.3s;
    }
    .state-banner.idle { border-color: var(--mass-gold); color: var(--mass-gold); }
    .state-banner.armed {
      background: #1a3a1a;
      border-color: var(--mass-green);
      color: var(--mass-green);
      animation: pulse 1s infinite;
    }
    .state-banner.racing {
      background: #3a1a1a;
      border-color: var(--mass-red);
      color: var(--mass-red);
      animation: flash 0.5s infinite;
    }
    .state-banner.finished {
      background: var(--mass-dark);
      border-color: var(--mass-gold);
      color: var(--mass-gold);
    }

    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    @keyframes flash { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

    /* ===== CARDS & GRID ===== */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--mass-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--mass-card-border);
      border-bottom: 3px solid var(--mass-blue);
    }

    .card-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--mass-muted);
      font-weight: 800;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }

    .card-value {
      font-size: 2.5rem;
      color: var(--mass-blue);
      font-weight: 900;
      line-height: 1;
      font-family: 'Courier New', monospace;
    }

    .card-unit {
      font-size: 1rem;
      color: var(--mass-muted);
      font-weight: normal;
      margin-left: 4px;
    }

    /* ===== BUTTONS ===== */
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 900;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 0 rgba(0,0,0,0.3);
      transition: all 0.1s;
      width: 100%;
      margin-bottom: 10px;
    }
    .btn:active { transform: translateY(4px); box-shadow: none; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--mass-blue); color: white; }
    .btn-success { background: var(--mass-green); color: white; }
    .btn-warning { background: var(--mass-gold); color: var(--mass-navy); }
    .btn-danger { background: var(--mass-red); color: white; }

    /* ===== LIDAR STAGED INDICATOR ===== */
    .lidar-indicator {
      display: none;
      text-align: center;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      font-weight: 900;
      font-size: 0.85rem;
      letter-spacing: 2px;
    }
    .lidar-indicator.staged {
      display: block;
      background: #1a3a1a;
      border: 2px solid var(--mass-green);
      color: var(--mass-green);
      animation: pulse 1.5s infinite;
    }

    /* ===== GARAGE ===== */
    .garage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .garage-car {
      background: var(--mass-card);
      border: 2px solid var(--mass-card-border);
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .garage-car:hover {
      border-color: var(--mass-blue);
      transform: translateY(-4px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    .garage-car.active {
      border-color: var(--mass-gold);
      background: #1e2a45;
      border-width: 3px;
    }
    .garage-car h3 { font-size: 1.1rem; margin-bottom: 8px; color: var(--mass-gold); }
    .garage-car p { font-size: 0.9rem; color: var(--mass-muted); margin: 4px 0; }
    .garage-stats {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--mass-card-border);
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--mass-muted);
    }
    .delete-btn, .edit-btn {
      position: absolute;
      top: 8px;
      color: white;
      width: 24px; height: 24px;
      border-radius: 50%;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .delete-btn { right: 8px; background: var(--mass-red); }
    .edit-btn { right: 36px; background: var(--mass-blue); }

    /* ===== INPUTS ===== */
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--mass-card-border);
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 10px;
      font-family: inherit;
      background: var(--mass-dark);
      color: var(--mass-text);
    }
    input:focus, select:focus { outline: none; border-color: var(--mass-gold); }

    /* ===== SECTION BOX ===== */
    .section {
      background: var(--mass-card);
      border: 2px solid var(--mass-card-border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      position: relative;
    }
    .section-title {
      position: absolute;
      top: -16px; left: 20px;
      background: var(--mass-gold);
      color: var(--mass-navy);
      padding: 6px 18px;
      border-radius: 20px;
      font-weight: 900;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ===== LED VISUALIZER BAR ===== */
    .led-visualizer {
      height: 8px;
      width: 100%;
      border-radius: 4px;
      margin-bottom: 15px;
      background: #333;
      box-shadow: 0 0 10px rgba(0,0,0,0.5) inset;
      transition: all 0.3s;
    }
    .led-visualizer.idle {
      background: var(--mass-gold);
      box-shadow: 0 0 15px var(--mass-gold);
      animation: breathe 3s infinite ease-in-out;
    }
    .led-visualizer.armed {
      background: var(--mass-green);
      box-shadow: 0 0 20px var(--mass-green);
      animation: pulse-fast 0.5s infinite;
    }
    .led-visualizer.racing {
      background: linear-gradient(90deg, transparent 0%, var(--mass-red) 50%, transparent 100%);
      background-size: 200% 100%;
      animation: chase 0.5s infinite linear;
    }
    .led-visualizer.finished {
      background: linear-gradient(90deg, var(--mass-gold), var(--mass-blue), var(--mass-gold));
      background-size: 400% 100%;
      animation: rainbow-flow 2s infinite linear;
      box-shadow: 0 0 20px rgba(212,175,55,0.5);
    }
    @keyframes breathe { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
    @keyframes pulse-fast { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    @keyframes chase { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes rainbow-flow { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

    /* ===== MOST WANTED — Criminal Leaderboard ===== */
    .most-wanted {
      position: relative;
      border-color: var(--mass-red);
      border-width: 2px;
    }
    .most-wanted .section-title {
      background: var(--mass-red);
      color: white;
      letter-spacing: 2px;
    }
    .mw-board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      padding-top: 12px;
    }
    .mw-card {
      background: var(--mass-dark);
      border: 2px solid var(--mass-card-border);
      border-radius: 10px;
      padding: 15px;
      position: relative;
      transition: all 0.3s;
    }
    .mw-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
    }
    .mw-card.rank-1 {
      border-color: var(--mass-gold);
      box-shadow: 0 0 15px rgba(212,175,55,0.3);
    }
    .mw-card.rank-2, .mw-card.rank-3 {
      border-color: var(--mass-blue);
    }
    .mw-rank {
      position: absolute;
      top: -10px; left: 12px;
      background: var(--mass-red);
      color: white;
      font-weight: 900;
      font-size: 0.75rem;
      padding: 3px 10px;
      border-radius: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .mw-card.rank-1 .mw-rank { background: var(--mass-gold); color: var(--mass-navy); }
    .mw-card.rank-2 .mw-rank, .mw-card.rank-3 .mw-rank { background: var(--mass-blue); }
    .mw-name {
      font-size: 1.2rem;
      font-weight: 900;
      color: var(--mass-gold);
      margin-top: 6px;
      margin-bottom: 8px;
    }
    .mw-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--mass-muted);
    }
    .mw-stats strong {
      color: var(--mass-text);
      font-family: 'Courier New', monospace;
    }
    .mw-threat {
      margin-top: 10px;
      padding: 4px 10px;
      border-radius: 4px;
      font-weight: 900;
      font-size: 0.7rem;
      text-align: center;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .mw-threat.armed-dangerous {
      background: rgba(220,53,69,0.2);
      border: 1px solid var(--mass-red);
      color: var(--mass-red);
    }
    .mw-threat.known-offender {
      background: rgba(212,175,55,0.15);
      border: 1px solid var(--mass-gold);
      color: var(--mass-gold);
    }
    .mw-threat.person-of-interest {
      background: rgba(136,136,170,0.1);
      border: 1px solid var(--mass-muted);
      color: var(--mass-muted);
    }
    .mw-empty {
      text-align: center;
      padding: 30px;
      color: var(--mass-muted);
      font-style: italic;
    }
    .mw-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 5px;
      margin-bottom: 4px;
    }
    .mw-toggle {
      font-size: 0.8rem;
      color: var(--mass-gold);
      cursor: pointer;
      font-weight: bold;
    }
    .mw-sort-controls {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }
    .mw-sort-btn {
      padding: 4px 10px;
      border: 1px solid var(--mass-card-border);
      border-radius: 4px;
      background: var(--mass-dark);
      color: var(--mass-muted);
      font-size: 0.7rem;
      font-weight: 800;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .mw-sort-btn.active {
      border-color: var(--mass-gold);
      color: var(--mass-gold);
    }
    @keyframes mw-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
    .mw-new-record { animation: mw-pulse 1s ease-in-out 3; }

    /* ===== SPEED PROFILE (mid-track) ===== */
    .speed-profile {
      display: none;
      padding: 10px 0;
    }
    .speed-profile.visible { display: block; }
    .speed-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    .speed-bar-label {
      width: 80px;
      font-size: 0.75rem;
      color: var(--mass-muted);
      text-align: right;
      text-transform: uppercase;
    }
    .speed-bar-fill {
      flex: 1;
      height: 20px;
      background: var(--mass-dark);
      border-radius: 4px;
      overflow: hidden;
    }
    .speed-bar-fill div {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s;
    }

    /* ===== GHOST CAR ===== */
    #ghostSection { display: none; }
    #ghostSection.new-record { border-color: var(--mass-green); }
    #ghostSection.new-record .section-title { background: var(--mass-green); color: white; }
    #ghostSection.slower { border-color: var(--mass-red); }
    #ghostSection.slower .section-title { background: var(--mass-red); color: white; }

    /* ===== LEADERBOARD OVERLAY ===== */
    .leaderboard-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .leaderboard-overlay.show { display: flex; animation: fadeIn 0.3s; }
    .leaderboard-card {
      background: var(--mass-card);
      border: 3px solid var(--mass-gold);
      border-radius: 16px;
      padding: 30px 40px;
      text-align: center;
      max-width: 400px;
      animation: slideUp 0.5s;
    }
    .leaderboard-rank {
      font-size: 4rem;
      font-weight: 900;
      color: var(--mass-gold);
      line-height: 1;
    }
    .leaderboard-text {
      font-size: 1.2rem;
      color: var(--mass-text);
      margin: 10px 0;
    }
    .leaderboard-detail {
      font-size: 0.9rem;
      color: var(--mass-muted);
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* ===== CHARTS ===== */
    #chartsSection canvas { max-width: 100%; background: var(--mass-dark); border-radius: 8px; padding: 5px; }

    /* ===== PHYSICS EXPLAINER ===== */
    .formula-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      padding-top: 15px;
    }
    .formula-card {
      background: var(--mass-dark);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--mass-card-border);
    }
    .formula-title { font-weight: 900; text-transform: uppercase; color: var(--mass-blue); font-size: 0.85rem; margin-bottom: 10px; }
    .formula-eq { font-size: 1.8rem; font-weight: 900; color: var(--mass-gold); font-family: 'Georgia', serif; margin-bottom: 8px; }
    .formula-desc { font-size: 0.8rem; color: var(--mass-muted); margin-bottom: 12px; }
    .formula-values {
      background: var(--mass-card);
      border-radius: 6px;
      padding: 10px;
      font-family: monospace;
      font-size: 0.9rem;
      color: var(--mass-green);
      font-weight: bold;
      min-height: 2.5em;
    }

    /* ===== TABLE ===== */
    table { width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
    thead { background: var(--mass-dark); color: var(--mass-gold); }
    th, td { padding: 12px; text-align: left; }
    tbody tr { border-bottom: 1px solid var(--mass-card-border); }
    tbody tr:hover { background: rgba(74,144,217,0.1); }

    /* ===== MECHANIC LOG ===== */
    .mech-notes { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--mass-card-border); }
    .mech-note { font-size: 0.75rem; color: var(--mass-muted); margin: 2px 0; }
    .mech-note-input {
      width: calc(100% - 60px);
      padding: 4px 6px;
      font-size: 0.75rem;
      display: inline-block;
      margin-top: 4px;
    }
    .mech-add-btn {
      width: 50px;
      padding: 4px;
      font-size: 0.7rem;
      display: inline-block;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header h1 { font-size: 2rem; letter-spacing: 2px; }
      .grid { grid-template-columns: repeat(2, 1fr); }
      .garage-grid { grid-template-columns: 1fr; }
      .mw-board { grid-template-columns: 1fr; }
      .mw-sort-controls { flex-wrap: wrap; }
      .mw-header { flex-direction: column; gap: 8px; align-items: flex-start; }
      #chartsSection .grid { grid-template-columns: 1fr; }
      .formula-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Settings & Console Links -->
    <a href="/config" class="settings-link" title="Device Settings" style="left:10px;">&#x2699;</a>
    <a href="/console" class="settings-link" title="Debug Console" style="left:52px; border-color:var(--mass-green);">&#x1F4DF;</a>

    <!-- Connection Status -->
    <div id="connection" class="connection-status disconnected">Disconnected</div>

    <!-- Header -->
    <div class="header">
      <div class="header-shield"></div>
      <h1>M.A.S.S. TRAP</h1>
      <div class="subtitle">Motion Analysis &amp; Speed System</div>
      <div class="tagline">COMMAND CENTER</div>
    </div>

    <!-- State Banner -->
    <div id="stateBanner" class="state-banner">INITIALIZING...</div>

    <!-- LED Visualizer Bar -->
    <div id="ledBar" class="led-visualizer"></div>

    <!-- LiDAR Sensor Indicator -->
    <div id="lidarIndicator" class="lidar-indicator"></div>

    <!-- Quick Actions -->
    <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
      <button id="btnArm" class="btn btn-success" onclick="armRace()">ARM SYSTEM</button>
      <button id="btnReset" class="btn btn-warning" onclick="resetRace()">RESET</button>
      <button id="btnSync" class="btn btn-primary" onclick="syncClock()">SYNC CLOCK</button>
    </div>

    <!-- Live Stats -->
    <div class="grid">
      <div class="card">
        <div class="card-label">Time</div>
        <div><span id="statTime" class="card-value">--</span><span class="card-unit">s</span></div>
      </div>
      <div class="card">
        <div class="card-label">Real Speed</div>
        <div><span id="statSpeed" class="card-value">--</span><span class="card-unit">mph</span></div>
      </div>
      <div class="card" style="border-bottom-color: var(--mass-gold);">
        <div class="card-label" id="scaleLabel">Scale Speed (1:64)</div>
        <div><span id="statScale" class="card-value" style="color: var(--mass-gold);">--</span><span class="card-unit">mph</span></div>
      </div>
    </div>

    <!-- Physics -->
    <div class="grid">
      <div class="card">
        <div class="card-label">Momentum</div>
        <div><span id="statMomentum" class="card-value">--</span><span class="card-unit">kg*m/s</span></div>
      </div>
      <div class="card">
        <div class="card-label">Kinetic Energy</div>
        <div><span id="statKE" class="card-value">--</span><span class="card-unit">J</span></div>
      </div>
      <div class="card">
        <div class="card-label">Total Runs</div>
        <div><span id="statRuns" class="card-value">0</span></div>
      </div>
    </div>

    <!-- ===== MOST WANTED — Criminal Leaderboard ===== -->
    <div class="section most-wanted" id="mostWantedSection">
      <div class="section-title">MOST WANTED</div>
      <div class="mw-header">
        <div class="mw-sort-controls">
          <button class="mw-sort-btn active" onclick="sortMostWanted('time')" id="mwSortTime">Fastest</button>
          <button class="mw-sort-btn" onclick="sortMostWanted('speed')" id="mwSortSpeed">Top Speed</button>
          <button class="mw-sort-btn" onclick="sortMostWanted('runs')" id="mwSortRuns">Most Offenses</button>
          <button class="mw-sort-btn" onclick="sortMostWanted('ke')" id="mwSortKe">Most Dangerous</button>
        </div>
        <span class="mw-toggle" onclick="toggleMostWanted()" id="mwToggle">Collapse &#x25B2;</span>
      </div>
      <div id="mwBoard" class="mw-board">
        <div class="mw-empty">No suspects in the system. Add cars to the garage and run races to populate the Most Wanted list.</div>
      </div>
    </div>

    <!-- Speed Profile (mid-track data from speed trap) -->
    <div id="speedProfileSection" class="section speed-profile">
      <div class="section-title">SPEED PROFILE</div>
      <div style="padding-top:8px;">
        <div class="speed-bar">
          <div class="speed-bar-label">Finish</div>
          <div class="speed-bar-fill"><div id="speedBarFinish" style="width:0; background:var(--mass-gold);"></div></div>
          <span id="speedValFinish" style="font-family:monospace; font-size:0.85rem; width:70px;">-- mph</span>
        </div>
        <div class="speed-bar">
          <div class="speed-bar-label">Mid-Track</div>
          <div class="speed-bar-fill"><div id="speedBarMid" style="width:0; background:var(--mass-blue);"></div></div>
          <span id="speedValMid" style="font-family:monospace; font-size:0.85rem; width:70px;">-- mph</span>
        </div>
      </div>
    </div>

    <!-- Ghost Car Comparison -->
    <div id="ghostSection" class="section">
      <div class="section-title">VS PERSONAL BEST</div>
      <div style="text-align:center; padding:15px;">
        <div id="ghostDelta" style="font-size:3rem; font-weight:900; line-height:1.2;"></div>
        <div id="ghostLabel" style="font-size:1rem; color:var(--mass-muted); margin-top:8px;"></div>
      </div>
    </div>

    <!-- Science Fair Charts -->
    <div class="section" id="chartsSection">
      <div class="section-title">EVIDENCE LAB</div>
      <div class="grid" style="grid-template-columns: 1fr 1fr; margin-top:10px;">
        <div><canvas id="speedChart" height="250"></canvas></div>
        <div><canvas id="keChart" height="250"></canvas></div>
      </div>
    </div>

    <!-- Physics Explainer -->
    <div class="section" id="physicsExplainer">
      <div class="section-title">FORENSIC ANALYSIS</div>
      <div id="explainerToggle" onclick="toggleExplainer()" style="text-align:center; cursor:pointer; padding:8px; color:var(--mass-gold); font-weight:bold;">
        Show Formulas &#x25BC;
      </div>
      <div id="explainerContent" style="display:none;">
        <div class="formula-grid">
          <div class="formula-card">
            <div class="formula-title">SPEED (Velocity)</div>
            <div class="formula-eq">v = d / t</div>
            <div class="formula-desc">velocity = distance &divide; time</div>
            <div id="formulaSpeed" class="formula-values">Run a race to see values!</div>
          </div>
          <div class="formula-card">
            <div class="formula-title">MOMENTUM</div>
            <div class="formula-eq">p = m &times; v</div>
            <div class="formula-desc">momentum = mass &times; velocity</div>
            <div id="formulaMomentum" class="formula-values">Run a race to see values!</div>
          </div>
          <div class="formula-card">
            <div class="formula-title">KINETIC ENERGY</div>
            <div class="formula-eq">KE = &frac12; m v&sup2;</div>
            <div class="formula-desc">kinetic energy = one half &times; mass &times; velocity squared</div>
            <div id="formulaKE" class="formula-values">Run a race to see values!</div>
          </div>
          <div class="formula-card">
            <div class="formula-title">G-FORCE</div>
            <div class="formula-eq">a = v / t</div>
            <div class="formula-desc">acceleration = velocity &divide; time, then &divide; 9.8 for G's</div>
            <div id="formulaGForce" class="formula-values">Run a race to see values!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Garage -->
    <div class="section">
      <div class="section-title">THE GARAGE</div>
      <div class="grid" style="grid-template-columns: 2fr 1fr 1fr;">
        <input type="text" id="carName" placeholder="Suspect Vehicle (e.g. Twin Mill)">
        <input type="text" id="carColor" placeholder="Color">
        <input type="number" id="carWeight" placeholder="Mass (g)" step="0.1">
      </div>
      <button id="addCarBtn" class="btn btn-warning" onclick="addCar()">ADD TO GARAGE</button>
      <div id="currentCar" style="text-align:center; margin:15px 0; font-size:1.2rem; font-weight:bold; color:var(--mass-muted);">
        No suspect vehicle selected
      </div>
      <div id="garageGrid" class="garage-grid"></div>
      <div id="garageStatus" style="text-align:center; margin:8px 0; font-size:0.85rem; font-weight:bold; min-height:1.2em;"></div>
      <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
        <button class="btn btn-success" onclick="manualSaveGarage()">SAVE GARAGE</button>
        <button class="btn btn-primary" onclick="exportGarage()">EXPORT</button>
        <label class="btn btn-warning" style="text-align:center; cursor:pointer;">
          IMPORT
          <input type="file" accept=".json" onchange="importGarage(event)" style="display:none;">
        </label>
        <button class="btn btn-danger" onclick="clearGarage()">CLEAR</button>
      </div>
    </div>

    <!-- Settings -->
    <div class="section">
      <div class="section-title">OPERATIONS</div>
      <div class="grid">
        <div>
          <div class="card-label">Track Length (meters)</div>
          <input type="number" id="trackLength" value="2.0" step="0.01" onchange="updateTrackLength()">
        </div>
        <div>
          <div class="card-label">Google Sheets URL (optional)</div>
          <input type="text" id="sheetsUrl" placeholder="https://script.google.com/..." onchange="saveSheetsUrl()">
          <div id="sheetsStatus" style="font-size:0.8rem; margin-top:4px; color:var(--mass-muted);"></div>
        </div>
      </div>
      <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
        <button class="btn btn-primary" onclick="exportCSV()">DOWNLOAD CSV</button>
        <button class="btn btn-success" onclick="testSheetsUpload()">TEST SHEETS</button>
        <button class="btn btn-danger" onclick="clearHistory()">CLEAR HISTORY</button>
      </div>
    </div>

    <!-- History -->
    <div class="section">
      <div class="section-title">CASE FILE</div>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Run</th><th>Suspect</th><th>Mass</th><th>Time</th>
              <th>Real MPH</th><th>Scale MPH</th><th>Momentum</th><th>KE</th>
            </tr>
          </thead>
          <tbody id="historyTable">
            <tr><td colspan="8" style="text-align:center; color:var(--mass-muted);">No evidence recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Leaderboard Overlay (Criminal Verdict) -->
  <div id="leaderboardOverlay" class="leaderboard-overlay" onclick="this.classList.remove('show');">
    <div class="leaderboard-card" onclick="event.stopPropagation();">
      <div id="lbVerdict" style="font-size:0.85rem; font-weight:900; letter-spacing:2px; color:var(--mass-red); text-transform:uppercase; margin-bottom:4px;"></div>
      <div id="lbRank" class="leaderboard-rank">#1</div>
      <div id="lbText" class="leaderboard-text"></div>
      <div id="lbDetail" class="leaderboard-detail"></div>
      <div id="lbThreat" style="margin-top:12px; padding:6px 14px; border-radius:6px; font-size:0.8rem; font-weight:900; display:inline-block;"></div>
    </div>
  </div>

  <div class="version-badge" id="versionBadge">v--</div>

  <script>
    // ========================================================================
    // WEBSOCKET CONNECTION
    // ========================================================================
    let ws = null;
    let wsReconnectTimer = null;
    let currentScaleFactor = 64;
    let configSheetsUrl = '';

    function escHtml(s) {
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function setCurrentCarDisplay(car) {
      const el = document.getElementById('currentCar');
      el.textContent = '';
      el.appendChild(document.createTextNode('Active Suspect: '));
      const span = document.createElement('span');
      span.style.color = 'var(--mass-gold)';
      span.textContent = car.name;
      el.appendChild(span);
      el.appendChild(document.createTextNode(' (' + car.weight + 'g)'));
    }

    function connectWebSocket() {
      const wsUrl = 'ws://' + window.location.hostname + ':81';
      ws = new WebSocket(wsUrl);
      ws.onopen = () => { updateConnectionStatus(true); clearTimeout(wsReconnectTimer); };
      ws.onclose = () => { updateConnectionStatus(false); wsReconnectTimer = setTimeout(connectWebSocket, 2000); };
      ws.onerror = () => {};
      ws.onmessage = (event) => {
        try { handleStateUpdate(JSON.parse(event.data)); } catch (e) { console.error('Parse error:', e); }
      };
    }

    function updateConnectionStatus(connected) {
      const el = document.getElementById('connection');
      el.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
      el.textContent = connected ? 'LINKED' : 'OFFLINE';
    }

    function send(data) {
      if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify(data)); }
      else { massToast('Not connected to M.A.S.S. Trap!', 'error'); }
    }

    // ========================================================================
    // STATE HANDLING
    // ========================================================================
    function handleStateUpdate(data) {
      if (data.role) {
        const roleName = data.role.charAt(0).toUpperCase() + data.role.slice(1);
        document.title = roleName + ' - M.A.S.S. Trap Command Center';
      }
      if (data.scaleFactor) {
        currentScaleFactor = data.scaleFactor;
        document.getElementById('scaleLabel').textContent = 'Scale Speed (1:' + currentScaleFactor + ')';
      }
      if (data.google_sheets_url && !document.getElementById('sheetsUrl').value) {
        document.getElementById('sheetsUrl').value = data.google_sheets_url;
        configSheetsUrl = data.google_sheets_url;
      }
      if (data.trackLength) {
        document.getElementById('trackLength').value = data.trackLength;
      }

      // LiDAR indicator
      if (data.lidar) {
        const lidarEl = document.getElementById('lidarIndicator');
        if (data.lidar.state === 'staged') {
          lidarEl.className = 'lidar-indicator staged';
          lidarEl.textContent = 'LIDAR TARGET ACQUIRED (' + data.lidar.distance_mm + 'mm)';
        } else {
          lidarEl.className = 'lidar-indicator';
        }
      }

      // State banner
      const banner = document.getElementById('stateBanner');
      banner.className = 'state-banner ' + data.state.toLowerCase();
      var themeBannerText = {
        interceptor: { IDLE: 'AWAITING SUSPECTS', ARMED: 'TRAP SET', RACING: 'IN PURSUIT', FINISHED: 'SUSPECT CLOCKED' },
        classic:     { IDLE: 'READY TO RACE!', ARMED: 'ON YOUR MARKS...', RACING: 'GO GO GO!', FINISHED: 'FINISH LINE!' },
        daytona:     { IDLE: 'PIT LANE', ARMED: 'GREEN FLAG', RACING: 'FULL SEND', FINISHED: 'CHECKERED FLAG' },
        casefile:    { IDLE: 'CASE OPEN', ARMED: 'STAKEOUT ACTIVE', RACING: 'SUSPECT FLEEING', FINISHED: 'EVIDENCE LOGGED' },
        cyber:       { IDLE: 'SYSTEM IDLE', ARMED: 'ARMED // READY', RACING: 'TRACKING...', FINISHED: 'TARGET ACQUIRED' }
      };
      var currentTheme = (localStorage.getItem('mass_theme') || 'interceptor').toLowerCase();
      var bannerText = themeBannerText[currentTheme] || themeBannerText.interceptor;
      var stateText = bannerText[data.state] || data.state;
      if (activeCar && activeCar.name) {
        banner.textContent = activeCar.name.toUpperCase() + ' \u2014 ' + stateText;
      } else {
        banner.textContent = stateText;
      }

      // LED visualizer
      document.getElementById('ledBar').className = 'led-visualizer ' + data.state.toLowerCase();

      // Hide ghost when not finished
      if (data.state !== 'FINISHED') { document.getElementById('ghostSection').style.display = 'none'; }

      // Stats
      document.getElementById('statTime').textContent = data.time ? data.time.toFixed(3) : '--';
      document.getElementById('statSpeed').textContent = data.speed_mph ? data.speed_mph.toFixed(1) : '--';
      document.getElementById('statScale').textContent = data.scale_mph ? data.scale_mph.toFixed(0) : '--';
      document.getElementById('statMomentum').textContent = data.momentum ? data.momentum.toFixed(4) : '--';
      document.getElementById('statKE').textContent = data.ke ? data.ke.toFixed(4) : '--';
      document.getElementById('statRuns').textContent = data.totalRuns || 0;

      // Speed profile (mid-track from speed trap node)
      if (data.midTrack_mph && data.speed_mph) {
        updateSpeedProfile(data.speed_mph, data.midTrack_mph);
      }

      // Race finished
      if (data.state === 'FINISHED' && data.time !== undefined) {
        showGhostComparison(data);
        updateGarageStats(data);
        addToHistory(data);
        addRaceToCharts(data);
        updateExplainerValues(data);
        showLeaderboardOverlay(data);

        const sheetsUrl = document.getElementById('sheetsUrl').value || configSheetsUrl;
        if (sheetsUrl && data.time > 0) { uploadToSheets(data, sheetsUrl); }
      }

      // Button states
      const btnArm = document.getElementById('btnArm');
      if (data.state === 'IDLE') {
        btnArm.disabled = false;
        btnArm.textContent = 'ARM SYSTEM';
      } else {
        btnArm.disabled = true;
        btnArm.textContent = data.state;
      }
    }

    // ========================================================================
    // SPEED PROFILE
    // ========================================================================
    function updateSpeedProfile(finishMph, midMph) {
      const section = document.getElementById('speedProfileSection');
      section.classList.add('visible');
      const maxMph = Math.max(finishMph, midMph) * 1.2;
      document.getElementById('speedBarFinish').style.width = (finishMph / maxMph * 100) + '%';
      document.getElementById('speedBarMid').style.width = (midMph / maxMph * 100) + '%';
      document.getElementById('speedValFinish').textContent = finishMph.toFixed(1) + ' mph';
      document.getElementById('speedValMid').textContent = midMph.toFixed(1) + ' mph';
    }

    // ========================================================================
    // LEADERBOARD OVERLAY (Criminal Verdict)
    // ========================================================================
    function showLeaderboardOverlay(data) {
      if (!data.time || data.time <= 0) return;
      // Find rank among all cars
      let allBests = garage.filter(c => c.stats && c.stats.bestTime != null && isFinite(c.stats.bestTime))
                          .map(c => ({ name: c.name, time: c.stats.bestTime }));
      allBests.sort((a, b) => a.time - b.time);
      const rank = allBests.findIndex(b => b.name === (activeCar ? activeCar.name : '')) + 1;
      if (rank <= 0 || allBests.length < 2) return;

      const overlay = document.getElementById('leaderboardOverlay');
      const rankText = '#' + rank;
      document.getElementById('lbRank').textContent = rankText;
      document.getElementById('lbRank').style.color = rank === 1 ? 'var(--mass-gold)' : rank <= 3 ? 'var(--mass-blue)' : 'var(--mass-muted)';

      // Criminal verdict text
      const verdictEl = document.getElementById('lbVerdict');
      const threatEl = document.getElementById('lbThreat');
      let msg = '', verdict = '', threatClass = '', threatText = '';

      if (rank === 1) {
        verdict = 'ALL POINTS BULLETIN';
        msg = 'PUBLIC ENEMY #1';
        threatClass = 'armed-dangerous';
        threatText = 'ARMED & DANGEROUS';
      } else if (rank === 2) {
        verdict = 'WARRANT ISSUED';
        msg = 'MOST WANTED #2';
        threatClass = 'armed-dangerous';
        threatText = 'ARMED & DANGEROUS';
      } else if (rank === 3) {
        verdict = 'SUSPECT IDENTIFIED';
        msg = 'MOST WANTED #3';
        threatClass = 'known-offender';
        threatText = 'KNOWN OFFENDER';
      } else if (rank <= Math.ceil(allBests.length / 2)) {
        verdict = 'BOOKING REPORT';
        msg = 'KNOWN OFFENDER #' + rank;
        threatClass = 'known-offender';
        threatText = 'KNOWN OFFENDER';
      } else {
        verdict = 'INCIDENT REPORT';
        msg = 'PERSON OF INTEREST #' + rank;
        threatClass = 'person-of-interest';
        threatText = 'PERSON OF INTEREST';
      }

      verdictEl.textContent = verdict;
      document.getElementById('lbText').textContent = msg;
      document.getElementById('lbDetail').textContent =
        (activeCar ? activeCar.name : 'Unknown') + ' | ' +
        data.time.toFixed(3) + 's | ' + (data.scale_mph || 0).toFixed(0) + ' scale mph';

      threatEl.textContent = threatText;
      threatEl.className = '';
      threatEl.style.background = threatClass === 'armed-dangerous' ? 'rgba(220,53,69,0.2)' :
                                   threatClass === 'known-offender' ? 'rgba(212,175,55,0.15)' :
                                   'rgba(136,136,170,0.1)';
      threatEl.style.border = '1px solid ' + (threatClass === 'armed-dangerous' ? 'var(--mass-red)' :
                               threatClass === 'known-offender' ? 'var(--mass-gold)' : 'var(--mass-muted)');
      threatEl.style.color = threatClass === 'armed-dangerous' ? 'var(--mass-red)' :
                              threatClass === 'known-offender' ? 'var(--mass-gold)' : 'var(--mass-muted)';

      overlay.classList.add('show');
      setTimeout(() => { overlay.classList.remove('show'); }, 5000);

      // Refresh the Most Wanted board
      renderMostWanted();
    }

    // ========================================================================
    // MOST WANTED — Criminal Leaderboard
    // ========================================================================
    let mwSortMode = 'time';
    let mwCollapsed = false;

    function toggleMostWanted() {
      mwCollapsed = !mwCollapsed;
      document.getElementById('mwBoard').style.display = mwCollapsed ? 'none' : 'grid';
      document.querySelector('.mw-sort-controls').style.display = mwCollapsed ? 'none' : 'flex';
      document.getElementById('mwToggle').innerHTML = mwCollapsed ? 'Expand &#x25BC;' : 'Collapse &#x25B2;';
    }

    function sortMostWanted(mode) {
      mwSortMode = mode;
      document.querySelectorAll('.mw-sort-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('mwSort' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
      renderMostWanted();
    }

    function getMostWantedData() {
      // Build ranked list from garage stats + history
      return garage
        .filter(c => c.stats && c.stats.runs > 0)
        .map(c => {
          const s = c.stats;
          // Get best KE from history for this car
          const carHistory = history.filter(h => h.car === c.name);
          const bestKE = carHistory.length > 0 ? Math.max(...carHistory.map(h => h.ke || 0)) : 0;
          const bestScaleMph = carHistory.length > 0 ? Math.max(...carHistory.map(h => h.scale_mph || 0)) : 0;
          return {
            name: c.name,
            color: c.color || 'N/A',
            weight: c.weight,
            bestTime: s.bestTime,
            bestSpeed: s.bestSpeed || 0,
            bestScaleMph: bestScaleMph,
            runs: s.runs || 0,
            bestKE: bestKE,
            id: c.id
          };
        });
    }

    function sortMWData(data) {
      switch (mwSortMode) {
        case 'time':
          return data.sort((a, b) => {
            if (a.bestTime == null) return 1;
            if (b.bestTime == null) return -1;
            return a.bestTime - b.bestTime;
          });
        case 'speed':
          return data.sort((a, b) => b.bestSpeed - a.bestSpeed);
        case 'runs':
          return data.sort((a, b) => b.runs - a.runs);
        case 'ke':
          return data.sort((a, b) => b.bestKE - a.bestKE);
        default:
          return data;
      }
    }

    function getThreatLevel(rank, total) {
      if (rank <= 3) return { cls: 'armed-dangerous', text: 'ARMED & DANGEROUS' };
      if (rank <= Math.max(5, Math.ceil(total * 0.5))) return { cls: 'known-offender', text: 'KNOWN OFFENDER' };
      return { cls: 'person-of-interest', text: 'PERSON OF INTEREST' };
    }

    function getRankTitle(rank) {
      if (rank === 1) return 'PUBLIC ENEMY #1';
      if (rank <= 3) return 'MOST WANTED';
      return 'APB #' + rank;
    }

    function getSortValue(item) {
      switch (mwSortMode) {
        case 'time': return item.bestTime != null ? item.bestTime.toFixed(3) + 's' : '--';
        case 'speed': return item.bestSpeed.toFixed(1) + ' mph';
        case 'runs': return item.runs + ' offense' + (item.runs !== 1 ? 's' : '');
        case 'ke': return item.bestKE.toFixed(4) + ' J';
        default: return '';
      }
    }

    function renderMostWanted() {
      const board = document.getElementById('mwBoard');
      let data = getMostWantedData();

      if (data.length === 0) {
        board.innerHTML = '<div class="mw-empty">No suspects in the system. Add cars to the garage and run races to populate the Most Wanted list.</div>';
        return;
      }

      data = sortMWData(data);
      const total = data.length;

      board.innerHTML = data.map((item, i) => {
        const rank = i + 1;
        const threat = getThreatLevel(rank, total);
        const rankTitle = getRankTitle(rank);
        const rankClass = rank <= 3 ? ' rank-' + rank : '';
        const isActive = activeCar && activeCar.id === item.id;

        return '<div class="mw-card' + rankClass + (isActive ? ' mw-new-record' : '') + '">' +
          '<div class="mw-rank">' + rankTitle + '</div>' +
          '<div class="mw-name">' + escHtml(item.name) + '</div>' +
          '<div class="mw-stats">' +
            '<div>Time: <strong>' + (item.bestTime != null ? item.bestTime.toFixed(3) + 's' : '--') + '</strong></div>' +
            '<div>Speed: <strong>' + item.bestSpeed.toFixed(1) + ' mph</strong></div>' +
            '<div>Scale: <strong>' + item.bestScaleMph.toFixed(0) + ' mph</strong></div>' +
            '<div>Mass: <strong>' + item.weight + 'g</strong></div>' +
            '<div>Offenses: <strong>' + item.runs + '</strong></div>' +
            '<div>KE: <strong>' + item.bestKE.toFixed(4) + ' J</strong></div>' +
          '</div>' +
          '<div class="mw-threat ' + threat.cls + '">' + threat.text + '</div>' +
        '</div>';
      }).join('');
    }

    // ========================================================================
    // RACE CONTROL
    // ========================================================================
    function armRace() { send({ cmd: 'arm' }); }
    function resetRace() { send({ cmd: 'reset' }); }
    function syncClock() {
      send({ cmd: 'syncClock' });
      massToast('\u2713 Clock sync requested', 'success', 2000);
    }
    function updateTrackLength() {
      const length = parseFloat(document.getElementById('trackLength').value);
      if (length > 0 && length < 100) { send({ cmd: 'setTrack', length: length }); }
    }

    // ========================================================================
    // GARAGE MANAGEMENT
    // ========================================================================
    let garage = [];
    let activeCar = JSON.parse(localStorage.getItem('hw_active_car') || 'null');
    let editingCarIndex = -1;

    async function loadGarageFromESP() {
      try {
        const resp = await fetch('/api/garage');
        const data = await resp.json();
        if (Array.isArray(data) && data.length > 0) { garage = data; }
        else {
          const local = JSON.parse(localStorage.getItem('hw_garage') || '[]');
          if (local.length > 0) { garage = local; await saveGarageToESP(); }
        }
      } catch (e) {
        garage = JSON.parse(localStorage.getItem('hw_garage') || '[]');
      }
      renderGarage();
    }

    async function saveGarageToESP() {
      localStorage.setItem('hw_garage', JSON.stringify(garage));
      let saved = false;
      for (let attempt = 0; attempt < 2; attempt++) {
        try {
          const resp = await fetch('/api/garage', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(garage) });
          if (resp.ok) { saved = true; break; }
        } catch (e) {}
      }
      return saved;
    }

    async function saveGarage() {
      renderGarage();
      const ok = await saveGarageToESP();
      showGarageStatus(ok ? 'Garage saved!' : 'Save failed - try SAVE GARAGE button', ok);
    }

    function showGarageStatus(msg, success) {
      const el = document.getElementById('garageStatus');
      if (!el) return;
      el.textContent = msg;
      el.style.color = success ? 'var(--mass-green)' : 'var(--mass-red)';
      setTimeout(() => { el.textContent = ''; }, 3000);
    }

    async function manualSaveGarage() {
      showGarageStatus('Saving...', true);
      const ok = await saveGarageToESP();
      showGarageStatus(ok ? 'Garage saved to ESP32!' : 'Failed to save', ok);
    }

    async function clearGarage() {
      if (garage.length === 0) { massToast('Garage is already empty!', 'error'); return; }
      const c = prompt('Type CLEAR to delete all ' + garage.length + ' cars:');
      if (c !== 'CLEAR') return;
      garage = [];
      activeCar = null;
      localStorage.removeItem('hw_active_car');
      localStorage.removeItem('hw_garage');
      document.getElementById('currentCar').textContent = 'No suspect vehicle selected';
      renderGarage();
      const ok = await saveGarageToESP();
      showGarageStatus(ok ? 'Garage cleared!' : 'Cleared locally but ESP32 save failed', ok);
    }

    function exportGarage() {
      if (garage.length === 0) { massToast('No cars to export!', 'error'); return; }
      const blob = new Blob([JSON.stringify(garage, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'masstrap_garage_' + Date.now() + '.json';
      a.click();
      window.URL.revokeObjectURL(url);
      showGarageStatus('Garage exported!', true);
    }

    function importGarage(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) { massToast('Invalid garage file', 'error'); return; }
          for (const car of imported) {
            if (!car.name || !car.weight) { massToast('Invalid car data', 'error'); return; }
            if (!car.stats) car.stats = { runs: 0, bestTime: null, bestSpeed: 0 };
            if (!car.id) car.id = Date.now() + Math.random();
          }
          if (garage.length > 0) {
            const choice = confirm('Replace all? Cancel to merge.');
            if (choice) { garage = imported; }
            else {
              let added = 0;
              for (const car of imported) {
                if (!garage.some(g => g.name.toLowerCase() === car.name.toLowerCase())) { garage.push(car); added++; }
              }
              showGarageStatus('Merged ' + added + ' new cars', true);
            }
          } else { garage = imported; }
          await saveGarage();
          showGarageStatus('Imported ' + imported.length + ' cars!', true);
        } catch (err) { massToast('Failed to parse: ' + err.message, 'error'); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    async function addCar() {
      const name = document.getElementById('carName').value.trim();
      const color = document.getElementById('carColor').value.trim();
      const weight = parseFloat(document.getElementById('carWeight').value);
      if (!name || name.length < 1 || name.length > 30) { massToast('Name must be 1-30 characters!', 'error'); return; }
      if (!weight || weight < 1 || weight > 200) { massToast('Mass must be 1-200 grams!', 'error'); return; }

      if (editingCarIndex >= 0) {
        garage[editingCarIndex].name = name;
        garage[editingCarIndex].color = color || 'N/A';
        garage[editingCarIndex].weight = weight;
        if (activeCar && activeCar.id === garage[editingCarIndex].id) {
          activeCar = garage[editingCarIndex];
          localStorage.setItem('hw_active_car', JSON.stringify(activeCar));
          send({ cmd: 'setCar', name: activeCar.name, weight: activeCar.weight });
          setCurrentCarDisplay(activeCar);
        }
        editingCarIndex = -1;
        document.getElementById('addCarBtn').textContent = 'ADD TO GARAGE';
      } else {
        if (garage.some(c => c.name.toLowerCase() === name.toLowerCase())) {
          massToast('Car already exists! Click pencil to edit.', 'error'); return;
        }
        garage.push({ id: Date.now(), name: name, color: color || 'N/A', weight: weight,
          stats: { runs: 0, bestTime: null, bestSpeed: 0 }, notes: [] });
      }
      await saveGarage();
      document.getElementById('carName').value = '';
      document.getElementById('carColor').value = '';
      document.getElementById('carWeight').value = '';
    }

    function editCar(index, event) {
      event.stopPropagation();
      editingCarIndex = index;
      const car = garage[index];
      document.getElementById('carName').value = car.name;
      document.getElementById('carColor').value = car.color === 'N/A' ? '' : car.color;
      document.getElementById('carWeight').value = car.weight;
      document.getElementById('addCarBtn').textContent = 'SAVE CHANGES';
      document.getElementById('carName').focus();
    }

    function selectCar(index) {
      activeCar = garage[index];
      localStorage.setItem('hw_active_car', JSON.stringify(activeCar));
      send({ cmd: 'setCar', name: activeCar.name, weight: activeCar.weight });
      setCurrentCarDisplay(activeCar);
      updateBannerCarName();
      renderGarage();
    }

    function updateBannerCarName() {
      var banner = document.getElementById('stateBanner');
      if (!banner) return;
      var themeBannerText = {
        interceptor: { IDLE: 'AWAITING SUSPECTS', ARMED: 'TRAP SET', RACING: 'IN PURSUIT', FINISHED: 'SUSPECT CLOCKED' },
        classic:     { IDLE: 'READY TO RACE!', ARMED: 'ON YOUR MARKS...', RACING: 'GO GO GO!', FINISHED: 'FINISH LINE!' },
        daytona:     { IDLE: 'PIT LANE', ARMED: 'GREEN FLAG', RACING: 'FULL SEND', FINISHED: 'CHECKERED FLAG' },
        casefile:    { IDLE: 'CASE OPEN', ARMED: 'STAKEOUT ACTIVE', RACING: 'SUSPECT FLEEING', FINISHED: 'EVIDENCE LOGGED' },
        cyber:       { IDLE: 'SYSTEM IDLE', ARMED: 'ARMED // READY', RACING: 'TRACKING...', FINISHED: 'TARGET ACQUIRED' }
      };
      var currentTheme = (localStorage.getItem('mass_theme') || 'interceptor').toLowerCase();
      var texts = themeBannerText[currentTheme] || themeBannerText.interceptor;
      var state = 'IDLE';
      if (banner.classList.contains('armed')) state = 'ARMED';
      else if (banner.classList.contains('racing')) state = 'RACING';
      else if (banner.classList.contains('finished')) state = 'FINISHED';
      var stateText = texts[state] || state;
      if (activeCar && activeCar.name) {
        banner.textContent = activeCar.name.toUpperCase() + ' \u2014 ' + stateText;
      } else {
        banner.textContent = stateText;
      }
    }

    async function deleteCar(index, event) {
      event.stopPropagation();
      if (confirm('Delete ' + garage[index].name + '?')) {
        const deletedId = garage[index].id;
        garage.splice(index, 1);
        if (activeCar && activeCar.id === deletedId) {
          activeCar = null;
          localStorage.removeItem('hw_active_car');
          document.getElementById('currentCar').textContent = 'No suspect vehicle selected';
        }
        if (editingCarIndex === index) editingCarIndex = -1;
        await saveGarage();
      }
    }

    // Mechanic's Log: add note to car
    async function addNote(index) {
      const input = document.getElementById('noteInput_' + index);
      if (!input || !input.value.trim()) return;
      if (!garage[index].notes) garage[index].notes = [];
      garage[index].notes.push({ text: input.value.trim(), ts: Date.now() });
      if (garage[index].notes.length > 20) garage[index].notes = garage[index].notes.slice(-20);
      input.value = '';
      await saveGarage();
    }

    function renderGarage() {
      const grid = document.getElementById('garageGrid');
      if (garage.length === 0) {
        grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--mass-muted);">No suspects in garage</p>';
        return;
      }
      grid.innerHTML = garage.map((car, i) => {
        if (!car.stats) car.stats = { runs: 0, bestTime: null, bestSpeed: 0 };
        const hasBest = car.stats.bestTime != null && car.stats.bestTime !== Infinity && isFinite(car.stats.bestTime);
        const notes = car.notes || [];
        const notesHtml = notes.slice(-3).map(n =>
          '<div class="mech-note">' + new Date(n.ts).toLocaleDateString() + ': ' + escHtml(n.text) + '</div>'
        ).join('');
        return '<div class="garage-car ' + (activeCar && activeCar.id === car.id ? 'active' : '') + '" onclick="selectCar(' + i + ')">' +
          '<button class="delete-btn" onclick="deleteCar(' + i + ', event)" title="Delete">x</button>' +
          '<button class="edit-btn" onclick="editCar(' + i + ', event)" title="Edit">&#9998;</button>' +
          '<h3>' + escHtml(car.name) + '</h3>' +
          '<p>' + escHtml(car.color || '') + '</p>' +
          '<p>' + car.weight + 'g</p>' +
          '<div class="garage-stats">' +
            '<span>Runs: ' + (car.stats.runs || 0) + '</span>' +
            '<span>Best: ' + (hasBest ? car.stats.bestTime.toFixed(3) : '--') + 's</span>' +
          '</div>' +
          '<div class="mech-notes">' +
            notesHtml +
            '<input type="text" id="noteInput_' + i + '" class="mech-note-input" placeholder="Add note..." onclick="event.stopPropagation();" onkeydown="if(event.key===\'Enter\')addNote(' + i + ')">' +
            '<button class="btn btn-primary mech-add-btn" onclick="event.stopPropagation(); addNote(' + i + ');">+</button>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    async function updateGarageStats(raceData) {
      if (!activeCar) return;
      const carIndex = garage.findIndex(c => c.id === activeCar.id);
      if (carIndex === -1) return;
      if (!garage[carIndex].stats) garage[carIndex].stats = { runs: 0, bestTime: null, bestSpeed: 0 };
      garage[carIndex].stats.runs++;
      const prevBest = garage[carIndex].stats.bestTime;
      if (prevBest == null || raceData.time < prevBest) garage[carIndex].stats.bestTime = raceData.time;
      if (raceData.speed_mph > (garage[carIndex].stats.bestSpeed || 0)) garage[carIndex].stats.bestSpeed = raceData.speed_mph;
      await saveGarage();
    }

    // ========================================================================
    // HISTORY MANAGEMENT
    // ========================================================================
    let history = [];

    async function loadHistoryFromESP() {
      try {
        const resp = await fetch('/api/history');
        const data = await resp.json();
        if (Array.isArray(data) && data.length > 0) { history = data; }
        else {
          const local = JSON.parse(localStorage.getItem('hw_history') || '[]');
          if (local.length > 0) { history = local; await saveHistoryToESP(); }
        }
      } catch (e) {
        history = JSON.parse(localStorage.getItem('hw_history') || '[]');
      }
      renderHistory();
    }

    async function saveHistoryToESP() {
      localStorage.setItem('hw_history', JSON.stringify(history));
      try {
        await fetch('/api/history', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(history) });
      } catch (e) {}
    }

    function addToHistory(raceData) {
      const entry = {
        timestamp: Date.now(),
        run: raceData.totalRuns,
        car: raceData.car,
        weight: raceData.weight,
        time: raceData.time,
        speed_mph: raceData.speed_mph,
        scale_mph: raceData.scale_mph,
        momentum: raceData.momentum,
        ke: raceData.ke
      };
      if (raceData.midTrack_mph) entry.midTrack_mph = raceData.midTrack_mph;
      history.unshift(entry);
      if (history.length > 100) history = history.slice(0, 100);
      saveHistoryToESP();
      renderHistory();
    }

    function renderHistory() {
      const tbody = document.getElementById('historyTable');
      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--mass-muted);">No evidence recorded yet</td></tr>';
        return;
      }
      tbody.innerHTML = history.slice(0, 20).map(h =>
        '<tr>' +
          '<td>#' + h.run + '</td>' +
          '<td><strong style="color:var(--mass-gold);">' + escHtml(h.car) + '</strong></td>' +
          '<td>' + h.weight + 'g</td>' +
          '<td style="font-family:monospace;">' + h.time.toFixed(3) + 's</td>' +
          '<td>' + h.speed_mph.toFixed(1) + '</td>' +
          '<td><strong style="color:var(--mass-gold);">' + h.scale_mph.toFixed(0) + '</strong></td>' +
          '<td>' + h.momentum.toFixed(3) + '</td>' +
          '<td>' + (h.ke != null ? h.ke.toFixed(4) : '--') + '</td>' +
        '</tr>'
      ).join('');
    }

    function clearHistory() {
      const c = prompt('Type DELETE to clear all evidence:');
      if (c === 'DELETE') { history = []; saveHistoryToESP(); renderHistory(); }
    }

    // ========================================================================
    // DATA EXPORT
    // ========================================================================
    function exportCSV() {
      if (history.length === 0) { massToast('No data!', 'warn'); return; }
      let csv = 'Run,Timestamp,Car,Weight(g),Time(s),Speed(mph),Scale(mph),Momentum,KE\n';
      history.forEach(h => {
        csv += h.run + ',' + new Date(h.timestamp).toISOString() + ',' + h.car + ',' + h.weight + ',' + h.time + ',' + h.speed_mph + ',' + h.scale_mph + ',' + h.momentum + ',' + h.ke + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'masstrap_data_' + Date.now() + '.csv';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function uploadToSheets(data, url) {
      const status = document.getElementById('sheetsStatus');
      status.textContent = 'Uploading...';
      status.style.color = 'var(--mass-blue)';
      fetch(url, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ timestamp: new Date().toISOString(), car: data.car, weight: data.weight,
          time: data.time, speed_mph: data.speed_mph, scale_mph: data.scale_mph, momentum: data.momentum, ke: data.ke })
      }).then(() => {
        status.textContent = 'Sent!'; status.style.color = 'var(--mass-green)';
        setTimeout(() => { status.textContent = ''; }, 3000);
      }).catch(err => { status.textContent = 'Failed'; status.style.color = 'var(--mass-red)'; });
    }

    function saveSheetsUrl() {
      const url = document.getElementById('sheetsUrl').value.trim();
      configSheetsUrl = url;
      send({ cmd: 'setSheetsUrl', url: url });
      const status = document.getElementById('sheetsStatus');
      status.textContent = 'URL saved'; status.style.color = 'var(--mass-green)';
      setTimeout(() => { status.textContent = ''; }, 2000);
    }

    function testSheetsUpload() {
      const url = document.getElementById('sheetsUrl').value.trim() || configSheetsUrl;
      if (!url) { massToast('Enter a Google Sheets URL first!', 'error'); return; }
      uploadToSheets({ car: 'TEST', weight: 35, time: 1.234, speed_mph: 1.62, scale_mph: 103.7, momentum: 0.057, ke: 0.023 }, url);
    }

    // ========================================================================
    // GHOST CAR COMPARISON
    // ========================================================================
    function showGhostComparison(raceData) {
      const section = document.getElementById('ghostSection');
      const deltaEl = document.getElementById('ghostDelta');
      const labelEl = document.getElementById('ghostLabel');
      if (!activeCar) { section.style.display = 'none'; return; }
      const carIndex = garage.findIndex(c => c.id === activeCar.id);
      if (carIndex === -1 || !garage[carIndex].stats) { section.style.display = 'none'; return; }
      const prevBest = garage[carIndex].stats.bestTime;
      if (prevBest == null || !isFinite(prevBest)) {
        section.style.display = 'block';
        section.className = 'section new-record';
        deltaEl.textContent = 'FIRST RUN!';
        deltaEl.style.color = 'var(--mass-green)';
        labelEl.textContent = raceData.time.toFixed(3) + 's is the benchmark for ' + activeCar.name;
        return;
      }
      const delta = raceData.time - prevBest;
      section.style.display = 'block';
      if (delta < 0) {
        section.className = 'section new-record';
        deltaEl.textContent = delta.toFixed(3) + 's';
        deltaEl.style.color = 'var(--mass-green)';
        labelEl.textContent = 'NEW RECORD! Previous: ' + prevBest.toFixed(3) + 's';
      } else if (delta === 0) {
        section.className = 'section new-record';
        deltaEl.textContent = 'TIED!';
        deltaEl.style.color = 'var(--mass-gold)';
        labelEl.textContent = 'Matched record: ' + prevBest.toFixed(3) + 's';
      } else {
        section.className = 'section slower';
        deltaEl.textContent = '+' + delta.toFixed(3) + 's';
        deltaEl.style.color = 'var(--mass-red)';
        labelEl.textContent = 'Record: ' + prevBest.toFixed(3) + 's';
      }
    }

    // ========================================================================
    // CHART.JS
    // ========================================================================
    let speedChart = null;
    let keChart = null;

    function initCharts() {
      if (typeof Chart === 'undefined') return;
      Chart.defaults.color = '#8888aa';
      Chart.defaults.borderColor = '#2a2a4a';

      speedChart = new Chart(document.getElementById('speedChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Speed (mph)', data: [],
          borderColor: '#4a90d9', backgroundColor: 'rgba(74,144,217,0.1)',
          borderWidth: 2, pointBackgroundColor: '#d4af37', pointRadius: 4, tension: 0.1, fill: true }] },
        options: { responsive: true,
          plugins: { title: { display: true, text: 'Speed vs Run', font: { size: 14, weight: 'bold' }, color: '#d4af37' }, legend: { display: false } },
          scales: { x: { title: { display: true, text: 'Run #' } }, y: { title: { display: true, text: 'Speed (mph)' }, beginAtZero: true } } }
      });

      keChart = new Chart(document.getElementById('keChart').getContext('2d'), {
        type: 'scatter',
        data: { datasets: [{ label: 'KE vs Mass', data: [],
          backgroundColor: '#d4af37', pointRadius: 6, pointHoverRadius: 8 }] },
        options: { responsive: true,
          plugins: { title: { display: true, text: 'Kinetic Energy vs Mass', font: { size: 14, weight: 'bold' }, color: '#d4af37' }, legend: { display: false },
            tooltip: { callbacks: { label: function(ctx) { return ctx.raw.car + ': ' + ctx.raw.y.toFixed(4) + 'J @ ' + ctx.raw.x + 'g'; } } } },
          scales: { x: { title: { display: true, text: 'Mass (g)' } }, y: { title: { display: true, text: 'Kinetic Energy (J)' }, beginAtZero: true } } }
      });

      updateChartsFromHistory();
    }

    function updateChartsFromHistory() {
      if (!speedChart || !keChart) return;
      const c = [...history].reverse();
      speedChart.data.labels = c.map((h, i) => '#' + (h.run || i + 1));
      speedChart.data.datasets[0].data = c.map(h => h.speed_mph);
      speedChart.update();
      keChart.data.datasets[0].data = c.map(h => ({ x: h.weight, y: h.ke, car: h.car }));
      keChart.update();
    }

    function addRaceToCharts(raceData) {
      if (!speedChart || !keChart) return;
      speedChart.data.labels.push('#' + (raceData.totalRuns || speedChart.data.labels.length + 1));
      speedChart.data.datasets[0].data.push(raceData.speed_mph);
      speedChart.update();
      keChart.data.datasets[0].data.push({ x: raceData.weight, y: raceData.ke, car: raceData.car });
      keChart.update();
    }

    // ========================================================================
    // PHYSICS EXPLAINER
    // ========================================================================
    let explainerOpen = false;
    function toggleExplainer() {
      explainerOpen = !explainerOpen;
      document.getElementById('explainerContent').style.display = explainerOpen ? 'block' : 'none';
      document.getElementById('explainerToggle').innerHTML = (explainerOpen ? 'Hide Formulas &#x25B2;' : 'Show Formulas &#x25BC;');
    }

    function updateExplainerValues(data) {
      if (!data.time || data.time <= 0) return;
      const d = parseFloat(document.getElementById('trackLength').value) || 2.0;
      const t = data.time;
      const v_ms = d / t;
      const m_kg = (data.weight || 35) / 1000.0;
      const gForce = (v_ms / t) / 9.8;
      document.getElementById('formulaSpeed').innerHTML =
        'v = ' + d.toFixed(2) + 'm &divide; ' + t.toFixed(3) + 's = <strong>' + v_ms.toFixed(2) + ' m/s</strong> (' + (v_ms * 2.23694).toFixed(1) + ' mph)';
      document.getElementById('formulaMomentum').innerHTML =
        'p = ' + m_kg.toFixed(3) + 'kg &times; ' + v_ms.toFixed(2) + 'm/s = <strong>' + (m_kg * v_ms).toFixed(4) + ' kg&middot;m/s</strong>';
      document.getElementById('formulaKE').innerHTML =
        'KE = 0.5 &times; ' + m_kg.toFixed(3) + 'kg &times; ' + v_ms.toFixed(2) + '&sup2; = <strong>' + (0.5 * m_kg * v_ms * v_ms).toFixed(4) + ' J</strong>';
      document.getElementById('formulaGForce').innerHTML =
        'a = ' + v_ms.toFixed(2) + 'm/s &divide; ' + t.toFixed(3) + 's &divide; 9.8 = <strong>' + gForce.toFixed(2) + ' G</strong>';
    }

    // ========================================================================
    // INITIALIZATION
    // ========================================================================
    async function loadVersion() {
      try {
        const resp = await fetch('/api/version');
        const v = await resp.json();
        document.getElementById('versionBadge').textContent = 'FW v' + v.firmware + ' | UI v' + v.web_ui;
      } catch (e) {
        const meta = document.querySelector('meta[name="fw-version"]');
        if (meta) document.getElementById('versionBadge').textContent = 'v' + meta.content;
      }
    }

    window.onload = async () => {
      await loadGarageFromESP();
      await loadHistoryFromESP();
      initCharts();
      connectWebSocket();
      loadVersion();
      if (activeCar) { setCurrentCarDisplay(activeCar); }
      renderMostWanted();
    };

    window.addEventListener('beforeunload', () => {
      localStorage.setItem('hw_garage', JSON.stringify(garage));
      localStorage.setItem('hw_history', JSON.stringify(history));
      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/garage', false);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(garage));
      } catch (e) {}
    });
  </script>
  <script src="/main.js"></script>
  <script src="/chart.min.js"></script>
</body>
</html>
