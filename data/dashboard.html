<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="fw-version" content="2.5.0">
  <title>M.A.S.S. Trap Command Center</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* ===== Playlist Mode Styles ===== */
    .playlist-badge{background:var(--accent);color:var(--bg);font-size:0.7rem;font-weight:900;padding:2px 8px;border-radius:10px;vertical-align:middle;}
    .pl-car-selector{display:flex;flex-wrap:wrap;gap:6px;}
    .pl-car-check{display:flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:0.85rem;transition:all 0.2s;}
    .pl-car-check:hover{border-color:var(--accent);}
    .pl-car-check input[type="checkbox"]{margin:0;accent-color:var(--accent);width:16px;height:16px;}
    .pl-car-check.checked{border-color:var(--accent);background:rgba(var(--accent-rgb,212,175,55),0.1);}
    .pl-condition-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
    .pl-cond-label{flex:1;min-width:120px;}
    .pl-cond-weight{width:80px;text-align:right;}
    .pl-cond-unit{font-size:0.8rem;color:var(--text-muted);width:12px;}
    .pl-cond-remove{background:var(--danger);color:#fff;border:none;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:0.8rem;}
    .pl-banner{background:linear-gradient(135deg,rgba(var(--accent-rgb,212,175,55),0.15),rgba(var(--secondary-rgb,74,144,217),0.1));border:2px solid var(--accent);border-radius:12px;padding:16px;text-align:center;margin:12px 0;}
    .pl-run-label{font-size:0.85rem;font-weight:700;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase;}
    .pl-instruction{font-size:1.4rem;font-weight:900;color:var(--text);margin:8px 0;line-height:1.3;}
    .pl-trial-label{font-size:0.9rem;color:var(--secondary);font-weight:600;}
    .pl-progress-container{position:relative;height:24px;background:var(--card-bg);border-radius:12px;overflow:hidden;border:1px solid var(--border);margin:8px 0;}
    .pl-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--secondary));border-radius:12px;transition:width 0.4s ease;}
    .pl-progress-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:0.75rem;font-weight:900;color:var(--text);}
    .pl-condition-alert{background:rgba(var(--danger-rgb,220,53,69),0.15);border:2px solid var(--danger);border-radius:8px;padding:12px;text-align:center;margin:8px 0;font-size:1.1rem;font-weight:700;animation:plAlertPulse 1.5s ease-in-out 3;}
    @keyframes plAlertPulse{0%,100%{opacity:1;}50%{opacity:0.6;}}
    .pl-results-table{width:100%;font-size:0.8rem;border-collapse:collapse;}
    .pl-results-table th,.pl-results-table td{padding:4px 8px;border-bottom:1px solid var(--border);text-align:left;}
    .pl-results-table th{font-weight:700;color:var(--accent);font-size:0.75rem;text-transform:uppercase;}
    .pl-results-table tr.pl-current{background:rgba(var(--accent-rgb,212,175,55),0.1);}
    .pl-results-table tr.pl-skipped{opacity:0.5;text-decoration:line-through;}
    .pl-complete-banner{background:linear-gradient(135deg,rgba(40,167,69,0.2),rgba(var(--accent-rgb,212,175,55),0.15));border:2px solid #28a745;border-radius:12px;padding:20px;text-align:center;font-size:1.3rem;font-weight:900;color:#28a745;margin:12px 0;}
    .pl-summary-table{width:100%;font-size:0.8rem;border-collapse:collapse;margin-top:8px;}
    .pl-summary-table th,.pl-summary-table td{padding:4px 8px;border:1px solid var(--border);text-align:center;}
    .pl-summary-table th{background:rgba(var(--accent-rgb,212,175,55),0.1);font-weight:700;color:var(--accent);}
    .pl-summary-table .pl-avg{font-weight:900;color:var(--secondary);}
    #plSetup input[type="text"],#plSetup input[type="number"]{background:var(--card-bg);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px 8px;}
    /* ===== Evidence Tag Styles ===== */
    .ev-tag{border:2px solid var(--accent);border-radius:8px;padding:12px;margin:10px 0;background:var(--card-bg);}
    .ev-tag-header{text-align:center;border-bottom:2px solid var(--accent);padding-bottom:8px;margin-bottom:8px;}
    .ev-tag-badge{font-size:0.7rem;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);}
    .ev-tag-case{font-size:1.4rem;font-weight:900;letter-spacing:3px;color:var(--accent);}
    .ev-tag-body{display:flex;gap:12px;align-items:flex-start;}
    .ev-tag-qr{flex-shrink:0;background:#fff;padding:4px;border-radius:4px;}
    .ev-tag-info{font-size:0.85rem;line-height:1.7;}
    .ev-tag-ts{font-size:0.7rem;color:var(--text-muted);margin-top:4px;}
  </style>
</head>
<body>
  <a href="#stateBanner" class="skip-link">Skip to race status</a>
  <!-- Navigation (populated by main.js getNavHTML + initNav) -->
  <nav class="mass-nav" id="mainNav">
    <ul class="mass-nav-list">
      <li><a href="/"><span class="mass-nav-icon">&#x1F3C1;</span><span class="mass-nav-label">Live Monitor</span></a></li>
      <li><a href="/history.html"><span class="mass-nav-icon">&#x1F4CB;</span><span class="mass-nav-label">Evidence Log</span></a></li>
      <li><a href="/config"><span class="mass-nav-icon">&#x2699;&#xFE0F;</span><span class="mass-nav-label">System Config</span></a></li>
      <li><a href="/console"><span class="mass-nav-icon">&#x1F4DF;</span><span class="mass-nav-label">Terminal</span></a></li>
    </ul>
  </nav>

  <!-- Connection Badge (fixed, top-right) -->
  <div id="connBadge" class="conn-badge disconnected" role="status" aria-live="assertive">OFFLINE</div>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="page-header-shield" aria-hidden="true"></div>
      <h1>M.A.S.S. TRAP</h1>
      <div class="subtitle">MOTION ANALYSIS &amp; SPEED SYSTEM</div>
      <div class="tagline">COMMAND CENTER</div>
      <div class="theme-selector">
        <label for="themePicker">Theme:</label>
        <select id="themePicker" onchange="setTheme(this.value)">
          <option value="interceptor">Interceptor</option>
          <option value="classic">Classic</option>
          <option value="daytona">Daytona</option>
          <option value="casefile">Case File</option>
          <option value="cyber">Cyber</option>
        </select>
      </div>
    </div>

    <!-- State Banner (Dispatcher: aria-live announces state changes) -->
    <div id="stateBanner" class="state-banner" aria-live="assertive" aria-atomic="true">INITIALIZING...</div>

    <!-- LED Visualizer Bar (decorative — hidden from AT) -->
    <div id="ledBar" class="led-bar" aria-hidden="true"></div>

    <!-- LiDAR Sensor Indicator -->
    <div id="lidarIndicator" class="lidar-indicator"></div>

    <!-- Dry-Run Banner (hidden until active) -->
    <div id="dryRunBanner" class="dry-run-banner" style="display:none;" role="status" aria-live="polite">
      &#x1F6A7; DRY RUN — No data will be logged or saved
    </div>

    <!-- Quick Actions (hidden in kiosk mode) -->
    <div class="grid grid-3 kiosk-hide" id="quickActions">
      <button id="btnArm" class="btn btn-success" onclick="armRace()">ARM SYSTEM</button>
      <button id="btnReset" class="btn btn-accent" onclick="resetRace()">RESET</button>
      <button id="btnSync" class="btn btn-primary" onclick="syncClock()">SYNC CLOCK</button>
    </div>

    <!-- Dry-Run Controls (hidden in kiosk mode) -->
    <div class="kiosk-hide" style="margin-top:8px;">
      <button id="btnDryRun" class="btn btn-outline btn-sm" onclick="toggleDryRun()" style="width:100%;">&#x1F9EA; ENABLE DRY RUN</button>
    </div>

    <!-- Science Fair Testing (Playlist Mode) — hidden in kiosk mode -->
    <details id="playlistSection" class="section kiosk-hide">
      <summary class="section-title" style="cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px;">
        <span aria-hidden="true" style="font-size:1.2em;">&#x1F9EA;</span>
        SCIENCE FAIR TESTING
        <span id="playlistBadge" class="playlist-badge" style="display:none;"></span>
      </summary>

      <!-- ===== SETUP PHASE ===== -->
      <div id="plSetup">
        <!-- Car Selector -->
        <div style="margin:12px 0;">
          <h3 style="font-size:0.9rem; font-weight:700; margin-bottom:8px; color:var(--accent);">SELECT TEST VEHICLES</h3>
          <div id="plCarSelector" class="pl-car-selector" role="group" aria-label="Select cars to include in test playlist">
            <p class="text-muted">Add cars to the garage first</p>
          </div>
          <button class="btn btn-outline btn-sm" onclick="plSelectAllCars()" style="margin-top:4px;">Select All</button>
        </div>

        <!-- Weight Conditions -->
        <div style="margin:12px 0;">
          <h3 style="font-size:0.9rem; font-weight:700; margin-bottom:8px; color:var(--accent);">WEIGHT CONDITIONS</h3>
          <p class="text-muted" style="font-size:0.8rem; margin-bottom:6px;">
            Define each weight condition. Enter exact scale readings for precise calculations.
          </p>
          <div id="plConditions">
            <!-- Baseline always present -->
            <div class="pl-condition-row" data-index="0">
              <input type="text" value="No added weight" class="pl-cond-label" aria-label="Condition label" readonly>
              <input type="number" value="0" class="pl-cond-weight" step="0.1" min="0" aria-label="Added weight in grams" readonly>
              <span class="pl-cond-unit">g</span>
              <span style="width:30px;"></span>
            </div>
          </div>
          <div class="grid grid-3" style="margin-top:6px; gap:6px;">
            <input type="text" id="plNewCondLabel" placeholder="e.g. +14g tungsten" aria-label="New condition label">
            <input type="number" id="plNewCondWeight" placeholder="e.g. 14.2" step="0.001" min="0.001" aria-label="Added weight in grams">
            <button class="btn btn-accent btn-sm" onclick="plAddCondition()">ADD CONDITION</button>
          </div>
        </div>

        <!-- Trials Per Condition -->
        <div style="margin:12px 0;">
          <label for="plTrials" style="font-size:0.9rem; font-weight:700; color:var(--accent);">TRIALS PER CONDITION</label>
          <input type="number" id="plTrials" value="3" min="2" max="10" style="width:80px; margin-left:8px;">
        </div>

        <!-- Test Plan Preview -->
        <div id="plPreview" style="display:none; margin:12px 0;">
          <h3 style="font-size:0.9rem; font-weight:700; margin-bottom:8px; color:var(--secondary);">TEST PLAN PREVIEW</h3>
          <div id="plPreviewTable" style="max-height:300px; overflow-y:auto; font-size:0.8rem;"></div>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-2" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="plGeneratePlan()">GENERATE TEST PLAN</button>
          <button class="btn btn-success" id="plStartBtn" onclick="plStartTesting()" disabled>START TESTING</button>
        </div>
      </div>

      <!-- ===== ACTIVE PHASE ===== -->
      <div id="plActive" style="display:none;">
        <!-- Big instruction banner -->
        <div id="plBanner" class="pl-banner" role="status" aria-live="assertive">
          <div id="plRunLabel" class="pl-run-label">Run 1 of 1</div>
          <div id="plInstruction" class="pl-instruction">Loading...</div>
          <div id="plTrialLabel" class="pl-trial-label">Trial 1 of 3</div>
        </div>

        <!-- Progress bar -->
        <div class="pl-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Test progress">
          <div id="plProgressBar" class="pl-progress-bar" style="width:0%;"></div>
          <span id="plProgressText" class="pl-progress-text">0%</span>
        </div>

        <!-- Condition change alert (hidden until needed) -->
        <div id="plConditionAlert" class="pl-condition-alert" style="display:none;" role="alert">
          <strong>ATTENTION:</strong> <span id="plConditionAlertText"></span>
        </div>

        <!-- Active controls -->
        <div class="grid grid-3" style="margin:8px 0;">
          <button class="btn btn-accent" onclick="plSkipRun()">SKIP RUN</button>
          <button class="btn btn-primary" id="plPauseBtn" onclick="plTogglePause()">PAUSE</button>
          <button class="btn btn-danger" onclick="plStopTesting()">STOP TESTING</button>
        </div>

        <!-- Live results table -->
        <div style="margin-top:12px; overflow-x:auto;">
          <table class="pl-results-table">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Car</th>
                <th scope="col">Condition</th>
                <th scope="col">Trial</th>
                <th scope="col">Time (s)</th>
                <th scope="col">Speed (m/s)</th>
                <th scope="col">Weight (g)</th>
              </tr>
            </thead>
            <tbody id="plResultsBody">
              <tr><td colspan="7" class="text-center text-muted">Waiting for first run...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ===== COMPLETED PHASE ===== -->
      <div id="plCompleted" style="display:none;">
        <div class="pl-complete-banner" role="status">
          <span style="font-size:1.5em;" aria-hidden="true">&#x1F3C6;</span>
          ALL TESTS COMPLETE!
        </div>

        <!-- Summary table with averages -->
        <div id="plSummary" style="margin:12px 0; overflow-x:auto;"></div>

        <!-- Export buttons -->
        <div class="grid grid-3" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="plExportCSV()">EXPORT RAW CSV</button>
          <button class="btn btn-success" onclick="plExportSummary()">EXPORT SUMMARY</button>
          <button class="btn btn-danger" onclick="plClearAndRestart()">CLEAR &amp; START OVER</button>
        </div>
      </div>
    </details>

    <!-- System Status Panel (shown in dry-run, collapsible otherwise) -->
    <div id="systemStatusPanel" class="section" style="display:none;">
      <h2 class="section-title">SYSTEM STATUS</h2>
      <div class="grid grid-2" id="systemStatusGrid">
        <div class="card"><div class="card-label">WebSocket</div><div class="card-value" id="sysWs">--</div></div>
        <div class="card"><div class="card-label">Peer Link</div><div class="card-value" id="sysPeer">--</div></div>
        <div class="card"><div class="card-label">Peers Online</div><div class="card-value" id="sysPeerCount">--</div></div>
        <div class="card"><div class="card-label">LiDAR</div><div class="card-value" id="sysLidar">--</div></div>
        <div class="card"><div class="card-label">Dry Run</div><div class="card-value" id="sysDryRun">OFF</div></div>
        <div class="card"><div class="card-label">Race State</div><div class="card-value" id="sysRaceState">--</div></div>
      </div>
    </div>

    <!-- Live Stats -->
    <div class="grid">
      <div class="card" id="timeCard">
        <div class="card-label">Time</div>
        <div><span id="statTime" class="card-value">--</span><span class="card-unit">s</span></div>
      </div>
      <div class="card">
        <div class="card-label">Real Speed</div>
        <div><span id="statSpeed" class="card-value">--</span><span class="card-unit" id="speedUnitLabel">mph</span></div>
      </div>
      <div class="card card-accent">
        <div class="card-label" id="scaleLabel">Scale Speed (1:64)</div>
        <div><span id="statScale" class="card-value">--</span><span class="card-unit" id="scaleUnitLabel">mph</span></div>
      </div>
    </div>

    <!-- Physics -->
    <div class="grid">
      <div class="card">
        <div class="card-label">Momentum</div>
        <div><span id="statMomentum" class="card-value">--</span><span class="card-unit">kg*m/s</span></div>
      </div>
      <div class="card">
        <div class="card-label">Kinetic Energy</div>
        <div><span id="statKE" class="card-value">--</span><span class="card-unit">J</span></div>
      </div>
      <div class="card">
        <div class="card-label">Total Runs</div>
        <div><span id="statRuns" class="card-value">0</span></div>
      </div>
    </div>

    <!-- Most Wanted -- Criminal Leaderboard -->
    <div class="section most-wanted" id="mostWantedSection">
      <h2 class="section-title">MOST WANTED</h2>
      <div class="mw-header">
        <div class="mw-sort-controls">
          <button class="mw-sort-btn active" onclick="sortMostWanted('time')" id="mwSortTime">Fastest</button>
          <button class="mw-sort-btn" onclick="sortMostWanted('speed')" id="mwSortSpeed">Top Speed</button>
          <button class="mw-sort-btn" onclick="sortMostWanted('runs')" id="mwSortRuns">Most Offenses</button>
          <button class="mw-sort-btn" onclick="sortMostWanted('ke')" id="mwSortKe">Most Dangerous</button>
        </div>
        <button class="mw-toggle" onclick="toggleMostWanted()" id="mwToggle"
          aria-expanded="true" aria-controls="mwBoard">Collapse</button>
      </div>
      <div id="mwBoard" class="mw-board">
        <div class="mw-empty">No suspects in the system. Add cars to the garage and run races to populate the Most Wanted list.</div>
      </div>
    </div>

    <!-- Speed Profile (mid-track data from speed trap) -->
    <div id="speedProfileSection" class="section speed-profile">
      <h2 class="section-title">SPEED PROFILE</h2>
      <div class="pt-8">
        <div class="speed-bar">
          <div class="speed-bar-label">Finish</div>
          <div class="speed-bar-fill"><div id="speedBarFinish" style="width:0; background:var(--accent);"></div></div>
          <span id="speedValFinish" class="font-data" style="font-size:0.85rem; width:70px;">-- mph</span>
        </div>
        <div class="speed-bar">
          <div class="speed-bar-label">Mid-Track</div>
          <div class="speed-bar-fill"><div id="speedBarMid" style="width:0; background:var(--secondary);"></div></div>
          <span id="speedValMid" class="font-data" style="font-size:0.85rem; width:70px;">-- mph</span>
        </div>
      </div>
    </div>

    <!-- Ghost Car Comparison -->
    <div id="ghostSection" class="section">
      <h2 class="section-title">VS PERSONAL BEST</h2>
      <div class="text-center" style="padding:15px;">
        <div id="ghostDelta" style="font-size:3rem; font-weight:900; line-height:1.2;"></div>
        <div id="ghostLabel" class="text-muted" style="font-size:1rem; margin-top:8px;"></div>
      </div>
    </div>

    <!-- Evidence Lab (Charts) -->
    <div class="section" id="chartsSection">
      <h2 class="section-title">EVIDENCE LAB</h2>
      <div class="grid grid-2 mt-8">
        <div class="chart-container"><canvas id="speedChart" height="250" role="img" aria-label="Speed versus run number chart"></canvas></div>
        <div class="chart-container"><canvas id="keChart" height="250" role="img" aria-label="Kinetic energy versus mass chart"></canvas></div>
      </div>
    </div>

    <!-- Forensic Analysis (Physics Explainer) -->
    <div class="section" id="physicsExplainer">
      <h2 class="section-title">FORENSIC ANALYSIS</h2>
      <button id="explainerToggle" onclick="toggleExplainer()" class="btn btn-outline" style="width:100%;"
        aria-expanded="false" aria-controls="explainerContent">Show Formulas</button>
      <div id="explainerContent" style="display:none;">
        <div class="formula-grid">
          <div class="formula-card">
            <div class="formula-title">SPEED (Velocity)</div>
            <div class="formula-eq">v = d / t</div>
            <div class="formula-desc">velocity = distance &divide; time</div>
            <div id="formulaSpeed" class="formula-values">Run a race to see values!</div>
          </div>
          <div class="formula-card">
            <div class="formula-title">MOMENTUM</div>
            <div class="formula-eq">p = m &times; v</div>
            <div class="formula-desc">momentum = mass &times; velocity</div>
            <div id="formulaMomentum" class="formula-values">Run a race to see values!</div>
          </div>
          <div class="formula-card">
            <div class="formula-title">KINETIC ENERGY</div>
            <div class="formula-eq">KE = &frac12; m v&sup2;</div>
            <div class="formula-desc">kinetic energy = one half &times; mass &times; velocity squared</div>
            <div id="formulaKE" class="formula-values">Run a race to see values!</div>
          </div>
          <div class="formula-card">
            <div class="formula-title">G-FORCE</div>
            <div class="formula-eq">a = v / t</div>
            <div class="formula-desc">acceleration = velocity &divide; time, then &divide; 9.8 for G's</div>
            <div id="formulaGForce" class="formula-values">Run a race to see values!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- The Garage (hidden in kiosk mode) -->
    <div class="section kiosk-hide">
      <h2 class="section-title">THE GARAGE</h2>
      <div class="grid grid-3">
        <div><label for="carName" class="card-label">Suspect Vehicle</label>
        <input type="text" id="carName" placeholder="e.g. Twin Mill"></div>
        <div><label for="carColor" class="card-label">Color</label>
        <input type="text" id="carColor" placeholder="e.g. Red"></div>
        <div><label for="carWeight" class="card-label">Mass (grams)</label>
        <input type="number" id="carWeight" placeholder="e.g. 35.000" min="0" step="0.001"></div>
      </div>
      <button id="addCarBtn" class="btn btn-accent" onclick="addCar()">ADD TO GARAGE</button>
      <div id="currentCar" class="text-center text-muted" style="margin:15px 0; font-size:1.2rem; font-weight:bold;">
        No suspect vehicle selected
      </div>
      <div id="garageGrid" class="garage-grid"></div>
      <div id="garageStatus" class="text-center" style="margin:8px 0; font-size:0.85rem; font-weight:bold; min-height:1.2em;"></div>
      <div class="grid grid-4">
        <button class="btn btn-success" onclick="manualSaveGarage()">SAVE GARAGE</button>
        <button class="btn btn-primary" onclick="exportGarage()">EXPORT</button>
        <label class="btn btn-accent" style="text-align:center; cursor:pointer;">
          IMPORT
          <input type="file" accept=".json" onchange="importGarage(event)" style="display:none;">
        </label>
        <button class="btn btn-danger" onclick="clearGarage()">CLEAR</button>
      </div>
      <div class="grid grid-3" style="margin-top:6px;">
        <button class="btn btn-outline btn-sm" onclick="evShowNfcWriterHelper()">&#x1F4F1; NFC TAGS</button>
        <button class="btn btn-outline btn-sm" onclick="evShowTagsOverlay(evidenceLog.slice(-10))">&#x1F3F7; EVIDENCE LOG</button>
        <button class="btn btn-outline btn-sm" onclick="evShowTagsOverlay([{caseNumber:evGetCaseNumber(),timestamp:new Date().toISOString(),car:activeCar?activeCar.name:'Select a car',weight:activeCar?activeCar.weight:0,time_s:0,speed_mps:0}])">&#x1F4CB; BLANK TAG</button>
      </div>
    </div>

    <!-- Operations (hidden in kiosk mode) -->
    <div class="section kiosk-hide">
      <h2 class="section-title">OPERATIONS</h2>
      <div class="grid">
        <div>
          <label for="trackLength" class="card-label" id="trackLengthLabel">Track Length (meters)</label>
          <input type="number" id="trackLength" value="2.0" min="0" step="0.01" onchange="updateTrackLength()">
        </div>
        <div>
          <label for="sheetsUrl" class="card-label">Google Sheets URL (optional)</label>
          <input type="text" id="sheetsUrl" placeholder="https://script.google.com/..." onchange="saveSheetsUrl()">
          <div id="sheetsStatus" class="text-muted" style="font-size:0.8rem; margin-top:4px;"></div>
        </div>
      </div>
      <div class="grid grid-3">
        <button class="btn btn-primary" onclick="exportCSV()">DOWNLOAD CSV</button>
        <button class="btn btn-success" onclick="testSheetsUpload()">TEST SHEETS</button>
        <button class="btn btn-danger" onclick="clearHistory()">CLEAR HISTORY</button>
      </div>
    </div>

    <!-- Case File (History) -->
    <div class="section">
      <h2 class="section-title">CASE FILE</h2>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th scope="col">Run</th><th scope="col">Suspect</th><th scope="col">Mass</th><th scope="col">Time</th>
              <th scope="col" id="thRealSpeed">Real MPH</th><th scope="col" id="thScaleSpeed">Scale MPH</th><th scope="col">Momentum</th><th scope="col">KE</th>
            </tr>
          </thead>
          <tbody id="historyTable">
            <tr><td colspan="8" class="text-center text-muted">No evidence recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Leaderboard Overlay (Criminal Verdict) -->
  <div id="leaderboardOverlay" class="leaderboard-overlay" onclick="closeLeaderboard();"
       role="dialog" aria-modal="true" aria-labelledby="lbVerdict" aria-describedby="lbText">
    <div class="leaderboard-card" onclick="event.stopPropagation();">
      <div id="lbVerdict" style="font-size:0.85rem; font-weight:900; letter-spacing:2px; color:var(--danger); text-transform:uppercase; margin-bottom:4px;"></div>
      <div id="lbRank" class="leaderboard-rank">#1</div>
      <div id="lbText" class="leaderboard-text"></div>
      <div id="lbDetail" class="leaderboard-detail"></div>
      <div id="lbThreat" style="margin-top:12px; padding:6px 14px; border-radius:6px; font-size:0.8rem; font-weight:900; display:inline-block;"></div>
    </div>
  </div>

  <!-- Version Badge -->
  <div class="version-badge" id="versionBadge">v--</div>

  <script src="/main.js"></script>
  <script src="/chart.min.js"></script>
  <script>
    // ========================================================================
    // DASHBOARD-SPECIFIC STATE
    // ========================================================================
    var currentScaleFactor = 64;
    var configSheetsUrl = '';
    var _lastAnnouncedState = '';
    var _lastRaceTime = '';

    // Update all unit labels on the page when units change
    function updateUnitLabels() {
      var su = speedUnit();
      var el;
      el = document.getElementById('speedUnitLabel'); if (el) el.textContent = su;
      el = document.getElementById('scaleUnitLabel'); if (el) el.textContent = su;
      el = document.getElementById('trackLengthLabel'); if (el) el.textContent = 'Track Length (meters)';
      el = document.getElementById('thRealSpeed'); if (el) el.textContent = 'Real ' + su.toUpperCase();
      el = document.getElementById('thScaleSpeed'); if (el) el.textContent = 'Scale ' + su.toUpperCase();
    }

    // ========================================================================
    // STATE HANDLING
    // ========================================================================
    function handleStateUpdate(data) {
      if (data.role) {
        var roleName = data.role.charAt(0).toUpperCase() + data.role.slice(1);
        document.title = roleName + ' - M.A.S.S. Trap Command Center';
      }
      // Unit system from firmware config
      if (data.units) {
        setUnits(data.units);
        updateUnitLabels();
      }
      if (data.scaleFactor) {
        currentScaleFactor = data.scaleFactor;
        document.getElementById('scaleLabel').textContent = 'Scale Speed (1:' + currentScaleFactor + ')';
      }
      if (data.google_sheets_url && !document.getElementById('sheetsUrl').value) {
        document.getElementById('sheetsUrl').value = data.google_sheets_url;
        configSheetsUrl = data.google_sheets_url;
      }
      if (data.trackLength) {
        document.getElementById('trackLength').value = data.trackLength;
      }

      // LiDAR indicator
      if (data.lidar) {
        var lidarEl = document.getElementById('lidarIndicator');
        if (data.lidar.state === 'staged') {
          lidarEl.className = 'lidar-indicator staged';
          lidarEl.textContent = 'LIDAR TARGET ACQUIRED (' + data.lidar.distance_mm + 'mm)';
        } else {
          lidarEl.className = 'lidar-indicator';
        }
      }

      // State banner
      var banner = document.getElementById('stateBanner');
      banner.className = 'state-banner ' + data.state.toLowerCase();
      var themeBannerText = {
        interceptor: { IDLE: 'AWAITING SUSPECTS', ARMED: 'TRAP SET', RACING: 'IN PURSUIT', FINISHED: 'SUSPECT CLOCKED' },
        classic:     { IDLE: 'READY TO RACE!', ARMED: 'ON YOUR MARKS...', RACING: 'GO GO GO!', FINISHED: 'FINISH LINE!' },
        daytona:     { IDLE: 'PIT LANE', ARMED: 'GREEN FLAG', RACING: 'FULL SEND', FINISHED: 'CHECKERED FLAG' },
        casefile:    { IDLE: 'CASE OPEN', ARMED: 'STAKEOUT ACTIVE', RACING: 'SUSPECT FLEEING', FINISHED: 'EVIDENCE LOGGED' },
        cyber:       { IDLE: 'SYSTEM IDLE', ARMED: 'ARMED // READY', RACING: 'TRACKING...', FINISHED: 'TARGET ACQUIRED' }
      };
      var currentTheme = (localStorage.getItem('mass_theme') || 'interceptor').toLowerCase();
      var bannerText = themeBannerText[currentTheme] || themeBannerText.interceptor;
      var stateText = bannerText[data.state] || data.state;
      // Prepend active car name so you always know what's loaded
      if (activeCar && activeCar.name) {
        banner.textContent = activeCar.name.toUpperCase() + ' \u2014 ' + stateText;
      } else {
        banner.textContent = stateText;
      }

      // Dispatcher: announce state changes (once per transition)
      if (data.state !== _lastAnnouncedState) {
        _lastAnnouncedState = data.state;
        if (data.state === 'ARMED') announce('System armed. Awaiting target.');
        else if (data.state === 'RACING') announce('Target acquired. Pursuit active.');
        // FINISHED announced below with full race data
      }

      // LED visualizer
      document.getElementById('ledBar').className = 'led-bar ' + data.state.toLowerCase();

      // Hide ghost when not finished
      if (data.state !== 'FINISHED') { document.getElementById('ghostSection').style.display = 'none'; }

      // Timer silencing: hide running timer from screen readers during RACING
      var timeCard = document.getElementById('timeCard');
      if (data.state === 'RACING') {
        timeCard.setAttribute('aria-hidden', 'true');
      } else {
        timeCard.removeAttribute('aria-hidden');
      }

      // Stats — unit-aware speed display
      document.getElementById('statTime').textContent = data.time ? safeFixed(data.time, 3) : '--';
      if (data.speed_mps) {
        document.getElementById('statSpeed').textContent = formatSpeed(data.speed_mps, 1);
        document.getElementById('statScale').textContent = formatSpeed(data.speed_mps * currentScaleFactor, 0);
      } else {
        document.getElementById('statSpeed').textContent = data.speed_mph ? mphToDisplaySpeed(data.speed_mph) : '--';
        document.getElementById('statScale').textContent = data.scale_mph ? mphToDisplaySpeed(data.scale_mph).split('.')[0] : '--';
      }
      document.getElementById('statMomentum').textContent = data.momentum ? safeFixed(data.momentum, 4) : '--';
      document.getElementById('statKE').textContent = data.ke ? safeFixed(data.ke, 4) : '--';
      document.getElementById('statRuns').textContent = data.totalRuns || 0;

      // Speed profile (mid-track from speed trap node) — unit-aware
      if (data.speed_mps && data.midTrack_mps) {
        updateSpeedProfile(data.speed_mps, data.midTrack_mps);
      } else if (data.midTrack_mph && data.speed_mph) {
        // Fallback: convert mph back to mps for consistent display
        updateSpeedProfile(data.speed_mph / MPS_TO_MPH, data.midTrack_mph / MPS_TO_MPH);
      }

      // Update dry-run state from firmware
      updateDryRunUI(data.dryRun);

      // Update system status panel
      updateSystemStatus(data);

      // Race finished
      if (data.state === 'FINISHED' && data.time !== undefined) {
        showGhostComparison(data);

        // Dry-run guard: skip data persistence when dry-run is active
        if (!data.dryRun) {
          updateGarageStats(data);
          addToHistory(data);
        }
        addRaceToCharts(data);
        updateExplainerValues(data);

        // Playlist mode: suppress leaderboard overlay during testing, record result instead
        if (playlistMode.active && !playlistMode.paused) {
          // Record evidence with playlist context
          var plTest = playlistMode.tests[playlistMode.currentIndex] || null;
          if (!data.dryRun) evRecordRun(data, plTest);
          plOnRaceFinished(data);
          // Announce within playlist context (plOnRaceFinished handles the advance announce)
          _lastRaceTime = safeFixed(data.time, 3) + ' seconds';
        } else {
          // Record evidence for non-playlist runs
          if (!data.dryRun) evRecordRun(data, null);
          showLeaderboardOverlay(data);
          // Dispatcher: announce race result
          var carName = data.car || (activeCar ? activeCar.name : 'Unknown vehicle');
          _lastRaceTime = safeFixed(data.time, 3) + ' seconds';
          var dryLabel = data.dryRun ? ' (dry run)' : '';
          announce('Suspect clocked. ' + carName + '. ' + _lastRaceTime + '.' + dryLabel);
        }

        var sheetsUrl = document.getElementById('sheetsUrl').value || configSheetsUrl;
        if (sheetsUrl && data.time > 0 && !data.dryRun) { uploadToSheets(data, sheetsUrl); }
      }

      // Button states
      var btnArm = document.getElementById('btnArm');
      if (data.state === 'IDLE') {
        btnArm.disabled = false;
        btnArm.textContent = 'ARM SYSTEM';
      } else {
        btnArm.disabled = true;
        btnArm.textContent = data.state;
      }
    }

    // ========================================================================
    // SPEED PROFILE
    // ========================================================================
    // Speed profile now takes m/s values and converts to display unit
    function updateSpeedProfile(finishMps, midMps) {
      var section = document.getElementById('speedProfileSection');
      section.classList.add('visible');
      var finishDisplay = parseFloat(formatSpeed(finishMps, 1));
      var midDisplay = parseFloat(formatSpeed(midMps, 1));
      var maxVal = Math.max(finishDisplay, midDisplay) * 1.2;
      document.getElementById('speedBarFinish').style.width = (finishDisplay / maxVal * 100) + '%';
      document.getElementById('speedBarMid').style.width = (midDisplay / maxVal * 100) + '%';
      document.getElementById('speedValFinish').textContent = finishDisplay.toFixed(1) + ' ' + speedUnit();
      document.getElementById('speedValMid').textContent = midDisplay.toFixed(1) + ' ' + speedUnit();
    }

    // ========================================================================
    // LEADERBOARD OVERLAY (Criminal Verdict)
    // ========================================================================
    function showLeaderboardOverlay(data) {
      if (!data.time || data.time <= 0) return;
      // Find rank among all cars
      var allBests = garage.filter(function(c) { return c.stats && c.stats.bestTime != null && isFinite(c.stats.bestTime); })
                          .map(function(c) { return { name: c.name, time: c.stats.bestTime }; });
      allBests.sort(function(a, b) { return a.time - b.time; });
      var rank = allBests.findIndex(function(b) { return b.name === (activeCar ? activeCar.name : ''); }) + 1;
      if (rank <= 0 || allBests.length < 2) return;

      var overlay = document.getElementById('leaderboardOverlay');
      var rankText = '#' + rank;
      document.getElementById('lbRank').textContent = rankText;
      document.getElementById('lbRank').style.color = rank === 1 ? 'var(--accent)' : rank <= 3 ? 'var(--secondary)' : 'var(--text-muted)';

      // Criminal verdict text
      var verdictEl = document.getElementById('lbVerdict');
      var threatEl = document.getElementById('lbThreat');
      var msg = '', verdict = '', threatClass = '', threatText = '';

      if (rank === 1) {
        verdict = 'ALL POINTS BULLETIN';
        msg = 'PUBLIC ENEMY #1';
        threatClass = 'armed-dangerous';
        threatText = 'ARMED & DANGEROUS';
      } else if (rank === 2) {
        verdict = 'WARRANT ISSUED';
        msg = 'MOST WANTED #2';
        threatClass = 'armed-dangerous';
        threatText = 'ARMED & DANGEROUS';
      } else if (rank === 3) {
        verdict = 'SUSPECT IDENTIFIED';
        msg = 'MOST WANTED #3';
        threatClass = 'known-offender';
        threatText = 'KNOWN OFFENDER';
      } else if (rank <= Math.ceil(allBests.length / 2)) {
        verdict = 'BOOKING REPORT';
        msg = 'KNOWN OFFENDER #' + rank;
        threatClass = 'known-offender';
        threatText = 'KNOWN OFFENDER';
      } else {
        verdict = 'INCIDENT REPORT';
        msg = 'PERSON OF INTEREST #' + rank;
        threatClass = 'person-of-interest';
        threatText = 'PERSON OF INTEREST';
      }

      verdictEl.textContent = verdict;
      document.getElementById('lbText').textContent = msg;
      var scaleDisplay = data.speed_mps ? formatSpeed(data.speed_mps * currentScaleFactor, 0) : safeFixed(data.scale_mph || 0, 0);
      document.getElementById('lbDetail').textContent =
        (activeCar ? activeCar.name : 'Unknown') + ' | ' +
        safeFixed(data.time, 3) + 's | ' + scaleDisplay + ' scale ' + speedUnit();

      threatEl.textContent = threatText;
      threatEl.className = '';
      threatEl.style.background = threatClass === 'armed-dangerous' ? 'rgba(var(--danger-rgb),0.2)' :
                                   threatClass === 'known-offender' ? 'rgba(var(--accent-rgb),0.15)' :
                                   'rgba(128,128,128,0.1)';
      threatEl.style.border = '1px solid ' + (threatClass === 'armed-dangerous' ? 'var(--danger)' :
                               threatClass === 'known-offender' ? 'var(--accent)' : 'var(--text-muted)');
      threatEl.style.color = threatClass === 'armed-dangerous' ? 'var(--danger)' :
                              threatClass === 'known-offender' ? 'var(--accent)' : 'var(--text-muted)';

      overlay.classList.add('show');
      // Focus management: save current focus, move to overlay
      overlay._prevFocus = document.activeElement;
      overlay.setAttribute('tabindex', '-1');
      overlay.focus();
      setTimeout(function() { closeLeaderboard(); }, 5000);

      // Refresh the Most Wanted board
      renderMostWanted();
    }

    function closeLeaderboard() {
      var overlay = document.getElementById('leaderboardOverlay');
      overlay.classList.remove('show');
      // Restore focus to element that was active before overlay opened
      if (overlay._prevFocus && typeof overlay._prevFocus.focus === 'function') {
        overlay._prevFocus.focus();
        overlay._prevFocus = null;
      }
    }

    // ========================================================================
    // MOST WANTED -- Criminal Leaderboard
    // ========================================================================
    var mwSortMode = 'time';
    var mwCollapsed = false;

    function toggleMostWanted() {
      mwCollapsed = !mwCollapsed;
      document.getElementById('mwBoard').style.display = mwCollapsed ? 'none' : 'grid';
      document.querySelector('.mw-sort-controls').style.display = mwCollapsed ? 'none' : 'flex';
      var toggle = document.getElementById('mwToggle');
      toggle.textContent = mwCollapsed ? 'Expand' : 'Collapse';
      toggle.setAttribute('aria-expanded', mwCollapsed ? 'false' : 'true');
    }

    function sortMostWanted(mode) {
      mwSortMode = mode;
      document.querySelectorAll('.mw-sort-btn').forEach(function(b) { b.classList.remove('active'); });
      document.getElementById('mwSort' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
      renderMostWanted();
    }

    function getMostWantedData() {
      return garage
        .filter(function(c) { return c.stats && c.stats.runs > 0; })
        .map(function(c) {
          var s = c.stats;
          var carHistory = history.filter(function(h) { return h.car === c.name; });
          var bestKE = carHistory.length > 0 ? Math.max.apply(null, carHistory.map(function(h) { return h.ke || 0; })) : 0;
          var bestScaleMph = carHistory.length > 0 ? Math.max.apply(null, carHistory.map(function(h) { return h.scale_mph || 0; })) : 0;
          return {
            name: c.name,
            color: c.color || 'N/A',
            weight: c.weight,
            bestTime: s.bestTime,
            bestSpeed: s.bestSpeed || 0,
            bestScaleMph: bestScaleMph,
            runs: s.runs || 0,
            bestKE: bestKE,
            id: c.id
          };
        });
    }

    function sortMWData(data) {
      switch (mwSortMode) {
        case 'time':
          return data.sort(function(a, b) {
            if (a.bestTime == null) return 1;
            if (b.bestTime == null) return -1;
            return a.bestTime - b.bestTime;
          });
        case 'speed':
          return data.sort(function(a, b) { return b.bestSpeed - a.bestSpeed; });
        case 'runs':
          return data.sort(function(a, b) { return b.runs - a.runs; });
        case 'ke':
          return data.sort(function(a, b) { return b.bestKE - a.bestKE; });
        default:
          return data;
      }
    }

    function getThreatLevel(rank, total) {
      if (rank <= 3) return { cls: 'armed-dangerous', text: 'ARMED & DANGEROUS' };
      if (rank <= Math.max(5, Math.ceil(total * 0.5))) return { cls: 'known-offender', text: 'KNOWN OFFENDER' };
      return { cls: 'person-of-interest', text: 'PERSON OF INTEREST' };
    }

    function getRankTitle(rank) {
      if (rank === 1) return 'PUBLIC ENEMY #1';
      if (rank <= 3) return 'MOST WANTED';
      return 'APB #' + rank;
    }

    function getSortValue(item) {
      switch (mwSortMode) {
        case 'time': return item.bestTime != null ? safeFixed(item.bestTime, 3) + 's' : '--';
        case 'speed': return mphToDisplaySpeed(item.bestSpeed) + ' ' + speedUnit();
        case 'runs': return item.runs + ' offense' + (item.runs !== 1 ? 's' : '');
        case 'ke': return safeFixed(item.bestKE, 4) + ' J';
        default: return '';
      }
    }

    function renderMostWanted() {
      var board = document.getElementById('mwBoard');
      var data = getMostWantedData();

      if (data.length === 0) {
        board.innerHTML = '<div class="mw-empty">No suspects in the system. Add cars to the garage and run races to populate the Most Wanted list.</div>';
        return;
      }

      data = sortMWData(data);
      var total = data.length;

      board.innerHTML = data.map(function(item, i) {
        var rank = i + 1;
        var threat = getThreatLevel(rank, total);
        var rankTitle = getRankTitle(rank);
        var rankClass = rank <= 3 ? ' rank-' + rank : '';
        var isActive = activeCar && activeCar.id === item.id;

        return '<div class="mw-card' + rankClass + (isActive ? ' mw-new-record' : '') + '">' +
          '<div class="mw-rank">' + rankTitle + '</div>' +
          '<div class="mw-name">' + item.name + '</div>' +
          '<div class="mw-stats">' +
            '<div>Time: <strong>' + (item.bestTime != null ? safeFixed(item.bestTime, 3) + 's' : '--') + '</strong></div>' +
            '<div>Speed: <strong>' + mphToDisplaySpeed(item.bestSpeed) + ' ' + speedUnit() + '</strong></div>' +
            '<div>Scale: <strong>' + mphToDisplaySpeed(item.bestScaleMph).split('.')[0] + ' ' + speedUnit() + '</strong></div>' +
            '<div>Mass: <strong>' + item.weight + 'g</strong></div>' +
            '<div>Offenses: <strong>' + item.runs + '</strong></div>' +
            '<div>KE: <strong>' + safeFixed(item.bestKE, 4) + ' J</strong></div>' +
          '</div>' +
          '<div class="mw-threat ' + threat.cls + '">' + threat.text + '</div>' +
        '</div>';
      }).join('');
    }

    // ========================================================================
    // RACE CONTROL
    // ========================================================================
    function armRace() { wsSend({ cmd: 'arm' }); }
    function resetRace() { wsSend({ cmd: 'reset' }); }
    function syncClock() { wsSend({ cmd: 'syncClock' }); alert('Clock sync requested!'); }
    function updateTrackLength() {
      var length = parseFloat(document.getElementById('trackLength').value);
      if (length > 0 && length < 100) { wsSend({ cmd: 'setTrack', length: length }); }
    }

    // ========================================================================
    // GARAGE MANAGEMENT
    // ========================================================================
    var garage = [];
    var activeCar = JSON.parse(localStorage.getItem('hw_active_car') || 'null');
    var editingCarIndex = -1;

    function setCurrentCarDisplay(car) {
      var el = document.getElementById('currentCar');
      el.textContent = '';
      el.appendChild(document.createTextNode('Active Suspect: '));
      var span = document.createElement('span');
      span.style.color = 'var(--accent)';
      span.textContent = car.name;
      el.appendChild(span);
      el.appendChild(document.createTextNode(' (' + car.weight + 'g)'));
    }

    async function loadGarageFromESP() {
      try {
        var resp = await fetch('/api/garage');
        var data = await resp.json();
        if (Array.isArray(data) && data.length > 0) { garage = data; }
        else {
          var local = JSON.parse(localStorage.getItem('hw_garage') || '[]');
          if (local.length > 0) { garage = local; await saveGarageToESP(); }
        }
      } catch (e) {
        garage = JSON.parse(localStorage.getItem('hw_garage') || '[]');
      }
      renderGarage();
    }

    async function saveGarageToESP() {
      localStorage.setItem('hw_garage', JSON.stringify(garage));
      var saved = false;
      for (var attempt = 0; attempt < 2; attempt++) {
        try {
          var resp = await fetch('/api/garage', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(garage) });
          if (resp.ok) { saved = true; break; }
        } catch (e) {}
      }
      return saved;
    }

    async function saveGarage() {
      renderGarage();
      var ok = await saveGarageToESP();
      showGarageStatus(ok ? 'Garage saved!' : 'Save failed - try SAVE GARAGE button', ok);
    }

    function showGarageStatus(msg, success) {
      var el = document.getElementById('garageStatus');
      if (!el) return;
      el.textContent = msg;
      el.style.color = success ? 'var(--success)' : 'var(--danger)';
      setTimeout(function() { el.textContent = ''; }, 3000);
    }

    async function manualSaveGarage() {
      showGarageStatus('Saving...', true);
      var ok = await saveGarageToESP();
      showGarageStatus(ok ? 'Garage saved to ESP32!' : 'Failed to save', ok);
    }

    async function clearGarage() {
      if (garage.length === 0) { alert('Garage is already empty!'); return; }
      var c = prompt('Type CLEAR to delete all ' + garage.length + ' cars:');
      if (c !== 'CLEAR') return;
      garage = [];
      activeCar = null;
      localStorage.removeItem('hw_active_car');
      localStorage.removeItem('hw_garage');
      document.getElementById('currentCar').textContent = 'No suspect vehicle selected';
      renderGarage();
      var ok = await saveGarageToESP();
      showGarageStatus(ok ? 'Garage cleared!' : 'Cleared locally but ESP32 save failed', ok);
    }

    function exportGarage() {
      if (garage.length === 0) { alert('No cars to export!'); return; }
      var blob = new Blob([JSON.stringify(garage, null, 2)], { type: 'application/json' });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'masstrap_garage_' + Date.now() + '.json';
      a.click();
      window.URL.revokeObjectURL(url);
      showGarageStatus('Garage exported!', true);
    }

    function importGarage(event) {
      var file = event.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = async function(e) {
        try {
          var imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) { alert('Invalid garage file'); return; }
          for (var i = 0; i < imported.length; i++) {
            var car = imported[i];
            if (!car.name || !car.weight) { alert('Invalid car data'); return; }
            if (!car.stats) car.stats = { runs: 0, bestTime: null, bestSpeed: 0 };
            if (!car.id) car.id = Date.now() + Math.random();
          }
          if (garage.length > 0) {
            var choice = confirm('Replace all? Cancel to merge.');
            if (choice) { garage = imported; }
            else {
              var added = 0;
              for (var j = 0; j < imported.length; j++) {
                var ic = imported[j];
                if (!garage.some(function(g) { return g.name.toLowerCase() === ic.name.toLowerCase(); })) { garage.push(ic); added++; }
              }
              showGarageStatus('Merged ' + added + ' new cars', true);
            }
          } else { garage = imported; }
          await saveGarage();
          showGarageStatus('Imported ' + imported.length + ' cars!', true);
        } catch (err) { alert('Failed to parse: ' + err.message); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    async function addCar() {
      var name = document.getElementById('carName').value.trim();
      var color = document.getElementById('carColor').value.trim();
      var weight = parseFloat(document.getElementById('carWeight').value);
      if (!name || name.length < 1 || name.length > 30) { alert('Name must be 1-30 characters!'); return; }
      if (!weight || weight < 1 || weight > 200) { alert('Mass must be 1-200 grams!'); return; }

      if (editingCarIndex >= 0) {
        garage[editingCarIndex].name = name;
        garage[editingCarIndex].color = color || 'N/A';
        garage[editingCarIndex].weight = weight;
        if (activeCar && activeCar.id === garage[editingCarIndex].id) {
          activeCar = garage[editingCarIndex];
          localStorage.setItem('hw_active_car', JSON.stringify(activeCar));
          wsSend({ cmd: 'setCar', name: activeCar.name, weight: activeCar.weight });
          setCurrentCarDisplay(activeCar);
        }
        editingCarIndex = -1;
        document.getElementById('addCarBtn').textContent = 'ADD TO GARAGE';
      } else {
        if (garage.some(function(c) { return c.name.toLowerCase() === name.toLowerCase(); })) {
          alert('Car already exists! Click pencil to edit.'); return;
        }
        garage.push({ id: Date.now(), name: name, color: color || 'N/A', weight: weight,
          stats: { runs: 0, bestTime: null, bestSpeed: 0 }, notes: [] });
      }
      await saveGarage();
      document.getElementById('carName').value = '';
      document.getElementById('carColor').value = '';
      document.getElementById('carWeight').value = '';
    }

    function editCar(index, event) {
      event.stopPropagation();
      editingCarIndex = index;
      var car = garage[index];
      document.getElementById('carName').value = car.name;
      document.getElementById('carColor').value = car.color === 'N/A' ? '' : car.color;
      document.getElementById('carWeight').value = car.weight;
      document.getElementById('addCarBtn').textContent = 'SAVE CHANGES';
      document.getElementById('carName').focus();
    }

    function selectCar(index) {
      activeCar = garage[index];
      localStorage.setItem('hw_active_car', JSON.stringify(activeCar));
      wsSend({ cmd: 'setCar', name: activeCar.name, weight: activeCar.weight });
      setCurrentCarDisplay(activeCar);
      updateBannerCarName();
      renderGarage();
      // Dispatcher: announce car selection
      announce(activeCar.name + ' loaded. ' + activeCar.weight + ' grams.');
    }

    // Refresh banner text with current car name (called on car select + state change)
    function updateBannerCarName() {
      var banner = document.getElementById('stateBanner');
      if (!banner) return;
      var themeBannerText = {
        interceptor: { IDLE: 'AWAITING SUSPECTS', ARMED: 'TRAP SET', RACING: 'IN PURSUIT', FINISHED: 'SUSPECT CLOCKED' },
        classic:     { IDLE: 'READY TO RACE!', ARMED: 'ON YOUR MARKS...', RACING: 'GO GO GO!', FINISHED: 'FINISH LINE!' },
        daytona:     { IDLE: 'PIT LANE', ARMED: 'GREEN FLAG', RACING: 'FULL SEND', FINISHED: 'CHECKERED FLAG' },
        casefile:    { IDLE: 'CASE OPEN', ARMED: 'STAKEOUT ACTIVE', RACING: 'SUSPECT FLEEING', FINISHED: 'EVIDENCE LOGGED' },
        cyber:       { IDLE: 'SYSTEM IDLE', ARMED: 'ARMED // READY', RACING: 'TRACKING...', FINISHED: 'TARGET ACQUIRED' }
      };
      var currentTheme = (localStorage.getItem('mass_theme') || 'interceptor').toLowerCase();
      var texts = themeBannerText[currentTheme] || themeBannerText.interceptor;
      // Detect current state from banner class
      var state = 'IDLE';
      if (banner.classList.contains('armed')) state = 'ARMED';
      else if (banner.classList.contains('racing')) state = 'RACING';
      else if (banner.classList.contains('finished')) state = 'FINISHED';
      var stateText = texts[state] || state;
      if (activeCar && activeCar.name) {
        banner.textContent = activeCar.name.toUpperCase() + ' \u2014 ' + stateText;
      } else {
        banner.textContent = stateText;
      }
    }

    async function deleteCar(index, event) {
      event.stopPropagation();
      if (confirm('Delete ' + garage[index].name + '?')) {
        var deletedId = garage[index].id;
        garage.splice(index, 1);
        if (activeCar && activeCar.id === deletedId) {
          activeCar = null;
          localStorage.removeItem('hw_active_car');
          document.getElementById('currentCar').textContent = 'No suspect vehicle selected';
        }
        if (editingCarIndex === index) editingCarIndex = -1;
        await saveGarage();
      }
    }

    // Mechanic's Log: add note to car
    async function addNote(index) {
      var input = document.getElementById('noteInput_' + index);
      if (!input || !input.value.trim()) return;
      if (!garage[index].notes) garage[index].notes = [];
      garage[index].notes.push({ text: input.value.trim(), ts: Date.now() });
      if (garage[index].notes.length > 20) garage[index].notes = garage[index].notes.slice(-20);
      input.value = '';
      await saveGarage();
    }

    function renderGarage() {
      var grid = document.getElementById('garageGrid');
      // Keep playlist car selector in sync with garage
      if (typeof plRenderCarSelector === 'function') { try { plRenderCarSelector(); } catch(e) {} }
      if (garage.length === 0) {
        grid.innerHTML = '<p style="grid-column:1/-1;" class="text-center text-muted">No suspects in garage</p>';
        return;
      }
      grid.innerHTML = garage.map(function(car, i) {
        if (!car.stats) car.stats = { runs: 0, bestTime: null, bestSpeed: 0 };
        var hasBest = car.stats.bestTime != null && car.stats.bestTime !== Infinity && isFinite(car.stats.bestTime);
        var isActive = activeCar && activeCar.id === car.id;
        var bestStr = hasBest ? safeFixed(car.stats.bestTime, 3) + ' seconds' : 'no runs';
        var label = escHtml(car.name) + ', ' + car.weight + ' grams, ' + bestStr + (isActive ? ', selected' : '');
        var notes = car.notes || [];
        var notesHtml = notes.slice(-3).map(function(n) {
          return '<div class="mech-note">' + new Date(n.ts).toLocaleDateString() + ': ' + n.text + '</div>';
        }).join('');
        return '<div class="garage-car ' + (isActive ? 'active' : '') + '" ' +
          'role="button" tabindex="0" ' +
          'onclick="selectCar(' + i + ')" ' +
          'onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();selectCar(' + i + ')}" ' +
          'aria-pressed="' + (isActive ? 'true' : 'false') + '" ' +
          'aria-label="' + label + '">' +
          '<button class="delete-btn" onclick="deleteCar(' + i + ', event)" aria-label="Delete ' + escHtml(car.name) + '">x</button>' +
          '<button class="edit-btn" onclick="editCar(' + i + ', event)" aria-label="Edit ' + escHtml(car.name) + '">&#9998;</button>' +
          '<h3>' + car.name + '</h3>' +
          '<p>' + (car.color || '') + '</p>' +
          '<p>' + car.weight + 'g</p>' +
          '<div class="garage-stats">' +
            '<span>Runs: ' + (car.stats.runs || 0) + '</span>' +
            '<span>Best: ' + (hasBest ? safeFixed(car.stats.bestTime, 3) : '--') + 's</span>' +
          '</div>' +
          '<div class="mech-notes">' +
            notesHtml +
            '<label for="noteInput_' + i + '" class="sr-only">Add note for ' + escHtml(car.name) + '</label>' +
            '<input type="text" id="noteInput_' + i + '" class="mech-note-input" placeholder="Add note..." onclick="event.stopPropagation();" onkeydown="if(event.key===\'Enter\')addNote(' + i + ')">' +
            '<button class="btn btn-primary mech-add-btn" onclick="event.stopPropagation(); addNote(' + i + ');" aria-label="Save note for ' + escHtml(car.name) + '">+</button>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    async function updateGarageStats(raceData) {
      if (!activeCar) return;
      var carIndex = garage.findIndex(function(c) { return c.id === activeCar.id; });
      if (carIndex === -1) return;
      if (!garage[carIndex].stats) garage[carIndex].stats = { runs: 0, bestTime: null, bestSpeed: 0 };
      garage[carIndex].stats.runs++;
      var prevBest = garage[carIndex].stats.bestTime;
      if (prevBest == null || raceData.time < prevBest) garage[carIndex].stats.bestTime = raceData.time;
      if (raceData.speed_mph > (garage[carIndex].stats.bestSpeed || 0)) garage[carIndex].stats.bestSpeed = raceData.speed_mph;
      await saveGarage();
    }

    // ========================================================================
    // HISTORY MANAGEMENT
    // ========================================================================
    var history = [];

    async function loadHistoryFromESP() {
      try {
        var resp = await fetch('/api/history');
        var data = await resp.json();
        if (Array.isArray(data) && data.length > 0) { history = data; }
        else {
          var local = JSON.parse(localStorage.getItem('hw_history') || '[]');
          if (local.length > 0) { history = local; await saveHistoryToESP(); }
        }
      } catch (e) {
        history = JSON.parse(localStorage.getItem('hw_history') || '[]');
      }
      renderHistory();
    }

    async function saveHistoryToESP() {
      localStorage.setItem('hw_history', JSON.stringify(history));
      try {
        await fetch('/api/history', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(history) });
      } catch (e) {}
    }

    function addToHistory(raceData) {
      var entry = {
        timestamp: Date.now(),
        run: raceData.totalRuns,
        car: raceData.car,
        weight: raceData.weight,
        time: raceData.time,
        speed_mps: raceData.speed_mps || (raceData.speed_mph / MPS_TO_MPH),
        speed_mph: raceData.speed_mph,
        scale_mph: raceData.scale_mph,
        momentum: raceData.momentum,
        ke: raceData.ke
      };
      if (raceData.midTrack_mph) entry.midTrack_mph = raceData.midTrack_mph;
      if (raceData.midTrack_mps) entry.midTrack_mps = raceData.midTrack_mps;
      history.unshift(entry);
      if (history.length > 100) history = history.slice(0, 100);
      saveHistoryToESP();
      renderHistory();
    }

    function renderHistory() {
      var tbody = document.getElementById('historyTable');
      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No evidence recorded yet</td></tr>';
        return;
      }
      tbody.innerHTML = history.slice(0, 20).map(function(h) {
        var displaySpeed = h.speed_mps ? formatSpeed(h.speed_mps, 1) : mphToDisplaySpeed(h.speed_mph);
        var displayScale = h.speed_mps ? formatSpeed(h.speed_mps * currentScaleFactor, 0) : mphToDisplaySpeed(h.scale_mph).split('.')[0];
        return '<tr>' +
          '<td>#' + h.run + '</td>' +
          '<td><strong class="text-accent">' + h.car + '</strong></td>' +
          '<td>' + h.weight + 'g</td>' +
          '<td class="font-data">' + safeFixed(h.time, 3) + 's</td>' +
          '<td>' + displaySpeed + '</td>' +
          '<td><strong class="text-accent">' + displayScale + '</strong></td>' +
          '<td>' + safeFixed(h.momentum, 3) + '</td>' +
          '<td>' + safeFixed(h.ke, 4) + '</td>' +
        '</tr>';
      }).join('');
    }

    function clearHistory() {
      var c = prompt('Type DELETE to clear all evidence:');
      if (c === 'DELETE') { history = []; saveHistoryToESP(); renderHistory(); }
    }

    // ========================================================================
    // DATA EXPORT
    // ========================================================================
    function exportCSV() {
      if (history.length === 0) { alert('No data!'); return; }
      var su = speedUnit();
      var csv = 'Run,Timestamp,Car,Weight(g),Time(s),Speed(' + su + '),Scale(' + su + '),Speed(m/s),Momentum,KE\n';
      history.forEach(function(h) {
        var displaySpeed = h.speed_mps ? formatSpeed(h.speed_mps, 2) : mphToDisplaySpeed(h.speed_mph);
        var displayScale = h.speed_mps ? formatSpeed(h.speed_mps * currentScaleFactor, 1) : mphToDisplaySpeed(h.scale_mph);
        var rawMps = h.speed_mps || (h.speed_mph / MPS_TO_MPH);
        csv += h.run + ',' + new Date(h.timestamp).toISOString() + ',' + h.car + ',' + h.weight + ',' + h.time + ',' + displaySpeed + ',' + displayScale + ',' + safeFixed(rawMps, 3) + ',' + h.momentum + ',' + h.ke + '\n';
      });
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'masstrap_data_' + Date.now() + '.csv';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function uploadToSheets(data, url) {
      var status = document.getElementById('sheetsStatus');
      status.textContent = 'Uploading...';
      status.style.color = 'var(--secondary)';
      fetch(url, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ timestamp: new Date().toISOString(), car: data.car, weight: data.weight,
          time: data.time, speed_mph: data.speed_mph, scale_mph: data.scale_mph, momentum: data.momentum, ke: data.ke })
      }).then(function() {
        status.textContent = 'Sent!'; status.style.color = 'var(--success)';
        setTimeout(function() { status.textContent = ''; }, 3000);
      }).catch(function(err) { status.textContent = 'Failed'; status.style.color = 'var(--danger)'; });
    }

    function saveSheetsUrl() {
      var url = document.getElementById('sheetsUrl').value.trim();
      configSheetsUrl = url;
      wsSend({ cmd: 'setSheetsUrl', url: url });
      var status = document.getElementById('sheetsStatus');
      status.textContent = 'URL saved'; status.style.color = 'var(--success)';
      setTimeout(function() { status.textContent = ''; }, 2000);
    }

    function testSheetsUpload() {
      var url = document.getElementById('sheetsUrl').value.trim() || configSheetsUrl;
      if (!url) { alert('Enter a Google Sheets URL first!'); return; }
      uploadToSheets({ car: 'TEST', weight: 35, time: 1.234, speed_mph: 1.62, scale_mph: 103.7, momentum: 0.057, ke: 0.023 }, url);
    }

    // ========================================================================
    // GHOST CAR COMPARISON
    // ========================================================================
    function showGhostComparison(raceData) {
      var section = document.getElementById('ghostSection');
      var deltaEl = document.getElementById('ghostDelta');
      var labelEl = document.getElementById('ghostLabel');
      if (!activeCar) { section.style.display = 'none'; return; }
      var carIndex = garage.findIndex(function(c) { return c.id === activeCar.id; });
      if (carIndex === -1 || !garage[carIndex].stats) { section.style.display = 'none'; return; }
      var prevBest = garage[carIndex].stats.bestTime;
      if (prevBest == null || !isFinite(prevBest)) {
        section.style.display = 'block';
        section.className = 'section new-record';
        deltaEl.textContent = 'FIRST RUN!';
        deltaEl.style.color = 'var(--success)';
        labelEl.textContent = safeFixed(raceData.time, 3) + 's is the benchmark for ' + activeCar.name;
        return;
      }
      var delta = raceData.time - prevBest;
      section.style.display = 'block';
      if (delta < 0) {
        section.className = 'section new-record';
        deltaEl.textContent = safeFixed(delta, 3) + 's';
        deltaEl.style.color = 'var(--success)';
        labelEl.textContent = 'NEW RECORD! Previous: ' + safeFixed(prevBest, 3) + 's';
      } else if (delta === 0) {
        section.className = 'section new-record';
        deltaEl.textContent = 'TIED!';
        deltaEl.style.color = 'var(--accent)';
        labelEl.textContent = 'Matched record: ' + safeFixed(prevBest, 3) + 's';
      } else {
        section.className = 'section slower';
        deltaEl.textContent = '+' + safeFixed(delta, 3) + 's';
        deltaEl.style.color = 'var(--danger)';
        labelEl.textContent = 'Record: ' + safeFixed(prevBest, 3) + 's';
      }
    }

    // ========================================================================
    // CHART.JS
    // ========================================================================
    var speedChart = null;
    var keChart = null;

    function initCharts() {
      if (typeof Chart === 'undefined') return;
      // Read theme colors from CSS variables so charts adapt per theme
      var cs = getComputedStyle(document.documentElement);
      var cAccent = cs.getPropertyValue('--accent').trim() || '#d4af37';
      var cSecondary = cs.getPropertyValue('--secondary').trim() || '#4a90d9';
      var cMuted = cs.getPropertyValue('--text-muted').trim() || '#8888aa';
      var cBorder = cs.getPropertyValue('--border').trim() || '#2a2a4a';
      var cSecRgb = cs.getPropertyValue('--secondary-rgb').trim() || '74,144,217';

      Chart.defaults.color = cMuted;
      Chart.defaults.borderColor = cBorder;

      var su = speedUnit();
      speedChart = new Chart(document.getElementById('speedChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Speed (' + su + ')', data: [],
          borderColor: cSecondary, backgroundColor: 'rgba(' + cSecRgb + ',0.1)',
          borderWidth: 2, pointBackgroundColor: cAccent, pointRadius: 4, tension: 0.1, fill: true }] },
        options: { responsive: true,
          plugins: { title: { display: true, text: 'Speed vs Run', font: { size: 14, weight: 'bold' }, color: cAccent }, legend: { display: false } },
          scales: { x: { title: { display: true, text: 'Run #' } }, y: { title: { display: true, text: 'Speed (' + su + ')' }, beginAtZero: true } } }
      });

      keChart = new Chart(document.getElementById('keChart').getContext('2d'), {
        type: 'scatter',
        data: { datasets: [{ label: 'KE vs Mass', data: [],
          backgroundColor: cAccent, pointRadius: 6, pointHoverRadius: 8 }] },
        options: { responsive: true,
          plugins: { title: { display: true, text: 'Kinetic Energy vs Mass', font: { size: 14, weight: 'bold' }, color: cAccent }, legend: { display: false },
            tooltip: { callbacks: { label: function(ctx) { return ctx.raw.car + ': ' + safeFixed(ctx.raw.y, 4) + 'J @ ' + ctx.raw.x + 'g'; } } } },
          scales: { x: { title: { display: true, text: 'Mass (g)' } }, y: { title: { display: true, text: 'Kinetic Energy (J)' }, beginAtZero: true } } }
      });

      updateChartsFromHistory();
    }

    function updateChartsFromHistory() {
      if (!speedChart || !keChart) return;
      var c = history.slice().reverse();
      speedChart.data.labels = c.map(function(h, i) { return '#' + (h.run || i + 1); });
      speedChart.data.datasets[0].data = c.map(function(h) {
        return h.speed_mps ? parseFloat(formatSpeed(h.speed_mps, 2)) : parseFloat(mphToDisplaySpeed(h.speed_mph));
      });
      speedChart.update();
      keChart.data.datasets[0].data = c.map(function(h) { return { x: h.weight, y: h.ke, car: h.car }; });
      keChart.update();
    }

    function addRaceToCharts(raceData) {
      if (!speedChart || !keChart) return;
      speedChart.data.labels.push('#' + (raceData.totalRuns || speedChart.data.labels.length + 1));
      var chartSpeed = raceData.speed_mps ? parseFloat(formatSpeed(raceData.speed_mps, 2)) : parseFloat(mphToDisplaySpeed(raceData.speed_mph));
      speedChart.data.datasets[0].data.push(chartSpeed);
      speedChart.update();
      keChart.data.datasets[0].data.push({ x: raceData.weight, y: raceData.ke, car: raceData.car });
      keChart.update();
    }

    // ========================================================================
    // PHYSICS EXPLAINER
    // ========================================================================
    var explainerOpen = false;
    function toggleExplainer() {
      explainerOpen = !explainerOpen;
      document.getElementById('explainerContent').style.display = explainerOpen ? 'block' : 'none';
      var toggle = document.getElementById('explainerToggle');
      toggle.textContent = explainerOpen ? 'Hide Formulas' : 'Show Formulas';
      toggle.setAttribute('aria-expanded', explainerOpen ? 'true' : 'false');
    }

    function updateExplainerValues(data) {
      if (!data.time || data.time <= 0) return;
      var d = parseFloat(document.getElementById('trackLength').value) || 2.0;
      var t = data.time;
      var v_ms = d / t;
      var m_kg = (data.weight || 35) / 1000.0;
      var gForce = (v_ms / t) / 9.8;
      document.getElementById('formulaSpeed').innerHTML =
        'v = ' + d.toFixed(2) + 'm &divide; ' + t.toFixed(3) + 's = <strong>' + v_ms.toFixed(2) + ' m/s</strong> (' + formatSpeed(v_ms, 1) + ' ' + speedUnit() + ')';
      document.getElementById('formulaMomentum').innerHTML =
        'p = ' + m_kg.toFixed(3) + 'kg &times; ' + v_ms.toFixed(2) + 'm/s = <strong>' + (m_kg * v_ms).toFixed(4) + ' kg&middot;m/s</strong>';
      document.getElementById('formulaKE').innerHTML =
        'KE = 0.5 &times; ' + m_kg.toFixed(3) + 'kg &times; ' + v_ms.toFixed(2) + '&sup2; = <strong>' + (0.5 * m_kg * v_ms * v_ms).toFixed(4) + ' J</strong>';
      document.getElementById('formulaGForce').innerHTML =
        'a = ' + v_ms.toFixed(2) + 'm/s &divide; ' + t.toFixed(3) + 's &divide; 9.8 = <strong>' + gForce.toFixed(2) + ' G</strong>';
    }

    // ========================================================================
    // DRY-RUN MODE — Race without logging/saving data
    // ========================================================================
    var _dryRunActive = false;

    function toggleDryRun() {
      _dryRunActive = !_dryRunActive;
      wsSend({ cmd: 'setDryRun', enabled: _dryRunActive });
    }

    function updateDryRunUI(isDryRun) {
      _dryRunActive = !!isDryRun;
      var banner = document.getElementById('dryRunBanner');
      var btn = document.getElementById('btnDryRun');
      var panel = document.getElementById('systemStatusPanel');

      if (banner) banner.style.display = _dryRunActive ? 'block' : 'none';
      if (btn) {
        btn.textContent = _dryRunActive ? '\uD83E\uDDEA DISABLE DRY RUN' : '\uD83E\uDDEA ENABLE DRY RUN';
        btn.className = _dryRunActive ? 'btn btn-danger btn-sm' : 'btn btn-outline btn-sm';
        btn.style.width = '100%';
      }
      if (panel) panel.style.display = _dryRunActive ? 'block' : 'none';
    }

    function updateSystemStatus(data) {
      var wsEl = document.getElementById('sysWs');
      var peerEl = document.getElementById('sysPeer');
      var countEl = document.getElementById('sysPeerCount');
      var lidarEl = document.getElementById('sysLidar');
      var dryEl = document.getElementById('sysDryRun');
      var stateEl = document.getElementById('sysRaceState');
      if (!wsEl) return;

      wsEl.textContent = wsConnected ? 'LINKED' : 'OFFLINE';
      wsEl.style.color = wsConnected ? '#28a745' : '#dc3545';

      peerEl.textContent = data.connected ? 'ONLINE' : 'OFFLINE';
      peerEl.style.color = data.connected ? '#28a745' : '#dc3545';

      countEl.textContent = (data.onlinePeers || 0) + ' / ' + (data.peerCount || 0);

      if (data.lidar) {
        lidarEl.textContent = data.lidar.state.toUpperCase() + ' (' + data.lidar.distance_mm + 'mm)';
        lidarEl.style.color = '#28a745';
      } else {
        lidarEl.textContent = 'N/A';
        lidarEl.style.color = 'var(--text-muted)';
      }

      dryEl.textContent = data.dryRun ? 'ACTIVE' : 'OFF';
      dryEl.style.color = data.dryRun ? '#ff6600' : '#28a745';

      stateEl.textContent = data.state || '--';
    }

    // ========================================================================
    // PLAYLIST MODE — Science Fair Guided Testing
    // ========================================================================
    var playlistMode = {
      active: false,
      paused: false,
      tests: [],
      currentIndex: 0,
      results: [],
      config: {
        trialsPerCondition: 3,
        conditions: [{ label: 'No added weight', addedWeight: 0 }],
        selectedCarIds: []
      }
    };

    // --- Restore from localStorage on load ---
    function plRestoreState() {
      try {
        var savedConfig = JSON.parse(localStorage.getItem('mass_playlist_config') || 'null');
        if (savedConfig) {
          playlistMode.config = savedConfig;
          plRenderConditions();
        }
        var savedState = JSON.parse(localStorage.getItem('mass_playlist_state') || 'null');
        if (savedState && savedState.active) {
          playlistMode.active = savedState.active;
          playlistMode.paused = savedState.paused || false;
          playlistMode.tests = savedState.tests;
          playlistMode.currentIndex = savedState.currentIndex;
          playlistMode.results = savedState.results;
          // Resume active UI
          plShowPhase('active');
          plUpdateActiveUI();
          if (playlistMode.paused) {
            document.getElementById('plPauseBtn').textContent = 'RESUME';
          }
        }
      } catch (e) { console.error('[PLAYLIST] Restore failed:', e); }
    }

    function plSaveConfig() {
      localStorage.setItem('mass_playlist_config', JSON.stringify(playlistMode.config));
    }

    function plSaveState() {
      localStorage.setItem('mass_playlist_state', JSON.stringify({
        active: playlistMode.active,
        paused: playlistMode.paused,
        tests: playlistMode.tests,
        currentIndex: playlistMode.currentIndex,
        results: playlistMode.results
      }));
    }

    // --- Car Selector ---
    function plRenderCarSelector() {
      var container = document.getElementById('plCarSelector');
      if (garage.length === 0) {
        container.innerHTML = '<p class="text-muted">Add cars to the garage first</p>';
        return;
      }
      container.innerHTML = garage.map(function(car) {
        var checked = playlistMode.config.selectedCarIds.indexOf(car.id) !== -1;
        return '<label class="pl-car-check' + (checked ? ' checked' : '') + '">' +
          '<input type="checkbox" ' + (checked ? 'checked' : '') +
          ' onchange="plToggleCar(' + car.id + ', this)" aria-label="Include ' + escHtml(car.name) + '">' +
          escHtml(car.name) + ' (' + car.weight + 'g)</label>';
      }).join('');
    }

    function plToggleCar(carId, checkbox) {
      var idx = playlistMode.config.selectedCarIds.indexOf(carId);
      if (checkbox.checked && idx === -1) {
        playlistMode.config.selectedCarIds.push(carId);
      } else if (!checkbox.checked && idx !== -1) {
        playlistMode.config.selectedCarIds.splice(idx, 1);
      }
      // Update visual state
      checkbox.parentElement.classList.toggle('checked', checkbox.checked);
      plSaveConfig();
      // Hide preview when selection changes
      document.getElementById('plPreview').style.display = 'none';
      document.getElementById('plStartBtn').disabled = true;
    }

    function plSelectAllCars() {
      playlistMode.config.selectedCarIds = garage.map(function(c) { return c.id; });
      plSaveConfig();
      plRenderCarSelector();
    }

    // --- Weight Conditions ---
    function plRenderConditions() {
      var container = document.getElementById('plConditions');
      container.innerHTML = playlistMode.config.conditions.map(function(cond, i) {
        var isBaseline = (i === 0);
        return '<div class="pl-condition-row" data-index="' + i + '">' +
          '<input type="text" value="' + escHtml(cond.label) + '" class="pl-cond-label"' +
            (isBaseline ? ' readonly' : ' onchange="plUpdateCondLabel(' + i + ', this.value)"') +
            ' aria-label="Condition ' + (i + 1) + ' label">' +
          '<input type="number" value="' + cond.addedWeight + '" class="pl-cond-weight" step="0.1" min="0"' +
            (isBaseline ? ' readonly' : ' onchange="plUpdateCondWeight(' + i + ', this.value)"') +
            ' aria-label="Condition ' + (i + 1) + ' weight">' +
          '<span class="pl-cond-unit">g</span>' +
          (isBaseline ? '<span style="width:30px;"></span>' :
            '<button class="pl-cond-remove" onclick="plRemoveCondition(' + i + ')" aria-label="Remove condition ' + escHtml(cond.label) + '">X</button>') +
        '</div>';
      }).join('');
      // Sync trials input
      document.getElementById('plTrials').value = playlistMode.config.trialsPerCondition;
    }

    function plAddCondition() {
      var label = document.getElementById('plNewCondLabel').value.trim();
      var weight = parseFloat(document.getElementById('plNewCondWeight').value);
      if (!label) { alert('Enter a label for this condition (e.g. "+14g tungsten")'); return; }
      if (isNaN(weight) || weight <= 0) { alert('Enter the added weight in grams (must be > 0)'); return; }
      playlistMode.config.conditions.push({ label: label, addedWeight: weight });
      document.getElementById('plNewCondLabel').value = '';
      document.getElementById('plNewCondWeight').value = '';
      plRenderConditions();
      plSaveConfig();
      // Hide preview when conditions change
      document.getElementById('plPreview').style.display = 'none';
      document.getElementById('plStartBtn').disabled = true;
    }

    function plRemoveCondition(index) {
      if (index === 0) return; // Can't remove baseline
      playlistMode.config.conditions.splice(index, 1);
      plRenderConditions();
      plSaveConfig();
      document.getElementById('plPreview').style.display = 'none';
      document.getElementById('plStartBtn').disabled = true;
    }

    function plUpdateCondLabel(index, value) {
      playlistMode.config.conditions[index].label = value.trim();
      plSaveConfig();
    }

    function plUpdateCondWeight(index, value) {
      var w = parseFloat(value);
      if (!isNaN(w) && w >= 0) {
        playlistMode.config.conditions[index].addedWeight = w;
        plSaveConfig();
      }
    }

    // --- Test Matrix Generator (Locard's Principle) ---
    // Order: for each condition (ascending weight) → for each trial → for each car
    // This spreads trials apart and cycles cars within each trial round
    function plGenerateMatrix() {
      var selectedCars = garage.filter(function(c) {
        return playlistMode.config.selectedCarIds.indexOf(c.id) !== -1;
      });
      var conditions = playlistMode.config.conditions;
      var trials = parseInt(document.getElementById('plTrials').value) || 3;
      playlistMode.config.trialsPerCondition = trials;
      plSaveConfig();

      var tests = [];
      var runNum = 0;
      for (var ci = 0; ci < conditions.length; ci++) {
        for (var ti = 0; ti < trials; ti++) {
          for (var cari = 0; cari < selectedCars.length; cari++) {
            runNum++;
            var car = selectedCars[cari];
            tests.push({
              index: runNum,
              carId: car.id,
              carName: car.name,
              baseWeight: car.weight,
              addedWeight: conditions[ci].addedWeight,
              totalWeight: Math.round((car.weight + conditions[ci].addedWeight) * 10) / 10,
              conditionLabel: conditions[ci].label,
              conditionIndex: ci,
              trial: ti + 1,
              totalTrials: trials
            });
          }
        }
      }
      return tests;
    }

    function plGeneratePlan() {
      // Validate
      if (playlistMode.config.selectedCarIds.length === 0) {
        alert('Select at least one car from the garage!');
        return;
      }
      if (playlistMode.config.conditions.length < 2) {
        alert('Add at least one weight condition beyond the baseline!');
        return;
      }

      var tests = plGenerateMatrix();
      playlistMode.tests = tests;

      // Render preview
      var preview = document.getElementById('plPreview');
      var table = document.getElementById('plPreviewTable');
      var html = '<table class="pl-results-table">' +
        '<thead><tr><th>#</th><th>Car</th><th>Condition</th><th>Added (g)</th><th>Total (g)</th><th>Trial</th></tr></thead><tbody>';
      var lastCondIdx = -1;
      for (var i = 0; i < tests.length; i++) {
        var t = tests[i];
        var condChange = (t.conditionIndex !== lastCondIdx);
        lastCondIdx = t.conditionIndex;
        html += '<tr' + (condChange && i > 0 ? ' style="border-top:2px solid var(--accent);"' : '') + '>' +
          '<td>' + t.index + '</td>' +
          '<td>' + escHtml(t.carName) + '</td>' +
          '<td>' + escHtml(t.conditionLabel) + '</td>' +
          '<td>' + t.addedWeight.toFixed(1) + '</td>' +
          '<td>' + t.totalWeight.toFixed(1) + '</td>' +
          '<td>' + t.trial + ' of ' + t.totalTrials + '</td></tr>';
      }
      html += '</tbody></table>';
      table.innerHTML = html;
      preview.style.display = 'block';
      document.getElementById('plStartBtn').disabled = false;

      // Update badge
      var badge = document.getElementById('playlistBadge');
      badge.textContent = tests.length + ' runs';
      badge.style.display = 'inline';

      announce('Test plan generated. ' + tests.length + ' total runs across ' +
        playlistMode.config.conditions.length + ' conditions.');
    }

    // --- Phase Switching ---
    function plShowPhase(phase) {
      document.getElementById('plSetup').style.display = phase === 'setup' ? 'block' : 'none';
      document.getElementById('plActive').style.display = phase === 'active' ? 'block' : 'none';
      document.getElementById('plCompleted').style.display = phase === 'completed' ? 'block' : 'none';
    }

    // --- Start Testing ---
    function plStartTesting() {
      if (playlistMode.tests.length === 0) {
        alert('Generate a test plan first!');
        return;
      }
      playlistMode.active = true;
      playlistMode.paused = false;
      playlistMode.currentIndex = 0;
      playlistMode.results = new Array(playlistMode.tests.length);
      for (var i = 0; i < playlistMode.results.length; i++) {
        playlistMode.results[i] = null;
      }

      plShowPhase('active');
      plSaveState();

      // Open the details element if closed
      var details = document.getElementById('playlistSection');
      if (details) details.open = true;

      // Load first test
      plLoadCurrentTest();

      var firstTest = playlistMode.tests[0];
      announce('Science fair testing started. ' + playlistMode.tests.length + ' runs total. ' +
        'First up: ' + firstTest.carName + ', ' + firstTest.conditionLabel + ', trial 1.');
    }

    // --- Load Current Test into System ---
    function plLoadCurrentTest() {
      var test = playlistMode.tests[playlistMode.currentIndex];
      if (!test) return;

      // Send setCar to firmware with total weight
      wsSend({ cmd: 'setCar', name: test.carName, weight: test.totalWeight });

      // Update activeCar locally for banner display
      var carIndex = garage.findIndex(function(c) { return c.id === test.carId; });
      if (carIndex !== -1) {
        activeCar = garage[carIndex];
        localStorage.setItem('hw_active_car', JSON.stringify(activeCar));
        setCurrentCarDisplay({ name: test.carName, weight: test.totalWeight });
      }

      // Update active phase UI
      plUpdateActiveUI();

      // Auto-arm after a short delay
      setTimeout(function() {
        if (playlistMode.active && !playlistMode.paused) {
          wsSend({ cmd: 'arm' });
        }
      }, 1000);
    }

    // --- Update Active Phase UI ---
    function plUpdateActiveUI() {
      var test = playlistMode.tests[playlistMode.currentIndex];
      if (!test) return;

      var total = playlistMode.tests.length;
      var current = playlistMode.currentIndex + 1;

      // Banner
      document.getElementById('plRunLabel').textContent = 'Run ' + current + ' of ' + total;
      document.getElementById('plInstruction').textContent =
        test.carName + ' \u2014 ' + test.conditionLabel;
      document.getElementById('plTrialLabel').textContent =
        'Trial ' + test.trial + ' of ' + test.totalTrials +
        ' | Total weight: ' + test.totalWeight.toFixed(1) + 'g';

      // Progress bar
      var pct = Math.round((playlistMode.currentIndex / total) * 100);
      var progressBar = document.getElementById('plProgressBar');
      var progressContainer = progressBar.parentElement;
      progressBar.style.width = pct + '%';
      document.getElementById('plProgressText').textContent = pct + '%';
      progressContainer.setAttribute('aria-valuenow', pct);

      // Badge
      var badge = document.getElementById('playlistBadge');
      badge.textContent = current + '/' + total;
      badge.style.display = 'inline';

      // Results table
      plRenderResultsTable();
    }

    // --- Results Table ---
    function plRenderResultsTable() {
      var tbody = document.getElementById('plResultsBody');
      var rows = [];
      for (var i = 0; i < playlistMode.tests.length; i++) {
        var test = playlistMode.tests[i];
        var result = playlistMode.results[i];
        var isCurrent = (i === playlistMode.currentIndex && playlistMode.active);
        var cls = isCurrent ? ' class="pl-current"' : '';
        if (result && result.skipped) cls = ' class="pl-skipped"';

        if (result && !result.skipped) {
          rows.push('<tr' + cls + '>' +
            '<td>' + test.index + '</td>' +
            '<td>' + escHtml(test.carName) + '</td>' +
            '<td>' + escHtml(test.conditionLabel) + '</td>' +
            '<td>' + test.trial + '</td>' +
            '<td class="font-data">' + safeFixed(result.time_s, 4) + '</td>' +
            '<td>' + safeFixed(result.speed_mps, 3) + '</td>' +
            '<td>' + test.totalWeight.toFixed(1) + '</td></tr>');
        } else if (result && result.skipped) {
          rows.push('<tr' + cls + '><td>' + test.index + '</td><td>' + escHtml(test.carName) +
            '</td><td colspan="5" class="text-muted">Skipped</td></tr>');
        } else if (isCurrent) {
          rows.push('<tr' + cls + '><td>' + test.index + '</td><td>' + escHtml(test.carName) +
            '</td><td>' + escHtml(test.conditionLabel) + '</td><td>' + test.trial +
            '</td><td colspan="3" class="text-muted">Waiting...</td></tr>');
        }
        // Don't render future rows to keep table compact
      }
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Waiting for first run...</td></tr>';
      } else {
        tbody.innerHTML = rows.join('');
        // Scroll to current row
        var currentRow = tbody.querySelector('.pl-current');
        if (currentRow) currentRow.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    // --- Handle Race Finish During Playlist ---
    function plOnRaceFinished(data) {
      if (!playlistMode.active || playlistMode.paused) return;
      if (playlistMode.currentIndex >= playlistMode.tests.length) return;

      var test = playlistMode.tests[playlistMode.currentIndex];
      var speed_mps = data.speed_mps || (data.speed_mph ? data.speed_mph / MPS_TO_MPH : 0);
      var mass_kg = test.totalWeight / 1000.0;

      playlistMode.results[playlistMode.currentIndex] = {
        time_s: data.time,
        speed_mps: speed_mps,
        speed_mph: data.speed_mph || (speed_mps * MPS_TO_MPH),
        momentum: mass_kg * speed_mps,
        ke: 0.5 * mass_kg * speed_mps * speed_mps,
        timestamp: Date.now()
      };

      plSaveState();
      plUpdateActiveUI();

      // Check if all done
      if (playlistMode.currentIndex >= playlistMode.tests.length - 1) {
        // All tests complete!
        plCompleteTesting();
        return;
      }

      // Determine if next test has a different condition (weight change alert)
      var nextIndex = playlistMode.currentIndex + 1;
      var nextTest = playlistMode.tests[nextIndex];
      var condChanged = (nextTest.conditionIndex !== test.conditionIndex);

      // Wait for firmware auto-reset (5 seconds), then advance
      setTimeout(function() {
        playlistMode.currentIndex = nextIndex;
        plSaveState();

        // Condition change alert
        if (condChanged) {
          var alertDiv = document.getElementById('plConditionAlert');
          var alertText = document.getElementById('plConditionAlertText');
          alertText.textContent = 'New weight condition! ' + nextTest.conditionLabel +
            '. Add ' + nextTest.addedWeight.toFixed(1) + 'g to each car.';
          alertDiv.style.display = 'block';
          announce('ATTENTION: New weight condition. ' + nextTest.conditionLabel +
            '. Add ' + nextTest.addedWeight.toFixed(1) + ' grams to each car. ' +
            'Starting with ' + nextTest.carName + '.');
          // Hide alert after 8 seconds
          setTimeout(function() { alertDiv.style.display = 'none'; }, 8000);
        } else {
          document.getElementById('plConditionAlert').style.display = 'none';
          announce('Run ' + (nextIndex + 1) + ' of ' + playlistMode.tests.length + '. ' +
            nextTest.carName + ', ' + nextTest.conditionLabel + '. Trial ' +
            nextTest.trial + ' of ' + nextTest.totalTrials + '.');
        }

        plLoadCurrentTest();
      }, 5500); // Slightly after the firmware 5s auto-reset
    }

    // --- Skip Run ---
    function plSkipRun() {
      if (!playlistMode.active) return;
      playlistMode.results[playlistMode.currentIndex] = { skipped: true, timestamp: Date.now() };

      if (playlistMode.currentIndex >= playlistMode.tests.length - 1) {
        plCompleteTesting();
        return;
      }

      var nextIndex = playlistMode.currentIndex + 1;
      var nextTest = playlistMode.tests[nextIndex];
      playlistMode.currentIndex = nextIndex;
      plSaveState();
      announce('Run skipped. Moving to run ' + (nextIndex + 1) + '. ' + nextTest.carName + '.');
      plLoadCurrentTest();
    }

    // --- Pause/Resume ---
    function plTogglePause() {
      playlistMode.paused = !playlistMode.paused;
      var btn = document.getElementById('plPauseBtn');
      btn.textContent = playlistMode.paused ? 'RESUME' : 'PAUSE';
      plSaveState();
      if (playlistMode.paused) {
        announce('Testing paused. Press Resume to continue.');
      } else {
        announce('Testing resumed. ' + (playlistMode.tests.length - playlistMode.currentIndex) + ' runs remaining.');
        plLoadCurrentTest();
      }
    }

    // --- Stop Testing ---
    function plStopTesting() {
      if (!confirm('Stop testing? Completed results will be kept.')) return;
      playlistMode.active = false;
      playlistMode.paused = false;
      plSaveState();

      // If we have any results, show completed phase
      var hasResults = playlistMode.results.some(function(r) { return r && !r.skipped; });
      if (hasResults) {
        plBuildSummary();
        plShowPhase('completed');
        announce('Testing stopped. Results available for export.');
      } else {
        plShowPhase('setup');
        announce('Testing stopped. No results collected.');
      }
    }

    // --- Complete Testing ---
    function plCompleteTesting() {
      playlistMode.active = false;
      playlistMode.paused = false;

      // Final progress
      var progressBar = document.getElementById('plProgressBar');
      progressBar.style.width = '100%';
      document.getElementById('plProgressText').textContent = '100%';

      plSaveState();
      plBuildSummary();
      plShowPhase('completed');

      var completedCount = playlistMode.results.filter(function(r) { return r && !r.skipped; }).length;
      announce('All ' + completedCount + ' tests complete! Great work, scientist! Export your data below.');
    }

    // --- Build Summary Table ---
    function plBuildSummary() {
      var container = document.getElementById('plSummary');

      // Group results by car, then by condition
      var cars = {};
      for (var i = 0; i < playlistMode.tests.length; i++) {
        var test = playlistMode.tests[i];
        var result = playlistMode.results[i];
        if (!result || result.skipped) continue;
        if (!cars[test.carName]) cars[test.carName] = { baseWeight: test.baseWeight, conditions: {} };
        if (!cars[test.carName].conditions[test.conditionLabel]) {
          cars[test.carName].conditions[test.conditionLabel] = {
            addedWeight: test.addedWeight,
            totalWeight: test.totalWeight,
            trials: []
          };
        }
        cars[test.carName].conditions[test.conditionLabel].trials.push(result);
      }

      var html = '';
      var carNames = Object.keys(cars);
      for (var ci = 0; ci < carNames.length; ci++) {
        var carName = carNames[ci];
        var carData = cars[carName];
        var numTrials = playlistMode.config.trialsPerCondition;

        html += '<h3 style="font-size:0.9rem; font-weight:700; color:var(--accent); margin-top:12px;">' +
          escHtml(carName) + ' (' + carData.baseWeight + 'g base)</h3>';
        html += '<table class="pl-summary-table"><thead><tr>' +
          '<th>Condition</th><th>Added (g)</th><th>Total (g)</th>';
        for (var t = 1; t <= numTrials; t++) html += '<th>T' + t + ' (s)</th>';
        html += '<th>Avg Time (s)</th><th>Avg Speed (m/s)</th></tr></thead><tbody>';

        var condLabels = Object.keys(carData.conditions);
        for (var cdi = 0; cdi < condLabels.length; cdi++) {
          var condLabel = condLabels[cdi];
          var cond = carData.conditions[condLabel];
          var times = cond.trials.map(function(r) { return r.time_s; });
          var speeds = cond.trials.map(function(r) { return r.speed_mps; });
          var avgTime = times.reduce(function(a, b) { return a + b; }, 0) / times.length;
          var avgSpeed = speeds.reduce(function(a, b) { return a + b; }, 0) / speeds.length;

          html += '<tr><td>' + escHtml(condLabel) + '</td>' +
            '<td>' + cond.addedWeight.toFixed(1) + '</td>' +
            '<td>' + cond.totalWeight.toFixed(1) + '</td>';
          for (var ti = 0; ti < numTrials; ti++) {
            html += '<td>' + (times[ti] !== undefined ? safeFixed(times[ti], 4) : '--') + '</td>';
          }
          html += '<td class="pl-avg">' + safeFixed(avgTime, 4) + '</td>' +
            '<td class="pl-avg">' + safeFixed(avgSpeed, 3) + '</td></tr>';
        }
        html += '</tbody></table>';
      }

      container.innerHTML = html;
    }

    // --- CSV Export (Raw Data) ---
    function plExportCSV() {
      var csv = 'Run,Car,BaseWeight(g),AddedWeight(g),TotalWeight(g),Condition,Trial,Time(s),Speed(m/s),Speed(mph),Momentum(kg*m/s),KE(J)\n';
      for (var i = 0; i < playlistMode.tests.length; i++) {
        var test = playlistMode.tests[i];
        var result = playlistMode.results[i];
        if (!result || result.skipped) continue;
        csv += test.index + ',' +
          escCsvField(test.carName) + ',' +
          test.baseWeight + ',' +
          test.addedWeight.toFixed(1) + ',' +
          test.totalWeight.toFixed(1) + ',' +
          escCsvField(test.conditionLabel) + ',' +
          test.trial + ',' +
          safeFixed(result.time_s, 4) + ',' +
          safeFixed(result.speed_mps, 3) + ',' +
          safeFixed(result.speed_mph, 2) + ',' +
          safeFixed(result.momentum, 4) + ',' +
          safeFixed(result.ke, 4) + '\n';
      }
      plDownloadFile(csv, 'masstrap_sciencefair_' + Date.now() + '.csv', 'text/csv');
    }

    function escCsvField(str) {
      if (str.indexOf(',') !== -1 || str.indexOf('"') !== -1) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }

    // --- Summary Export ---
    function plExportSummary() {
      var trackLen = parseFloat(document.getElementById('trackLength').value) || 2.0;
      var lines = [];
      lines.push('M.A.S.S. TRAP SCIENCE FAIR DATA SUMMARY');
      lines.push('Generated: ' + new Date().toLocaleString());
      lines.push('');
      lines.push('Independent Variable: Added Weight (grams)');
      lines.push('Dependent Variable: Time (seconds) / Speed (m/s)');
      lines.push('Controlled Variables: Track length (' + trackLen.toFixed(2) + 'm), Start height, Release method, Car model per condition group');
      lines.push('');

      // Build same structure as summary table
      var cars = {};
      for (var i = 0; i < playlistMode.tests.length; i++) {
        var test = playlistMode.tests[i];
        var result = playlistMode.results[i];
        if (!result || result.skipped) continue;
        if (!cars[test.carName]) cars[test.carName] = { baseWeight: test.baseWeight, conditions: {} };
        if (!cars[test.carName].conditions[test.conditionLabel]) {
          cars[test.carName].conditions[test.conditionLabel] = {
            addedWeight: test.addedWeight,
            totalWeight: test.totalWeight,
            trials: []
          };
        }
        cars[test.carName].conditions[test.conditionLabel].trials.push(result);
      }

      var numTrials = playlistMode.config.trialsPerCondition;
      var carNames = Object.keys(cars);
      for (var ci = 0; ci < carNames.length; ci++) {
        var carName = carNames[ci];
        var carData = cars[carName];
        lines.push('Car: ' + carName + ' (' + carData.baseWeight + 'g base)');

        // Header row
        var hdr = 'Condition\tAdded(g)\tTotal(g)';
        for (var t = 1; t <= numTrials; t++) hdr += '\tTrial ' + t + '(s)';
        hdr += '\tAvg Time(s)\tAvg Speed(m/s)';
        lines.push(hdr);

        var condLabels = Object.keys(carData.conditions);
        for (var cdi = 0; cdi < condLabels.length; cdi++) {
          var condLabel = condLabels[cdi];
          var cond = carData.conditions[condLabel];
          var times = cond.trials.map(function(r) { return r.time_s; });
          var speeds = cond.trials.map(function(r) { return r.speed_mps; });
          var avgTime = times.reduce(function(a, b) { return a + b; }, 0) / times.length;
          var avgSpeed = speeds.reduce(function(a, b) { return a + b; }, 0) / speeds.length;

          var row = condLabel + '\t' + cond.addedWeight.toFixed(1) + '\t' + cond.totalWeight.toFixed(1);
          for (var ti = 0; ti < numTrials; ti++) {
            row += '\t' + (times[ti] !== undefined ? safeFixed(times[ti], 4) : '--');
          }
          row += '\t' + safeFixed(avgTime, 4) + '\t' + safeFixed(avgSpeed, 3);
          lines.push(row);
        }
        lines.push('');
      }

      plDownloadFile(lines.join('\n'), 'masstrap_summary_' + Date.now() + '.txt', 'text/plain');
    }

    function plDownloadFile(content, filename, type) {
      var blob = new Blob([content], { type: type });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // --- Clear & Start Over ---
    function plClearAndRestart() {
      if (!confirm('Clear all results and start over?')) return;
      playlistMode.active = false;
      playlistMode.paused = false;
      playlistMode.tests = [];
      playlistMode.currentIndex = 0;
      playlistMode.results = [];
      localStorage.removeItem('mass_playlist_state');
      plShowPhase('setup');
      plRenderCarSelector();
      document.getElementById('plPreview').style.display = 'none';
      document.getElementById('plStartBtn').disabled = true;
      var badge = document.getElementById('playlistBadge');
      badge.style.display = 'none';
      announce('Playlist cleared. Ready to set up a new test plan.');
    }

    // ========================================================================
    // EVIDENCE SYSTEM — Case Numbers, NFC Scan, Evidence Tags
    // ========================================================================
    var evidenceLog = JSON.parse(localStorage.getItem('mass_evidence_log') || '[]');
    var evidenceCounter = parseInt(localStorage.getItem('mass_evidence_counter') || '0');

    function evNextCaseNumber() {
      evidenceCounter++;
      localStorage.setItem('mass_evidence_counter', evidenceCounter);
      var year = new Date().getFullYear().toString().slice(-2);
      var seq = ('0000' + evidenceCounter).slice(-4);
      return 'MASS' + year + '-' + seq;
    }

    function evGetCaseNumber() {
      // Return current case number without incrementing (for display)
      var year = new Date().getFullYear().toString().slice(-2);
      var seq = ('0000' + (evidenceCounter + 1)).slice(-4);
      return 'MASS' + year + '-' + seq;
    }

    // Record evidence entry when a race finishes
    function evRecordRun(raceData, playlistTest) {
      var caseNum = evNextCaseNumber();
      var entry = {
        caseNumber: caseNum,
        timestamp: new Date().toISOString(),
        car: raceData.car || (activeCar ? activeCar.name : 'Unknown'),
        carId: activeCar ? activeCar.id : null,
        weight: raceData.weight,
        time_s: raceData.time,
        speed_mps: raceData.speed_mps || (raceData.speed_mph ? raceData.speed_mph / MPS_TO_MPH : 0),
        speed_mph: raceData.speed_mph || 0,
        momentum: raceData.momentum || 0,
        ke: raceData.ke || 0,
        totalRuns: raceData.totalRuns,
        photoUrl: null // Populated later when photo is linked
      };
      if (playlistTest) {
        entry.condition = playlistTest.conditionLabel;
        entry.addedWeight = playlistTest.addedWeight;
        entry.baseWeight = playlistTest.baseWeight;
        entry.trial = playlistTest.trial;
      }
      evidenceLog.push(entry);
      // Keep last 500 entries
      if (evidenceLog.length > 500) evidenceLog = evidenceLog.slice(-500);
      localStorage.setItem('mass_evidence_log', JSON.stringify(evidenceLog));
      return caseNum;
    }

    // NFC scan handler — reads URL params, selects car, arms track
    function evHandleNfcScan() {
      var params = new URLSearchParams(window.location.search);
      var nfcCarId = params.get('nfc');
      var nfcCarName = params.get('car');
      if (!nfcCarId && !nfcCarName) return false;

      // Wait for garage to load, then find and select car
      var scanInterval = setInterval(function() {
        if (garage.length === 0) return; // Still loading
        clearInterval(scanInterval);

        var carIndex = -1;
        if (nfcCarId) {
          carIndex = garage.findIndex(function(c) { return String(c.id) === String(nfcCarId); });
        }
        if (carIndex === -1 && nfcCarName) {
          carIndex = garage.findIndex(function(c) {
            return c.name.toLowerCase() === decodeURIComponent(nfcCarName).toLowerCase();
          });
        }

        if (carIndex !== -1) {
          // Car found — select it and arm
          selectCar(carIndex);
          announce('NFC tag scanned. ' + garage[carIndex].name + ' loaded. Arming system.');

          // Show scan confirmation banner
          evShowScanBanner(garage[carIndex]);

          // Auto-arm after brief delay
          setTimeout(function() {
            wsSend({ cmd: 'arm' });
          }, 1500);

          // Clean URL without reloading
          if (window.history.replaceState) {
            window.history.replaceState({}, '', window.location.pathname);
          }
        } else {
          // Car not found — prompt to add it
          evShowNewCarPrompt(nfcCarName || 'Unknown Vehicle', nfcCarId);
        }
      }, 200);

      // Timeout after 5 seconds
      setTimeout(function() { clearInterval(scanInterval); }, 5000);
      return true;
    }

    function evShowScanBanner(car) {
      // Brief green flash overlay for NFC scan confirmation
      var banner = document.createElement('div');
      banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;' +
        'background:linear-gradient(135deg,rgba(40,167,69,0.95),rgba(var(--accent-rgb,212,175,55),0.9));' +
        'color:#fff;text-align:center;padding:20px;font-weight:900;font-size:1.2rem;' +
        'animation:plAlertPulse 0.5s ease-in-out;';
      banner.setAttribute('role', 'alert');
      banner.innerHTML = '&#x1F4F1; NFC SCANNED: ' + escHtml(car.name) +
        ' (' + car.weight + 'g) — ARMING...';
      document.body.appendChild(banner);
      setTimeout(function() { banner.remove(); }, 3000);
    }

    function evShowNewCarPrompt(name, nfcId) {
      announce('Unknown vehicle scanned. Please add this car to the garage.');
      var weight = prompt('New vehicle detected: "' + name + '"\nEnter weight in grams:');
      if (weight && parseFloat(weight) > 0) {
        document.getElementById('carName').value = name;
        document.getElementById('carWeight').value = weight;
        document.getElementById('carName').focus();
        // Scroll to garage section
        document.querySelector('.section.kiosk-hide').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // Generate NFC tag URL for a car
    function evGetNfcUrl(car) {
      // Use hostname-based URL so it works on LAN
      var base = window.location.protocol + '//' + window.location.host;
      return base + '/?nfc=' + car.id + '&car=' + encodeURIComponent(car.name);
    }

    // Generate QR code as SVG (tiny QR library — no external deps)
    // Uses a minimal QR encoder for alphanumeric URLs
    function evGenerateQrSvg(text, size) {
      // Use the canvas-based approach with a simple matrix
      // For tonight, we'll use the Google Charts API for QR codes
      // (works offline once cached, lightweight)
      var img = document.createElement('img');
      img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=' + size + 'x' + size +
        '&data=' + encodeURIComponent(text) + '&format=svg';
      img.alt = 'QR Code: ' + text;
      img.width = size;
      img.height = size;
      img.style.imageRendering = 'pixelated';
      return img;
    }

    // Evidence Tag Generator — printable card
    function evGenerateTag(entry) {
      var tagHtml = '<div class="ev-tag">' +
        '<div class="ev-tag-header">' +
          '<div class="ev-tag-badge">M.A.S.S. TRAP</div>' +
          '<div class="ev-tag-case">' + entry.caseNumber + '</div>' +
        '</div>' +
        '<div class="ev-tag-body">' +
          '<div class="ev-tag-qr" id="evQr_' + entry.caseNumber + '"></div>' +
          '<div class="ev-tag-info">' +
            '<div><strong>Vehicle:</strong> ' + escHtml(entry.car) + '</div>' +
            '<div><strong>Mass:</strong> ' + entry.weight + 'g</div>';
      if (entry.condition) {
        tagHtml += '<div><strong>Condition:</strong> ' + escHtml(entry.condition) + '</div>' +
          '<div><strong>Trial:</strong> ' + entry.trial + '</div>';
      }
      tagHtml += '<div><strong>Time:</strong> ' + safeFixed(entry.time_s, 4) + 's</div>' +
            '<div><strong>Speed:</strong> ' + safeFixed(entry.speed_mps, 3) + ' m/s</div>' +
            '<div class="ev-tag-ts">' + new Date(entry.timestamp).toLocaleString() + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
      return tagHtml;
    }

    // Show evidence tags overlay with print button
    function evShowTagsOverlay(entries) {
      if (!entries || entries.length === 0) {
        alert('No evidence to tag!');
        return;
      }
      var overlay = document.createElement('div');
      overlay.id = 'evOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000;' +
        'background:rgba(0,0,0,0.85);overflow-y:auto;padding:20px;';

      var content = '<div style="max-width:600px;margin:0 auto;">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">' +
          '<h2 style="color:var(--accent);margin:0;">EVIDENCE TAGS</h2>' +
          '<div>' +
            '<button class="btn btn-success" onclick="evPrintTags()" style="margin-right:8px;">PRINT</button>' +
            '<button class="btn btn-danger" onclick="document.getElementById(\'evOverlay\').remove()">CLOSE</button>' +
          '</div>' +
        '</div>';

      for (var i = 0; i < entries.length; i++) {
        content += evGenerateTag(entries[i]);
      }
      content += '</div>';
      overlay.innerHTML = content;
      document.body.appendChild(overlay);

      // Inject QR codes
      for (var j = 0; j < entries.length; j++) {
        var qrContainer = document.getElementById('evQr_' + entries[j].caseNumber);
        if (qrContainer) {
          var url = window.location.protocol + '//' + window.location.host +
            '/evidence#' + entries[j].caseNumber;
          qrContainer.appendChild(evGenerateQrSvg(url, 100));
        }
      }
    }

    function evPrintTags() {
      var overlay = document.getElementById('evOverlay');
      if (!overlay) return;
      var printWin = window.open('', '_blank');
      printWin.document.write('<!DOCTYPE html><html><head><title>Evidence Tags</title>' +
        '<style>' +
        'body{font-family:monospace;background:#fff;color:#000;padding:10px;}' +
        '.ev-tag{border:2px solid #000;border-radius:8px;padding:12px;margin:10px 0;page-break-inside:avoid;max-width:400px;}' +
        '.ev-tag-header{text-align:center;border-bottom:2px solid #000;padding-bottom:8px;margin-bottom:8px;}' +
        '.ev-tag-badge{font-size:0.7rem;font-weight:900;letter-spacing:2px;text-transform:uppercase;}' +
        '.ev-tag-case{font-size:1.4rem;font-weight:900;letter-spacing:3px;}' +
        '.ev-tag-body{display:flex;gap:12px;align-items:flex-start;}' +
        '.ev-tag-qr{flex-shrink:0;}' +
        '.ev-tag-info{font-size:0.8rem;line-height:1.6;}' +
        '.ev-tag-ts{font-size:0.65rem;color:#666;margin-top:4px;}' +
        '@media print{body{margin:0;}.ev-tag{border:1px solid #000;}}' +
        '</style></head><body>');
      var tags = overlay.querySelectorAll('.ev-tag');
      for (var i = 0; i < tags.length; i++) {
        printWin.document.write(tags[i].outerHTML);
      }
      printWin.document.write('</body></html>');
      printWin.document.close();
      printWin.print();
    }

    // Copy NFC URL to clipboard with visual feedback
    function evCopyNfcUrl(url, btn) {
      var originalText = btn.textContent;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() {
          btn.textContent = 'COPIED!';
          btn.className = btn.className.replace('btn-success', 'btn-accent');
          announce('URL copied to clipboard. Paste into NFC Tools.');
          setTimeout(function() {
            btn.textContent = originalText;
            btn.className = btn.className.replace('btn-accent', 'btn-success');
          }, 2000);
        }).catch(function() {
          evCopyFallback(url, btn, originalText);
        });
      } else {
        evCopyFallback(url, btn, originalText);
      }
    }

    function evCopyFallback(url, btn, originalText) {
      var ta = document.createElement('textarea');
      ta.value = url;
      ta.style.cssText = 'position:fixed;left:-9999px;';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      btn.textContent = 'COPIED!';
      btn.className = btn.className.replace('btn-success', 'btn-accent');
      announce('URL copied to clipboard. Paste into NFC Tools.');
      setTimeout(function() {
        btn.textContent = originalText;
        btn.className = btn.className.replace('btn-accent', 'btn-success');
      }, 2000);
    }

    // NFC Tag Writer Helper — generates the URLs to write to tags
    function evShowNfcWriterHelper() {
      if (garage.length === 0) {
        alert('Add cars to the garage first!');
        return;
      }
      var overlay = document.createElement('div');
      overlay.id = 'nfcWriterOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000;' +
        'background:rgba(0,0,0,0.9);overflow-y:auto;padding:20px;';

      var html = '<div style="max-width:600px;margin:0 auto;">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">' +
          '<h2 style="color:var(--accent);margin:0;">NFC TAG WRITER</h2>' +
          '<button class="btn btn-danger" onclick="document.getElementById(\'nfcWriterOverlay\').remove()">CLOSE</button>' +
        '</div>' +
        '<p class="text-muted" style="margin-bottom:12px;">Write these URLs to NTAG213 stickers using your iPhone (NFC Tools app or Shortcuts). ' +
        'Stick the tag on the bottom of each car. Tap to scan = auto-select + arm.</p>';

      for (var i = 0; i < garage.length; i++) {
        var car = garage[i];
        var url = evGetNfcUrl(car);
        html += '<div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin:8px 0;' +
          'display:flex;align-items:center;gap:12px;">' +
          '<div id="nfcQr_' + i + '" style="flex-shrink:0;"></div>' +
          '<div style="flex:1;">' +
            '<div style="font-weight:900;color:var(--accent);">' + escHtml(car.name) + '</div>' +
            '<div class="text-muted" style="font-size:0.75rem;">' + car.weight + 'g | ' + (car.color || '') + '</div>' +
            '<button class="btn btn-success btn-sm" style="width:100%;margin-top:6px;font-size:0.8rem;" ' +
              'onclick="evCopyNfcUrl(\'' + escHtml(url.replace(/'/g, "\\'")) + '\', this)" ' +
              'aria-label="Copy NFC URL for ' + escHtml(car.name) + '">TAP TO COPY URL</button>' +
            '<div class="text-muted" style="font-size:0.6rem;margin-top:2px;word-break:break-all;opacity:0.5;">' + escHtml(url) + '</div>' +
          '</div>' +
        '</div>';
      }
      html += '</div>';
      overlay.innerHTML = html;
      document.body.appendChild(overlay);

      // Add QR codes
      for (var j = 0; j < garage.length; j++) {
        var qrEl = document.getElementById('nfcQr_' + j);
        if (qrEl) {
          qrEl.appendChild(evGenerateQrSvg(evGetNfcUrl(garage[j]), 80));
        }
      }
    }

    // ========================================================================
    // KIOSK MODE — Display-only for presentations
    // Activate: ?kiosk in URL  or  Ctrl+K toggle
    // ========================================================================
    var kioskMode = false;
    var _kioskViewerLocked = false; // true when viewer password protects kiosk exit

    function enterKiosk() {
      kioskMode = true;
      document.body.classList.add('kiosk');
      if (!document.getElementById('kioskExit')) {
        var hint = document.createElement('div');
        hint.id = 'kioskExit';
        hint.className = 'kiosk-exit';
        document.body.appendChild(hint);
      }
      // Check if viewer password is set — if so, require badge to exit
      fetch('/api/auth/info').then(function(r) { return r.json(); }).then(function(info) {
        if (info.hasViewerPassword) {
          _kioskViewerLocked = true;
          var hint = document.getElementById('kioskExit');
          if (hint) {
            hint.textContent = 'Tap to unlock';
            hint.className = 'kiosk-exit kiosk-unlock';
          }
        } else {
          _kioskViewerLocked = false;
          var hint = document.getElementById('kioskExit');
          if (hint) hint.textContent = 'Ctrl+K to exit';
        }
      }).catch(function() {
        var hint = document.getElementById('kioskExit');
        if (hint) hint.textContent = 'Ctrl+K to exit';
      });
      document.getElementById('kioskExit').onclick = function() {
        if (_kioskViewerLocked && sessionStorage.getItem('mass_viewer_auth') !== 'true') {
          // Show Badge Reader overlay; on success, exit kiosk
          checkAuthGate('viewer', { onSuccess: function() { exitKiosk(); } });
        } else {
          exitKiosk();
        }
      };
    }
    function exitKiosk() {
      kioskMode = false;
      _kioskViewerLocked = false;
      document.body.classList.remove('kiosk');
      var hint = document.getElementById('kioskExit');
      if (hint) hint.remove();
      if (window.history.replaceState) {
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    document.addEventListener('keydown', function(e) {
      // Escape: close leaderboard overlay
      if (e.key === 'Escape') {
        var overlay = document.getElementById('leaderboardOverlay');
        if (overlay && overlay.classList.contains('show')) {
          closeLeaderboard();
          e.preventDefault();
          return;
        }
      }
      // Ctrl+K: toggle kiosk mode
      if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        if (kioskMode) {
          // If viewer password protects kiosk, only exit if already authed
          if (_kioskViewerLocked && sessionStorage.getItem('mass_viewer_auth') !== 'true') {
            checkAuthGate('viewer', { onSuccess: function() { exitKiosk(); } });
          } else {
            exitKiosk();
          }
        } else {
          enterKiosk();
        }
      }
    });

    // ========================================================================
    // INITIALIZATION
    // ========================================================================
    window.onload = async function() {
      // CRITICAL: Register WS handler and connect FIRST — nothing can block this
      onWsMessage(handleStateUpdate);
      massInit();

      // Badge Reader gate — viewer password check
      checkAuthGate('viewer');

      // Each init step is isolated — a crash in one cannot kill the others
      try {
        var cfgResp = await fetch('/api/config');
        var cfgData = await cfgResp.json();
        if (cfgData.track) {
          document.getElementById('trackLength').value = cfgData.track.length_m || 2.0;
        }
        if (cfgData.regional) {
          setUnits(cfgData.regional.units || 'imperial');
        }
      } catch (e) { console.error('[INIT] Config fetch failed:', e); }

      try { updateUnitLabels(); } catch (e) { console.error('[INIT] Unit labels failed:', e); }
      try { await loadGarageFromESP(); } catch (e) { console.error('[INIT] Garage load failed:', e); }
      try { await loadHistoryFromESP(); } catch (e) { console.error('[INIT] History load failed:', e); }
      try { initCharts(); } catch (e) { console.error('[INIT] Charts failed:', e); }
      try { if (activeCar) { setCurrentCarDisplay(activeCar); } } catch (e) { console.error('[INIT] Active car display failed:', e); }
      try { renderMostWanted(); } catch (e) { console.error('[INIT] Most Wanted render failed:', e); }

      // Playlist Mode init: render car selector and restore any saved state
      try { plRenderCarSelector(); plRenderConditions(); plRestoreState(); } catch (e) { console.error('[INIT] Playlist init failed:', e); }

      // NFC scan: check if page was opened from an NFC tag tap
      try { evHandleNfcScan(); } catch (e) { console.error('[INIT] NFC scan handler failed:', e); }

      // Auto-enter kiosk if ?kiosk in URL
      if (window.location.search.indexOf('kiosk') !== -1) enterKiosk();
    };

    window.addEventListener('beforeunload', function() {
      localStorage.setItem('hw_garage', JSON.stringify(garage));
      localStorage.setItem('hw_history', JSON.stringify(history));
      try {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/garage', false);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(garage));
      } catch (e) {}
    });
  </script>
</body>
</html>
