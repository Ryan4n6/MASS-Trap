<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="fw-version" content="2.5.0">
  <title>M.A.S.S. Trap - System Config</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <a href="#configTablist" class="skip-link">Skip to configuration</a>
  <div id="navContainer"></div>
  <div class="container">
    <div class="page-header">
      <div class="page-header-shield" aria-hidden="true"></div>
      <h1>M.A.S.S. TRAP</h1>
      <div class="subtitle">Motion Analysis &amp; Speed System</div>
      <div class="tagline">SYSTEM CONFIG</div>
      <div class="theme-selector">
        <label for="themePicker">Theme:</label> <select id="themePicker" onchange="setTheme(this.value)">
          <option value="interceptor">Interceptor</option>
          <option value="classic">Classic</option>
          <option value="daytona">Daytona</option>
          <option value="casefile">Case File</option>
          <option value="cyber">Cyber</option>
        </select>
      </div>
    </div>

    <!-- Config Tabs -->
    <div id="configTablist" class="config-tabs">
      <button id="tabBtn-network" class="config-tab active" data-tab="network" onclick="showTab('network', this)">Network</button>
      <button id="tabBtn-device" class="config-tab" data-tab="device" onclick="showTab('device', this)">Device</button>
      <button id="tabBtn-pins" class="config-tab" data-tab="pins" onclick="showTab('pins', this)">Pins</button>
      <button id="tabBtn-peer" class="config-tab" data-tab="peer" onclick="showTab('peer', this)">Peer</button>
      <button id="tabBtn-track" class="config-tab" data-tab="track" onclick="showTab('track', this)">Track</button>
      <button id="tabBtn-audio" class="config-tab" data-tab="audio" onclick="showTab('audio', this)">Audio</button>
      <button id="tabBtn-lidar" class="config-tab" data-tab="lidar" onclick="showTab('lidar', this)">LiDAR</button>
      <button id="tabBtn-integrations" class="config-tab" data-tab="integrations" onclick="showTab('integrations', this)">WLED</button>
      <button id="tabBtn-regional" class="config-tab" data-tab="regional" onclick="showTab('regional', this)">Regional</button>
      <button id="tabBtn-maintenance" class="config-tab" data-tab="maintenance" onclick="showTab('maintenance', this)">System</button>
    </div>

    <!-- Tab: Network -->
    <div id="tab-network" class="config-tab-content active">
      <label for="wifiScan" class="card-label">WiFi Network</label>
      <div style="display:flex; gap:8px;">
        <select id="wifiScan" style="flex:1;" onchange="document.getElementById('wifiSSID').value=this.value; if(this.value) document.getElementById('networkMode').value='wifi';">
          <option value="">-- Scan for networks --</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="scanWifi()">Scan</button>
      </div>
      <label for="wifiSSID" class="sr-only">WiFi SSID</label>
      <input type="text" id="wifiSSID" placeholder="WiFi SSID (or type manually)">

      <label for="wifiPass" class="card-label">WiFi Password</label>
      <div style="display:flex; gap:8px;">
        <input type="password" id="wifiPass" placeholder="WiFi Password" style="flex:1;">
        <button class="btn btn-outline btn-sm" onclick="togglePass('wifiPass')" aria-label="Toggle password visibility">Show</button>
      </div>

      <label for="hostname" class="card-label">Hostname</label>
      <input type="text" id="hostname" placeholder="masstrap" value="masstrap">
      <div class="hint">Access device at http://[hostname].local</div>

      <label for="networkMode" class="card-label">Network Mode</label>
      <select id="networkMode">
        <option value="wifi" selected>Connect to WiFi (recommended)</option>
        <option value="standalone">Standalone AP (no router needed)</option>
      </select>
      <div class="hint">Standalone mode creates its own WiFi network for use when no router is available.</div>
    </div>

    <!-- Tab: Device -->
    <div id="tab-device" class="config-tab-content">
      <div class="card-label" id="roleGroupLabel">Device Role</div>
      <div class="role-cards" role="radiogroup" aria-labelledby="roleGroupLabel">
        <button type="button" class="role-card" id="role-start" role="radio" aria-checked="false" onclick="selectRole('start')">
          <div class="role-icon" aria-hidden="true">&#x1F7E2;</div>
          <h3>START GATE</h3>
          <p>Detects car release, sends start signal</p>
        </button>
        <button type="button" class="role-card selected" id="role-finish" role="radio" aria-checked="true" onclick="selectRole('finish')">
          <div class="role-icon" aria-hidden="true">&#x1F3C1;</div>
          <h3>FINISH GATE</h3>
          <p>Logs time, calculates speed &amp; physics</p>
        </button>
        <button type="button" class="role-card" id="role-speedtrap" role="radio" aria-checked="false" onclick="selectRole('speedtrap')">
          <div class="role-icon" aria-hidden="true">&#x1F6A8;</div>
          <h3>SPEED TRAP</h3>
          <p>Mid-track velocity via dual IR sensors</p>
        </button>
      </div>
      <input type="hidden" id="role" value="finish">

      <label for="deviceId" class="card-label">Device ID</label>
      <input type="number" id="deviceId" value="1" min="1" max="254">
      <div class="hint">Unique number for this device (1-254). Use different IDs for each device.</div>
    </div>

    <!-- Tab: Pins -->
    <div id="tab-pins" class="config-tab-content">
      <div class="info-box">
        <strong>ESP32-S3 Safe GPIOs:</strong> 1-5, 12-21, 35-48<br>
        <strong>Avoid:</strong> GPIO 0 (boot), 6-11 (flash SPI)
      </div>

      <label for="sensorPin" class="card-label" id="sensorLabel">IR Sensor Pin (Finish Line)</label>
      <select id="sensorPin">
        <option value="4" selected>GPIO 4 (default)</option>
        <option value="1">GPIO 1</option>
        <option value="2">GPIO 2</option>
        <option value="3">GPIO 3</option>
        <option value="5">GPIO 5</option>
        <option value="12">GPIO 12</option>
        <option value="13">GPIO 13</option>
        <option value="14">GPIO 14</option>
        <option value="15">GPIO 15</option>
        <option value="16">GPIO 16</option>
        <option value="17">GPIO 17</option>
        <option value="18">GPIO 18</option>
        <option value="19">GPIO 19</option>
        <option value="20">GPIO 20</option>
        <option value="21">GPIO 21</option>
      </select>
      <div class="hint">Connect your IR break-beam sensor signal wire to this pin</div>

      <div id="sensorPin2Group" style="display:none;">
        <label for="sensorPin2" class="card-label">Second IR Sensor Pin (Speed Trap)</label>
        <select id="sensorPin2">
          <option value="5" selected>GPIO 5 (default)</option>
          <option value="1">GPIO 1</option>
          <option value="2">GPIO 2</option>
          <option value="3">GPIO 3</option>
          <option value="4">GPIO 4</option>
          <option value="12">GPIO 12</option>
          <option value="13">GPIO 13</option>
          <option value="14">GPIO 14</option>
          <option value="15">GPIO 15</option>
          <option value="16">GPIO 16</option>
          <option value="17">GPIO 17</option>
          <option value="18">GPIO 18</option>
          <option value="19">GPIO 19</option>
          <option value="20">GPIO 20</option>
          <option value="21">GPIO 21</option>
        </select>
        <div class="hint">Second sensor ~10cm apart from first for velocity measurement</div>
      </div>

      <label for="ledPin" class="card-label">Status LED Pin</label>
      <select id="ledPin">
        <option value="2" selected>GPIO 2 (default / built-in LED)</option>
        <option value="1">GPIO 1</option>
        <option value="3">GPIO 3</option>
        <option value="4">GPIO 4</option>
        <option value="5">GPIO 5</option>
        <option value="12">GPIO 12</option>
        <option value="13">GPIO 13</option>
        <option value="14">GPIO 14</option>
        <option value="15">GPIO 15</option>
        <option value="16">GPIO 16</option>
        <option value="17">GPIO 17</option>
        <option value="18">GPIO 18</option>
      </select>
    </div>

    <!-- Tab: Peer -->
    <div id="tab-peer" class="config-tab-content">
      <label for="myMac" class="card-label">This Device's MAC Address</label>
      <input type="text" id="myMac" readonly style="background:var(--bg-dark); font-family:var(--font-data); color:var(--accent);">
      <div class="hint">Give this MAC address to your partner device</div>

      <label for="peerMac" class="card-label">Partner Device MAC Address</label>
      <input type="text" id="peerMac" placeholder="XX:XX:XX:XX:XX:XX" style="font-family:var(--font-data);">
      <div class="hint">Enter the MAC of the other gate, or use discovery below</div>

      <button class="btn btn-primary btn-sm" style="margin-top:14px;" onclick="discoverDevices()">Scan for Devices</button>
      <div id="deviceList" class="device-list">
        <div class="hint">Click "Scan for Devices" to find nearby M.A.S.S. Trap devices on the network</div>
      </div>
    </div>

    <!-- Tab: Track -->
    <div id="tab-track" class="config-tab-content">
      <label for="trackLength" class="card-label">Track Length (meters)</label>
      <input type="number" id="trackLength" value="2.0" step="0.01" min="0.1" max="100">
      <div class="hint">Distance from start gate sensor to finish gate sensor</div>

      <label for="scaleFactor" class="card-label">Scale Factor</label>
      <input type="number" id="scaleFactor" value="64" min="1" max="1000">
      <div class="hint">1:64 for standard Hot Wheels. Scale speed = actual speed x this factor.</div>

      <div id="speedTrapSpacing" style="display:none;">
        <label for="sensorSpacing" class="card-label">Speed Trap Sensor Spacing (meters)</label>
        <input type="number" id="sensorSpacing" value="0.10" step="0.01" min="0.01" max="1.0">
        <div class="hint">Distance between the two IR sensors on the speed trap (~10cm recommended)</div>
      </div>
    </div>

    <!-- Tab: Audio -->
    <div id="tab-audio" class="config-tab-content">
      <div class="card-label">Audio System (MAX98357A I2S)</div>

      <div class="toggle-row">
        <label for="audioEnabled">Enable Audio</label>
        <label class="toggle-switch" style="margin:0;">
          <input type="checkbox" id="audioEnabled">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="hint">Non-blocking WAV playback via I2S DMA. Requires MAX98357A amplifier.</div>

      <div id="audioSettings">
        <div class="grid-3" style="margin-top:14px;">
          <div>
            <label for="audioBclk" class="card-label">BCLK Pin</label>
            <input type="number" id="audioBclk" value="15" min="0" max="48">
          </div>
          <div>
            <label for="audioLrc" class="card-label">LRC Pin</label>
            <input type="number" id="audioLrc" value="16" min="0" max="48">
          </div>
          <div>
            <label for="audioDout" class="card-label">DOUT Pin</label>
            <input type="number" id="audioDout" value="17" min="0" max="48">
          </div>
        </div>

        <label for="audioVolume" class="card-label">Volume (0-21)</label>
        <input type="range" id="audioVolume" min="0" max="21" value="10" style="padding:0; border:none; background:transparent;"
               oninput="document.getElementById('volLabel').textContent=this.value">
        <div class="hint">Current: <span id="volLabel">10</span></div>
      </div>
    </div>

    <!-- Tab: LiDAR -->
    <div id="tab-lidar" class="config-tab-content">
      <div class="card-label">LiDAR Staging (Benewake TF-Luna)</div>

      <div class="toggle-row">
        <label for="lidarEnabled">Enable LiDAR</label>
        <label class="toggle-switch" style="margin:0;">
          <input type="checkbox" id="lidarEnabled">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="hint">Solid-state UART LiDAR for automatic car staging detection and auto-arm.</div>

      <div id="lidarSettings">
        <div class="grid-2" style="margin-top:14px;">
          <div>
            <label for="lidarRx" class="card-label">RX Pin (from Luna TX)</label>
            <input type="number" id="lidarRx" value="39" min="0" max="48">
          </div>
          <div>
            <label for="lidarTx" class="card-label">TX Pin (to Luna RX)</label>
            <input type="number" id="lidarTx" value="38" min="0" max="48">
          </div>
        </div>

        <label for="lidarThreshold" class="card-label">Detection Threshold (mm)</label>
        <input type="number" id="lidarThreshold" value="50" min="10" max="500">
        <div class="hint">Objects closer than this distance are detected as a car. Default 50mm.</div>

        <div id="lidarLive" class="info-box" style="margin-top:14px; display:none;">
          <strong>Live Reading:</strong> <span id="lidarDistance">--</span>mm | State: <span id="lidarState">--</span>
        </div>
        <button class="btn btn-primary btn-sm" style="margin-top:10px;" onclick="pollLidar()">Test LiDAR</button>
      </div>
    </div>

    <!-- Tab: Integrations (WLED) -->
    <div id="tab-integrations" class="config-tab-content">
      <div class="card-label">Google Sheets</div>
      <label for="sheetsUrl" class="card-label">Webhook URL</label>
      <input type="text" id="sheetsUrl" placeholder="https://script.google.com/macros/s/.../exec">
      <div class="hint">Race data auto-uploads after each run. Leave blank to disable.</div>

      <hr class="divider">

      <div class="card-label">WLED Integration</div>
      <label for="wledHost" class="card-label">WLED Controller Host</label>
      <div style="display:flex; gap:8px;">
        <input type="text" id="wledHost" placeholder="wled-1.local or 192.168.x.x" style="flex:1;">
        <button class="btn btn-primary btn-sm" onclick="testWled()">Test</button>
      </div>
      <div class="hint">Hostname or IP of your WLED controller for LED race effects</div>

      <div id="wledStatus" class="info-box" style="display:none;" role="status" aria-live="polite"></div>

      <button class="btn btn-outline btn-sm" style="margin-top:10px;" onclick="loadWledEffects()">Load Effects from WLED</button>

      <div class="grid-2" style="margin-top:10px;">
        <div>
          <label for="wledIdle" class="card-label">Idle Effect</label>
          <select id="wledIdle" class="wled-effect"><option value="0">0 - Solid</option></select>
        </div>
        <div>
          <label for="wledArmed" class="card-label">Armed Effect</label>
          <select id="wledArmed" class="wled-effect"><option value="28">28 - Breathe</option></select>
        </div>
        <div>
          <label for="wledRacing" class="card-label">Racing Effect</label>
          <select id="wledRacing" class="wled-effect"><option value="49">49 - Chase Rainbow</option></select>
        </div>
        <div>
          <label for="wledFinished" class="card-label">Finished Effect</label>
          <select id="wledFinished" class="wled-effect"><option value="11">11 - Rainbow</option></select>
        </div>
      </div>
    </div>

    <!-- Tab: Regional / Display Preferences -->
    <div id="tab-regional" class="config-tab-content">
      <label for="unitSystem" class="card-label">Unit System</label>
      <select id="unitSystem">
        <option value="imperial">Imperial (mph, feet)</option>
        <option value="metric">Metric (km/h, meters)</option>
      </select>
      <div class="hint">Controls speed and distance display across dashboard, history, CSV exports, and speed trap.</div>

      <label for="timezone" class="card-label" style="margin-top:18px;">Timezone</label>
      <select id="timezone">
        <option value="EST5EDT,M3.2.0,M11.1.0">US Eastern (EST/EDT)</option>
        <option value="CST6CDT,M3.2.0,M11.1.0">US Central (CST/CDT)</option>
        <option value="MST7MDT,M3.2.0,M11.1.0">US Mountain (MST/MDT)</option>
        <option value="PST8PDT,M3.2.0,M11.1.0">US Pacific (PST/PDT)</option>
        <option value="MST7">US Arizona (MST, no DST)</option>
        <option value="AST4">US Atlantic (AST)</option>
        <option value="HST10">US Hawaii (HST)</option>
        <option value="AKST9AKDT,M3.2.0,M11.1.0">US Alaska (AKST/AKDT)</option>
        <option value="GMT0BST,M3.5.0/1,M10.5.0">UK (GMT/BST)</option>
        <option value="CET-1CEST,M3.5.0,M10.5.0/3">Central Europe (CET/CEST)</option>
        <option value="EET-2EEST,M3.5.0/3,M10.5.0/4">Eastern Europe (EET/EEST)</option>
        <option value="JST-9">Japan (JST)</option>
        <option value="AEST-10AEDT,M10.1.0,M4.1.0/3">Australia Eastern (AEST/AEDT)</option>
        <option value="UTC">UTC (no offset)</option>
      </select>
      <div class="hint">Sets the local time used for log timestamps (NTP). Requires reboot to take effect.</div>

      <div id="tzCustomGroup" style="margin-top:10px;">
        <label for="tzCustom" class="card-label">Custom POSIX TZ String (advanced)</label>
        <input type="text" id="tzCustom" placeholder="e.g. EST5EDT,M3.2.0,M11.1.0">
        <div class="hint">Override the dropdown with a custom <a href="https://www.gnu.org/software/libc/manual/html_node/TZ-Variable.html" target="_blank" style="color:var(--accent);">POSIX TZ string</a>. Leave blank to use dropdown selection.</div>
      </div>
    </div>

    <!-- Tab: Maintenance / System -->
    <div id="tab-maintenance" class="config-tab-content">
      <div class="card-label">Device Information</div>
      <div id="deviceInfo" class="info-box">Loading device info...</div>

      <hr class="divider">

      <label for="viewerPassword" class="card-label">Viewer Password (Badge Reader)</label>
      <div style="display:flex; gap:8px;">
        <input type="password" id="viewerPassword" placeholder="Leave blank for open access" style="flex:1;">
        <button class="btn btn-outline btn-sm" onclick="togglePass('viewerPassword')" aria-label="Toggle password visibility">Show</button>
      </div>
      <div class="hint">Viewers must enter this password to access the dashboard and evidence log. Leave blank for open access.</div>

      <label for="otaPassword" class="card-label">Admin Password (Internal Affairs)</label>
      <div style="display:flex; gap:8px;">
        <input type="password" id="otaPassword" placeholder="Default: admin" style="flex:1;">
        <button class="btn btn-outline btn-sm" onclick="togglePass('otaPassword')" aria-label="Toggle password visibility">Show</button>
      </div>
      <div class="hint">Used for system configuration, console access, OTA firmware updates, and API authentication.</div>

      <hr class="divider">

      <!-- Firmware Update Section -->
      <div class="card-label" id="firmware-update">Firmware Update</div>
      <div id="fwVersionCompare" class="fw-version-compare">
        <div>
          <div class="fw-ver-label">Installed</div>
          <div id="fwInstalled" class="fw-ver-value">v--</div>
        </div>
        <div>
          <div class="fw-ver-label">Latest</div>
          <div id="fwLatest" class="fw-ver-value">—</div>
        </div>
      </div>
      <button class="btn btn-outline" id="fwCheckBtn" onclick="checkForUpdates()">Check for Updates</button>

      <div id="fwReleasePanel" style="display:none;">
        <div class="fw-release-info">
          <strong id="fwReleaseName"></strong>
          <div id="fwReleaseNotes" class="fw-release-notes"></div>
          <div id="fwAssetInfo" class="fw-asset-info"></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-accent" id="fwInstallBtn" onclick="installGitHubUpdate()">Install Update</button>
          <a id="fwGitHubLink" class="btn btn-outline" href="#" target="_blank" rel="noopener" style="text-decoration:none;">View on GitHub ↗</a>
        </div>
      </div>

      <div id="fwUpToDate" style="display:none; margin-top:8px;">
        <span style="color:var(--success, #28a745);">✓ Firmware is up to date</span>
      </div>
      <div id="fwCheckFailed" style="display:none; margin-top:8px;">
        <span style="color:var(--text-muted);">Could not check for updates. Check your internet connection.</span>
      </div>

      <!-- Manual upload fallback (collapsed) -->
      <details class="fw-manual-section">
        <summary>Advanced: Manual Firmware Upload</summary>
        <div class="hint" style="margin-top:8px; color:var(--danger, #dc3545);">
          ⚠️ Only use official builds from <a href="https://github.com/Ryan4n6/MASS-Trap/releases" target="_blank" rel="noopener" style="color:var(--accent);">GitHub Releases</a>.
          Uploading untrusted firmware can brick or compromise your device.
        </div>
        <div id="fwDropZone" class="fw-drop-zone">
          Drop .bin file here or click to select
          <input type="file" id="fwFileInput" accept=".bin" style="display:none;" onchange="handleFwFileSelect(this)">
        </div>
        <div id="fwFileInfo" style="display:none; margin-top:6px; font-size:0.8rem; color:var(--text-muted);"></div>
        <button class="btn btn-outline" id="fwUploadBtn" style="display:none; margin-top:8px;" onclick="uploadFirmware()">Upload &amp; Install</button>
        <div class="fw-upload-progress" id="fwUploadProgress">
          <div class="fw-upload-progress-bar" id="fwUploadProgressBar"></div>
        </div>
      </details>
      <div class="hint" style="margin-top:8px;">⚡ Device will reboot after update. <a href="https://github.com/Ryan4n6/MASS-Trap/issues" target="_blank" rel="noopener" style="color:var(--accent);">Report issues</a></div>

      <hr class="divider">

      <div class="card-label">System Snapshot</div>
      <div class="hint" style="margin-top:0; margin-bottom:10px;">Full backup of config + car garage + race history. Restore to same device or clone to a new one.</div>
      <div class="grid-3">
        <button class="btn btn-primary" style="margin:0;" onclick="downloadSnapshot()">Export</button>
        <button class="btn btn-outline" style="margin:0;" onclick="document.getElementById('snapshotFile').click()">Import</button>
        <button class="btn btn-outline" style="margin:0;" onclick="document.getElementById('cloneFile').click()">Clone</button>
      </div>
      <input type="file" id="snapshotFile" accept=".json" style="display:none;" onchange="restoreSnapshot(this, false)">
      <input type="file" id="cloneFile" accept=".json" style="display:none;" onchange="restoreSnapshot(this, true)">
      <div class="hint" style="margin-top:6px;"><strong>Clone</strong> strips WiFi/hostname for flashing to a different device.</div>

      <hr class="divider">

      <div class="card-label">Legacy Config Backup</div>
      <div class="grid-2">
        <button class="btn btn-outline" style="margin:0;" onclick="downloadBackup()">Export Config</button>
        <button class="btn btn-outline" style="margin:0;" onclick="document.getElementById('restoreFile').click()">Import Config</button>
      </div>
      <input type="file" id="restoreFile" accept=".json" style="display:none;" onchange="restoreBackup(this)">

      <hr class="divider">

      <div class="card-label" style="color:var(--danger);">Danger Zone</div>
      <button class="btn btn-danger" onclick="factoryReset()">
        Factory Reset
      </button>
      <div class="hint">Deletes ALL configuration and race data. Device reboots into setup mode.</div>
    </div>
  </div>

  <!-- Save bar (fixed bottom) -->
  <div class="save-bar">
    <button class="btn btn-accent" onclick="saveConfig()">SAVE CONFIGURATION &amp; REBOOT</button>
  </div>

  <!-- Status bar -->
  <div id="statusBar" class="status-bar" role="status" aria-live="polite"></div>
  <div id="versionBadge" class="version-badge">v--</div>

  <script src="/main.js"></script>
  <script>
    // ====================================================================
    // TAB NAVIGATION
    // ====================================================================
    var selectedRole = 'finish';

    function showTab(name, clickedBtn) {
      var tabs = document.querySelectorAll('.config-tab-content');
      for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
      var btns = document.querySelectorAll('.config-tab');
      for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
      document.getElementById('tab-' + name).classList.add('active');
      // Resolve clicked button: explicit param, event target, or fallback to id
      var activeBtn = clickedBtn || (typeof event !== 'undefined' && event && event.target) || document.getElementById('tabBtn-' + name);
      if (activeBtn) {
        activeBtn.classList.add('active');
        updateAriaTabState(activeBtn, '.config-tab');
      }
    }

    // ====================================================================
    // ROLE SELECTION
    // ====================================================================
    function selectRole(role) {
      selectedRole = role;
      document.getElementById('role').value = role;
      var cards = document.querySelectorAll('.role-card');
      for (var i = 0; i < cards.length; i++) {
        cards[i].classList.remove('selected');
        cards[i].setAttribute('aria-checked', 'false');
      }
      var activeCard = document.getElementById('role-' + role);
      activeCard.classList.add('selected');
      activeCard.setAttribute('aria-checked', 'true');

      // Update pin labels
      var sLabel = document.getElementById('sensorLabel');
      if (role === 'start') sLabel.textContent = 'Trigger Pin (Break-Beam Sensor)';
      else if (role === 'speedtrap') sLabel.textContent = 'IR Sensor Pin 1 (Speed Trap)';
      else sLabel.textContent = 'IR Sensor Pin (Finish Line)';

      // Show/hide speed trap fields
      document.getElementById('sensorPin2Group').style.display = role === 'speedtrap' ? 'block' : 'none';
      document.getElementById('speedTrapSpacing').style.display = role === 'speedtrap' ? 'block' : 'none';
    }

    // Arrow key navigation for role radiogroup
    (function() {
      var roleNames = ['start', 'finish', 'speedtrap'];
      document.addEventListener('keydown', function(e) {
        var active = document.activeElement;
        if (!active || !active.classList.contains('role-card')) return;
        var idx = roleNames.indexOf(active.id.replace('role-', ''));
        if (idx < 0) return;
        var newIdx = -1;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          newIdx = (idx + 1) % roleNames.length;
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          newIdx = (idx - 1 + roleNames.length) % roleNames.length;
        }
        if (newIdx >= 0) {
          e.preventDefault();
          selectRole(roleNames[newIdx]);
          document.getElementById('role-' + roleNames[newIdx]).focus();
        }
      });
    })();

    // ====================================================================
    // WIFI SCAN
    // ====================================================================
    function scanWifi() {
      var sel = document.getElementById('wifiScan');
      sel.innerHTML = '<option value="">Scanning...</option>';
      fetch('/api/scan').then(function(resp) {
        return resp.json();
      }).then(function(networks) {
        sel.innerHTML = '<option value="">-- Select network --</option>';
        for (var i = 0; i < networks.length; i++) {
          var n = networks[i];
          var sec = n.secure ? ' (secured)' : ' (open)';
          sel.innerHTML += '<option value="' + n.ssid + '">' + n.ssid + ' (' + n.rssi + 'dBm)' + sec + '</option>';
        }
      }).catch(function() {
        sel.innerHTML = '<option value="">Scan failed - try again</option>';
      });
    }

    // ====================================================================
    // PASSWORD TOGGLE
    // ====================================================================
    function togglePass(id) {
      var input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    // ====================================================================
    // DEVICE DISCOVERY
    // ====================================================================
    function discoverDevices() {
      var list = document.getElementById('deviceList');
      list.innerHTML = '<div class="hint">Scanning for devices...</div>';
      fetch('/api/peers').then(function(resp) {
        return resp.json();
      }).then(function(devices) {
        if (devices.length === 0) {
          list.innerHTML = '<div class="hint">No devices found. Make sure other devices are powered on.</div>';
          return;
        }
        var html = '';
        for (var i = 0; i < devices.length; i++) {
          var d = devices[i];
          var link = d.hostname ? '<a href="http://' + d.hostname + '.local/" target="_blank" onclick="event.stopPropagation()" style="color:var(--accent);text-decoration:underline;">' + d.hostname + '</a>' : d.mac;
          html += '<div class="device-item" onclick="document.getElementById(\'peerMac\').value=\'' + d.mac + '\'" style="cursor:pointer;">' +
            '<div><span class="device-role">' + d.role.toUpperCase() + '</span><span> - ' + link + '</span></div>' +
            '<span class="device-mac">' + d.mac + '</span></div>';
        }
        list.innerHTML = html;
      }).catch(function() {
        list.innerHTML = '<div class="hint">Discovery failed. Try again.</div>';
      });
    }

    // ====================================================================
    // WLED
    // ====================================================================
    function testWled() {
      var host = document.getElementById('wledHost').value.trim();
      var status = document.getElementById('wledStatus');
      if (!host) { status.style.display = 'block'; status.textContent = 'Enter a WLED host first'; return; }
      status.style.display = 'block';
      status.textContent = 'Testing connection...';
      fetch('/api/wled/info').then(function(resp) {
        if (resp.ok) {
          return resp.json().then(function(info) {
            status.textContent = 'Connected! WLED v' + (info.ver || '?') + ' - ' + (info.name || 'unnamed');
            status.className = 'info-box';
          });
        } else {
          status.textContent = 'Could not reach WLED controller';
          status.className = 'info-box warning';
        }
      }).catch(function(e) {
        status.textContent = 'Connection failed: ' + e.message;
        status.className = 'info-box warning';
      });
    }

    function loadWledEffects() {
      fetch('/api/wled/effects').then(function(resp) {
        if (!resp.ok) { alert('Could not load effects. Test WLED connection first.'); return; }
        return resp.json();
      }).then(function(effects) {
        if (!effects) return;
        var selects = document.querySelectorAll('.wled-effect');
        for (var s = 0; s < selects.length; s++) {
          var sel = selects[s];
          var currentVal = sel.value;
          var html = '';
          for (var idx = 0; idx < effects.length; idx++) {
            html += '<option value="' + idx + '"' + (idx == currentVal ? ' selected' : '') + '>' + idx + ' - ' + effects[idx] + '</option>';
          }
          sel.innerHTML = html;
        }
        showStatus('Effects loaded from WLED!', 'success');
      }).catch(function(e) {
        alert('Failed to load effects: ' + e.message);
      });
    }

    // ====================================================================
    // LIDAR TEST
    // ====================================================================
    function pollLidar() {
      var liveDiv = document.getElementById('lidarLive');
      liveDiv.style.display = 'block';
      fetch('/api/lidar/status').then(function(resp) {
        return resp.json();
      }).then(function(data) {
        if (!data.enabled) {
          document.getElementById('lidarDistance').textContent = 'DISABLED';
          document.getElementById('lidarState').textContent = 'Enable LiDAR and save config first';
          return;
        }
        document.getElementById('lidarDistance').textContent = data.distance_mm;
        document.getElementById('lidarState').textContent = data.state.toUpperCase();
      }).catch(function(e) {
        document.getElementById('lidarDistance').textContent = 'ERROR';
        document.getElementById('lidarState').textContent = e.message;
      });
    }

    // ====================================================================
    // SAVE CONFIG
    // ====================================================================
    function saveConfig() {
      var sensorPin = parseInt(document.getElementById('sensorPin').value);
      var ledPin = parseInt(document.getElementById('ledPin').value);
      if (sensorPin === ledPin) {
        showStatus('Sensor pin and LED pin cannot be the same!', 'error');
        return;
      }

      var networkMode = document.getElementById('networkMode').value || 'wifi';

      var config = {
        configured: true,
        version: 2,
        network: {
          wifi_ssid: document.getElementById('wifiSSID').value.trim(),
          wifi_pass: document.getElementById('wifiPass').value,
          hostname: document.getElementById('hostname').value.trim() || 'masstrap',
          mode: networkMode
        },
        device: {
          role: selectedRole,
          id: parseInt(document.getElementById('deviceId').value) || 1
        },
        pins: {
          sensor_pin: sensorPin,
          sensor_pin_2: parseInt(document.getElementById('sensorPin2').value) || 5,
          led_pin: ledPin
        },
        audio: {
          enabled: document.getElementById('audioEnabled').checked,
          bclk_pin: parseInt(document.getElementById('audioBclk').value) || 15,
          lrc_pin: parseInt(document.getElementById('audioLrc').value) || 16,
          dout_pin: parseInt(document.getElementById('audioDout').value) || 17,
          volume: parseInt(document.getElementById('audioVolume').value) || 10
        },
        lidar: {
          enabled: document.getElementById('lidarEnabled').checked,
          rx_pin: parseInt(document.getElementById('lidarRx').value) || 39,
          tx_pin: parseInt(document.getElementById('lidarTx').value) || 38,
          threshold_mm: parseInt(document.getElementById('lidarThreshold').value) || 50
        },
        peer: {
          mac: document.getElementById('peerMac').value.trim() || '00:00:00:00:00:00'
        },
        track: {
          length_m: parseFloat(document.getElementById('trackLength').value) || 2.0,
          scale_factor: parseInt(document.getElementById('scaleFactor').value) || 64,
          sensor_spacing_m: parseFloat(document.getElementById('sensorSpacing').value) || 0.10
        },
        integrations: {
          google_sheets_url: document.getElementById('sheetsUrl').value.trim(),
          wled_host: document.getElementById('wledHost').value.trim(),
          wled_effects: {
            idle: parseInt(document.getElementById('wledIdle').value) || 0,
            armed: parseInt(document.getElementById('wledArmed').value) || 28,
            racing: parseInt(document.getElementById('wledRacing').value) || 49,
            finished: parseInt(document.getElementById('wledFinished').value) || 11
          }
        },
        regional: {
          units: document.getElementById('unitSystem').value || 'imperial',
          timezone: document.getElementById('tzCustom').value.trim() || document.getElementById('timezone').value || 'EST5EDT,M3.2.0,M11.1.0'
        },
        ota: {
          password: document.getElementById('otaPassword').value || 'admin'
        },
        auth: {
          viewer_password: document.getElementById('viewerPassword').value || ''
        }
      };

      showStatus('Saving configuration...', '');
      fetch('/api/config', {
        method: 'POST',
        headers: authHeaders({ 'Content-Type': 'application/json' }),
        body: JSON.stringify(config)
      }).then(function(resp) {
        return resp.json().then(function(result) {
          if (resp.ok) {
            showStatus('Config saved! Device rebooting...', 'success');
            setTimeout(function() {
              var host = config.network.hostname || 'masstrap';
              showStatus('Reconnecting to http://' + host + '.local ...', '');
              setTimeout(function() { window.location.href = 'http://' + host + '.local/'; }, 5000);
            }, 3000);
          } else {
            showStatus('Error: ' + (result.error || 'Save failed'), 'error');
          }
        });
      }).catch(function(e) {
        showStatus('Error: ' + e.message, 'error');
      });
    }

    // ====================================================================
    // BACKUP / RESTORE / SNAPSHOT / RESET
    // ====================================================================
    function downloadBackup() {
      window.location.href = '/api/backup';
    }

    function downloadSnapshot() {
      window.location.href = '/api/system/backup';
    }

    function restoreBackup(input) {
      var file = input.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(ev) {
        var text = ev.target.result;
        try {
          JSON.parse(text);
        } catch (e) {
          showStatus('Invalid JSON file', 'error');
          input.value = '';
          return;
        }
        showStatus('Restoring configuration...', '');
        fetch('/api/restore', {
          method: 'POST',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: text
        }).then(function(resp) {
          if (resp.ok) {
            showStatus('Config restored! Device rebooting...', 'success');
          } else {
            showStatus('Restore failed', 'error');
          }
        }).catch(function() {
          showStatus('Restore failed', 'error');
        });
        input.value = '';
      };
      reader.readAsText(file);
    }

    function restoreSnapshot(input, skipNetwork) {
      var file = input.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(ev) {
        var text = ev.target.result;
        try {
          JSON.parse(text);
        } catch (e) {
          showStatus('Invalid snapshot file', 'error');
          input.value = '';
          return;
        }
        var label = skipNetwork ? 'Cloning system snapshot...' : 'Restoring system snapshot...';
        showStatus(label, '');
        var url = '/api/system/restore' + (skipNetwork ? '?skip_network=true' : '');
        fetch(url, {
          method: 'POST',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: text
        }).then(function(resp) {
          if (resp.ok) {
            showStatus('System snapshot restored! Device rebooting...', 'success');
          } else {
            showStatus('Restore failed', 'error');
          }
        }).catch(function() {
          showStatus('Restore failed', 'error');
        });
        input.value = '';
      };
      reader.readAsText(file);
    }

    function factoryReset() {
      if (!confirm('This will delete ALL configuration and race data. Continue?')) return;
      if (!confirm('Are you absolutely sure? This cannot be undone.')) return;
      fetch('/api/reset', { method: 'POST', headers: authHeaders() }).then(function() {
        showStatus('Factory reset! Device rebooting into setup mode...', 'success');
      }).catch(function() {
        showStatus('Reset failed', 'error');
      });
    }

    // ====================================================================
    // STATUS BAR
    // ====================================================================
    function showStatus(msg, type) {
      var bar = document.getElementById('statusBar');
      bar.textContent = msg;
      bar.className = 'status-bar show' + (type ? ' ' + type : '');
      if (type) setTimeout(function() { bar.classList.remove('show'); }, 5000);
    }

    // ====================================================================
    // LOAD EXISTING CONFIG
    // ====================================================================
    function loadExistingConfig() {
      fetch('/api/mac').then(function(r) { return r.json(); }).then(function(macData) {
        document.getElementById('myMac').value = macData.mac;
      }).catch(function() {});

      fetch('/api/info').then(function(r) { return r.json(); }).then(function(info) {
        if (info.role && info.role !== 'unconfigured') {
          var roleName = info.role.charAt(0).toUpperCase() + info.role.slice(1);
          document.title = 'M.A.S.S. Trap - ' + roleName + ' Config';
        }
        document.getElementById('deviceInfo').innerHTML =
          '<strong>Firmware:</strong> v' + (info.firmware || '?') + '<br>' +
          '<strong>Role:</strong> ' + (info.role || 'unconfigured').toUpperCase() + '<br>' +
          '<strong>IP:</strong> ' + (info.ip || 'N/A') + '<br>' +
          '<strong>Uptime:</strong> ' + (info.uptime_s || 0) + 's<br>' +
          '<strong>Free Heap:</strong> ' + (info.free_heap || 0).toLocaleString() + ' bytes<br>' +
          '<strong>Audio:</strong> ' + (info.audio_enabled ? 'Enabled' : 'Disabled') + '<br>' +
          '<strong>LiDAR:</strong> ' + (info.lidar_enabled ? 'Enabled' : 'Disabled');
      }).catch(function() {});

      fetch('/api/config').then(function(r) { return r.json(); }).then(function(cfg) {
        if (!cfg.configured) return;

        if (cfg.network) {
          document.getElementById('wifiSSID').value = cfg.network.wifi_ssid || '';
          document.getElementById('wifiPass').value = cfg.network.wifi_pass || '';
          document.getElementById('hostname').value = cfg.network.hostname || 'masstrap';
          document.getElementById('networkMode').value = cfg.network.mode || 'wifi';
        }
        if (cfg.device) {
          selectRole(cfg.device.role || 'finish');
          document.getElementById('deviceId').value = cfg.device.id || 1;
        }
        if (cfg.pins) {
          document.getElementById('sensorPin').value = cfg.pins.sensor_pin || 4;
          document.getElementById('sensorPin2').value = cfg.pins.sensor_pin_2 || 5;
          document.getElementById('ledPin').value = cfg.pins.led_pin || 2;
        }
        if (cfg.audio) {
          document.getElementById('audioEnabled').checked = cfg.audio.enabled || false;
          document.getElementById('audioBclk').value = cfg.audio.bclk_pin || 15;
          document.getElementById('audioLrc').value = cfg.audio.lrc_pin || 16;
          document.getElementById('audioDout').value = cfg.audio.dout_pin || 17;
          document.getElementById('audioVolume').value = cfg.audio.volume || 10;
          document.getElementById('volLabel').textContent = cfg.audio.volume || 10;
        }
        if (cfg.lidar) {
          document.getElementById('lidarEnabled').checked = cfg.lidar.enabled || false;
          document.getElementById('lidarRx').value = cfg.lidar.rx_pin || 39;
          document.getElementById('lidarTx').value = cfg.lidar.tx_pin || 38;
          document.getElementById('lidarThreshold').value = cfg.lidar.threshold_mm || 50;
        }
        if (cfg.peer) {
          document.getElementById('peerMac').value = cfg.peer.mac || '';
        }
        if (cfg.track) {
          document.getElementById('trackLength').value = cfg.track.length_m || 2.0;
          document.getElementById('scaleFactor').value = cfg.track.scale_factor || 64;
          document.getElementById('sensorSpacing').value = cfg.track.sensor_spacing_m || 0.10;
        }
        if (cfg.integrations) {
          document.getElementById('sheetsUrl').value = cfg.integrations.google_sheets_url || '';
          document.getElementById('wledHost').value = cfg.integrations.wled_host || '';
          if (cfg.integrations.wled_effects) {
            document.getElementById('wledIdle').value = cfg.integrations.wled_effects.idle || 0;
            document.getElementById('wledArmed').value = cfg.integrations.wled_effects.armed || 28;
            document.getElementById('wledRacing').value = cfg.integrations.wled_effects.racing || 49;
            document.getElementById('wledFinished').value = cfg.integrations.wled_effects.finished || 11;
          }
        }
        if (cfg.regional) {
          document.getElementById('unitSystem').value = cfg.regional.units || 'imperial';
          var tz = cfg.regional.timezone || 'EST5EDT,M3.2.0,M11.1.0';
          // Try to match dropdown, otherwise put in custom field
          var tzSelect = document.getElementById('timezone');
          var matched = false;
          for (var i = 0; i < tzSelect.options.length; i++) {
            if (tzSelect.options[i].value === tz) { tzSelect.value = tz; matched = true; break; }
          }
          if (!matched) {
            tzSelect.value = 'UTC'; // Fallback dropdown
            document.getElementById('tzCustom').value = tz;
          }
        }
        if (cfg.ota) {
          document.getElementById('otaPassword').value = cfg.ota.password || 'admin';
        }
        if (cfg.auth) {
          document.getElementById('viewerPassword').value = cfg.auth.viewer_password || '';
        }
      }).catch(function(e) {
        console.log('Could not load config (may be first boot):', e);
      });
    }

    // ====================================================================
    // FIRMWARE UPDATE
    // ====================================================================
    var _fwReleaseCache = null;  // Cached release data for install flow

    function checkForUpdates() {
      var btn = document.getElementById('fwCheckBtn');
      btn.textContent = 'Checking...';
      btn.disabled = true;

      // Hide previous results
      document.getElementById('fwReleasePanel').style.display = 'none';
      document.getElementById('fwUpToDate').style.display = 'none';
      document.getElementById('fwCheckFailed').style.display = 'none';

      // Get current firmware version from device
      fetch('/api/version').then(function(r) { return r.json(); }).then(function(v) {
        var currentFw = v.firmware || '0.0.0';
        document.getElementById('fwInstalled').textContent = 'v' + currentFw;

        // Force-refresh GitHub check (bypass 24hr cache)
        return checkGitHubRelease(true).then(function(release) {
          btn.textContent = 'Check for Updates';
          btn.disabled = false;

          if (!release || !release.tag_name) {
            document.getElementById('fwLatest').textContent = '—';
            document.getElementById('fwCheckFailed').style.display = 'block';
            return;
          }

          var latest = release.tag_name.replace(/^v/i, '');
          document.getElementById('fwLatest').textContent = 'v' + latest;

          if (compareSemver(latest, currentFw) > 0) {
            // Update available!
            document.getElementById('fwLatest').classList.add('fw-outdated');
            document.getElementById('fwLatest').classList.remove('fw-current');
            document.getElementById('fwReleaseName').textContent = release.name || release.tag_name;

            // Truncate release notes to first 500 chars
            var body = release.body || 'No release notes available.';
            if (body.length > 500) body = body.substring(0, 500) + '...';
            document.getElementById('fwReleaseNotes').textContent = body;

            // Find .bin asset
            var asset = null;
            if (release.assets) {
              for (var i = 0; i < release.assets.length; i++) {
                if (release.assets[i].name.match(/\.bin$/i)) {
                  asset = release.assets[i];
                  break;
                }
              }
            }

            if (asset) {
              var sizeMB = (asset.size / 1024 / 1024).toFixed(2);
              document.getElementById('fwAssetInfo').textContent = asset.name + ' (' + sizeMB + ' MB)';
              document.getElementById('fwInstallBtn').style.display = '';
              _fwReleaseCache = { release: release, asset: asset };
            } else {
              document.getElementById('fwAssetInfo').textContent = 'No .bin asset found in this release. Use manual upload.';
              document.getElementById('fwInstallBtn').style.display = 'none';
              _fwReleaseCache = null;
            }

            document.getElementById('fwGitHubLink').href = release.html_url || GITHUB_RELEASES_URL;
            document.getElementById('fwReleasePanel').style.display = 'block';
          } else {
            // Up to date
            document.getElementById('fwLatest').classList.remove('fw-outdated');
            document.getElementById('fwLatest').classList.add('fw-current');
            document.getElementById('fwUpToDate').style.display = 'block';
          }
        });
      }).catch(function(err) {
        btn.textContent = 'Check for Updates';
        btn.disabled = false;
        document.getElementById('fwCheckFailed').style.display = 'block';
      });
    }

    function installGitHubUpdate() {
      if (!_fwReleaseCache || !_fwReleaseCache.asset) return;
      var asset = _fwReleaseCache.asset;
      var release = _fwReleaseCache.release;
      var ver = release.tag_name || 'unknown';

      if (!confirm('Install firmware ' + ver + '?\n\nThe device will download from GitHub and reboot.\nThis takes 30-60 seconds.')) {
        return;
      }

      // Parse MD5 from release body (looks for **MD5:** <hash>)
      var md5 = '';
      if (release.body) {
        var md5Match = release.body.match(/\*\*MD5:\*\*\s*([a-fA-F0-9]{32})/);
        if (md5Match) md5 = md5Match[1].toLowerCase();
      }

      // Show overlay
      showFwUpdateOverlay('Downloading firmware ' + ver + '...');

      // Tell ESP to download from GitHub
      var payload = JSON.stringify({ url: asset.browser_download_url, md5: md5 });
      fetch('/api/firmware/update-from-url', {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, authHeaders()),
        body: payload
      }).then(function(r) {
        if (!r.ok) return r.json().then(function(e) { throw new Error(e.error || 'Request failed'); });
        return r.json();
      }).then(function(data) {
        updateOverlayMessage('Device is downloading and installing firmware...\nDo not power off.');
        if (!md5) {
          updateOverlaySub('⚠️ No MD5 checksum found in release — integrity check skipped');
        }
        // Wait for device to reboot
        waitForReboot(release);
      }).catch(function(err) {
        removeFwUpdateOverlay();
        alert('Firmware update failed: ' + err.message);
      });
    }

    function waitForReboot(release) {
      var attempts = 0;
      var maxAttempts = 60; // 2 minutes at 2s intervals
      var checkInterval = setInterval(function() {
        attempts++;
        if (attempts > maxAttempts) {
          clearInterval(checkInterval);
          removeFwUpdateOverlay();
          alert('Device did not come back online after 2 minutes.\nIt may need manual attention.');
          return;
        }
        updateOverlaySub('Waiting for device to reboot... (' + attempts + 's)');

        fetch('/api/version', { cache: 'no-store' }).then(function(r) {
          return r.json();
        }).then(function(v) {
          // Device is back! Clear the overlay and show release notes
          clearInterval(checkInterval);
          removeFwUpdateOverlay();
          showReleaseNotesPopup(v.firmware, release);
          // Refresh the version badge
          loadVersion();
        }).catch(function() {
          // Device still rebooting — keep waiting
        });
      }, 2000);
    }

    function showFwUpdateOverlay(msg) {
      var overlay = document.createElement('div');
      overlay.id = 'fwOverlay';
      overlay.className = 'fw-update-overlay';
      overlay.innerHTML = '<div class="fw-spinner"></div>' +
        '<div class="fw-overlay-msg" id="fwOverlayMsg">' + msg + '</div>' +
        '<div class="fw-overlay-sub" id="fwOverlaySub">Please do not close this page or power off the device.</div>';
      document.body.appendChild(overlay);
    }

    function updateOverlayMessage(msg) {
      var el = document.getElementById('fwOverlayMsg');
      if (el) el.textContent = msg;
    }

    function updateOverlaySub(msg) {
      var el = document.getElementById('fwOverlaySub');
      if (el) el.textContent = msg;
    }

    function removeFwUpdateOverlay() {
      var el = document.getElementById('fwOverlay');
      if (el) el.parentNode.removeChild(el);
    }

    function showReleaseNotesPopup(newVersion, release) {
      // Create backdrop
      var backdrop = document.createElement('div');
      backdrop.className = 'fw-release-popup-backdrop';
      backdrop.onclick = function() { closeReleasePopup(); };

      // Create popup
      var popup = document.createElement('div');
      popup.className = 'fw-release-popup';
      popup.id = 'fwReleasePopup';

      var title = release ? (release.name || release.tag_name) : ('v' + newVersion);
      var body = release && release.body ? release.body : 'No release notes available.';
      if (body.length > 800) body = body.substring(0, 800) + '...';
      var url = release && release.html_url ? release.html_url : GITHUB_RELEASES_URL;

      popup.innerHTML = '<h3>🎉 Updated to ' + title + '</h3>' +
        '<div class="fw-release-body">' + body.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' +
        '<div style="display:flex; gap:8px; margin-top:12px;">' +
        '<button class="btn btn-accent" onclick="closeReleasePopup()">Got it!</button>' +
        '<a class="btn btn-outline" href="' + url + '" target="_blank" rel="noopener" style="text-decoration:none;">Full Release Notes ↗</a>' +
        '</div>';

      document.body.appendChild(backdrop);
      document.body.appendChild(popup);
    }

    function closeReleasePopup() {
      var popup = document.getElementById('fwReleasePopup');
      if (popup) popup.parentNode.removeChild(popup);
      var backdrops = document.querySelectorAll('.fw-release-popup-backdrop');
      for (var i = 0; i < backdrops.length; i++) backdrops[i].parentNode.removeChild(backdrops[i]);
    }

    // Manual upload — file select handler
    function handleFwFileSelect(input) {
      var file = input.files[0];
      if (!file) return;
      if (!file.name.match(/\.bin$/i)) {
        alert('Please select a .bin firmware file.');
        input.value = '';
        return;
      }
      var sizeMB = (file.size / 1024 / 1024).toFixed(2);
      document.getElementById('fwFileInfo').textContent = file.name + ' (' + sizeMB + ' MB)';
      document.getElementById('fwFileInfo').style.display = 'block';
      document.getElementById('fwUploadBtn').style.display = 'inline-block';
    }

    // Manual upload — send file to ESP
    function uploadFirmware() {
      var input = document.getElementById('fwFileInput');
      if (!input.files[0]) return;

      if (!confirm('Upload and install ' + input.files[0].name + '?\n\nThe device will reboot after upload.')) {
        return;
      }

      var formData = new FormData();
      formData.append('firmware', input.files[0]);

      var progressContainer = document.getElementById('fwUploadProgress');
      var progressBar = document.getElementById('fwUploadProgressBar');
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/firmware/upload');
      xhr.setRequestHeader('X-API-Key', getApiKey());

      xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
          var pct = Math.round(e.loaded / e.total * 100);
          progressBar.style.width = pct + '%';
        }
      };

      xhr.onload = function() {
        if (xhr.status === 200) {
          showFwUpdateOverlay('Upload complete — device is rebooting...');
          waitForReboot(null);
        } else {
          progressContainer.style.display = 'none';
          try {
            var resp = JSON.parse(xhr.responseText);
            alert('Upload failed: ' + (resp.error || 'Unknown error'));
          } catch (e) {
            alert('Upload failed: ' + xhr.statusText);
          }
        }
      };

      xhr.onerror = function() {
        progressContainer.style.display = 'none';
        alert('Upload failed: network error');
      };

      xhr.send(formData);
    }

    // Drop zone handlers
    (function() {
      var dz = document.getElementById('fwDropZone');
      var fi = document.getElementById('fwFileInput');
      if (!dz || !fi) return;

      dz.onclick = function() { fi.click(); };
      dz.ondragover = function(e) { e.preventDefault(); dz.classList.add('dragover'); };
      dz.ondragleave = function() { dz.classList.remove('dragover'); };
      dz.ondrop = function(e) {
        e.preventDefault();
        dz.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
          fi.files = e.dataTransfer.files;
          handleFwFileSelect(fi);
        }
      };
    })();

    // ====================================================================
    // INIT
    // ====================================================================
    window.onload = function() {
      document.getElementById('navContainer').innerHTML = getNavHTML();
      massInit({ws: false});
      initAriaTabs('#configTablist', '.config-tab', 'tab-');
      loadExistingConfig();
      scanWifi();
      // Internal Affairs gate — admin password check
      checkAuthGate('admin');
      // Deep-link: #firmware-update switches to System tab and scrolls
      if (window.location.hash === '#firmware-update') {
        showTab('maintenance', document.getElementById('tabBtn-maintenance'));
        setTimeout(function() {
          var el = document.getElementById('firmware-update');
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      }
    };
  </script>
</body>
</html>
