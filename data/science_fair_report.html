<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M.A.S.S. Trap — Science Fair Laboratory Report</title>
<style>
/* ========================================================================
   M.A.S.S. TRAP — FORENSIC SCIENCE FAIR REPORT (Template-Driven)
   Motion Analysis & Speed System — Laboratory Evidence Report
   Zero hardcoded values — everything populated from localStorage data
   ======================================================================== */

:root {
  --navy: #091B2F;
  --navy-light: #0D2844;
  --navy-mid: #132E4A;
  --gold: #D4AF37;
  --gold-light: #E8C84A;
  --orange: #FF4500;
  --orange-glow: rgba(255, 69, 0, 0.15);
  --green: #00C853;
  --red: #FF1744;
  --cyan: #00BCD4;
  --white: #F5F5F5;
  --gray: #9E9E9E;
  --gray-dark: #616161;
  --paper: #FAFAFA;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.15);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

@page {
  size: letter;
  margin: 0.75in;
}

body {
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
  background: var(--navy);
  color: var(--white);
  line-height: 1.6;
  min-height: 100vh;
}

/* === PRINT STYLES === */
@media print {
  body { background: white; color: #1a1a1a; font-size: 10pt; line-height: 1.4; }
  .report-container { max-width: 100%; padding: 0; }
  .cover-page { page-break-after: always; min-height: auto; padding: 2em 0; background: white !important; }
  .cover-badge { filter: none; }
  .section { page-break-inside: avoid; border: 1px solid #ccc !important; background: white !important; color: #1a1a1a !important; box-shadow: none !important; }
  .section-header { background: #2a2a2a !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .data-table th { background: #2a2a2a !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .status-bar, .no-print { display: none !important; }
  .watermark { opacity: 0.03; }
  .toc a { color: #1a1a1a; }
  .variable-card { border: 1px solid #ccc; background: #f5f5f5 !important; color: #1a1a1a !important; }
  .variable-label { color: #333 !important; }
  .anomaly-badge { border: 1px solid #ccc !important; }
  #photoGalleryGrid { grid-template-columns: repeat(3, 1fr) !important; gap: 8px !important; }
  #photoGalleryGrid img { height: 100px !important; }
  #photoGalleryGrid div { border-color: #ccc !important; background: #f9f9f9 !important; }
  #photoGalleryGrid a { text-decoration: none; }
}

/* === REPORT CONTAINER === */
.report-container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 2rem;
}

/* === STATUS BAR (screen only) === */
.status-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 40px;
  background: linear-gradient(90deg, var(--navy) 0%, var(--navy-light) 50%, var(--navy) 100%);
  border-bottom: 2px solid var(--gold);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 2rem;
  z-index: 1000;
  font-family: 'Consolas', 'Courier New', monospace;
  font-size: 0.75rem;
  color: var(--gold);
}
.status-bar .blink {
  animation: blink 1.5s ease-in-out infinite;
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
.status-bar .classification {
  letter-spacing: 3px;
  text-transform: uppercase;
  font-weight: 700;
}

/* === COVER PAGE === */
.cover-page {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 4rem 2rem;
  position: relative;
  overflow: hidden;
  margin-top: 40px;
}
.cover-page::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 30%, rgba(212, 175, 55, 0.08) 0%, transparent 70%);
  pointer-events: none;
}
.watermark {
  position: absolute;
  font-size: 20vw;
  font-weight: 900;
  color: rgba(212, 175, 55, 0.03);
  letter-spacing: 2vw;
  pointer-events: none;
  user-select: none;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-15deg);
  white-space: nowrap;
}
.cover-badge {
  width: 140px;
  height: 140px;
  border: 4px solid var(--gold);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 2rem;
  position: relative;
  background: var(--navy-light);
  box-shadow: 0 0 40px rgba(212, 175, 55, 0.2), inset 0 0 20px rgba(212, 175, 55, 0.1);
}
.cover-badge-inner { font-size: 3.5rem; line-height: 1; }
.cover-title {
  font-size: 2.8rem;
  font-weight: 800;
  letter-spacing: 6px;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 0.5rem;
  text-shadow: 0 2px 20px rgba(212, 175, 55, 0.3);
}
.cover-subtitle {
  font-size: 1.1rem;
  font-weight: 300;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--gray);
  margin-bottom: 3rem;
}
.cover-report-title {
  font-size: 1.8rem;
  font-weight: 600;
  color: var(--white);
  margin-bottom: 0.5rem;
  line-height: 1.3;
}
.cover-case-id {
  font-family: 'Consolas', 'Courier New', monospace;
  font-size: 1.2rem;
  color: var(--orange);
  letter-spacing: 2px;
  margin-bottom: 3rem;
  padding: 0.5rem 1.5rem;
  border: 1px solid var(--orange);
  border-radius: 4px;
  display: inline-block;
}
.cover-meta {
  display: grid;
  grid-template-columns: auto auto;
  gap: 0.5rem 2rem;
  text-align: left;
  font-size: 0.95rem;
  color: var(--gray);
  margin-top: 1rem;
}
.cover-meta .label { font-weight: 600; color: var(--gold); text-align: right; }
.cover-meta .value { color: var(--white); }
.cover-divider {
  width: 200px;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  margin: 2rem auto;
}

/* === EXECUTIVE SUMMARY BAR === */
.exec-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1rem;
  margin: 2rem 0;
}
.exec-card {
  background: var(--navy-light);
  border: 1px solid rgba(212, 175, 55, 0.3);
  border-radius: 8px;
  padding: 1.2rem;
  text-align: center;
}
.exec-card .num {
  font-size: 2rem;
  font-weight: 800;
  color: var(--gold);
  font-family: 'Consolas', monospace;
}
.exec-card .desc {
  font-size: 0.8rem;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* === TABLE OF CONTENTS === */
.toc {
  background: var(--navy-light);
  border: 1px solid rgba(212, 175, 55, 0.2);
  border-radius: 12px;
  padding: 2rem;
  margin: 2rem 0;
}
.toc h2 {
  color: var(--gold);
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 3px;
  margin-bottom: 1rem;
}
.toc-list { list-style-type: decimal; padding-left: 1.5rem; }
.toc-list li { margin-bottom: 0.4rem; }
.toc-list a { color: rgba(255, 255, 255, 0.8); text-decoration: none; font-size: 0.95rem; }
.toc-list a:hover { color: var(--gold); }

/* === SECTION BLOCKS === */
.section {
  background: var(--navy-light);
  border: 1px solid rgba(212, 175, 55, 0.15);
  border-radius: 12px;
  margin: 2rem 0;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.section-header {
  background: linear-gradient(90deg, var(--navy-mid), var(--navy-light));
  padding: 1rem 1.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  border-bottom: 2px solid rgba(212, 175, 55, 0.3);
}
.section-number {
  font-family: 'Consolas', monospace;
  font-size: 1.8rem;
  font-weight: 900;
  color: var(--orange);
  min-width: 3rem;
}
.section-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 2px;
}
.section-body { padding: 1.5rem; }

/* === HYPOTHESIS BOX === */
.hypothesis-box {
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(0, 200, 83, 0.3);
  border-radius: 8px;
  padding: 1.2rem 1.5rem;
  margin: 1rem 0;
}
.hypothesis-label {
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--green);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 0.5rem;
}
.hypothesis-text { font-size: 1rem; line-height: 1.6; color: rgba(255, 255, 255, 0.95); }

/* === VARIABLES GRID === */
.variable-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}
.variable-card {
  border-radius: 8px;
  padding: 1.2rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.variable-card.independent { background: rgba(0, 200, 83, 0.08); border-color: rgba(0, 200, 83, 0.3); }
.variable-card.dependent { background: rgba(0, 188, 212, 0.08); border-color: rgba(0, 188, 212, 0.3); }
.variable-card.controlled { background: rgba(212, 175, 55, 0.05); border-color: rgba(212, 175, 55, 0.2); }
.variable-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 0.3rem;
}
.variable-card.independent .variable-label { color: var(--green); }
.variable-card.dependent .variable-label { color: var(--cyan); }
.variable-card.controlled .variable-label { color: var(--gold); }
.variable-name { font-weight: 600; color: var(--white); font-size: 0.95rem; }
.variable-detail { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 0.3rem; line-height: 1.5; }

/* === MATERIALS GRID === */
.materials-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}
.material-item {
  display: flex;
  gap: 0.8rem;
  align-items: flex-start;
  padding: 1rem;
  background: rgba(0, 0, 0, 0.15);
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}
.material-icon { font-size: 1.5rem; min-width: 2rem; text-align: center; }
.material-name { font-weight: 600; color: var(--white); font-size: 0.95rem; }
.material-spec { font-size: 0.8rem; color: var(--gray); margin-top: 0.2rem; }

/* === PROCEDURE STEPS === */
.procedure-list { counter-reset: procedure; margin: 1.5rem 0; }
.procedure-step {
  counter-increment: procedure;
  display: flex;
  gap: 1.2rem;
  margin-bottom: 1.2rem;
  padding: 1rem;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  border-left: 3px solid rgba(212, 175, 55, 0.3);
  transition: border-color 0.2s;
}
.procedure-step:hover { border-left-color: var(--gold); }
.procedure-step::before {
  content: counter(procedure, decimal-leading-zero);
  font-family: 'Consolas', monospace;
  font-size: 1.4rem;
  font-weight: 800;
  color: var(--orange);
  min-width: 2.5rem;
  line-height: 1.4;
}
.procedure-step .text { color: rgba(255, 255, 255, 0.9); flex: 1; }
.procedure-step .note { font-size: 0.85rem; color: var(--cyan); margin-top: 0.3rem; font-style: italic; }

/* === DATA TABLES === */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.5rem 0;
  font-size: 0.85rem;
}
.data-table th {
  background: var(--navy-mid);
  color: var(--gold);
  padding: 0.6rem 0.8rem;
  text-align: left;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 2px solid var(--gold);
}
.data-table td {
  padding: 0.6rem 0.8rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  color: rgba(255, 255, 255, 0.9);
  font-family: 'Consolas', monospace;
  font-size: 0.82rem;
}
.data-table tr:nth-child(even) td { background: rgba(0,0,0,0.12); }
.data-table .anomaly-row td { background: rgba(255, 165, 0, 0.12) !important; border-left: 3px solid var(--orange); }

/* === ANOMALY BADGES === */
.anomaly-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.5px;
}
.anomaly-badge.high { background: rgba(255, 23, 68, 0.15); color: var(--red); border: 1px solid rgba(255, 23, 68, 0.4); }
.anomaly-badge.medium { background: rgba(255, 165, 0, 0.15); color: var(--orange); border: 1px solid rgba(255, 165, 0, 0.4); }
.anomaly-badge.info { background: rgba(0, 188, 212, 0.15); color: var(--cyan); border: 1px solid rgba(0, 188, 212, 0.4); }

/* === METRIC CALLOUTS === */
.metric-row { display: flex; gap: 1.5rem; flex-wrap: wrap; margin: 1.5rem 0; }
.metric-box {
  flex: 1;
  min-width: 150px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  padding: 1.2rem;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.metric-value { font-family: 'Consolas', monospace; font-size: 2rem; font-weight: 800; color: var(--gold); }
.metric-unit { font-size: 0.9rem; color: var(--gray); margin-left: 0.3rem; }
.metric-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--gray); margin-top: 0.3rem; }

/* === EQUATION BLOCKS === */
.equation-block {
  background: rgba(0, 0, 0, 0.25);
  border-radius: 8px;
  padding: 1.2rem 1.5rem;
  margin: 1rem 0;
  font-family: 'Consolas', 'Courier New', monospace;
  font-size: 1rem;
  text-align: center;
  color: var(--cyan);
  border: 1px solid rgba(0, 188, 212, 0.2);
}
.equation-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--gray);
  margin-bottom: 0.5rem;
  font-family: 'Segoe UI', sans-serif;
}

/* === CHAIN OF CUSTODY TABLE === */
.coc-table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; font-size: 0.85rem; }
.coc-table th {
  background: var(--navy-mid);
  color: var(--gold);
  padding: 0.6rem 0.8rem;
  text-align: left;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 2px solid var(--gold);
}
.coc-table td { padding: 0.6rem 0.8rem; border-bottom: 1px solid rgba(255, 255, 255, 0.06); color: rgba(255, 255, 255, 0.9); }
.coc-table tr:nth-child(even) td { background: rgba(0,0,0,0.12); }

/* === ANALYSIS === */
.analysis-highlight {
  background: linear-gradient(135deg, rgba(0, 200, 83, 0.08), rgba(0, 188, 212, 0.05));
  border: 1px solid rgba(0, 200, 83, 0.3);
  border-radius: 8px;
  padding: 1.2rem 1.5rem;
  margin: 1rem 0;
}
.analysis-highlight .finding { font-weight: 700; color: var(--green); margin-bottom: 0.3rem; }
.analysis-highlight .detail { color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; }

.warning-box {
  background: rgba(255, 23, 68, 0.08);
  border: 1px solid rgba(255, 23, 68, 0.3);
  border-radius: 8px;
  padding: 1.2rem 1.5rem;
  margin: 1rem 0;
}
.warning-box .label { font-weight: 700; color: var(--red); margin-bottom: 0.3rem; }

/* === ATTESTATION === */
.attestation {
  background: rgba(0, 0, 0, 0.3);
  border: 2px solid var(--gold);
  border-radius: 12px;
  padding: 2rem;
  margin: 2rem 0;
  font-family: 'Georgia', 'Times New Roman', serif;
}
.attestation-header {
  text-align: center;
  font-size: 1rem;
  font-weight: 700;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 3px;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(212, 175, 55, 0.3);
}
.attestation p { margin-bottom: 1rem; line-height: 1.8; color: rgba(255, 255, 255, 0.85); }
.attestation .sig-line { margin-top: 3rem; display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; }
.attestation .sig-block { border-top: 1px solid var(--gray); padding-top: 0.5rem; }
.attestation .sig-block .name { font-weight: 700; color: var(--white); }
.attestation .sig-block .role { font-size: 0.85rem; color: var(--gray); }

/* === FOOTER === */
.report-footer {
  text-align: center;
  padding: 3rem 0;
  border-top: 1px solid rgba(212, 175, 55, 0.2);
  margin-top: 3rem;
}
.report-footer .system-name { font-size: 1.1rem; color: var(--gold); letter-spacing: 4px; text-transform: uppercase; font-weight: 700; }
.report-footer .version { font-size: 0.8rem; color: var(--gray); margin-top: 0.3rem; font-family: 'Consolas', monospace; }
.report-footer .disclaimer { font-size: 0.75rem; color: var(--gray-dark); margin-top: 1.5rem; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.5; }

/* === NO DATA MESSAGE === */
.no-data-msg {
  text-align: center;
  padding: 6rem 2rem;
  color: var(--gray);
}
.no-data-msg .icon { font-size: 4rem; margin-bottom: 1rem; }
.no-data-msg h2 { color: var(--gold); margin-bottom: 0.5rem; }
.no-data-msg p { max-width: 500px; margin: 0.5rem auto; }
.no-data-msg .hint { color: var(--cyan); font-size: 0.85rem; margin-top: 1.5rem; }

/* === PLACEHOLDER (when section has no data) === */
.placeholder-note {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--gray);
  font-style: italic;
  border: 2px dashed rgba(212, 175, 55, 0.2);
  border-radius: 12px;
  margin: 1.5rem 0;
}
.placeholder-note .icon { font-size: 2.5rem; margin-bottom: 1rem; }
.placeholder-note .instruction { color: var(--gold); font-style: normal; font-weight: 600; margin-top: 0.5rem; }

/* === RESPONSIVE === */
@media (max-width: 768px) {
  .report-container { padding: 1rem; }
  .cover-title { font-size: 1.8rem; letter-spacing: 3px; }
  .cover-meta { grid-template-columns: 1fr; gap: 0.3rem 0; }
  .section-body { padding: 1.2rem; }
  .exec-summary { grid-template-columns: 1fr 1fr; }
  .variable-grid { grid-template-columns: 1fr; }
  .attestation .sig-line { grid-template-columns: 1fr; gap: 2rem; }
}
</style>
</head>
<body>

<!-- STATUS BAR -->
<div class="status-bar no-print">
  <div>
    <span class="blink">&#9679;</span>&nbsp;
    M.A.S.S. TRAP &mdash; LABORATORY REPORT
  </div>
  <div class="classification">SCIENCE FAIR EVIDENCE REPORT</div>
  <div id="statusBarInfo">Loading data...</div>
</div>

<!-- REPORT CONTENT (populated by JavaScript) -->
<div class="report-container" id="reportContainer">
  <div class="no-data-msg" id="noDataMsg">
    <div class="icon">&#x1F52C;</div>
    <h2>NO REPORT DATA</h2>
    <p>This report is populated automatically from experiment data.</p>
    <p>Use the <strong>GENERATE REPORT</strong> button in the Dashboard Evidence Log to select cases and build a report.</p>
    <div class="hint">&#x2192; Dashboard &rarr; Garage Section &rarr; &#x1F52C; REPORT button</div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // === UTILITY FUNCTIONS ===
  var escH = function(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; };
  var sf = function(v, d) { var n = parseFloat(v); return isNaN(n) ? '—' : n.toFixed(d || 2); };
  var MPS_TO_MPH = 2.23694;

  // === LOAD REPORT DATA FROM LOCALSTORAGE ===
  function loadReportData(data) {
    if (!data || !data.tests || data.tests.length === 0) return;

    var container = document.getElementById('reportContainer');
    var noData = document.getElementById('noDataMsg');
    if (noData) noData.style.display = 'none';

    var trackLen = data.trackLength || 2.0;
    var tests = data.tests || [];
    var cars = data.cars || {};
    var carNames = Object.keys(cars);
    var anomalies = data.anomalies || [];
    var photos = data.photos || [];
    var variables = data.variables || {};
    var selectedCases = data.selectedCases || [];
    var trialsPerCondition = data.trialsPerCondition || 3;
    var isMultiCase = data.multiCase || selectedCases.length > 1;
    var generated = data.generated ? new Date(data.generated) : new Date();

    // Compute some aggregate stats
    var totalTrials = tests.length;
    var allTimes = tests.map(function(t) { return t.time_s; }).filter(function(t) { return t > 0; });
    var avgTime = allTimes.length > 0 ? allTimes.reduce(function(a, b) { return a + b; }, 0) / allTimes.length : 0;
    var allSpeeds = tests.map(function(t) { return t.speed_mps; }).filter(function(s) { return s > 0; });
    var avgSpeed = allSpeeds.length > 0 ? allSpeeds.reduce(function(a, b) { return a + b; }, 0) / allSpeeds.length : 0;
    var fastestTest = tests[0];
    var slowestTest = tests[0];
    for (var fi = 1; fi < tests.length; fi++) {
      if (tests[fi].speed_mps > fastestTest.speed_mps) fastestTest = tests[fi];
      if (tests[fi].speed_mps < slowestTest.speed_mps && tests[fi].speed_mps > 0) slowestTest = tests[fi];
    }

    // Case ID display
    var caseDisplay = selectedCases.length > 0 ? selectedCases.join(' + ') : 'MASS26';

    // Update status bar
    var statusInfo = document.getElementById('statusBarInfo');
    if (statusInfo) statusInfo.textContent = caseDisplay + ' — ' + generated.toLocaleDateString();

    // Build vehicle inventory for materials section
    var vehicleInventory = [];
    for (var ci = 0; ci < carNames.length; ci++) {
      var carData = cars[carNames[ci]];
      var baseWt = carData.baseWeight || 0;
      var condKeys = Object.keys(carData.conditions);
      vehicleInventory.push({
        name: carNames[ci],
        baseWeight: baseWt,
        conditionCount: condKeys.length,
        trialCount: condKeys.reduce(function(sum, k) { return sum + carData.conditions[k].trials.length; }, 0)
      });
    }

    // Build condition list from data
    var allConditions = {};
    for (var cni = 0; cni < carNames.length; cni++) {
      var conds = Object.keys(cars[carNames[cni]].conditions);
      for (var cci = 0; cci < conds.length; cci++) {
        var condObj = cars[carNames[cni]].conditions[conds[cci]];
        allConditions[conds[cci]] = {
          addedWeight: condObj.addedWeight || 0,
          totalWeight: condObj.totalWeight || 0
        };
      }
    }
    var conditionNames = Object.keys(allConditions);

    // ==================== BUILD FULL REPORT HTML ====================
    var html = '';

    // --- COVER PAGE ---
    html += '<div class="cover-page">';
    html += '<div class="watermark">M.A.S.S.</div>';
    html += '<div class="cover-badge"><div class="cover-badge-inner">&#9878;</div></div>';
    html += '<div class="cover-title">M.A.S.S. TRAP</div>';
    html += '<div class="cover-subtitle">Motion Analysis &amp; Speed System</div>';
    html += '<div class="cover-divider"></div>';
    html += '<div class="cover-report-title">Laboratory Report:<br>';
    html += 'Effect of ' + escH(variables.iv || 'Mass') + ' on ' + escH(variables.dv || 'Velocity') + ' in a Gravity-Driven System</div>';
    html += '<div class="cover-case-id">' + escH(caseDisplay) + '</div>';
    html += '<div class="cover-divider"></div>';
    html += '<div class="cover-meta">';
    html += '<span class="label">Report Date:</span><span class="value">' + generated.toLocaleDateString() + '</span>';
    html += '<span class="label">Track Length:</span><span class="value">' + sf(trackLen, 2) + ' meters</span>';
    html += '<span class="label">Vehicles Tested:</span><span class="value">' + carNames.length + '</span>';
    html += '<span class="label">Total Runs:</span><span class="value">' + totalTrials + '</span>';
    if (isMultiCase) {
      html += '<span class="label">Cases Combined:</span><span class="value">' + selectedCases.length + '</span>';
    }
    if (anomalies.length > 0) {
      html += '<span class="label">Anomalies Detected:</span><span class="value" style="color:var(--orange);">' + anomalies.length + '</span>';
    }
    html += '</div></div>';

    // --- EXECUTIVE SUMMARY (computed stats only — cover page has the basic counts) ---
    html += '<div class="exec-summary">';
    html += '<div class="exec-card"><div class="num">' + totalTrials + '</div><div class="desc">Total Runs</div></div>';
    html += '<div class="exec-card"><div class="num">' + sf(avgTime, 3) + '</div><div class="desc">Avg Time (s)</div></div>';
    html += '<div class="exec-card"><div class="num">' + sf(avgSpeed, 3) + '</div><div class="desc">Avg Speed (m/s)</div></div>';
    html += '<div class="exec-card"><div class="num">' + sf(avgSpeed * MPS_TO_MPH, 1) + '</div><div class="desc">Avg Speed (MPH)</div></div>';
    if (anomalies.length > 0) {
      html += '<div class="exec-card"><div class="num" style="color:var(--orange);">' + anomalies.length + '</div><div class="desc">Anomalies</div></div>';
    }
    html += '</div>';

    // --- TABLE OF CONTENTS ---
    html += '<nav class="toc"><h2>Table of Contents</h2><ol class="toc-list">';
    html += '<li><a href="#sec-question">Testable Question</a></li>';
    html += '<li><a href="#sec-hypothesis">Hypothesis</a></li>';
    html += '<li><a href="#sec-variables">Variables</a></li>';
    html += '<li><a href="#sec-materials">Materials &amp; Equipment</a></li>';
    html += '<li><a href="#sec-procedure">Procedure</a></li>';
    html += '<li><a href="#sec-data">Quantitative Data</a></li>';
    html += '<li><a href="#sec-physics">Physics Calculations</a></li>';
    if (anomalies.length > 0) html += '<li><a href="#sec-anomalies">Anomaly Report</a></li>';
    html += '<li><a href="#sec-analysis">Analysis &amp; Trends</a></li>';
    html += '<li><a href="#sec-conclusion">Conclusion</a></li>';
    if (photos.length > 0) html += '<li><a href="#sec-photos">Photo Evidence Gallery</a></li>';
    html += '<li><a href="#sec-sources">Sources of Error &amp; Future Work</a></li>';
    html += '<li><a href="#sec-attestation">Attestation</a></li>';
    html += '</ol></nav>';

    // --- 01: TESTABLE QUESTION ---
    html += '<section class="section" id="sec-question"><div class="section-header">';
    html += '<span class="section-number">01</span><span class="section-title">Testable Question</span></div>';
    html += '<div class="section-body">';
    html += '<div class="hypothesis-box"><div class="hypothesis-label">Research Question</div>';
    html += '<div class="hypothesis-text">Does adding ' + escH(variables.iv || 'mass') +
      ' to a 1:64 scale vehicle change its ' + escH(variables.dv || 'speed') +
      ' when traveling down a fixed-length, gravity-driven track?</div></div>';
    html += '<p>This experiment investigates the relationship between ' + escH(variables.iv || 'mass') +
      ' and ' + escH(variables.dv || 'speed/time') +
      ' using a ' + sf(trackLen, 2) + '-meter inclined track. The M.A.S.S. Trap provides microsecond-precision ' +
      'electronic timing to measure these differences with scientific accuracy.</p>';
    html += '</div></section>';

    // --- 02: HYPOTHESIS ---
    html += '<section class="section" id="sec-hypothesis"><div class="section-header">';
    html += '<span class="section-number">02</span><span class="section-title">Hypothesis</span></div>';
    html += '<div class="section-body">';
    html += '<div class="hypothesis-box"><div class="hypothesis-label">Hypothesis</div>';
    html += '<div class="hypothesis-text">If ' + escH(variables.iv || 'mass is added') +
      ' to a gravity-driven vehicle, then it will travel faster (lower elapsed time) because the increased ' +
      'gravitational force overcomes a larger proportion of rolling friction and air resistance losses.</div></div>';
    html += '<p><strong>Reasoning:</strong> While gravity accelerates all objects equally in a vacuum (g = 9.81 m/s&sup2;), ' +
      'friction forces do not scale linearly with mass. A heavier car has more gravitational potential energy (PE = mgh), ' +
      'producing greater kinetic energy at the bottom. Since aerodynamic drag depends on velocity and cross-sectional area ' +
      '(not mass), the heavier vehicle should achieve a higher terminal velocity.</p>';
    html += '</div></section>';

    // --- 03: VARIABLES ---
    html += '<section class="section" id="sec-variables"><div class="section-header">';
    html += '<span class="section-number">03</span><span class="section-title">Variables</span></div>';
    html += '<div class="section-body"><div class="variable-grid">';
    // Independent
    html += '<div class="variable-card independent"><div class="variable-label">Independent Variable (Manipulated)</div>';
    html += '<div class="variable-name">' + escH(variables.iv || 'Mass Added to Vehicle') + '</div>';
    html += '<div class="variable-detail">Conditions tested: ' + conditionNames.map(function(c) { return escH(c); }).join(', ') + '.<br>';
    html += 'All weights measured to &plusmn;0.001g precision.</div></div>';
    // Dependent
    html += '<div class="variable-card dependent"><div class="variable-label">Dependent Variable (Measured)</div>';
    html += '<div class="variable-name">' + escH(variables.dv || 'Elapsed Time & Average Speed') + '</div>';
    html += '<div class="variable-detail">Time measured in seconds (to microsecond precision) by IR break-beam sensors. ' +
      'Average speed = ' + sf(trackLen, 2) + 'm &div; elapsed time. Additional: momentum (p = mv) and kinetic energy (KE = &frac12;mv&sup2;).</div></div>';
    // Controlled
    html += '<div class="variable-card controlled"><div class="variable-label">Controlled Variables (Constants)</div>';
    html += '<div class="variable-name">' + escH(variables.cv || 'Track, start height, release method') + '</div>';
    html += '<div class="variable-detail">Track: ' + sf(trackLen, 2) + 'm. Same start height, gravity release (no push). ' +
      trialsPerCondition + ' trials per condition. Locard&rsquo;s Exchange Principle ordering.</div></div>';
    html += '</div></div></section>';

    // --- 04: MATERIALS ---
    html += '<section class="section" id="sec-materials"><div class="section-header">';
    html += '<span class="section-number">04</span><span class="section-title">Materials &amp; Equipment</span></div>';
    html += '<div class="section-body"><div class="materials-grid">';
    // System components (always shown)
    html += '<div class="material-item"><div class="material-icon">&#9881;</div><div>';
    html += '<div class="material-name">M.A.S.S. Trap Timing System</div>';
    html += '<div class="material-spec">ESP32-S3 &bull; IR break-beam sensors &bull; Microsecond precision &bull; ' + sf(trackLen, 2) + 'm track</div>';
    html += '</div></div>';
    // Vehicles from data
    for (var vi = 0; vi < vehicleInventory.length; vi++) {
      var veh = vehicleInventory[vi];
      html += '<div class="material-item"><div class="material-icon">&#127923;</div><div>';
      html += '<div class="material-name">' + escH(veh.name) + '</div>';
      html += '<div class="material-spec">Base mass: ' + sf(veh.baseWeight, 3) + 'g &bull; ' +
        veh.conditionCount + ' conditions &bull; ' + veh.trialCount + ' trials</div>';
      html += '</div></div>';
    }
    // Standard equipment
    html += '<div class="material-item"><div class="material-icon">&#9878;</div><div>';
    html += '<div class="material-name">Digital Milligram Scale</div>';
    html += '<div class="material-spec">&plusmn;0.001g precision &bull; Calibrated</div></div></div>';
    html += '<div class="material-item"><div class="material-icon">&#128187;</div><div>';
    html += '<div class="material-name">Dashboard Web Interface</div>';
    html += '<div class="material-spec">Real-time WebSocket &bull; Playlist Mode &bull; Evidence Log</div></div></div>';
    html += '</div></div></section>';

    // --- 05: PROCEDURE ---
    html += '<section class="section" id="sec-procedure"><div class="section-header">';
    html += '<span class="section-number">05</span><span class="section-title">Procedure</span></div>';
    html += '<div class="section-body"><div class="procedure-list">';
    html += '<div class="procedure-step"><div class="text"><strong>Weigh test vehicles</strong> using the milligram scale. Record the bare mass of each vehicle to &plusmn;0.001g.</div></div>';
    html += '<div class="procedure-step"><div class="text"><strong>Set up the M.A.S.S. Trap track.</strong> Assemble ' + sf(trackLen, 2) + ' meters of track. Verify start and finish gate connectivity via dashboard.</div></div>';
    html += '<div class="procedure-step"><div class="text"><strong>Configure the Playlist Mode</strong> experiment. Select vehicles, define weight conditions, set ' + trialsPerCondition + ' trials per condition.</div></div>';
    html += '<div class="procedure-step"><div class="text"><strong>Run the test matrix.</strong> Follow the Playlist Mode prompts. For each run: place the correct vehicle at the start, ARM the track, release and let gravity accelerate the vehicle through the timing sensors.</div></div>';
    html += '<div class="procedure-step"><div class="text"><strong>Review sanity checks.</strong> The system flags runs with unusual times (stalls, glitches, sensor errors). KEEP or REDO flagged runs.</div></div>';
    html += '<div class="procedure-step"><div class="text"><strong>Repeat</strong> for all ' + totalTrials + ' runs across ' + carNames.length + ' vehicle(s) and ' + conditionNames.length + ' condition(s).</div></div>';
    html += '<div class="procedure-step"><div class="text"><strong>Generate this report</strong> from the Evidence Log. Review anomaly flags and data accuracy.</div></div>';
    html += '</div></div></section>';

    // --- 06: QUANTITATIVE DATA ---
    html += '<section class="section" id="sec-data"><div class="section-header">';
    html += '<span class="section-number">06</span><span class="section-title">Quantitative Data</span></div>';
    html += '<div class="section-body">';

    // One data table per car
    for (var di = 0; di < carNames.length; di++) {
      var cn = carNames[di];
      var cd = cars[cn];
      var condKeys = Object.keys(cd.conditions);

      html += '<h3 style="color:var(--gold);margin:1.5rem 0 0.8rem;font-size:1rem;text-transform:uppercase;letter-spacing:2px;">' +
        escH(cn) + ' <span style="font-size:0.75rem;color:var(--gray);font-weight:400;">(base: ' + sf(cd.baseWeight, 3) + 'g)</span></h3>';

      html += '<table class="data-table"><thead><tr>';
      html += '<th>Condition</th><th>Added (g)</th><th>Total (g)</th>';
      // Dynamic trial columns
      var maxTrials = 0;
      for (var mk = 0; mk < condKeys.length; mk++) {
        if (cd.conditions[condKeys[mk]].trials.length > maxTrials) maxTrials = cd.conditions[condKeys[mk]].trials.length;
      }
      for (var mt = 1; mt <= maxTrials; mt++) html += '<th>T' + mt + ' (s)</th>';
      html += '<th>Avg (s)</th><th>Speed (m/s)</th>';
      html += '</tr></thead><tbody>';

      for (var ck = 0; ck < condKeys.length; ck++) {
        var cond = cd.conditions[condKeys[ck]];
        var trials = cond.trials;
        var times = trials.map(function(t) { return t.time_s; });
        var avgT = times.reduce(function(a, b) { return a + b; }, 0) / times.length;
        var speeds = trials.map(function(t) { return t.speed_mps; });
        var avgS = speeds.reduce(function(a, b) { return a + b; }, 0) / speeds.length;

        html += '<tr>';
        html += '<td style="font-weight:600;">' + escH(condKeys[ck]) + '</td>';
        html += '<td>' + sf(cond.addedWeight, 1) + '</td>';
        html += '<td>' + sf(cond.totalWeight, 3) + '</td>';
        for (var ti = 0; ti < maxTrials; ti++) {
          if (ti < trials.length) {
            var trialAnom = trials[ti].anomaly ? ' class="anomaly-row"' : '';
            var anomTag = trials[ti].anomaly ? ' <span class="anomaly-badge medium">&#x26A0;</span>' : '';
            html += '<td' + trialAnom + '>' + sf(trials[ti].time_s, 4) + anomTag + '</td>';
          } else {
            html += '<td style="color:var(--gray-dark);">—</td>';
          }
        }
        html += '<td style="font-weight:700;color:var(--gold);">' + sf(avgT, 4) + '</td>';
        html += '<td style="font-weight:700;color:var(--cyan);">' + sf(avgS, 3) + '</td>';
        html += '</tr>';

        // Stats row
        if (cond.stats) {
          html += '<tr style="font-size:0.72rem;color:var(--gray);">';
          html += '<td colspan="3" style="text-align:right;font-style:italic;">Stats:</td>';
          html += '<td colspan="' + maxTrials + '">Range: ' + sf(cond.stats.minTime, 4) + '–' + sf(cond.stats.maxTime, 4) +
            's &bull; &sigma;=' + sf(cond.stats.stddev, 4) + 's</td>';
          html += '<td colspan="2"></td></tr>';
        }
      }
      html += '</tbody></table>';
    }

    html += '</div></section>';

    // --- 07: PHYSICS CALCULATIONS ---
    html += '<section class="section" id="sec-physics"><div class="section-header">';
    html += '<span class="section-number">07</span><span class="section-title">Physics Calculations</span></div>';
    html += '<div class="section-body">';

    html += '<div class="equation-block"><div class="equation-label">Average Speed</div>';
    html += 'v = d / t = ' + sf(trackLen, 2) + 'm / t</div>';

    html += '<div class="equation-block"><div class="equation-label">Momentum</div>';
    html += 'p = m &times; v <span style="font-size:0.8rem;color:var(--gray);"> (kg&middot;m/s)</span></div>';

    html += '<div class="equation-block"><div class="equation-label">Kinetic Energy</div>';
    html += 'KE = &frac12;mv&sup2; <span style="font-size:0.8rem;color:var(--gray);"> (Joules)</span></div>';

    // Show example calculation with actual data
    if (tests.length > 0) {
      var ex = tests[0];
      var exMassKg = (ex.totalWeight || ex.baseWeight || 30) / 1000;
      var exSpeed = ex.speed_mps || (trackLen / ex.time_s);
      html += '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:1rem 1.5rem;margin:1rem 0;font-size:0.85rem;">';
      html += '<strong style="color:var(--gold);">Example calculation (' + escH(ex.car) + ', ' + escH(ex.condition) + '):</strong><br>';
      html += 'v = ' + sf(trackLen, 2) + 'm / ' + sf(ex.time_s, 4) + 's = <strong>' + sf(exSpeed, 3) + ' m/s</strong> (' + sf(exSpeed * MPS_TO_MPH, 1) + ' mph)<br>';
      html += 'p = ' + sf(exMassKg, 4) + 'kg &times; ' + sf(exSpeed, 3) + 'm/s = <strong>' + sf(exMassKg * exSpeed, 5) + ' kg&middot;m/s</strong><br>';
      html += 'KE = &frac12; &times; ' + sf(exMassKg, 4) + 'kg &times; (' + sf(exSpeed, 3) + ')&sup2; = <strong>' + sf(0.5 * exMassKg * exSpeed * exSpeed, 5) + ' J</strong>';
      html += '</div>';
    }

    html += '</div></section>';

    // --- 08: ANOMALY REPORT (only if anomalies exist) ---
    if (anomalies.length > 0) {
      html += '<section class="section" id="sec-anomalies"><div class="section-header">';
      html += '<span class="section-number">08</span><span class="section-title">Anomaly Report</span></div>';
      html += '<div class="section-body">';
      html += '<p style="margin-bottom:1rem;">The data aggregation engine detected <strong style="color:var(--orange);">' +
        anomalies.length + ' anomalies</strong> across the selected data. These are flagged for review — they may indicate ' +
        'sensor issues, systematic errors, or genuinely interesting findings.</p>';

      // Group anomalies by severity
      var highAnom = anomalies.filter(function(a) { return a.severity === 'high'; });
      var medAnom = anomalies.filter(function(a) { return a.severity === 'medium'; });
      var infoAnom = anomalies.filter(function(a) { return a.severity === 'info'; });

      if (highAnom.length > 0) {
        html += '<h4 style="color:var(--red);margin:1rem 0 0.5rem;">&#x1F6A8; High Severity (' + highAnom.length + ')</h4>';
        for (var hi = 0; hi < highAnom.length; hi++) {
          html += '<div class="warning-box"><div class="label">' + escH(highAnom[hi].type.toUpperCase()) + '</div>' +
            '<p style="color:rgba(255,255,255,0.8);font-size:0.85rem;">' + escH(highAnom[hi].msg) + '</p></div>';
        }
      }
      if (medAnom.length > 0) {
        html += '<h4 style="color:var(--orange);margin:1rem 0 0.5rem;">&#x26A0;&#xFE0F; Medium Severity (' + medAnom.length + ')</h4>';
        for (var mi = 0; mi < medAnom.length; mi++) {
          html += '<div style="background:rgba(255,165,0,0.08);border:1px solid rgba(255,165,0,0.3);border-radius:8px;padding:0.8rem 1.2rem;margin:0.5rem 0;">';
          html += '<span class="anomaly-badge medium">' + escH(medAnom[mi].type) + '</span> ';
          html += '<span style="color:rgba(255,255,255,0.8);font-size:0.85rem;">' + escH(medAnom[mi].msg) + '</span></div>';
        }
      }
      if (infoAnom.length > 0) {
        html += '<h4 style="color:var(--cyan);margin:1rem 0 0.5rem;">&#x1F4A1; Observations (' + infoAnom.length + ')</h4>';
        for (var ii = 0; ii < infoAnom.length; ii++) {
          html += '<div style="background:rgba(0,188,212,0.08);border:1px solid rgba(0,188,212,0.3);border-radius:8px;padding:0.8rem 1.2rem;margin:0.5rem 0;">';
          html += '<span class="anomaly-badge info">' + escH(infoAnom[ii].type) + '</span> ';
          html += '<span style="color:rgba(255,255,255,0.8);font-size:0.85rem;">' + escH(infoAnom[ii].msg) + '</span></div>';
        }
      }

      html += '</div></section>';
    }

    // --- 09: ANALYSIS & TRENDS ---
    var sectionNum = anomalies.length > 0 ? '09' : '08';
    html += '<section class="section" id="sec-analysis"><div class="section-header">';
    html += '<span class="section-number">' + sectionNum + '</span><span class="section-title">Analysis &amp; Trends</span></div>';
    html += '<div class="section-body">';

    for (var ai = 0; ai < carNames.length; ai++) {
      var acn = carNames[ai];
      var acd = cars[acn];
      var aConds = Object.keys(acd.conditions);
      var allAvgs = [];
      for (var aci = 0; aci < aConds.length; aci++) {
        var ac = acd.conditions[aConds[aci]];
        var aSpds = ac.trials.map(function(t) { return t.speed_mps; });
        var aAvg = aSpds.reduce(function(a, b) { return a + b; }, 0) / aSpds.length;
        allAvgs.push({ label: aConds[aci], added: ac.addedWeight, total: ac.totalWeight, avgSpeed: aAvg, speeds: aSpds });
      }

      // Trend detection
      var increasing = true;
      var decreasing = true;
      for (var ti2 = 1; ti2 < allAvgs.length; ti2++) {
        if (allAvgs[ti2].avgSpeed <= allAvgs[ti2 - 1].avgSpeed) increasing = false;
        if (allAvgs[ti2].avgSpeed >= allAvgs[ti2 - 1].avgSpeed) decreasing = false;
      }

      var fastest = allAvgs[0];
      var slowest = allAvgs[0];
      for (var afi = 1; afi < allAvgs.length; afi++) {
        if (allAvgs[afi].avgSpeed > fastest.avgSpeed) fastest = allAvgs[afi];
        if (allAvgs[afi].avgSpeed < slowest.avgSpeed) slowest = allAvgs[afi];
      }
      var speedRange = fastest.avgSpeed - slowest.avgSpeed;
      var pctRange = slowest.avgSpeed > 0 ? (speedRange / slowest.avgSpeed * 100) : 0;

      html += '<h3 style="color:var(--gold);margin:1.5rem 0 0.8rem;font-size:1rem;text-transform:uppercase;letter-spacing:2px;">' + escH(acn) + '</h3>';

      var trendText = '';
      if (allAvgs.length < 2) {
        trendText = 'Only one condition tested — no trend analysis possible.';
      } else if (increasing) {
        trendText = 'Speed <strong style="color:var(--green);">increased</strong> consistently as mass was added.';
      } else if (decreasing) {
        trendText = 'Speed <strong style="color:var(--red);">decreased</strong> consistently as mass was added.';
      } else {
        trendText = 'Speed showed <strong style="color:var(--cyan);">no clear linear trend</strong> as mass was added.';
      }

      html += '<div class="analysis-highlight"><div class="finding">Trend: ' + trendText + '</div>';
      html += '<div class="detail">';
      if (allAvgs.length >= 2) {
        html += 'Fastest: <strong>' + escH(fastest.label) + '</strong> at ' + sf(fastest.avgSpeed, 3) + ' m/s (' + sf(fastest.total, 1) + 'g). ';
        html += 'Slowest: <strong>' + escH(slowest.label) + '</strong> at ' + sf(slowest.avgSpeed, 3) + ' m/s (' + sf(slowest.total, 1) + 'g). ';
        html += 'Range: ' + sf(speedRange, 3) + ' m/s (' + sf(pctRange, 1) + '% difference).';
      }
      html += '</div></div>';

      // Trial consistency
      var maxSpread = 0;
      var maxSpreadCond = '';
      for (var ci2 = 0; ci2 < allAvgs.length; ci2++) {
        if (allAvgs[ci2].speeds.length < 2) continue;
        var sMin = Math.min.apply(null, allAvgs[ci2].speeds);
        var sMax = Math.max.apply(null, allAvgs[ci2].speeds);
        var spread = sMax - sMin;
        if (spread > maxSpread) { maxSpread = spread; maxSpreadCond = allAvgs[ci2].label; }
      }
      if (maxSpreadCond) {
        html += '<p style="font-size:0.9rem;">Trial consistency: Max speed spread was <strong>' + sf(maxSpread, 3) + ' m/s</strong> (' + escH(maxSpreadCond) + ') — ';
        if (maxSpread < 0.05) html += '<strong style="color:var(--green);">excellent repeatability</strong>.';
        else if (maxSpread < 0.15) html += '<strong style="color:var(--gold);">good repeatability</strong>.';
        else html += '<strong style="color:var(--orange);">moderate variation</strong>.';
        html += '</p>';
      }
    }

    // Cross-vehicle comparison
    if (carNames.length > 1) {
      html += '<h3 style="color:var(--gold);margin:1.5rem 0 0.8rem;font-size:1rem;text-transform:uppercase;letter-spacing:2px;">Cross-Vehicle Comparison</h3>';
      html += '<p>Multiple vehicles were tested independently, controlling for vehicle-specific factors (wheel friction, alignment). ';
      html += 'This allows comparison of how ' + escH(variables.iv || 'mass') + ' affects ' + escH(variables.dv || 'speed') + ' across different starting configurations.</p>';
    }

    html += '</div></section>';

    // --- 10: CONCLUSION ---
    sectionNum = parseInt(sectionNum) + 1;
    if (sectionNum < 10) sectionNum = '0' + sectionNum;
    html += '<section class="section" id="sec-conclusion"><div class="section-header">';
    html += '<span class="section-number">' + sectionNum + '</span><span class="section-title">Conclusion</span></div>';
    html += '<div class="section-body">';

    // Determine overall trend
    var overallIncrease = 0;
    var overallDecrease = 0;
    var overallFlat = 0;
    for (var cci = 0; cci < carNames.length; cci++) {
      var ccData = cars[carNames[cci]];
      var ccConds = Object.keys(ccData.conditions);
      var ccAvgs = [];
      for (var ccj = 0; ccj < ccConds.length; ccj++) {
        var ccTrials = ccData.conditions[ccConds[ccj]].trials;
        var ccSum = 0;
        for (var cck = 0; cck < ccTrials.length; cck++) ccSum += ccTrials[cck].speed_mps;
        ccAvgs.push(ccSum / ccTrials.length);
      }
      if (ccAvgs.length >= 2) {
        if (ccAvgs[ccAvgs.length - 1] > ccAvgs[0] + 0.01) overallIncrease++;
        else if (ccAvgs[ccAvgs.length - 1] < ccAvgs[0] - 0.01) overallDecrease++;
        else overallFlat++;
      }
    }

    var supported = overallIncrease > overallDecrease;
    html += '<div class="hypothesis-box" style="border-color: ' + (supported ? 'var(--green)' : 'var(--red)') + ';">';
    html += '<div class="hypothesis-label" style="color: ' + (supported ? 'var(--green)' : 'var(--red)') + ';">Hypothesis ' + (supported ? 'SUPPORTED' : 'NOT SUPPORTED') + '</div>';
    html += '<div class="hypothesis-text">';
    if (supported) {
      html += 'The experimental data supports the hypothesis. Heavier vehicles traveled faster (lower elapsed time) down the track, suggesting that added mass helps overcome friction and drag.';
    } else if (overallDecrease > overallIncrease) {
      html += 'The experimental data does not support the hypothesis. Heavier vehicles traveled slower, suggesting that increased friction from added weight outweighs the gravitational advantage.';
    } else {
      html += 'The experimental data shows no clear relationship between mass and speed, suggesting that gravitational advantage and friction increases approximately cancel out in this system.';
    }
    html += '</div></div>';

    html += '<p>Across ' + totalTrials + ' trials with ' + carNames.length + ' vehicle(s) and ' +
      conditionNames.length + ' weight condition(s), the data ' + (supported ? 'consistently showed' : 'did not consistently show') +
      ' a relationship between ' + escH(variables.iv || 'mass') + ' and ' + escH(variables.dv || 'speed') + '.</p>';

    html += '<p><strong>Real-world connection:</strong> At full scale, heavier vehicles rolling downhill have more ' +
      'momentum to push through air resistance and rolling friction, even though gravity accelerates all masses equally in a vacuum. ' +
      'This experiment demonstrates that effect at 1:64 scale.</p>';

    html += '</div></section>';

    // --- PHOTO GALLERY (only if photos exist) ---
    if (photos.length > 0) {
      sectionNum = parseInt(sectionNum) + 1;
      if (sectionNum < 10) sectionNum = '0' + sectionNum;
      html += '<section class="section" id="sec-photos"><div class="section-header">';
      html += '<span class="section-number">' + sectionNum + '</span><span class="section-title">Photo Evidence Gallery</span></div>';
      html += '<div class="section-body">';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;">';
      for (var pi = 0; pi < photos.length; pi++) {
        var photo = photos[pi];
        html += '<div style="border:1px solid rgba(212,175,55,0.3);border-radius:8px;overflow:hidden;background:rgba(9,27,47,0.5);">';
        html += '<a href="' + escH(photo.url) + '" target="_blank" style="display:block;">';
        html += '<img src="' + escH(photo.thumb || photo.url) + '" alt="Evidence ' + escH(photo.caseNumber) + '" style="width:100%;height:120px;object-fit:cover;display:block;">';
        html += '</a><div style="padding:6px;font-size:0.7rem;">';
        html += '<div style="color:var(--gold);font-weight:900;">' + escH(photo.caseNumber) + '</div>';
        html += '<div>' + escH(photo.car);
        if (photo.condition) html += ' &bull; ' + escH(photo.condition);
        html += '</div></div></div>';
      }
      html += '</div></div></section>';
    }

    // --- SOURCES OF ERROR ---
    sectionNum = parseInt(sectionNum) + 1;
    if (sectionNum < 10) sectionNum = '0' + sectionNum;
    html += '<section class="section" id="sec-sources"><div class="section-header">';
    html += '<span class="section-number">' + sectionNum + '</span><span class="section-title">Sources of Error &amp; Future Work</span></div>';
    html += '<div class="section-body">';
    html += '<p><strong>Potential sources of error:</strong></p><ul style="margin:0.5rem 0 1rem 1.5rem;line-height:1.8;">';
    html += '<li>Wheel alignment variation between vehicles</li>';
    html += '<li>Track surface friction (dust, debris between runs)</li>';
    html += '<li>Weight placement on vehicle affecting center of gravity</li>';
    html += '<li>IR sensor trigger timing (break-beam width affects edge detection)</li>';
    html += '<li>Temperature changes affecting wheel lubrication or track flex</li>';
    html += '</ul>';
    html += '<p><strong>Future work:</strong></p><ul style="margin:0.5rem 0 1rem 1.5rem;line-height:1.8;">';
    html += '<li>Add onboard accelerometer (XIAO ESP32-S3 + IMU) for g-force measurement</li>';
    html += '<li>Add atmospheric sensors (BME280) for temperature/humidity/pressure correlation</li>';
    html += '<li>Use ball bearings of known drag coefficient for air resistance calibration</li>';
    html += '<li>Test more weight conditions for higher resolution trend detection</li>';
    html += '<li>Add mid-track speed measurement (speed trap) for acceleration profile</li>';
    html += '</ul></div></section>';

    // --- ATTESTATION ---
    sectionNum = parseInt(sectionNum) + 1;
    if (sectionNum < 10) sectionNum = '0' + sectionNum;
    html += '<section class="section" id="sec-attestation"><div class="section-header">';
    html += '<span class="section-number">' + sectionNum + '</span><span class="section-title">Attestation</span></div>';
    html += '<div class="section-body">';
    html += '<div class="attestation"><div class="attestation-header">Integrity Statement</div>';
    html += '<p>I certify that this experiment was conducted using the M.A.S.S. Trap electronic timing system. ' +
      'All data was collected automatically by the system and has not been manually altered. ' +
      'The ' + totalTrials + ' trials reported herein were recorded on case' + (selectedCases.length > 1 ? 's' : '') + ' ' +
      escH(caseDisplay) + '.</p>';
    html += '<p>The M.A.S.S. Trap system provides microsecond-precision timing using infrared break-beam sensors, ' +
      'eliminating human reaction time error. All calculations (speed, momentum, kinetic energy) are computed ' +
      'automatically from the raw timing data.</p>';
    if (anomalies.length > 0) {
      html += '<p><strong>Disclosure:</strong> The anomaly detection system flagged ' + anomalies.length +
        ' data point(s) for review. These are documented in Section 08 of this report.</p>';
    }
    html += '<div class="sig-line">';
    html += '<div class="sig-block"><div class="name">________________________</div><div class="role">Student Investigator</div></div>';
    html += '<div class="sig-block"><div class="name">________________________</div><div class="role">Date</div></div>';
    html += '</div></div></div></section>';

    // --- RAW DATA APPENDIX ---
    sectionNum = parseInt(sectionNum) + 1;
    if (sectionNum < 10) sectionNum = '0' + sectionNum;
    html += '<section class="section"><div class="section-header">';
    html += '<span class="section-number">' + sectionNum + '</span><span class="section-title">Appendix: Raw Data</span></div>';
    html += '<div class="section-body" style="overflow-x:auto;">';
    html += '<table class="data-table"><thead><tr>';
    html += '<th>#</th><th>Case</th><th>Car</th><th>Condition</th><th>Trial</th>';
    html += '<th>Weight (g)</th><th>Time (s)</th><th>Speed (m/s)</th><th>Momentum</th><th>KE</th>';
    html += '</tr></thead><tbody>';
    for (var ri = 0; ri < tests.length; ri++) {
      var r = tests[ri];
      html += '<tr>';
      html += '<td>' + (ri + 1) + '</td>';
      html += '<td style="font-size:0.7rem;color:var(--accent);">' + escH((r.caseNumber || '').split('-').slice(-1)[0]) + '</td>';
      html += '<td>' + escH(r.car) + '</td>';
      html += '<td>' + escH(r.condition) + '</td>';
      html += '<td>' + (r.trial || '') + '</td>';
      html += '<td>' + sf(r.totalWeight, 3) + '</td>';
      html += '<td>' + sf(r.time_s, 4) + '</td>';
      html += '<td>' + sf(r.speed_mps, 3) + '</td>';
      html += '<td>' + sf(r.momentum, 5) + '</td>';
      html += '<td>' + sf(r.ke, 5) + '</td>';
      html += '</tr>';
    }
    html += '</tbody></table></div></section>';

    // --- FOOTER ---
    html += '<div class="report-footer">';
    html += '<div class="system-name">M.A.S.S. TRAP</div>';
    html += '<div class="version">Motion Analysis &amp; Speed System &mdash; Template-Driven Report v2</div>';
    html += '<div class="disclaimer">This report was auto-generated from experimental data stored in the M.A.S.S. Trap ' +
      'evidence system. All values are computed from raw sensor measurements. No data has been manually entered or modified. ' +
      'Report generated: ' + generated.toLocaleString() + '</div>';
    html += '</div>';

    // Inject into page
    container.innerHTML = html;

    // Add print button
    var footer = container.querySelector('.report-footer');
    if (footer) {
      var printBtn = document.createElement('button');
      printBtn.textContent = 'PRINT / SAVE AS PDF';
      printBtn.className = 'no-print';
      printBtn.style.cssText = 'margin-top:1.5rem;padding:12px 32px;background:var(--gold);color:var(--navy);border:none;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer;letter-spacing:2px;';
      printBtn.onclick = function() { window.print(); };
      footer.appendChild(printBtn);

      var backBtn = document.createElement('button');
      backBtn.textContent = 'BACK TO DASHBOARD';
      backBtn.className = 'no-print';
      backBtn.style.cssText = 'margin-top:0.5rem;margin-left:1rem;padding:12px 32px;background:transparent;color:var(--gold);border:1px solid var(--gold);border-radius:8px;font-weight:700;font-size:0.85rem;cursor:pointer;letter-spacing:2px;';
      backBtn.onclick = function() { window.location.href = '/'; };
      footer.appendChild(backBtn);
    }
  }

  // === CHECK FOR DATA IN LOCALSTORAGE ===
  try {
    var stored = localStorage.getItem('mass_report_data');
    if (stored) {
      var parsed = JSON.parse(stored);
      loadReportData(parsed);
    }
  } catch (e) {
    console.error('[REPORT] Failed to load data:', e);
  }

})();
</script>

</body>
</html>
