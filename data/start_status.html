<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="fw-version" content="2.4.0">
  <title>Start Gate - M.A.S.S. Trap</title>
  <style>
    :root {
      --mass-navy: #1a1a2e;
      --mass-gold: #d4af37;
      --mass-blue: #4a90d9;
      --mass-green: #28a745;
      --mass-red: #dc3545;
      --mass-dark: #0f0f1e;
      --mass-card: #16213e;
      --mass-card-border: #2a2a4a;
      --mass-text: #e0e0e0;
      --mass-muted: #8888aa;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--mass-navy);
      min-height: 100vh;
      padding: 15px;
      color: var(--mass-text);
    }
    .container { max-width: 600px; margin: 0 auto; }

    /* ===== HEADER ===== */
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px 0;
    }
    .header-shield {
      display: inline-block;
      width: 50px; height: 58px;
      background: var(--mass-gold);
      clip-path: polygon(50% 0%, 100% 15%, 100% 65%, 50% 100%, 0% 65%, 0% 15%);
      margin-bottom: 8px;
      position: relative;
    }
    .header-shield::after {
      content: 'M';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--mass-navy);
    }
    .header h1 {
      font-size: 1.6rem;
      font-weight: 900;
      letter-spacing: 3px;
      color: var(--mass-gold);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .header .subtitle {
      font-size: 0.7rem;
      letter-spacing: 5px;
      color: var(--mass-muted);
      text-transform: uppercase;
      margin-top: 2px;
    }
    .header .role-badge {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 18px;
      background: var(--mass-green);
      color: white;
      font-weight: 800;
      font-size: 0.75rem;
      letter-spacing: 2px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .nav-links {
      text-align: center;
      margin-bottom: 18px;
    }
    .nav-links a {
      color: var(--mass-blue);
      text-decoration: none;
      font-weight: 700;
      font-size: 0.8rem;
      letter-spacing: 1px;
      margin: 0 10px;
      border-bottom: 2px solid transparent;
      padding-bottom: 2px;
      transition: all 0.2s;
    }
    .nav-links a:hover {
      color: var(--mass-gold);
      border-bottom-color: var(--mass-gold);
    }

    /* ===== STATE BANNER ===== */
    .state-banner {
      background: var(--mass-card);
      border: 2px solid var(--mass-card-border);
      padding: 28px 20px;
      border-radius: 10px;
      text-align: center;
      font-size: 2.2rem;
      font-weight: 900;
      letter-spacing: 4px;
      text-transform: uppercase;
      margin-bottom: 18px;
      transition: all 0.3s;
      color: var(--mass-muted);
    }
    .state-banner.idle {
      border-color: var(--mass-card-border);
      color: var(--mass-muted);
    }
    .state-banner.armed {
      background: rgba(40,167,69,0.15);
      border-color: var(--mass-green);
      color: var(--mass-green);
      animation: pulse 1.5s ease-in-out infinite;
    }
    .state-banner.racing {
      background: rgba(220,53,69,0.15);
      border-color: var(--mass-red);
      color: var(--mass-red);
      animation: flash 0.4s infinite;
    }
    .state-banner.finished {
      background: rgba(212,175,55,0.1);
      border-color: var(--mass-gold);
      color: var(--mass-gold);
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
      50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(40,167,69,0.3); }
    }
    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* ===== CARDS ===== */
    .card {
      background: var(--mass-card);
      border: 1px solid var(--mass-card-border);
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 14px;
    }
    .card-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--mass-gold);
      font-weight: 800;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--mass-card-border);
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 7px 0;
      border-bottom: 1px solid rgba(42,42,74,0.5);
      font-size: 0.88rem;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--mass-muted); font-weight: 600; }
    .info-value { font-weight: 700; font-family: 'Courier New', monospace; }
    .info-value.connected { color: var(--mass-green); }
    .info-value.disconnected { color: var(--mass-red); }

    /* ===== LIDAR CARD ===== */
    .lidar-card { display: none; }
    .lidar-card.visible { display: block; }
    .lidar-bar-container {
      background: var(--mass-dark);
      border-radius: 4px;
      height: 20px;
      margin-top: 8px;
      overflow: hidden;
      position: relative;
    }
    .lidar-bar {
      height: 100%;
      background: var(--mass-gold);
      border-radius: 4px;
      transition: width 0.3s;
      min-width: 2px;
    }
    .lidar-bar.staged {
      background: var(--mass-green);
      animation: lidarPulse 1s infinite;
    }
    @keyframes lidarPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .lidar-reading {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-top: 6px;
    }
    .lidar-distance {
      font-size: 1.8rem;
      font-weight: 900;
      font-family: 'Courier New', monospace;
      color: var(--mass-gold);
    }
    .lidar-state-label {
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 3px 10px;
      border-radius: 4px;
      background: rgba(42,42,74,0.5);
    }
    .lidar-state-label.empty { color: var(--mass-muted); }
    .lidar-state-label.staged { color: var(--mass-green); background: rgba(40,167,69,0.15); }
    .lidar-state-label.launched { color: var(--mass-red); background: rgba(220,53,69,0.15); }

    /* ===== MESSAGE BOX ===== */
    .message {
      background: var(--mass-card);
      border: 1px solid var(--mass-card-border);
      border-radius: 10px;
      padding: 18px;
      text-align: center;
      font-size: 0.88rem;
      line-height: 1.7;
      color: var(--mass-muted);
    }
    .message strong { color: var(--mass-gold); }

    /* ===== VERSION BADGE ===== */
    .version-badge {
      position: fixed;
      bottom: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: var(--mass-muted);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      z-index: 1000;
      font-family: monospace;
    }

    /* ===== WEBSOCKET STATUS ===== */
    .ws-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      background: var(--mass-red);
    }
    .ws-dot.live {
      background: var(--mass-green);
      box-shadow: 0 0 6px var(--mass-green);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-shield"></div>
      <h1>M.A.S.S. TRAP</h1>
      <div class="subtitle">Motion Analysis & Speed System</div>
      <div class="role-badge">Start Gate</div>
    </div>

    <div class="nav-links">
      <a href="/config">Settings</a>
      <a href="/console">Debug Console</a>
    </div>

    <div id="stateBanner" class="state-banner idle">INITIALIZING</div>

    <!-- Peer Connection -->
    <div class="card">
      <div class="card-title">System Status</div>
      <div class="info-row">
        <span class="info-label"><span id="wsDot" class="ws-dot"></span>WebSocket</span>
        <span class="info-value" id="wsStatus">Connecting...</span>
      </div>
      <div class="info-row">
        <span class="info-label">Finish Gate</span>
        <span class="info-value" id="peerStatus">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Race State</span>
        <span class="info-value" id="raceState">--</span>
      </div>
    </div>

    <!-- LiDAR Card (hidden if not enabled) -->
    <div id="lidarCard" class="card lidar-card">
      <div class="card-title">LiDAR Staging Sensor</div>
      <div class="lidar-reading">
        <div><span id="lidarDist" class="lidar-distance">--</span><span style="color:var(--mass-muted); font-size:0.9rem;"> mm</span></div>
        <span id="lidarLabel" class="lidar-state-label empty">NO TARGET</span>
      </div>
      <div class="lidar-bar-container">
        <div id="lidarBar" class="lidar-bar" style="width:0%"></div>
      </div>
    </div>

    <!-- Device Info -->
    <div class="card">
      <div class="card-title">Device Information</div>
      <div class="info-row">
        <span class="info-label">IP Address</span>
        <span class="info-value" id="ipAddr">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Uptime</span>
        <span class="info-value" id="uptime">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Free Memory</span>
        <span class="info-value" id="freeHeap">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">WiFi Signal</span>
        <span class="info-value" id="wifiRssi">--</span>
      </div>
    </div>

    <div class="message">
      This is the <strong>Start Gate</strong> sensor node.<br>
      Race data, garage, and history are managed by the <strong>Finish Gate</strong>.<br>
      Open the Finish Gate dashboard to control races and view results.
    </div>
  </div>

  <div class="version-badge" id="versionBadge">v--</div>

  <script>
    // ====================================================================
    // WEBSOCKET
    // ====================================================================
    var ws = null;
    var wsConnected = false;

    function connectWS() {
      ws = new WebSocket('ws://' + window.location.hostname + ':81');

      ws.onopen = function() {
        wsConnected = true;
        document.getElementById('wsDot').classList.add('live');
        document.getElementById('wsStatus').textContent = 'Connected';
        document.getElementById('wsStatus').className = 'info-value connected';
      };

      ws.onclose = function() {
        wsConnected = false;
        document.getElementById('wsDot').classList.remove('live');
        document.getElementById('wsStatus').textContent = 'Disconnected';
        document.getElementById('wsStatus').className = 'info-value disconnected';
        setTimeout(connectWS, 2000);
      };

      ws.onmessage = function(e) {
        try {
          var d = JSON.parse(e.data);

          // Update state banner
          var banner = document.getElementById('stateBanner');
          var state = (d.state || 'UNKNOWN').toLowerCase();
          banner.className = 'state-banner ' + state;
          banner.textContent = d.state || 'UNKNOWN';
          document.getElementById('raceState').textContent = d.state || '--';

          // Peer status
          var peer = document.getElementById('peerStatus');
          if (d.connected) {
            peer.textContent = 'LINKED';
            peer.className = 'info-value connected';
          } else {
            peer.textContent = 'NO LINK';
            peer.className = 'info-value disconnected';
          }

          // LiDAR data
          if (d.lidar) {
            var lidarCard = document.getElementById('lidarCard');
            lidarCard.classList.add('visible');

            var dist = d.lidar.distance_mm;
            document.getElementById('lidarDist').textContent = dist != null ? dist : '--';

            var lidarState = d.lidar.state || 'empty';
            var label = document.getElementById('lidarLabel');
            label.className = 'lidar-state-label ' + lidarState;
            if (lidarState === 'staged') label.textContent = 'CAR STAGED';
            else if (lidarState === 'launched') label.textContent = 'LAUNCHED';
            else label.textContent = 'NO TARGET';

            // Bar visualization (closer = more fill, max 300mm range)
            var bar = document.getElementById('lidarBar');
            var pct = dist != null ? Math.max(0, Math.min(100, (1 - dist / 300) * 100)) : 0;
            bar.style.width = pct + '%';
            bar.className = 'lidar-bar' + (lidarState === 'staged' ? ' staged' : '');
          }
        } catch (err) {}
      };
    }

    // ====================================================================
    // DEVICE INFO (polled)
    // ====================================================================
    async function loadInfo() {
      try {
        var resp = await fetch('/api/info');
        var info = await resp.json();
        document.getElementById('ipAddr').textContent = info.ip || '--';

        var s = info.uptime_s || 0;
        if (s >= 3600) {
          document.getElementById('uptime').textContent = Math.floor(s / 3600) + 'h ' + Math.floor((s % 3600) / 60) + 'm';
        } else if (s >= 60) {
          document.getElementById('uptime').textContent = Math.floor(s / 60) + 'm ' + (s % 60) + 's';
        } else {
          document.getElementById('uptime').textContent = s + 's';
        }

        document.getElementById('freeHeap').textContent = (info.free_heap || 0).toLocaleString() + ' B';
        document.getElementById('wifiRssi').textContent = (info.wifi_rssi || 0) + ' dBm';

        // Show LiDAR card if enabled
        if (info.lidar_enabled) {
          document.getElementById('lidarCard').classList.add('visible');
        }
      } catch (e) {}
    }

    // ====================================================================
    // VERSION
    // ====================================================================
    async function loadVersion() {
      try {
        var resp = await fetch('/api/version');
        var v = await resp.json();
        document.getElementById('versionBadge').textContent = 'FW v' + v.firmware + ' | UI v' + v.web_ui;
      } catch (e) {
        var meta = document.querySelector('meta[name="fw-version"]');
        if (meta) document.getElementById('versionBadge').textContent = 'v' + meta.content;
      }
    }

    // ====================================================================
    // INIT
    // ====================================================================
    window.onload = function() {
      connectWS();
      loadInfo();
      loadVersion();
      setInterval(loadInfo, 15000);
    };
  </script>
</body>
</html>
