<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="fw-version" content="2.5.0">
  <title>Start Gate - M.A.S.S. Trap</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div id="navContainer"></div>
  <div class="container">
    <div class="page-header">
      <div class="page-header-shield"></div>
      <h1>M.A.S.S. TRAP</h1>
      <div class="subtitle">Motion Analysis &amp; Speed System</div>
      <div class="role-badge start">Start Gate</div>
      <div class="theme-selector">
        Theme: <select id="themePicker" onchange="setTheme(this.value)">
          <option value="interceptor">Interceptor</option>
          <option value="classic">Classic</option>
          <option value="daytona">Daytona</option>
          <option value="casefile">Case File</option>
          <option value="cyber">Cyber</option>
        </select>
      </div>
    </div>

    <!-- State Banner -->
    <div id="stateBanner" class="state-banner">INITIALIZING</div>

    <!-- System Status -->
    <div class="section">
      <div class="section-title">SYSTEM STATUS</div>
      <div class="info-row" style="padding-top:12px;">
        <span class="info-label"><span id="wsDot" class="ws-dot"></span>WebSocket</span>
        <span class="info-value" id="wsStatus">Connecting...</span>
      </div>
      <div class="info-row">
        <span class="info-label">Race State</span>
        <span class="info-value" id="raceState">--</span>
      </div>
    </div>

    <!-- Peer Network -->
    <div class="section" id="peerCard">
      <div class="section-title secondary">PEER NETWORK</div>
      <div id="peerList" style="padding-top:8px;">
        <div class="info-row">
          <span class="info-label">Scanning...</span>
          <span class="info-value text-muted">Searching for peers</span>
        </div>
      </div>
    </div>

    <!-- LiDAR Card -->
    <div id="lidarCard" class="section" style="display:none;">
      <div class="section-title">LIDAR STAGING SENSOR</div>
      <div class="lidar-reading" style="padding-top:8px;">
        <div><span id="lidarDist" class="lidar-distance">--</span><span class="unit"> mm</span></div>
        <span id="lidarLabel" class="lidar-state-label empty">NO TARGET</span>
      </div>
      <div class="lidar-bar-container">
        <div id="lidarBar" class="lidar-bar" style="width:0%"></div>
      </div>
    </div>

    <!-- Device Info -->
    <div class="section">
      <div class="section-title">DEVICE INFORMATION</div>
      <div class="info-row" style="padding-top:8px;">
        <span class="info-label">IP Address</span>
        <span class="info-value" id="ipAddr">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Uptime</span>
        <span class="info-value" id="uptime">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Free Memory</span>
        <span class="info-value" id="freeHeap">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">WiFi Signal</span>
        <span class="info-value" id="wifiRssi">--</span>
      </div>
    </div>

    <!-- Info Message -->
    <div class="message-box">
      This is the <strong>Start Gate</strong> sensor node.<br>
      Race data, garage, and history are managed by the <strong>Finish Gate</strong>.<br>
      Open the Finish Gate dashboard to control races and view results.
    </div>
  </div>

  <div id="versionBadge" class="version-badge">v--</div>

  <script src="/main.js"></script>
  <script>
    // ====================================================================
    // WEBSOCKET — uses shared connectWebSocket from main.js
    // ====================================================================
    onWsMessage(function(d) {
      // Update state banner
      var banner = document.getElementById('stateBanner');
      var state = (d.state || 'UNKNOWN').toLowerCase();
      banner.className = 'state-banner ' + state;
      banner.textContent = d.state || 'UNKNOWN';
      document.getElementById('raceState').textContent = d.state || '--';

      // LiDAR data
      if (d.lidar) {
        var lidarCard = document.getElementById('lidarCard');
        lidarCard.style.display = 'block';

        var dist = d.lidar.distance_mm;
        document.getElementById('lidarDist').textContent = dist != null ? dist : '--';

        var lidarState = d.lidar.state || 'empty';
        var label = document.getElementById('lidarLabel');
        label.className = 'lidar-state-label ' + lidarState;
        if (lidarState === 'staged') label.textContent = 'CAR STAGED';
        else if (lidarState === 'launched') label.textContent = 'LAUNCHED';
        else label.textContent = 'NO TARGET';

        var bar = document.getElementById('lidarBar');
        var pct = dist != null ? Math.max(0, Math.min(100, (1 - dist / 300) * 100)) : 0;
        bar.style.width = pct + '%';
        bar.className = 'lidar-bar' + (lidarState === 'staged' ? ' staged' : '');
      }
    });

    // ====================================================================
    // DEVICE INFO (polled)
    // ====================================================================
    function loadInfo() {
      fetch('/api/info').then(function(r) { return r.json(); }).then(function(info) {
        document.getElementById('ipAddr').textContent = info.ip || '--';
        document.getElementById('uptime').textContent = formatUptime(info.uptime_s);
        document.getElementById('freeHeap').textContent = formatBytes(info.free_heap);
        document.getElementById('wifiRssi').textContent = (info.wifi_rssi || 0) + ' dBm';

        if (info.lidar_enabled) {
          document.getElementById('lidarCard').style.display = 'block';
        }
      }).catch(function() {});
    }

    // ====================================================================
    // PEER NETWORK STATUS
    // ====================================================================
    function loadPeers() {
      fetch('/api/peers').then(function(r) { return r.json(); }).then(function(peers) {
        var container = document.getElementById('peerList');
        if (!peers || peers.length === 0) {
          container.innerHTML = '<div class="info-row">' +
            '<span class="info-label">No peers found</span>' +
            '<span class="info-value text-muted">Beaconing...</span></div>';
          return;
        }

        var html = '';
        for (var i = 0; i < peers.length; i++) {
          var p = peers[i];
          var dotClass = p.status || 'offline';
          var statusText = p.status === 'online' ? 'ONLINE' :
                          p.status === 'stale' ? 'STALE' : 'OFFLINE';
          var statusStyle = p.status === 'online' ? 'color:var(--success)' :
                           p.status === 'stale' ? '' : 'color:var(--danger)';
          var role = p.role || 'unknown';
          var name = p.hostname || p.mac || '--';
          var pairedBadge = p.paired ? ' *' : '';
          var nameHtml = p.hostname ? '<a href="http://' + escHtml(p.hostname) + '.local/" target="_blank" style="color:var(--accent);text-decoration:underline;">' + escHtml(name) + '</a>' : escHtml(name);

          html += '<div class="info-row">' +
            '<span class="info-label">' +
              '<span class="peer-dot ' + dotClass + '"></span>' +
              nameHtml + pairedBadge +
              '<span class="peer-role ' + role + '">' + role + '</span>' +
            '</span>' +
            '<span class="info-value" style="' + statusStyle + '">' + statusText + '</span>' +
          '</div>';
        }
        container.innerHTML = html;
      }).catch(function() {});
    }

    // ====================================================================
    // WS STATUS INDICATOR — sync with shared wsConnected state
    // ====================================================================
    function updateWsIndicator() {
      var dot = document.getElementById('wsDot');
      var label = document.getElementById('wsStatus');
      if (wsConnected) {
        dot.classList.add('live');
        label.textContent = 'Connected';
        label.style.color = 'var(--success)';
      } else {
        dot.classList.remove('live');
        label.textContent = 'Disconnected';
        label.style.color = 'var(--danger)';
      }
    }

    // ====================================================================
    // INIT
    // ====================================================================
    window.onload = function() {
      document.getElementById('navContainer').innerHTML = getNavHTML();
      massInit();
      loadInfo();
      loadPeers();
      setInterval(loadInfo, 15000);
      setInterval(loadPeers, 5000);
      setInterval(updateWsIndicator, 1000);
    };
  </script>
</body>
</html>
