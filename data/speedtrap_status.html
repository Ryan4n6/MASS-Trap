<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="fw-version" content="2.5.0">
  <title>Speed Trap - M.A.S.S. Trap</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div id="navContainer"></div>
  <div class="container">
    <div class="page-header">
      <div class="page-header-shield"></div>
      <h1>M.A.S.S. TRAP</h1>
      <div class="subtitle">Motion Analysis &amp; Speed System</div>
      <div class="role-badge speedtrap">Speed Trap Node</div>
      <div class="theme-selector">
        Theme: <select id="themePicker" onchange="setTheme(this.value)">
          <option value="interceptor">Interceptor</option>
          <option value="classic">Classic</option>
          <option value="daytona">Daytona</option>
          <option value="casefile">Case File</option>
          <option value="cyber">Cyber</option>
        </select>
      </div>
    </div>

    <!-- Last Measured Speed -->
    <div class="section">
      <div class="section-title">LAST MEASURED SPEED</div>
      <div style="text-align:center; padding-top:12px;">
        <span id="lastSpeed" class="big-value">--</span><span class="unit" id="speedUnitLabel">mph</span>
      </div>
      <div class="text-center text-muted mt-8" style="font-size:0.85rem;">
        <span id="lastSpeedMs">-- m/s</span> | Scale: <span id="lastSpeedScale" class="text-accent">--</span> <span id="scaleUnitLabel">mph</span>
      </div>
    </div>

    <!-- System Status -->
    <div class="section">
      <div class="section-title">SYSTEM STATUS</div>
      <div class="info-row" style="padding-top:8px;">
        <span class="info-label">Peer Connection</span>
        <span class="info-value" id="peerStatus"><span class="status-dot wait"></span>Checking...</span>
      </div>
      <div class="info-row">
        <span class="info-label">Sensor 1 (GPIO)</span>
        <span class="info-value" id="sensor1Pin">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Sensor 2 (GPIO)</span>
        <span class="info-value" id="sensor2Pin">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Sensor Spacing</span>
        <span class="info-value" id="sensorSpacing">-- m</span>
      </div>
      <div class="info-row">
        <span class="info-label">IP Address</span>
        <span class="info-value" id="ipAddr">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Free Heap</span>
        <span class="info-value" id="freeHeap">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Uptime</span>
        <span class="info-value" id="uptime">--</span>
      </div>
    </div>

    <!-- Peer Network -->
    <div class="section" id="peerCard">
      <div class="section-title secondary">PEER NETWORK</div>
      <div id="peerList" style="padding-top:8px;">
        <div class="info-row">
          <span class="info-label"><span class="status-dot wait"></span>Searching...</span>
          <span class="info-value text-muted">Searching for peers</span>
        </div>
      </div>
    </div>
  </div>

  <div id="versionBadge" class="version-badge">v--</div>

  <script src="/main.js"></script>
  <script>
    // ====================================================================
    // REFRESH DEVICE INFO + CONFIG
    // ====================================================================
    function refresh() {
      fetch('/api/info').then(function(r) { return r.json(); }).then(function(info) {
        document.getElementById('ipAddr').textContent = info.ip || 'N/A';
        document.getElementById('freeHeap').textContent = formatBytes(info.free_heap);
        document.getElementById('uptime').textContent = formatUptime(info.uptime_s);

        var peerEl = document.getElementById('peerStatus');
        if (info.peer_connected) {
          peerEl.innerHTML = '<span class="status-dot ok"></span>Connected';
        } else {
          peerEl.innerHTML = '<span class="status-dot err"></span>Disconnected';
        }
      }).catch(function() {});

      fetch('/api/config').then(function(r) { return r.json(); }).then(function(cfg) {
        var pins = cfg.pins || {};
        document.getElementById('sensor1Pin').textContent = 'GPIO ' + (pins.sensor_pin || '--');
        document.getElementById('sensor2Pin').textContent = 'GPIO ' + (pins.sensor_pin_2 || '--');
        var track = cfg.track || {};
        document.getElementById('sensorSpacing').textContent = (track.sensor_spacing_m || 0.10) + ' m';
      }).catch(function() {});
    }

    // ====================================================================
    // PEER NETWORK STATUS
    // ====================================================================
    function loadPeers() {
      fetch('/api/peers').then(function(r) { return r.json(); }).then(function(peers) {
        var container = document.getElementById('peerList');
        if (!peers || peers.length === 0) {
          container.innerHTML = '<div class="info-row">' +
            '<span class="info-label">No peers found</span>' +
            '<span class="info-value text-muted">Beaconing...</span></div>';
          return;
        }

        var html = '';
        for (var i = 0; i < peers.length; i++) {
          var p = peers[i];
          var dotClass = p.status || 'offline';
          var statusText = p.status === 'online' ? 'ONLINE' :
                          p.status === 'stale' ? 'STALE' : 'OFFLINE';
          var statusStyle = p.status === 'online' ? 'color:var(--success)' :
                           p.status === 'stale' ? '' : 'color:var(--danger)';
          var role = p.role || 'unknown';
          var name = p.hostname || p.mac || '--';
          var pairedBadge = p.paired ? ' *' : '';
          var nameHtml = p.hostname ? '<a href="http://' + escHtml(p.hostname) + '.local/" target="_blank" style="color:var(--accent);text-decoration:underline;">' + escHtml(name) + '</a>' : escHtml(name);

          html += '<div class="info-row">' +
            '<span class="info-label">' +
              '<span class="peer-dot ' + dotClass + '"></span>' +
              nameHtml + pairedBadge +
              '<span class="peer-role ' + role + '">' + role + '</span>' +
            '</span>' +
            '<span class="info-value" style="' + statusStyle + '">' + statusText + '</span>' +
          '</div>';
        }
        container.innerHTML = html;
      }).catch(function() {});
    }

    // ====================================================================
    // INIT
    // ====================================================================
    window.onload = function() {
      document.getElementById('navContainer').innerHTML = getNavHTML();
      // Fetch units from config
      fetch('/api/config').then(function(r) { return r.json(); }).then(function(cfg) {
        if (cfg.regional) setUnits(cfg.regional.units || 'imperial');
        var su = speedUnit();
        var el1 = document.getElementById('speedUnitLabel'); if (el1) el1.textContent = su;
        var el2 = document.getElementById('scaleUnitLabel'); if (el2) el2.textContent = su;
      }).catch(function(){});
      massInit({ws: false});
      refresh();
      loadPeers();
      setInterval(refresh, 3000);
      setInterval(loadPeers, 5000);
    };
  </script>
</body>
</html>
