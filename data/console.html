<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="fw-version" content="2.5.0">
  <title>M.A.S.S. Trap - Terminal</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body class="console-page">
  <div id="navContainer"></div>
  <div class="container">
    <!-- Device Info Bar -->
    <div class="info-grid">
      <div class="info-card"><div class="label">Role</div><div class="value" id="infoRole">--</div></div>
      <div class="info-card"><div class="label">IP Address</div><div class="value" id="infoIP">--</div></div>
      <div class="info-card"><div class="label">Free Heap</div><div class="value" id="infoHeap">--</div></div>
      <div class="info-card"><div class="label">Uptime</div><div class="value" id="infoUptime">--</div></div>
      <div class="info-card"><div class="label">WiFi RSSI</div><div class="value" id="infoRSSI">--</div></div>
      <div class="info-card"><div class="label">Peer</div><div class="value" id="infoPeer">--</div></div>
    </div>

    <!-- Tabs: Serial Monitor | File Browser -->
    <div class="config-tabs">
      <button class="config-tab active" onclick="showTab('serial')">Serial Monitor</button>
      <button class="config-tab" onclick="showTab('files')">File Browser</button>
    </div>

    <!-- Serial Monitor -->
    <div id="tab-serial" class="config-tab-content active">
      <div class="console-controls">
        <button class="btn btn-success btn-sm" onclick="fetchLog()">Refresh</button>
        <button class="btn btn-danger btn-sm" onclick="clearLog()">Clear Log</button>
        <label><input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()"> Auto-refresh (2s)</label>
        <label><input type="checkbox" id="autoScroll" checked> Auto-scroll</label>
        <label>Filter: <input type="text" id="logFilter" placeholder="e.g. WIFI, ESP-NOW" style="width:140px;"></label>
        <button class="btn btn-accent btn-sm" onclick="downloadLog()">Download</button>
      </div>
      <div id="serialOutput" class="serial-output">Connecting...</div>
    </div>

    <!-- File Browser -->
    <div id="tab-files" class="config-tab-content">
      <div class="console-controls">
        <button class="btn btn-success btn-sm" onclick="loadFileList()">Refresh Files</button>
        <span id="currentFile" class="text-accent" style="font-weight:700; margin-left:10px;">No file selected</span>
        <span style="flex:1;"></span>
        <button class="btn btn-primary btn-sm" id="btnSaveFile" onclick="saveFile()" style="display:none;">Save File</button>
        <button class="btn btn-danger btn-sm" id="btnDeleteFile" onclick="deleteFile()" style="display:none;">Delete</button>
      </div>
      <div id="fileListGrid" class="file-grid">
        <p class="text-muted">Loading files...</p>
      </div>
      <textarea id="fileEditor" class="file-editor" style="display:none;" placeholder="Select a file to edit..."></textarea>
    </div>
  </div>

  <!-- Console Status Bar (fixed bottom) -->
  <div class="console-status-bar">
    <span id="statusMsg">Initializing...</span>
    <span>
      <span class="text-muted" id="statusVersion">v--</span> |
      <span class="heap" id="statusHeap">--</span> free |
      <span class="uptime" id="statusUptime">--</span>
    </span>
  </div>

  <script src="/main.js"></script>
  <script>
    // ====================================================================
    // M.A.S.S. TRAP — TERMINAL / DEBUG CONSOLE  v2.5.0
    // ====================================================================

    // ====================================================================
    // DEVICE INFO
    // ====================================================================
    function loadDeviceInfo() {
      fetch('/api/info').then(function(resp) {
        return resp.json();
      }).then(function(info) {
        // Update tab title with role
        if (info.role) {
          var rn = info.role.charAt(0).toUpperCase() + info.role.slice(1);
          document.title = rn + ' - M.A.S.S. Trap Terminal';
        }

        document.getElementById('infoRole').textContent = (info.role || 'unknown').toUpperCase();
        document.getElementById('infoIP').textContent = info.ip || 'N/A';
        document.getElementById('infoHeap').textContent = formatBytes(info.free_heap);
        document.getElementById('infoUptime').textContent = formatUptime(info.uptime_s);
        document.getElementById('infoRSSI').textContent = (info.wifi_rssi || 0) + ' dBm';
        document.getElementById('infoPeer').textContent = info.peer_connected ? 'Connected' : 'Disconnected';
        document.getElementById('infoPeer').style.color = info.peer_connected ? '#28a745' : '#dc3545';

        // Status bar
        document.getElementById('statusHeap').textContent = formatBytes(info.free_heap);
        document.getElementById('statusUptime').textContent = formatUptime(info.uptime_s);
        document.getElementById('statusMsg').textContent = 'Connected to ' + (info.hostname || 'device');
      }).catch(function() {
        document.getElementById('statusMsg').textContent = 'Connection error';
      });
    }

    // ====================================================================
    // SERIAL MONITOR
    // ====================================================================
    var rawLog = '';
    var autoRefreshTimer = null;

    function fetchLog() {
      fetch('/api/log').then(function(resp) {
        return resp.text();
      }).then(function(text) {
        rawLog = text;
        renderLog();
      }).catch(function(e) {
        document.getElementById('serialOutput').textContent = 'Failed to fetch log: ' + e.message;
      });
    }

    function renderLog() {
      var output = document.getElementById('serialOutput');
      var filter = document.getElementById('logFilter').value.trim().toUpperCase();
      var lines = rawLog.split('\n');

      if (filter) {
        lines = lines.filter(function(l) {
          return l.toUpperCase().indexOf(filter) !== -1;
        });
      }

      // Colorize output
      output.innerHTML = lines.map(function(line) {
        if (line.indexOf('[WIFI]') !== -1 || line.indexOf('WiFi') !== -1) return '<span class="esp">' + escHtml(line) + '</span>';
        if (line.indexOf('[ESP-NOW]') !== -1 || line.indexOf('[DISCOVER]') !== -1) return '<span class="esp">' + escHtml(line) + '</span>';
        if (line.indexOf('[BOOT]') !== -1 || line.indexOf('========') !== -1) return '<span class="boot">' + escHtml(line) + '</span>';
        if (line.indexOf('ERROR') !== -1 || line.indexOf('FAIL') !== -1 || line.indexOf('error') !== -1) return '<span class="err">' + escHtml(line) + '</span>';
        if (line.indexOf('WARN') !== -1 || line.indexOf('warn') !== -1) return '<span class="warn">' + escHtml(line) + '</span>';
        return escHtml(line);
      }).join('\n');

      if (document.getElementById('autoScroll').checked) {
        output.scrollTop = output.scrollHeight;
      }
    }

    function clearLog() {
      fetch('/api/log', { method: 'DELETE', headers: authHeaders() }).then(function() {
        rawLog = '';
        document.getElementById('serialOutput').textContent = '(log cleared)';
      }).catch(function() {});
    }

    function downloadLog() {
      var blob = new Blob([rawLog], { type: 'text/plain' });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'masstrap_serial_' + Date.now() + '.log';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function toggleAutoRefresh() {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
      if (document.getElementById('autoRefresh').checked) {
        autoRefreshTimer = setInterval(function() {
          fetchLog();
          loadDeviceInfo();
        }, 2000);
      }
    }

    // Filter on keyup
    document.getElementById('logFilter').addEventListener('input', renderLog);

    // ====================================================================
    // FILE BROWSER
    // ====================================================================
    var currentFilePath = '';
    var fileList = [];

    function loadFileList() {
      fetch('/api/files?path=/').then(function(resp) {
        return resp.json();
      }).then(function(data) {
        fileList = data;
        renderFileList();
      }).catch(function() {
        document.getElementById('fileListGrid').innerHTML = '<p class="text-danger">Failed to load files</p>';
      });
    }

    function renderFileList() {
      var grid = document.getElementById('fileListGrid');
      if (fileList.length === 0) {
        grid.innerHTML = '<p class="text-muted">No files found on filesystem</p>';
        return;
      }
      grid.innerHTML = fileList.map(function(f) {
        var isActive = currentFilePath === '/' + f.name;
        return '<div class="file-item' + (isActive ? ' active' : '') + '" onclick="openFile(\'/' + escHtml(f.name) + '\')">' +
          '<div class="fname">' + escHtml(f.name) + '</div>' +
          '<div class="fsize">' + formatBytes(f.size) + '</div>' +
        '</div>';
      }).join('');
    }

    function openFile(path) {
      fetch('/api/files?path=' + encodeURIComponent(path)).then(function(resp) {
        return resp.json();
      }).then(function(data) {
        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }
        currentFilePath = path;
        document.getElementById('currentFile').textContent = path + ' (' + formatBytes(data.size) + ')';
        document.getElementById('fileEditor').value = data.content;
        document.getElementById('fileEditor').style.display = 'block';
        document.getElementById('btnSaveFile').style.display = 'inline-block';
        document.getElementById('btnDeleteFile').style.display = 'inline-block';
        renderFileList();
      }).catch(function(e) {
        alert('Failed to open file: ' + e.message);
      });
    }

    function saveFile() {
      if (!currentFilePath) return;
      var content = document.getElementById('fileEditor').value;
      fetch('/api/files?path=' + encodeURIComponent(currentFilePath), {
        method: 'POST',
        headers: authHeaders({ 'Content-Type': 'application/octet-stream' }),
        body: content
      }).then(function(resp) {
        return resp.json();
      }).then(function(result) {
        if (result.status === 'ok') {
          document.getElementById('currentFile').textContent = currentFilePath + ' (saved - ' + formatBytes(result.size) + ')';
          document.getElementById('statusMsg').textContent = 'Saved ' + currentFilePath;
          loadFileList();
        } else {
          alert('Save failed: ' + (result.error || 'unknown'));
        }
      }).catch(function(e) {
        alert('Save failed: ' + e.message);
      });
    }

    function deleteFile() {
      if (!currentFilePath) return;
      if (!confirm('Delete ' + currentFilePath + '? This cannot be undone.')) return;
      fetch('/api/files?path=' + encodeURIComponent(currentFilePath), {
        method: 'DELETE',
        headers: authHeaders()
      }).then(function(resp) {
        return resp.json();
      }).then(function(result) {
        if (result.status === 'ok') {
          currentFilePath = '';
          document.getElementById('currentFile').textContent = 'File deleted';
          document.getElementById('fileEditor').style.display = 'none';
          document.getElementById('btnSaveFile').style.display = 'none';
          document.getElementById('btnDeleteFile').style.display = 'none';
          loadFileList();
        } else {
          alert('Delete failed: ' + (result.error || 'unknown'));
        }
      }).catch(function(e) {
        alert('Delete failed: ' + e.message);
      });
    }

    // ====================================================================
    // TABS
    // ====================================================================
    function showTab(name) {
      var panels = document.querySelectorAll('.config-tab-content');
      for (var i = 0; i < panels.length; i++) panels[i].classList.remove('active');
      var tabs = document.querySelectorAll('.config-tab');
      for (var j = 0; j < tabs.length; j++) tabs[j].classList.remove('active');

      document.getElementById('tab-' + name).classList.add('active');
      event.target.classList.add('active');

      if (name === 'files') loadFileList();
    }

    // ====================================================================
    // CONSOLE STATUS BAR VERSION
    // ====================================================================
    function loadConsoleVersion() {
      fetch('/api/version').then(function(r) { return r.json(); }).then(function(v) {
        document.getElementById('statusVersion').textContent = 'FW v' + v.firmware;
      }).catch(function() {
        var meta = document.querySelector('meta[name="fw-version"]');
        if (meta) document.getElementById('statusVersion').textContent = 'v' + meta.content;
      });
    }

    // ====================================================================
    // INIT
    // ====================================================================
    window.onload = function() {
      document.getElementById('navContainer').innerHTML = getNavHTML();
      massInit({ws: false});
      // Internal Affairs gate — admin password check
      checkAuthGate('admin');
      loadDeviceInfo();
      loadConsoleVersion();
      fetchLog();
      toggleAutoRefresh();
    };
  </script>
</body>
</html>
